[
  {
    "id": "https://github.com/WasmEdge/WasmEdge/issues/3503",
    "source": {
      "issue_number": 3503
    },
    "initial_question": {
      "title": "O_TRUNC print bug.",
      "body": "### Summary\r\n\r\nThe file is opened with O_RDWR and O_TRUNC, but do not print`Access mode: O_TRUNC`.\r\nI'm not sure whether this is a bug.\r\n\r\n### Current State\r\n\r\nWasmEdge print:\r\n```\r\nGet file descriptor of file subdir_2/subfile_3 succeed!\r\nAccess mode: Read/Write\r\nEnter function fd_fdstat_set_flags_00018_ZJtyU\r\nSetting flags succeed!\r\nAfter setting flags\r\nAccess mode: Read/Write\r\nAccess mode: O_APPEND\r\n```\r\n\r\n### Expected State\r\nPrint:\r\n```\r\nGet file descriptor of file subdir_2/subfile_3 succeed!\r\nAccess mode: Read/Write\r\nAccess mode: O_TRUNC\r\nEnter function fd_fdstat_set_flags_00018_ZJtyU\r\nSetting flags succeed!\r\nAfter setting flags\r\nAccess mode: Read/Write\r\nAccess mode: O_TRUNC\r\nAccess mode: O_APPEND\r\n```\r\n\r\n### Reproduction steps\r\n\r\nThe test case is :\r\n```\r\n\r\n#include <stdio.h>\r\n#include <stdlib.h>\r\n#include <fcntl.h>\r\n#include <unistd.h>\r\n\r\nint get_fd(const char *filename, int flags) {\r\n    int fd = open(filename, flags);\r\n    \r\n    if (fd == -1) {\r\n        printf(\"Get file descriptor of file %s failed!\\n\", filename);\r\n        return -1;\r\n    } else {\r\n        printf(\"Get file descriptor of file %s succeed!\\n\", filename);\r\n        return fd;\r\n    }\r\n}\r\n\r\nvoid closebyfd(int fd) {\r\n    if (close(fd) == -1) {\r\n        printf(\"Close the file %d by descriptor failed!\\n\", fd);\r\n    }\r\n}\r\n\r\nvoid fd_fdstat_set_flags_00018_ZJtyU(int fd) {\r\n    printf(\"Enter function fd_fdstat_set_flags_00018_ZJtyU\\n\");\r\n\r\n    int flags = fcntl(fd, F_GETFL);\r\n    flags = flags | O_APPEND;\r\n    \r\n    if (fcntl(fd, F_SETFL, flags) == -1) {\r\n        printf(\"Setting flags failed!\\n\");\r\n    } else {\r\n        printf(\"Setting flags succeed!\\n\");\r\n    }\r\n}\r\n\r\n\r\n    \r\nvoid print_flags(int fd){\r\n    int flags1 = fcntl(fd, F_GETFL);\r\n    int access_mode1 = flags1 & O_ACCMODE;\r\n    if (access_mode1 == O_RDONLY) {\r\n        printf(\"Access mode: Read Only\\n\");\r\n    }\r\n    if (access_mode1 == O_WRONLY) {\r\n        printf(\"Access mode: Write Only\\n\");\r\n    }\r\n    if (access_mode1 == O_RDWR) {\r\n        printf(\"Access mode: Read/Write\\n\");\r\n    }\r\n    if (flags1 & O_TRUNC) {\r\n        printf(\"Access mode: O_TRUNC\\n\");\r\n    }\r\n    if (flags1 & O_APPEND) {\r\n        printf(\"Access mode: O_APPEND\\n\");\r\n    }\r\n    if (flags1 & O_CREAT) {\r\n        printf(\"Access mode: O_CREAT\\n\");\r\n    }\r\n    if (flags1 & O_EXCL) {\r\n        printf(\"Access mode: O_EXCL\\n\");\r\n    }\r\n    if (flags1 & O_NONBLOCK) {\r\n        printf(\"Access mode: Non-blocking\\n\");\r\n    }\r\n    if (flags1 & O_SYNC) {\r\n        printf(\"Access mode: Synchronous Write\\n\");\r\n    }\r\n    if (flags1 & O_DSYNC) {\r\n        printf(\"Access mode: Data Synchronization Write\\n\");\r\n    }\r\n}\r\n    \r\nint main() {\r\n    \r\n    int fd = get_fd(\"subdir_2/subfile_3\", O_RDWR | O_TRUNC);\r\n\r\n    if (fd == -1) {\r\n        return 1;\r\n    }\r\n\r\n    \r\n    print_flags(fd);\r\n    fd_fdstat_set_flags_00018_ZJtyU(fd);\r\n    printf(\"After setting flags\\n\");\r\n    print_flags(fd);\r\n\r\n\r\n    closebyfd(fd);\r\n\r\n    return 0;\r\n}\r\n\r\n```\r\n\r\nSteps to reproduce:\r\n(1)compile to wasm:`./wasi-sdk-21.0/bin/clang --target=wasm32-unkown-wasi --sysroot=./wasi-sdk-21.0/share/wasi-sysroot test.c -o test.wasm`\r\n\r\n(2)Running wasm:\r\n(Before run the Wasm file, subdir_2/subfile_3 exists.)\r\nwasmedge --dir=. test.wasm\r\n\r\n\r\n\r\n### Components\r\n\r\nCLI\r\n\r\n### WasmEdge Version or Commit you used\r\n\r\n0.13.5 and 0.13.3\r\n\r\n### Operating system information\r\n\r\nUbuntu 20.04\r\n\r\n### Hardware Architecture\r\n\r\nx86_64\r\n"
    },
    "satisfaction_conditions": [
      "Program correctly opens and accesses the target file with O_RDWR and O_TRUNC flags",
      "File size is reduced to 0 when opened with O_TRUNC",
      "Program accurately reports access modes that are available through fcntl",
      "O_APPEND flag is successfully added and reported after modification"
    ],
    "created_at": "2024-06-24T07:52:21Z"
  }
]