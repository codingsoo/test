[
  {
    "number": 4302,
    "title": "11 vulnerabilities (4 moderate, 7 high)",
    "created_at": "2024-12-20T10:28:56Z",
    "closed_at": "2024-12-20T10:32:38Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4302",
    "body": "Running `npm install sharp` on macOS 15.1 using node 20.17.0 warns about vulnerabilities. Any plans to resolve these?\r\n\r\n```\r\nnpm install sharp --save-dev\r\n\r\nadded 8 packages, removed 70 packages, and audited 1139 packages in 17s\r\n\r\n193 packages are looking for funding\r\n  run `npm fund` for details\r\n\r\n11 vulnerabilities (4 moderate, 7 high)\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4302/comments",
    "author": "saeid-elio",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-12-20T10:32:38Z",
        "body": "> audited 1139 packages in 17s\r\n\r\nYou're running an audit on all of your dependencies, not just sharp.\r\n\r\n```\r\n$ npm i sharp\r\nadded 11 packages in 3s\r\n\r\n$ npm audit\r\nfound 0 vulnerabilities\r\n```"
      },
      {
        "user": "saeid-elio",
        "created_at": "2024-12-20T11:15:49Z",
        "body": "True, my bad."
      }
    ]
  },
  {
    "number": 4295,
    "title": "Changing exif data question",
    "created_at": "2024-12-13T19:31:47Z",
    "closed_at": "2024-12-14T08:06:41Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4295",
    "body": "Hi, could you please explain how to change ExifImageWidth and ExifImageHeight? I use withMetadata() and Ideally I want to copy all metadata except ExifImageWidth, ExifImageHeight. ImageHeight and ImageWidth copied too and it's not correct when I change orientation. Please help.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4295/comments",
    "author": "ihopciklumer",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-12-13T20:42:51Z",
        "body": "Please try something like the following:\r\n```js\r\n.withExif({\r\n  IFD0: {\r\n    PixelXDimension: \"123\",\r\n    PixelYDimension: \"456\"\r\n  }\r\n})\r\n```"
      },
      {
        "user": "ihopciklumer",
        "created_at": "2024-12-14T08:06:41Z",
        "body": "Thanks! It helped!"
      }
    ]
  },
  {
    "number": 4292,
    "title": "[Windows] Missed support of long path",
    "created_at": "2024-12-09T14:04:46Z",
    "closed_at": "2025-01-06T11:33:24Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4292",
    "body": "## Possible bug\r\n\r\nIt works fine until I pass a long path to load an image with `sharp` function.\r\n\r\nAs _workaround_ I can manually read the file with Node.js and pass `ArrayBuffer` of the image to `sharp` function instead of the image path string.\r\n\r\n### Is this a possible bug in a feature of sharp, unrelated to installation?\r\n\r\nIt's bug of handling a Windows filesystem long path.\r\n\r\n### ENV\r\n\r\n- Window 10\r\n- Node v20.18.0\r\n- Sharp 0.33.5\r\n\r\n\r\n### What are the steps to reproduce?\r\n\r\nRun the TS code.\r\n\r\n### What is the expected behaviour?\r\n\r\nNo errors. A workaround is not needed. It just works from the box.\r\n\r\n### Please provide a minimal, standalone code sample, without other dependencies, that demonstrates this problem\r\n\r\n```ts\r\nimport sharp from \"sharp\";\r\nimport fs from \"node:fs/promises\";\r\nimport path from \"node:path\";\r\n\r\nconst imageName = \"image-for-long-path-3x3.png\";\r\n\r\n// create an image\r\nawait saveImageDataWithSharp({\r\n    data: new Uint8ClampedArray([255, 255, 255, 0, 0, 0, 128, 128, 128]),\r\n    width: 3,\r\n    height: 3,\r\n    channels: 1\r\n}, imageName);\r\n\r\n// move it to a long path directory\r\nconst dirPath = path.join(\"./\", ...[\r\n    \"a\".repeat(100), \"b\".repeat(100), \"c\".repeat(100), \"d\".repeat(100)\r\n]);\r\nawait fs.mkdir(dirPath, {recursive: true});\r\n\r\nconst newPath = path.join(dirPath, imageName);\r\nawait fs.rename(imageName, newPath);\r\n\r\n// ---\r\n\r\n// it works fine\r\nconsole.log(\"reading with fs:\");\r\nconsole.log(await getImageDataWithSharp((await fs.readFile(newPath)).buffer));\r\n\r\nconsole.log();\r\n\r\n// it throws an error\r\nconsole.log(\"reading with sharp:\");\r\ntry {\r\n    console.log(await getImageDataWithSharp(newPath));\r\n} catch (e) {\r\n    console.log((e as Error).message);\r\n}\r\n\r\n\r\n// ---\r\n\r\nexport function saveImageDataWithSharp(imageData: ImageDataLikeEx, outputFilePath: string): Promise<sharp.OutputInfo> {\r\n    const image: sharp.Sharp = sharp(imageData.data, {\r\n        raw: {\r\n            width: imageData.width,\r\n            height: imageData.height,\r\n            channels: imageData.channels ? imageData.channels : 4,\r\n        }\r\n    });\r\n    return image.toFile(outputFilePath);\r\n}\r\n\r\nexport async function getImageDataWithSharp(inputData: string | ArrayBuffer): Promise<ImageDataLike> {\r\n    const imageData = await sharp(inputData)\r\n        .ensureAlpha()\r\n        .raw()\r\n        .toBuffer({resolveWithObject: true});\r\n    const {data, info} = imageData;\r\n    return {\r\n        width: info.width,\r\n        height: info.height,\r\n        data: new Uint8ClampedArray(data.buffer),\r\n    };\r\n}\r\n\r\ntype ImageDataLike = {\r\n    data:   Uint8ClampedArray\r\n    width:  number\r\n    height: number\r\n};\r\ntype ImageDataLikeEx = {\r\n    data:   Uint8ClampedArray | Uint8Array\r\n    width:  number\r\n    height: number\r\n    channels?: 4 | 1 | 2 | 3\r\n};\r\n```\r\n\r\n```\r\nreading with fs:\r\n{\r\n  width: 3,\r\n  height: 3,\r\n  data: Uint8ClampedArray(36) [\r\n    255, 255, 255, 255, 255, 255, 255, 255,\r\n    255, 255, 255, 255,   0,   0,   0, 255,\r\n      0,   0,   0, 255,   0,   0,   0, 255,\r\n    128, 128, 128, 255, 128, 128, 128, 255,\r\n    128, 128, 128, 255\r\n  ]\r\n}\r\n\r\nreading with sharp:\r\nInput file is missing: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\\bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb\\cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc\\dddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd\\image-for-long-path-3x3.png\r\n```\r\n\r\n### Please provide sample image(s) that help explain this problem\r\n\r\nGenerated.\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4292/comments",
    "author": "AlttiRi",
    "comments": [
      {
        "user": "AlttiRi",
        "created_at": "2024-12-09T14:11:55Z",
        "body": "BTW, using `path.toNamespacedPath(newPath))` also helps.\r\nIt simply `resolve`s the path to absolute one and prepends `\\\\?\\`."
      },
      {
        "user": "lovell",
        "created_at": "2024-12-09T14:31:34Z",
        "body": "Is it still the case that Windows has problems with filesystem paths longer than 260 characters? If so, use of `toNamespacedPath` is probably the right approach here."
      },
      {
        "user": "lovell",
        "created_at": "2025-01-06T11:33:24Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 4285,
    "title": "Error: Image input not supported, even though i am giving image/jpeg file",
    "created_at": "2024-11-26T13:39:40Z",
    "closed_at": "2025-01-27T08:33:08Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4285",
    "body": "### What are you trying to achieve?\r\nI am trying to implement sharp on my backend system, when i want to create thumbnail for images [jpeg, jpg,png]\r\nI will be attaching the code section below, i have used mime-type to verify my file, mime lookup gives value of image/jpeg\r\nand the file exist for sure. but still its giving me image input not supported, what is the possible issue?\r\n\r\n\r\n### Please provide a minimal, standalone code sample, without other dependencies, that demonstrates this question\r\n \r\n                    await sharp(filePath).resize(200, 200).toFile(thumbnailPath,(err,info)=>{\r\n                        if(err){\r\n                            console.log(\"Error in generating thumbnail\",err);\r\n                        }else{\r\n                            console.log(\"Thumbnail generated successfully\",info);\r\n                            thumbnailgenerated = true;\r\n                             }\r\n                        }\r\n                    );\r\n                    \r\n<!-- Please provide either formatted code or a link to a repo/gist that helps someone else understand here. -->\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4285/comments",
    "author": "Saurabh9678",
    "comments": [
      {
        "user": "Saurabh9678",
        "created_at": "2024-11-26T13:43:47Z",
        "body": "this is the error i am getting, what are the possible reasons?\r\nand how to debug?\r\n\r\n\r\n    Error in generating thumbnail Error: Input file contains unsupported image format\r\n    at Sharp.toFile (/Users/saurabh/Desktop/daakia-backend-nodejs/node_modules/sharp/lib/output.js:90:19)\r\n    at uploadChatAttachmentFileToAzure (/Users/saurabh/Desktop/daakia-backend-nodejs/middlewares/uploadToAzure.js:153:60)\r\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\r\n    at async Middleware_Common_Object.<anonymous> (/Users/saurabh/Desktop/daakia-backend-nodejs/middlewares/uploadToAzure.js:233:30)"
      },
      {
        "user": "QAtestingin",
        "created_at": "2024-11-28T10:05:31Z",
        "body": "Facing same issue."
      },
      {
        "user": "lovell",
        "created_at": "2024-11-28T18:05:32Z",
        "body": "> uploadChatAttachmentFileToAzure\r\n\r\nPlease ensure there are no networking-related errors or race conditions in your code. If you're still having problems, please provide a sample image that allows someone else to consistently reproduce."
      },
      {
        "user": "lovell",
        "created_at": "2025-01-06T11:32:01Z",
        "body": "@Saurabh9678 Were you able to make any progress with this? If you still require help, please provide the requested information."
      },
      {
        "user": "lovell",
        "created_at": "2025-01-27T08:33:08Z",
        "body": "Closing due to inactivity but please feel free to reopen with the requested details if further help is required."
      }
    ]
  },
  {
    "number": 4284,
    "title": "Can it support nodejs16？",
    "created_at": "2024-11-24T02:39:21Z",
    "closed_at": "2024-11-24T08:45:03Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4284",
    "body": "my server is centos7, and the nodejs max support version is 16 😭",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4284/comments",
    "author": "i7soft",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-11-24T08:45:03Z",
        "body": "The short answer is no, the slightly longer answer is Node.js doesn't support Node.js 16 as it reached end-of-life in September 2023 and CentOS doesn't support CentOS 7 as it reached end-of-life in June."
      }
    ]
  },
  {
    "number": 4271,
    "title": "PNG from SVG Buffer fails with \"Input buffer has corrupt header: glib: XML parse error\"",
    "created_at": "2024-11-16T10:38:50Z",
    "closed_at": "2024-11-16T16:38:02Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4271",
    "body": "## Possible bug\r\n\r\n### Is this a possible bug in a feature of sharp, unrelated to installation?\r\n\r\n- [x] Running `npm install sharp` completes without error.\r\n- [x] Running `node -e \"require('sharp')\"` completes without error.\r\n\r\n### Are you using the latest version of sharp?\r\n\r\n- [x] I am using the latest version of `sharp` as reported by `npm view sharp dist-tags.latest`.\r\n\r\n### What is the output of running `npx envinfo --binaries --system --npmPackages=sharp --npmGlobalPackages=sharp`?\r\n\r\n```\r\n  System:\r\n    OS: Windows 10 10.0.19045\r\n    CPU: (12) x64 Intel(R) Core(TM) i5-10500H CPU @ 2.50GHz\r\n    Memory: 43.09 GB / 63.79 GB\r\n  Binaries:\r\n    Node: 22.11.0 - C:\\Program Files\\nodejs\\node.EXE       \r\n    Yarn: 4.5.1 - C:\\Program Files (x86)\\Yarn\\bin\\yarn.CMD \r\n    npm: 10.8.3 - C:\\Program Files\\nodejs\\npm.CMD\r\n  npmPackages:\r\n    sharp: ^0.33.5 => 0.33.5\r\n```\r\n\r\n<!-- Please provide output of the above command here. -->\r\n\r\n### Does this problem relate to file caching?\r\n\r\n- [x] Adding `sharp.cache(false)` does not fix this problem.\r\n\r\n### Does this problem relate to images appearing to have been rotated by 90 degrees?\r\n\r\n- [x] Using `rotate()` or `keepExif()` does not fix this problem.\r\n\r\n### What are the steps to reproduce?\r\n\r\n1) Use `ReactDOMServer.renderToString`, `ReactDOM.render`, `ReactDOMServer.renderToStaticMarkup`, or a literal string with `<svg>...` in it.\r\n2) Attempt to convert the SVG to PNG using various sample codes.\r\n\r\n```tsx\r\n  const svg = ReactDOMServer.renderToString(<SvgComponent />)\r\n  console.log('Rendering composite...')\r\n  const png = sharp(Buffer.from(svg))\r\n    .png()\r\n    .resize(24, 24)\r\n  console.log('Converting to buffer...')\r\n  const buf = await png.toBuffer() // errors here\r\n  console.log('Returning base64...')\r\n```\r\n\r\nI've also tried the simpler\r\n\r\n```tsx\r\n  const svg = ReactDOMServer.renderToString(<SvgComponent />)\r\n  const buffer = await sharp(Buffer.from(svg))\r\n    .png()\r\n    .toBuffer()\r\n```\r\n\r\nSame error.\r\n\r\n```\r\nError: Input buffer has corrupt header: glib: XML parse error: Error domain 1 code 5 on line 1 column 425 of data: Extra content at the end of the document\r\n```\r\n\r\nYou may ask, \"why not `composite`?\" Well, see my previous issue.\r\n\r\n### What is the expected behaviour?\r\n\r\nPNG output\r\n\r\n### Please provide a minimal, standalone code sample, without other dependencies, that demonstrates this problem\r\n\r\n\"Without dependencies\" is hardly possible in the NPM ecosystem, come on now. However, this can be reproduced in the minimal `create-react-app` as well as the `create-next-app` (this is a NextJS application.)\r\n\r\nCode directly from my app:\r\n\r\n```tsx\r\nimport Facebook from '@mui/icons-material/Facebook' // or any other icon\r\nimport ReactDOMServer from 'react-dom/server'\r\nimport sharp from 'sharp'\r\n\r\nconst svgToImage = async (SvgComponent: typeof Facebook): Promise<Buffer> => {\r\n  // Also tried all the other render methods, output is valid SVG\r\n  const svg = ReactDOMServer.renderToStaticMarkup(<SvgComponent />)\r\n  return await sharp(Buffer.from(svg))\r\n    .png()\r\n    .toBuffer()\r\n}\r\n```\r\n\r\n### Please provide sample image(s) that help explain this problem\r\n\r\nAny image from MaterialUI Icons, literally any of them (yes, I looped through the entire namespace to test.) What I want working atm however are `<Facebook />`, `<Instagram />` etc brand logos.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4271/comments",
    "author": "AlbinoGeek",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-11-16T14:04:16Z",
        "body": "> or a literal string with \\<svg\\>... in it.\r\n\r\nPlease can you provide an example string that represents a valid SVG that fails in this manner."
      },
      {
        "user": "AlbinoGeek",
        "created_at": "2024-11-16T15:51:26Z",
        "body": "```html\r\n<style data-emotion=\"css 1umw9bq-MuiSvgIcon-root\">.css-1umw9bq-MuiSvgIcon-root{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;fill:currentColor;font-size:1.5rem;}</style><svg class=\"MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-1umw9bq-MuiSvgIcon-root\" focusable=\"false\" aria-hidden=\"true\" viewBox=\"0 0 24 24\" data-testid=\"FacebookIcon\"><path d=\"M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2m13 2h-2.5A3.5 3.5 0 0 0 12 8.5V11h-2v3h2v7h3v-7h3v-3h-3V9a1 1 0 0 1 1-1h2V5z\"></path></svg>\r\n```\r\n\r\nI have also tried stripping the `<style>` tag, although this is counter-productive for my use-case. Also, last I checked, SVGs supported both classes and inline styles. It's entirely fair if `sharp` doesn't, but I would expect a slightly more useful error message if that's the case."
      },
      {
        "user": "lovell",
        "created_at": "2024-11-16T16:05:23Z",
        "body": "Thanks, this sample string is not valid XML so that's why you're seeing an \"XML parse error\" message. As you suggest you'll need to (re)move the `<style>` element as valid SVG must be valid XML, and valid XML must have a single root node."
      },
      {
        "user": "AlbinoGeek",
        "created_at": "2024-11-16T16:08:46Z",
        "body": "Mmmm.... I'm having trouble understanding how both `Resend.js` and NextJS itself manage to display these SVGs, using the `sharp` library no less, while retaining the style. I suppose they have some magic surrounding forcing the styles into the SVG's individual path/rect/etc, if I had to guess?\r\n\r\nHow would you recommend I approach this issue then, considering that removing the styling destroys the images (in the case of these brand images, they do not render correctly without the styles.) My only other option appears to be **an entire headless browser** just to render an SVG, which seems painful and redundant.\r\n\r\nThe following absolute madhouse has gotten me close, but not quite:\r\n\r\n**Edit, Spaghetti rewrote to be.... readable?**\r\n\r\n```tsx\r\nconst convertSvgToImage = async (\r\n  MuiSvgIcon: typeof Facebook\r\n): Promise<Buffer> => {\r\n  const html = ReactDOMServer.renderToString(<MuiSvgIcon />)\r\n  const css = RegExp(/MuiSvgIcon-root{(.*)}/).exec(html)?.[1] ?? ''\r\n  return await sharp(Buffer.from(html\r\n    .replace(/<style data-emotion[^>]*>.*<\\/style>/, '')\r\n    .replace(/class=\"[^\"]*\"/, `style=\"${css}\"`)\r\n  )).resize(48, 48).png().toBuffer()\r\n}\r\n```"
      },
      {
        "user": "AlbinoGeek",
        "created_at": "2024-11-16T16:38:02Z",
        "body": "Well I suppose if anyone find this later...\r\n\r\nThe above snippet will get you \"close enough\", maybe?\r\n\r\nThe colours are wrong, the images are fuzzy, but hey, it \"works\"?\r\n\r\nClosing as this is apparently just not a feature of `sharp`, which, fair."
      }
    ]
  },
  {
    "number": 4266,
    "title": ".toBuffer() / .toArray() / .toFile() seems to affect unrelated Buffer instance",
    "created_at": "2024-11-14T12:58:27Z",
    "closed_at": "2025-01-09T14:08:24Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4266",
    "body": "## Question about an existing feature\r\n\r\n### What are you trying to achieve?\r\n\r\nI want to crop an image defined as base64 data. The original uncropped image should later be used to create a `File` object to be sent via `FormData` to a third-party service. For this purpose I create two separate `Buffer` instances from the same base64 string via `Buffer.from()`.\r\n\r\nCalling `.toBuffer()`, `.toArray()`, or `.toFile()` on the `Sharp` instance used for cropping seems to affect the original `Buffer` in a way that causes an error when sent to the third-party service. The service's responds with a generic error which provides no further insights.\r\n\r\nMy main question is: How is it possible that two independent buffers are linked? Is it related to buffers created via `Buffer.from()` being pooled?\r\n\r\nI am not even sure if this is a Node.js issue or a Sharp issue. Thanks for your help and for any hint or idea!\r\n\r\n\r\n### When you searched for similar issues, what did you find that might be related?\r\nSearched this issue tracker and Google for \"extract changes original buffer\", \"modified buffer\", \"Node.js buffer re-used\" and all sorts of variations and combinations.\r\n\r\n### Please provide a minimal, standalone code sample, without other dependencies, that demonstrates this question\r\n\r\n```ts\r\nconst cropImage = (imageBuffer: Buffer, region: ImageRegion) => {\r\n  sharp.cache(false)\r\n  return sharp(imageBuffer)\r\n    .extract({\r\n      left: region.x,\r\n      top: region.y,\r\n      width: region.width,\r\n      height: region.height,\r\n    })\r\n    .jpeg()\r\n  // .toBuffer() // => fails; toArray() or toFile() also fails\r\n  // .then((data) => `data:image/jpeg;base64,${data.toString('base64')}`)\r\n}\r\n\r\nconst imageBase64DataString = imageBase64DataUri.replace(/^data:image\\/jpeg;base64,/, '')\r\nconst firstBuffer = Buffer.from(imageBase64DataString, 'base64')\r\n\r\nconst secondBuffer = Buffer.from(imageBase64DataString, 'base64')\r\nconst regionBase64Uri = await cropImage(secondBuffer, region)\r\n\r\nconst file = new File([firstBuffer], 'image.jpg', { type: 'image/jpeg' })\r\nconst formData = new FormData()\r\nformData.append('file', file, 'image.jpg')\r\n\r\n// third-party API call - fails whenever toBuffer() is used, see above\r\nconst { error, fileMetadata } = await nhost.storage.upload({formData})\r\n```\r\n\r\n\r\n### Please provide sample image(s) that help explain this question\r\n\r\nAny image. Black 4x4 JPEG I am currently using for testing:\r\n```\r\ndata:image/jpeg;base64,/9j/4AAQSkZJRgABAQEBLAEsAAD//gATQ3JlYXRlZCB3aXRoIEdJTVD/4gKwSUNDX1BST0ZJTEUAAQEAAAKgbGNtcwQwAABtbnRyUkdCIFhZWiAH6AALAA4ACwArAC5hY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA1kZXNjAAABIAAAAEBjcHJ0AAABYAAAADZ3dHB0AAABmAAAABRjaGFkAAABrAAAACxyWFlaAAAB2AAAABRiWFlaAAAB7AAAABRnWFlaAAACAAAAABRyVFJDAAACFAAAACBnVFJDAAACFAAAACBiVFJDAAACFAAAACBjaHJtAAACNAAAACRkbW5kAAACWAAAACRkbWRkAAACfAAAACRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACQAAAAcAEcASQBNAFAAIABiAHUAaQBsAHQALQBpAG4AIABzAFIARwBCbWx1YwAAAAAAAAABAAAADGVuVVMAAAAaAAAAHABQAHUAYgBsAGkAYwAgAEQAbwBtAGEAaQBuAABYWVogAAAAAAAA9tYAAQAAAADTLXNmMzIAAAAAAAEMQgAABd7///MlAAAHkwAA/ZD///uh///9ogAAA9wAAMBuWFlaIAAAAAAAAG+gAAA49QAAA5BYWVogAAAAAAAAJJ8AAA+EAAC2xFhZWiAAAAAAAABilwAAt4cAABjZcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltjaHJtAAAAAAADAAAAAKPXAABUfAAATM0AAJmaAAAmZwAAD1xtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAEcASQBNAFBtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEL/2wBDAP//////////////////////////////////////////////////////////////////////////////////////2wBDAf//////////////////////////////////////////////////////////////////////////////////////wgARCAAEAAQDAREAAhEBAxEB/8QAFAABAAAAAAAAAAAAAAAAAAAAAv/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAASf/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/9oACAEBAAEFAn//xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oACAEDAQE/AX//xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oACAECAQE/AX//xAAUEAEAAAAAAAAAAAAAAAAAAAAA/9oACAEBAAY/An//xAAUEAEAAAAAAAAAAAAAAAAAAAAA/9oACAEBAAE/IX//2gAMAwEAAgADAAAAEB//xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oACAEDAQE/EH//xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oACAECAQE/EH//xAAUEAEAAAAAAAAAAAAAAAAAAAAA/9oACAEBAAE/EH//2Q==\r\n```\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4266/comments",
    "author": "stefan-girlich",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-11-14T13:34:04Z",
        "body": "Please provide a complete code sample, without the 3rd party dependency, that allows someone else to reproduce. This will need to include things like a concrete definition of the `imageBase64DataUri` and `region` variables as well as some error handling."
      },
      {
        "user": "lovell",
        "created_at": "2025-01-06T11:28:04Z",
        "body": "@stefan-girlich Were you able to make any progress with this? If you still require help, please provide the requested information."
      },
      {
        "user": "stefan-girlich",
        "created_at": "2025-01-09T13:13:46Z",
        "body": "@lovell I am still not sure who to independent buffers could be related; the workaround for my case was switching around the order operations.\r\nI think setting up an environment for exact reproduction would require setting up an external nhost instance; feel free to close this issue. "
      },
      {
        "user": "lovell",
        "created_at": "2025-01-09T14:08:24Z",
        "body": "Thanks for the update, I'll close for now. Happy to re-open if you're still having problems and able to provide minimal, standalone code/image that allows someone else to reproduce."
      }
    ]
  },
  {
    "number": 4237,
    "title": "HEIC support for Windows",
    "created_at": "2024-10-15T11:44:42Z",
    "closed_at": "2024-10-15T13:09:12Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4237",
    "body": "Hello,\r\n\r\nI would like to get HEIC support for Windows. So far I have managed to get a custom libvips build working which is able to convert images from HEIC to JPEG without any issue. There is something however that confuses me regarding the installation guide and I don't understand how to progress from here.\r\n\r\nSo the installation guide says ``The use of a globally-installed libvips is unsupported on Windows and on macOS when running Node.js under Rosetta.``\r\n\r\nDoes this mean HEIC support for Windows is not possible? And if it would be, how would you be able to have a sharp instance that depends on libvips with HEIC support?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4237/comments",
    "author": "dvwgerritsen",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-10-15T12:18:09Z",
        "body": "Probably not impossible, but definitely unsupported. I wish you good luck but cannot help if you choose to do so."
      },
      {
        "user": "dvwgerritsen",
        "created_at": "2024-10-15T13:09:10Z",
        "body": "Alright will see how I go further, thanks a lot for your quick reply"
      }
    ]
  },
  {
    "number": 4230,
    "title": "Can't read an image, modify it, then save it with the same name",
    "created_at": "2024-10-03T23:55:23Z",
    "closed_at": "2024-10-04T18:41:15Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4230",
    "body": "## Edit\r\n\r\nI realize this is more of a feature request than it is an issue, since the code does give an error if the output file name is the same as the input file name. I will leave my original question below, but add in the related data for a feature request.\r\n\r\n## Feature request\r\n\r\n### What are you trying to achieve?\r\n\r\nCan have input file name the same as output file name.\r\n\r\n### When you searched for similar feature requests, what did you find that might be related?\r\n\r\nI could not find a similar feature request.\r\n\r\n### What would you expect the API to look like?\r\n\r\nThe call to write out data would appear the same as always, but now accept the input and output names to be the same.\r\n\r\n### What alternatives have you considered?\r\n\r\nAlternatively you could save the image under a temporary name, delete the original image, then save under the original name again. \r\n\r\n\r\n## Question about an existing feature\r\n\r\n### What are you trying to achieve?\r\n\r\nI would like to read an image, modify it, and then save it with the same name, effectively overwriting the original image file.\r\n\r\n### When you searched for similar issues, what did you find that might be related?\r\n\r\nI thought my issue may be similar to #3265, but disabling the cache doesn't change anything. For now I've been saving the image under a temporary name, deleting the original image, then saving under the original name again. \r\n\r\n### Please provide a minimal, standalone code sample, without other dependencies, that demonstrates this question\r\n\r\n```js\r\nconst sharp = require(\"sharp\");\r\n\r\nsharp.cache(false);\r\n\r\nsharp(\"image.jpg\")\r\n  .rotate(270)\r\n  .toFile(\"image.jpg\", (err, info) => { console.log(info) });\r\n```\r\n\"undefined\" is printed to the console and the original file is unmodified\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4230/comments",
    "author": "zelms",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-10-04T11:15:01Z",
        "body": "This is the expected behaviour as output and input are overlapped and the same file cannot be used for both. If you add some error handling to your sample code you should see a relevant message about this.\r\n\r\n```diff\r\n-  .toFile(\"image.jpg\", (err, info) => { console.log(info) });\r\n+  .toFile(\"image.jpg\", (err, info) => { console.log(err, info) });\r\n```"
      },
      {
        "user": "zelms",
        "created_at": "2024-10-04T18:41:15Z",
        "body": "Ok sounds good, thank you!"
      },
      {
        "user": "zelms",
        "created_at": "2024-10-04T19:03:42Z",
        "body": "For anyone else with a similar issue, here is my solution to it.\r\n\r\n```js\r\nconst sharp = require(\"sharp\");\r\nconst fs = require(\"fs\");\r\n\r\n//sharp.cache(false);\r\n\r\nconst filename = \"image.jpg\"\r\n\r\nasync function rotateImage(filename, cb) {\r\n  try {\r\n    sharp(filename)\r\n      .rotate(270)\r\n      .toFile(filename + \".tmp\", (err, info) => {\r\n        if(err) { cb(err, null); }\r\n\r\n        sharp(filename + \".tmp\")\r\n          .toFile(filename, (err, info) => {\r\n            if(err) { cb(err, null); }\r\n\r\n            fs.unlink(filename + \".tmp\", error => {\r\n              cb(error, info);\r\n            });\r\n          }); \r\n      });\r\n  } catch (error) {\r\n    cb(error, null);\r\n  }\r\n}\r\n\r\nrotateImage(filename, function(err, info) {\r\n  console.log(err);\r\n  console.log(info);\r\n});\r\n\r\n```"
      }
    ]
  },
  {
    "number": 4222,
    "title": "Color emojis are not being rendered",
    "created_at": "2024-09-25T19:39:34Z",
    "closed_at": "2024-11-06T10:04:14Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4222",
    "body": "I have used fonts like **Noto Color Emoji** but it the emojis don't seem to be rendered on my final image.\r\n\r\nLooked through old issues about this but couldn't find a fix. So curious if this has been fixed yet?\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4222/comments",
    "author": "rizwan1239",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-09-29T19:04:59Z",
        "body": "Did you see #2506?"
      },
      {
        "user": "lovell",
        "created_at": "2024-11-06T10:04:14Z",
        "body": "Let's track this at #2506"
      }
    ]
  },
  {
    "number": 4212,
    "title": "sharp not working in my AWS EC2",
    "created_at": "2024-09-06T10:58:00Z",
    "closed_at": "2024-10-29T09:15:08Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4212",
    "body": "this function working proper in my windows laptop but when I upload it to ec2 this below line is not working or giving any error\r\n\r\nticket\r\n.composite([ticketIdBuffer, customerNameBuffer, barcodeBuffer])\r\n.toFile(outputFilePath);\r\n\r\n// full function\r\nconst createTicket = async (user_id, name, orderid, event_id, barcodePath) => {\r\n// const eventId = event_id.replace(/[^a-zA-Z0-9]/g, \"\");\r\nconst customerName = name;\r\nconst orderId = orderid;\r\nconsole.log(\"customerName\", user_id, name, orderid, event_id, barcodePath);\r\n\r\nconst event = await Event.findOne({ event_id });\r\n\r\nconst passtemplate = event.pass_template;\r\nconst barcode = await Jimp.read(barcodePath);\r\nbarcode.resize(196 * 2, 236 * 2);\r\nconsole.log(\"passtemplate\", passtemplate);\r\nconsole.log(\"barcode\", barcode);\r\n\r\nconst nameTop = event.name_top;\r\nconst nameLeft = event.name_left;\r\nconst nameColor = event.name_color;\r\nconst nameSize = event.name_size;\r\nconst barcodeTop = event.barcode_top;\r\nconst barcodeLeft = event.barcode_left;\r\nconst ticketTop = event.ticket_top;\r\nconst ticketLeft = event.ticket_left;\r\nconst ticketColor = event.ticket_color;\r\nconst ticketSize = event.ticket_size;\r\n\r\nconst ticket = sharp(passtemplate);\r\n\r\nconst ticketIdSvg = await generateSvg1(\r\norderId,\r\nticketSize,\r\nticketColor,\r\n\"font/OpenSans-ExtraBold.ttf\"\r\n);\r\n\r\nconst customerNameSvg = await generateSvg1(\r\ncustomerName,\r\nnameSize,\r\nnameColor,\r\n\"font/OpenSans-ExtraBold.ttf\"\r\n);\r\n\r\nconst barcodeBuffer = {\r\ninput: Buffer.from(await barcode.getBufferAsync(Jimp.MIME_PNG)),\r\nleft: barcodeLeft,\r\ntop: barcodeTop,\r\n};\r\n\r\nconst ticketIdBuffer = {\r\ninput: Buffer.from(ticketIdSvg),\r\nleft: ticketLeft,\r\ntop: ticketTop,\r\n};\r\n\r\nconst customerNameBuffer = {\r\ninput: Buffer.from(customerNameSvg),\r\nleft: nameLeft,\r\ntop: nameTop,\r\n};\r\n\r\n// if pass already exists, delete it first before saving new one\r\nif (fs.existsSync(media/userpass/pass_${user_id}.png)) {\r\nfs.unlinkSync(media/userpass/pass_${user_id}.png);\r\n}\r\n\r\nconst outputFilePath = path.join(\"media/userpass\", pass_${user_id}.png);\r\nconsole.log(\"outputFilePath\", outputFilePath);\r\n\r\nconst pass = await ticket\r\n.composite([ticketIdBuffer, customerNameBuffer, barcodeBuffer])\r\n.toFile(outputFilePath);\r\n\r\nconsole.log(\"ticket generated\",pass);\r\nreturn pass_${user_id}.png;\r\n};",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4212/comments",
    "author": "Anjan-99",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-09-06T11:26:35Z",
        "body": "Please create a minimal, standalone repo with the simplest possible code and image(s), and without any other dependencies, that allows someone else to reproduce."
      },
      {
        "user": "Anjan-99",
        "created_at": "2024-09-06T11:32:11Z",
        "body": "means ? you want access ?"
      },
      {
        "user": "ghostlol",
        "created_at": "2024-09-13T05:58:44Z",
        "body": "Please clarify your question. Simply pasting code won't help anyone. If the code is working on your local machine, it should work on the EC2 instance as well. Ensure that the necessary libraries are properly installed on the EC2 machine."
      },
      {
        "user": "lovell",
        "created_at": "2024-09-23T19:52:41Z",
        "body": "@Anjan-99 Were you able to make any progress with this? If you still require help, please create a minimal, standalone repo with the simplest possible code and image(s), and without any other dependencies, that allows someone else to reproduce."
      },
      {
        "user": "lovell",
        "created_at": "2024-10-29T09:15:08Z",
        "body": "Closing due to inactivity but please feel free to reopen with the requested details if further help is required."
      }
    ]
  },
  {
    "number": 4202,
    "title": "How to maintain oiriginal image quality?",
    "created_at": "2024-09-02T02:00:19Z",
    "closed_at": "2024-09-02T08:19:29Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4202",
    "body": "I'm trying to watermark or resize the original image.\r\n\r\nand I want to save it in jpeg format and maintain the quality of the original image.\r\n\r\nWhen saving after work, the quality seems to be set to default 80.\r\n\r\nIf the quality of the original image is 90, is there a way to save or output the work result while maintaining this quality?\r\n\r\n```\r\nawait sharp('image.jpg')\r\n.composite([{input: watermark, gravity: 'centre'}])\r\n.jpeg({\r\n   quality: 100\r\n})\r\n```\r\n\r\nShould I set the quality to 100 as above to maintain the same quality as the original image? Or is there another way?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4202/comments",
    "author": "henryfra14",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-09-02T08:19:29Z",
        "body": "Please see #908"
      }
    ]
  },
  {
    "number": 4177,
    "title": "Handling HEIC files in an Electron application and distributing",
    "created_at": "2024-07-26T13:45:21Z",
    "closed_at": "2024-07-28T07:06:05Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4177",
    "body": "### What are you trying to achieve?\r\n\r\nAn corss-platform electron application handle HEIC/HEIF images.\r\n\r\n## Question:\r\nI am using Electron-forge to build an Electron application. I installed sharp directly in the project (I'm not sure if there is libvips on the machine), and it handles common image formats well. So, I packaged it and distributed it to Mac x64 and arm64 platforms as well as Windows platforms, and it runs well.\r\nNow, I want it to support HEIC/HEIF image formats, what should I do?\r\n\r\nAdditionally: The Mac version of my application is packaged and built on my local Mac arm64 machine, and my Windows version is packaged on Windows x64 Github Action.\r\n\r\nI checked the relevant documentation like build-from-source, but I'm not clear if the global installation of libraries like libvips on my local machine will be packaged into my Electron application for distribution when I build the application? Or, is it only available locally (because only I have globally installed libvips on my local machine, and my users haven’t installed it, so they cannot process HEIC/HEIF)?\r\n\r\nI looked into some issues like #4175 , and I encountered the same HEIC problem as they did, but it didn't resolve my doubt.\r\n\r\nThanks for the explanation!\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4177/comments",
    "author": "Xheldon",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-07-26T14:25:20Z",
        "body": "The quick answer is: this will be a world of pain, look for an alternative."
      },
      {
        "user": "Xheldon",
        "created_at": "2024-07-28T07:06:05Z",
        "body": "Thanks for reply!"
      }
    ]
  },
  {
    "number": 4127,
    "title": "Extend to a specified width and height in single operation without knowing the prior width or height",
    "created_at": "2024-06-07T11:24:29Z",
    "closed_at": "2024-07-02T08:16:12Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4127",
    "body": "It appears extend() only allows inputs of left, right, top and bottom, but it would be really convenient if there was a way to extend an image to a specified width or height without having to calculate the images width or height and using the differences in extend(), or using toBuffer on the image and creating a new image using composite(), both of which require async operations.\r\n\r\nIs this already a feature? If not it would be nice.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4127/comments",
    "author": "twilson90",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-06-07T14:53:04Z",
        "body": "If you only want to extend along one axis (\"letterbox\") then `.resize({ width, height, fit: 'inside' })` kind of does this.\r\n\r\nOtherwise, yes, you'll need to calculate this using the metadata. Although it is async, the `metadata()` call is usually very fast as it does not decode any pixel data."
      },
      {
        "user": "lovell",
        "created_at": "2024-07-02T08:16:12Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 4044,
    "title": "Not getting density value for tiff files ",
    "created_at": "2024-03-28T13:23:20Z",
    "closed_at": "2024-03-28T15:25:44Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4044",
    "body": "I am not able to see the density value from tiff file but it works fine with jpg and png files.\r\n  const image = sharp(fileResult.data);                          \r\n const metadata = await image.metadata();\r\n{\r\n  format: 'gif',\r\n  size: 24521,\r\n  width: 307,\r\n  height: 290,\r\n  space: 'srgb',\r\n  channels: 3,\r\n  depth: 'uchar',\r\n  isProgressive: false,\r\n  paletteBitDepth: 8,\r\n  pages: 1,\r\n  loop: 1,\r\n  delay: [ 100 ],\r\n  background: { r: 0, g: 0, b: 0 },\r\n  hasProfile: false,\r\n  hasAlpha: false\r\n}",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4044/comments",
    "author": "rajendraprasadyk",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-03-28T13:28:33Z",
        "body": ">  format: 'gif',\r\n\r\nThis looks like the metadata from a GIF image rather than a TIFF image."
      },
      {
        "user": "rajendraprasadyk",
        "created_at": "2024-03-28T15:25:28Z",
        "body": "sorry its my bad. please ignore this one, i have checked for tif file and its coming. Thank you"
      },
      {
        "user": "rajendraprasadyk",
        "created_at": "2024-03-28T15:26:49Z",
        "body": "Its working as expected "
      }
    ]
  },
  {
    "number": 4026,
    "title": "sharp is not compatible with the Node :- 17.9.1 NPM :-  8.11.0 ",
    "created_at": "2024-03-12T18:36:14Z",
    "closed_at": "2024-03-12T18:44:14Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/4026",
    "body": "## Feature request\r\ninstallation and compatibility\r\n### What are you trying to achieve?\r\nuser should install easily\r\n<!-- Please provide context here. -->\r\nsharp is not compatible with the Node :- 17.9.1 NPM :-  8.11.0  version that need to be fiexed\r\n### When you searched for similar feature requests, what did you find that might be related?\r\ncurrently consumed into it.\r\n<!-- Please demonstrate your research here. -->\r\nno sharp version is compatible with these versions Node :- 17.9.1 NPM :-  8.11.0 \r\n### What would you expect the API to look like?\r\napi should be same as previous but it should start working with node 17.9.1 and npm 8.11.0\r\n<!-- Please provide your suggestions here. -->\r\n\r\n### What alternatives have you considered?\r\n\r\n<!-- Please provide your ideas here. -->\r\n\r\n### Please provide sample image(s) that help explain this feature\r\n\r\n<!-- Please provide links to one or more images here. -->\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/4026/comments",
    "author": "ramanabhinav7",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-03-12T18:44:14Z",
        "body": "Node.js 17 reached end-of-life in 2022, please upgrade."
      },
      {
        "user": "ramanabhinav7",
        "created_at": "2024-03-13T10:33:38Z",
        "body": "Ok thanks for your reply."
      }
    ]
  },
  {
    "number": 3983,
    "title": "Is it possible to obtain the original image?",
    "created_at": "2024-02-06T20:16:00Z",
    "closed_at": "2024-02-13T16:56:41Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3983",
    "body": "I have an image (original.jpeg) processed by sharp using the following code:\r\n```javascript\r\n  const img = sharp(bufferStream);\r\n  const out = await img.toBuffer();\r\n  fs.writeFile('./out.jpeg', out, (err) => {});\r\n\r\n```\r\nthe output image is `out.jpeg`. when i run `md5sum` on both images it shows different hashes:\r\n```bash\r\n86e554644c690468c52dfdb4b20281b1  original.jpeg\r\n```\r\n\r\n```bash\r\n49cd573be5036b3c264dfc031e2bf180  out.jpeg\r\n```\r\n\r\nIs there a way to process `out.jpeg` and get the original image and produce the same hash as `original.jpeg` ?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3983/comments",
    "author": "ahmedid",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-02-07T17:19:39Z",
        "body": "JPEG is lossy, so any decode/encode roundtrip will always result in the output differing from the input."
      }
    ]
  },
  {
    "number": 3968,
    "title": "SVG embedding local files",
    "created_at": "2024-01-27T07:50:00Z",
    "closed_at": "2024-03-06T13:34:01Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3968",
    "body": "`<image xlink:href=\"d://xxx/xxx.png\"/>`\r\nCan we do this? Base64 is too big",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3968/comments",
    "author": "muyichuanqi",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2024-02-22T13:49:20Z",
        "body": "Yes, but only when loading an SVG image from the filesystem and only when the xlink path exists within the same or child directory as the SVG it is imported from."
      },
      {
        "user": "lovell",
        "created_at": "2024-03-06T13:34:01Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 3849,
    "title": "Something went wrong installing the \"sharp\" module (libhdf5)",
    "created_at": "2023-11-10T14:47:18Z",
    "closed_at": "2023-11-10T15:47:23Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3849",
    "body": "There seems to be issue when trying to run a project that has 'sharp' module, npm install was fine, but it is when I run my project this blows up:\r\n\r\n```\r\nError: \r\nSomething went wrong installing the \"sharp\" module\r\n\r\ndlopen(/Users/me/myproj/node_modules/sharp/build/Release/sharp-darwin-arm64v8.node, 0x0001): Library not loaded: /opt/homebrew/opt/hdf5/lib/libhdf5.200.dylib\r\n  Referenced from: <34EC9DD4-F027-30F1-ABD4-70161DA46595> /opt/homebrew/Cellar/libmatio/1.5.23/lib/libmatio.11.dylib\r\n  Reason: tried: '/opt/homebrew/opt/hdf5/lib/libhdf5.200.dylib' (no such file), '/System/Volumes/Preboot/Cryptexes/OS/opt/homebrew/opt/hdf5/lib/libhdf5.200.dylib' (no such file), '/opt/homebrew/opt/hdf5/lib/libhdf5.200.dylib' (no such file), '/usr/local/lib/libhdf5.200.dylib' (no such file), '/usr/lib/libhdf5.200.dylib' (no such file, not in dyld cache), '/opt/homebrew/Cellar/hdf5/1.14.2/lib/libhdf5.200.dylib' (no such file), '/System/Volumes/Preboot/Cryptexes/OS/opt/homebrew/Cellar/hdf5/1.14.2/lib/libhdf5.200.dylib' (no such file), '/opt/homebrew/Cellar/hdf5/1.14.2/lib/libhdf5.200.dylib' (no such file), '/usr/local/lib/libhdf5.200.dylib' (no such file), '/usr/lib/libhdf5.200.dylib' (no such file, not in dyld cache)\r\n  ```\r\n  \r\n  It is complaining about not finding libhdf5.200, I've checked the folder, and I can see I have the following one (newer one?!):\r\n  \r\n  ```\r\nlibhdf5.310.dylib\r\n  ```\r\n\r\n\r\nI am running M1 macbook, node v18.18.0, npmjs 10.1.0,\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3849/comments",
    "author": "chr4ss12",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-11-10T15:13:34Z",
        "body": "This looks like a local Homebrew misconfiguration, please try running `brew update && brew upgrade`"
      },
      {
        "user": "chr4ss12",
        "created_at": "2023-11-10T15:47:23Z",
        "body": "fixed thank you"
      },
      {
        "user": "yiyuan-liaoqiang",
        "created_at": "2023-11-13T03:12:20Z",
        "body": "> This looks like a local Homebrew misconfiguration, please try running `brew update && brew upgrade`\r\n\r\n666"
      }
    ]
  },
  {
    "number": 3836,
    "title": "Poor performance in production",
    "created_at": "2023-10-30T09:13:32Z",
    "closed_at": "2023-12-05T10:47:31Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3836",
    "body": "I am using sharp to merge images mainly doing ```.composite``` calls, ```.toBuffer()``` and ```.png()``` also creating empty images. Locally I am getting 50-60ms on my main image generation function, however in production I am getting 500-600ms, how I can debug that problem? Locally it's one core of i5, production has one core of Xeon Sliver, I assume that it can be some performance difference, but 10x is a bit strange. Production has installed libpng, libsvg, libvips and so on",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3836/comments",
    "author": "mrAndersen",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-10-30T18:41:20Z",
        "body": "For help with any performance-related problem, you'll need to provide minimal code and image(s) that allows someone else to reproduce, ideally as a standalone repo."
      },
      {
        "user": "lovell",
        "created_at": "2023-11-22T12:28:03Z",
        "body": "@mrAndersen Were you able to make any progress with this? If you still require help, please provide the requested information."
      },
      {
        "user": "lovell",
        "created_at": "2023-12-05T10:47:31Z",
        "body": "Closing due to inactivity but please feel free to reopen with the requested information if further help is required."
      }
    ]
  },
  {
    "number": 3803,
    "title": "Error: VipsImage: memory area too small --- should be N bytes, you passed M",
    "created_at": "2023-09-20T12:05:15Z",
    "closed_at": "2023-11-16T11:34:38Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3803",
    "body": "## Feature request\r\n\r\n### What are you trying to achieve?\r\n\r\n<!-- I'm trying to write code for image processing. -->\r\n\r\n### What alternatives have you considered?\r\n\r\n<!-- I tried to optimize the code, but it did not help to solve the problem with memory allocation in any way. -->\r\n\r\nI think i got error here, i think problem in return, i tried to use `clone()` but error still there -\r\n`async function cropImage(imageFile, maxWidth, maxHeight) {\r\n\tconst image = imageFile instanceof sharp ? imageFile : sharp(imageFile);\r\n\tconst metadata = await image.metadata();\r\n\tlet top;\r\n\tlet left;\r\n\tlet width;\r\n\tlet height;\r\n\r\n\tif (metadata.height > maxHeight) {\r\n\t\ttop = (metadata.height - maxHeight) / 2;\r\n\t\theight = maxHeight;\r\n\t}\r\n\r\n\tif (metadata.width > maxWidth) {\r\n\t\tleft = (metadata.width - maxWidth) / 2;\r\n\t\twidth = maxWidth;\r\n\t}\r\n\r\n\treturn await image.extract({ left, top, width, height });\r\n}`\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3803/comments",
    "author": "no1hink",
    "comments": [
      {
        "user": "no1hink",
        "created_at": "2023-09-20T12:06:17Z",
        "body": "```\r\n`async function cropImage(imageFile, maxWidth, maxHeight) {\r\n\tconst image = imageFile instanceof sharp ? imageFile : sharp(imageFile);\r\n\tconst metadata = await image.metadata();\r\n\tlet top;\r\n\tlet left;\r\n\tlet width;\r\n\tlet height;\r\n\r\n\tif (metadata.height > maxHeight) {\r\n\t\ttop = (metadata.height - maxHeight) / 2;\r\n\t\theight = maxHeight;\r\n\t}\r\n\r\n\tif (metadata.width > maxWidth) {\r\n\t\tleft = (metadata.width - maxWidth) / 2;\r\n\t\twidth = maxWidth;\r\n\t}\r\n\r\n\treturn await image.extract({ left, top, width, height });\r\n}`\r\n```\r\nHere is the code in the correct form"
      },
      {
        "user": "lovell",
        "created_at": "2023-09-20T12:16:54Z",
        "body": "Please can you provide complete code and sample image that allows someone else to reproduce."
      },
      {
        "user": "lovell",
        "created_at": "2023-09-20T12:46:56Z",
        "body": "There's a lot of code here. Please can you make a complete, minimal repo with simple code and an image that allows someone else to reproduce."
      },
      {
        "user": "lovell",
        "created_at": "2023-09-20T12:53:58Z",
        "body": "> const recolored = sharp(buffer, { raw: { width, height, channels: 3 } });\r\n\r\nThis is probably the line you want to focus on. Does `buffer` contain uncompressed pixel data? Is it `width * height * channels` bytes in length?"
      },
      {
        "user": "no1hink",
        "created_at": "2023-09-20T13:13:39Z",
        "body": "> > const recolored = sharp(buffer, { raw: { width, height, channels: 3 } });\r\n> \r\n> This is probably the line you want to focus on. Does `buffer` contain uncompressed pixel data? Is it `width * height * channels` bytes in length?\r\n\r\nLink on my repo, main file is imageplacer.js, all code there, so far I have not done the division into modules. It contains pictures in pictures folder."
      },
      {
        "user": "no1hink",
        "created_at": "2023-09-20T15:14:54Z",
        "body": "> > const recolored = sharp(buffer, { raw: { width, height, channels: 3 } });\r\n> \r\n> This is probably the line you want to focus on. Does `buffer` contain uncompressed pixel data? Is it `width * height * channels` bytes in length?\r\n\r\nI think error in this code - return not working, maybe i need to give more memory?\r\nIt log ```console.log(\"Background recolored Sucessfully\");``` but couldnt return anything.\r\n\r\n```\r\nasync function recolorBackground(backgroundBuffer) {\r\n\r\n\tconst backgroundFile = sharp(backgroundBuffer);\r\n\tconst { width, height, channels} = await backgroundFile.metadata();\r\n\ttry {\r\n\t\t// Convert the background image to a buffer\r\n\t\t\r\n\t\tconst buffer = await backgroundFile.toBuffer();\r\n\r\n\t\t// Modify pixel colors (if needed)\r\n\t\tfor (let i = 0; i < buffer.length; i += 3) {\r\n\t\t\tbuffer[i + 2] = 255 - buffer[i + 2]; // Invert blue channel\r\n\t\t}\r\n\t\t\r\n\t\tconst newObj = sharp(buffer, { raw: { width, height, channels: channels } });\r\n\t\t\r\n\t\tconsole.log(\"Background recolored Sucessfully\");\r\n\t\treturn newObj;\r\n\t} catch (error) {\r\n\t\tconsole.error('Error recoloring the image:', error);\r\n\t\tthrow error; // Rethrow the error for handling at a higher level\r\n\t}\r\n}\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2023-09-20T15:29:08Z",
        "body": "```diff\r\n- const buffer = await backgroundFile.toBuffer();\r\n+ const buffer = await backgroundFile.raw().toBuffer();\r\n```"
      },
      {
        "user": "no1hink",
        "created_at": "2023-09-20T15:38:22Z",
        "body": "> ```diff\r\n> - const buffer = await backgroundFile.toBuffer();\r\n> + const buffer = await backgroundFile.raw().toBuffer();\r\n> ```\r\n\r\nThanks its work, but now error in this func -` [Error: Input buffer contains unsupported image format]`\r\nI think got tha same error in creating a variable for output.\r\nI cant understand how extract func works and how to properly pass a sharp object for cropping.\r\n\r\n\r\n```async function cropImage(imageFile, maxWidth, maxHeight) {\r\n\tconst image = sharp(imageFile);\r\n\r\n\tconst { metadata, format } = await image.metadata();\r\n\r\n\tlet top;\r\n\tlet left;\r\n\tlet width;\r\n\tlet height;\r\n\r\n\tif (metadata.height > maxHeight) {\r\n\t\ttop = (metadata.height - maxHeight) / 2;\r\n\t\theight = maxHeight;\r\n\t}\r\n\r\n\tif (metadata.width > maxWidth) {\r\n\t\tleft = (metadata.width - maxWidth) / 2;\r\n\t\twidth = maxWidth;\r\n\t}\r\n\r\n\timage.extract({ left, top, width, height });\r\n\r\n\t// Check the format of the cropped image\r\n\tconst croppedImage = sharp(image);\r\n\tconst { format: croppedFormat } = await croppedImage.metadata();\r\n\tconsole.log('Output Image Format:', croppedFormat);\r\n\r\n\treturn croppedImage.toBuffer();\r\n}```"
      },
      {
        "user": "lovell",
        "created_at": "2023-09-20T15:43:14Z",
        "body": "```diff\r\n- const croppedImage = sharp(image);\r\n+ const croppedImage = sharp(await image.toBuffer());\r\n```"
      },
      {
        "user": "no1hink",
        "created_at": "2023-09-20T15:49:53Z",
        "body": "Is this function correct - `image.extract({ left: left, top: top, width: width, height: height });` or i need to write it to a variable\r\nCause still got error - `[Error: Input buffer contains unsupported image format]`"
      },
      {
        "user": "no1hink",
        "created_at": "2023-09-20T16:02:20Z",
        "body": "Also i tried to understand problem like this: \r\nThis is **backgroundImage** buffer\r\n`<Buffer 49 49 2a 00 c8 f1 04 00...324482 more bytes>`\r\nAnd after recoloring:\r\n`<Buffer 1d 17 e8 1d 17 e8 1d 17...6217510 more bytes>`\r\nNow it looks like a raw buffer, I mean relative to the previous value, respectively, when Image and Background go to the next **croppedImage** function, their data is different,because the Image buffer has remained unchanged"
      },
      {
        "user": "lovell",
        "created_at": "2023-11-05T10:07:21Z",
        "body": "@no1hink Were you able to make any progress with this?"
      },
      {
        "user": "lovell",
        "created_at": "2023-11-16T11:34:38Z",
        "body": "Closing due to inactivity but please feel free to reopen with more details if further help is required."
      }
    ]
  },
  {
    "number": 3800,
    "title": "My electron app not getting start after installation because of this package.  ",
    "created_at": "2023-09-18T08:10:02Z",
    "closed_at": "2023-11-16T11:34:06Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3800",
    "body": "# Issue\r\n## I'm creating a desktop app with electronjs framework. Using \"24.3.0\" version of electron and my Node version is \"18.0.0\". sharp package version is \"0.32.5\".\r\nI've to apply image blur effect and so I've choose sharp package. I'm using below methods of sharp.\r\n\r\nconst imageBuffer = Buffer.from(base64Data, 'base64');\r\n                sharp(imageBuffer, { format: 'jpeg' })\r\n                  .blur(imgBlurRate)\r\n                  .toBuffer((err, buffer) => {\r\n                    if (err) {\r\n                      console.log('err in blurring the image :: ', err);\r\n                    } else {\r\n                      let blurredBase64 = buffer.toString('base64');\r\n                      blurredBase64 = 'data:image/png;base64,' + blurredBase64;\r\n                      const blurredImg = blurredBase64;\r\n                    }\r\n                  });\r\n                  \r\n### The problem is that whenever I create a build with installing the sharp package and with include above code I didn't get any error and my build is getting created successfully with electron-builder package. I'm creating installable file so it is successfully getting creating without any error. But after Install the build whenever I try to run my app then it is not getting started. even the popup is not coming. Like whenever I click on the app nothing is happening there. Feels like clicking on any empty screen or that kind of thing. But If I try to create a build and run it without the sharp code included then it is working fine.                  ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3800/comments",
    "author": "LogicRaysTechnology",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-09-18T08:26:50Z",
        "body": "Please can you create a standalone repo with minimal dependencies and code that allows someone else to reproduce."
      },
      {
        "user": "lovell",
        "created_at": "2023-11-04T15:37:50Z",
        "body": "@LogicRaysTechnology Were you able to make any progress with this? If you still require help, please provide the requested information that allows someone else to reproduce."
      },
      {
        "user": "lovell",
        "created_at": "2023-11-16T11:34:06Z",
        "body": "Closing due to inactivity but please feel free to reopen with the requested details if further help is required."
      }
    ]
  },
  {
    "number": 3790,
    "title": "Recommended image type for source image to be thumbnailed.",
    "created_at": "2023-09-06T11:55:05Z",
    "closed_at": "2023-09-18T17:32:03Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3790",
    "body": "Hello,\r\n\r\nVery basic use case. User uploads image. I want to store a full size copy and then serve thumbnailed versions.\r\n\r\nThe thumbnails will be jpg or webp.\r\n\r\nFrom a performance point of view is there a best format to use for the master image? jpg / webp / something else?\r\n\r\nAlso, is there any point storing the master image at a higher quality setting than the images that will be served? So, as an example, if I serve images at q:80, is there any benefit to using q:90 or even 100 for the master source image? Or is that just a waste of disk space?\r\n\r\nThanks in advance for any advice.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3790/comments",
    "author": "goldmerc",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-09-06T12:21:24Z",
        "body": "Assuming these are lossy, photographic-like images, I'd probably go for JPEG input of a \"quality\" at least as high as the highest you'll need for an output, maybe avoid the use of chroma subsampling too. (If the input is already JPEG don't re-process to change the quality as this will introduce another round of loss.)"
      },
      {
        "user": "goldmerc",
        "created_at": "2023-09-06T12:35:01Z",
        "body": "Thanks @lovell. Yes, this would be photographic images. The user would be uploading a JPEG. Which would be run through sharp and saved. That would be the source image for future thumbnails. Just so I'm clear - you suggest not to use chroma subsampling when the source image is first saved or when the thumbnails are generated, or both? I was also planning to use the mozjpeg option. Is it best to avoid that on the source image too? Or can I use it for the source and thumbs? Thanks for the advice :-)"
      },
      {
        "user": "lovell",
        "created_at": "2023-09-06T12:43:14Z",
        "body": "You'll probably need to experiment as it all depends on the source images."
      },
      {
        "user": "goldmerc",
        "created_at": "2023-09-06T12:45:04Z",
        "body": "Fair enough - thanks for your help."
      },
      {
        "user": "goldmerc",
        "created_at": "2023-09-06T17:32:15Z",
        "body": "Did some experiments and found the results quite surprising (not that I know anything about this stuff!). With the images I'm working with, it seems to make very little difference to the thumbnails if the source image has mozjpeg optimisations + chroma subsampling or not. The resulting thumbnail is either exactly the same size or extremely close and I can't see any difference in the image quality. Checking the speed with simple console.time, it also looks like it's either faster or almost as fast to create a thumbnail from a source jpeg with mozjpeg optimisations. So, for my case, looks like mozjpeg + chroma subsampling is best for source images and thumbnails. Thanks for advising to test it."
      },
      {
        "user": "lovell",
        "created_at": "2023-09-18T17:32:03Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 3776,
    "title": "Compositing another sharp instance",
    "created_at": "2023-08-24T01:30:02Z",
    "closed_at": "2023-10-04T06:26:06Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3776",
    "body": "## Feature request\r\n\r\n### What are you trying to achieve?\r\n\r\nUsing a sharp instance as an input for a `composite()` operation.\r\n\r\n(In my case I need this because the text rendered by the constructor is white-on-black while I need black-on-white, but even if there was an option to change the text color, this is a useful feature on its own.)\r\n\r\n### When you searched for similar feature requests, what did you find that might be related?\r\n\r\nSearches for \"composite sharp object\" and the like didn't turn up anything similar.\r\n\r\n### What would you expect the API to look like?\r\n\r\n```javascript\r\nlet image = sharp({\r\n  create: {\r\n    width: 200,\r\n    height: 100,\r\n    channels: 4,\r\n    background: { r: 255, g: 255, b: 255, alpha: 1 }\r\n  }\r\n});\r\n\r\nlet text = sharp({\r\n  text: {\r\n    text: 'Test',\r\n    width: 200,\r\n    height: 100\r\n  }\r\n})\r\n.negate();\r\n\r\nimage = image.composite([{\r\n  input: text                                          // <---\r\n}]);\r\n\r\nimage\r\n.jpeg({\r\n  quality: 100,\r\n  chromaSubsampling: '4:4:4'\r\n})\r\n.toFile('image.jpg');\r\n```\r\n\r\n### What alternatives have you considered?\r\n\r\nCurrently a temporary buffer is necessary:\r\n```javascript\r\nlet image = sharp({\r\n  create: {\r\n    width: 200,\r\n    height: 100,\r\n    channels: 4,\r\n    background: { r: 255, g: 255, b: 255, alpha: 1 }\r\n  }\r\n});\r\n\r\nlet text = sharp({\r\n  text: {\r\n    text: 'Test',\r\n    width: 200,\r\n    height: 100\r\n  }\r\n})\r\n.negate();\r\n\r\nlet temp = await text.png().toBuffer();                // <---\r\n\r\nimage = image.composite([{\r\n  input: temp                                          // <---\r\n}]);\r\n\r\nimage\r\n.jpeg({\r\n  quality: 100,\r\n  chromaSubsampling: '4:4:4'\r\n})\r\n.toFile('image.jpg');\r\n```\r\n\r\nFrom reading other issues I can see that the temporary buffer actually seems like a common approach to \"materialize\" an image and then continue a different pipeline.\r\n\r\nIf this is the correct approach, maybe a special \"format\" could be added that contains width, height, channel depth and raw image data so that at least the PNG encoding would become unnecessary? I remember PNG encoding to be quite expensive performance-wise. Maybe TIFF is cheaper? Can it encode any channel depths that sharp supports?\r\n\r\nOr, even better, this sharp->temp->sharp conversion could be wrapped into a function similar to `clone()`, like `materialize()`. This would also help with things like my issue #3775 which could then be written as `sharp().composite().materialize().resize()`.\r\n\r\n### Please provide sample image(s) that help explain this feature\r\n\r\nn/a",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3776/comments",
    "author": "AndreKR",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-08-24T07:26:57Z",
        "body": "> so that at least the PNG encoding would become unnecessary?\r\n\r\nUse `.png({ compressionLevel: 0 })` for a fast but more memory intensive intermediate image."
      },
      {
        "user": "AndreKR",
        "created_at": "2023-08-27T19:32:17Z",
        "body": "Alright, I'm now ejecting every intermediate step as a PNG with `compressionLevel: 0` and everything works great. Doesn't even seem to be particularly slow, sharp seems to be really fast in general."
      },
      {
        "user": "kmxz",
        "created_at": "2024-11-09T11:27:36Z",
        "body": "I still find adding such an API can be very helpful. `composite` not accepting another Sharp instance is slightly counterintuitive.\r\n\r\nAlso, to avoid PNG encoding, I'm using a raw buffer as the intermediate step. Could be faster in some cases.\r\n```\r\nconst { data: input, info: raw } = await sharpInstance1.raw().toBuffer({ resolveWithObject: true }); \r\nsharpInstance2.composite([{ input, raw }]);\r\n```"
      },
      {
        "user": "AndreKR",
        "created_at": "2024-11-11T05:38:07Z",
        "body": "@kmxz I was planning to build an image manipulation library with a step-by-step API on top of sharp. Using the buffer is a good idea, I will make sure to do that."
      }
    ]
  },
  {
    "number": 3732,
    "title": "URL IMAGE",
    "created_at": "2023-07-20T14:11:37Z",
    "closed_at": "2023-07-20T20:07:37Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3732",
    "body": "Is there anyway to use a URL image in place of an image file?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3732/comments",
    "author": "flameface",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-07-20T20:07:37Z",
        "body": "Please see #1901"
      }
    ]
  },
  {
    "number": 3729,
    "title": "How to resize images when composite",
    "created_at": "2023-07-19T04:51:07Z",
    "closed_at": "2023-07-22T12:18:25Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3729",
    "body": "I am trying to merge images using 'sharp'.\r\nThere are 6 images, size is 1536x1536px.\r\n\r\nThe size of the combined image will be 1536x9216.\r\nI would like to know how to write a merged image to be reduced to 256x1536.\r\n\r\nindex.ts\r\n```typescript\r\nimport sharp from \"sharp\";\r\n\r\nasync function main() {\r\n\r\n  const imagePaths = [\"images/1.jpeg\", \"images/2.jpeg\", \"images/3.jpeg\",\"images/4.jpeg\", \"images/5.jpeg\", \"images/6.jpeg\"];\r\n  const outputImgWidth = 1536;\r\n  const outputImgHeight = 9216;\r\n \r\n    let totalHeight = 0;\r\n    const compositeParams = imagePaths.map(image => {\r\n      const top = totalHeight;\r\n      totalHeight += outputImgWidth;\r\n      \r\n      return {\r\n        input: image,\r\n        gravity: \"northwest\",\r\n        left: 0,\r\n        top: top\r\n      };\r\n    });\r\n  \r\n    await sharp({\r\n      create: {\r\n        width: outputImgWidth,\r\n        height: outputImgHeight,\r\n        channels: 4,\r\n        background: { r: 255, g: 255, b: 255, alpha: 0 }\r\n      }\r\n    })\r\n      .composite(compositeParams);\r\n      .toFile(`preview.jpg`,(err, info)=>{\r\n          if(err){ throw err }\r\n          console.log(info)\r\n        });\r\n}\r\n\r\nmain().then();\r\n``` \r\n\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3729/comments",
    "author": "HarunoOi",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-07-19T09:15:39Z",
        "body": "Hi, in this example, because all the dimensions are known up-front, I'd suggest images are resized before composition:\r\n```diff\r\n-        input: image,\r\n+        input: await image.resize({ width: 256, height: 256 }).toBuffer(),\r\n```\r\n"
      },
      {
        "user": "HarunoOi",
        "created_at": "2023-07-21T05:01:32Z",
        "body": "I changed it to this writing style.\r\n`input: await sharp(image).resize(256).toBuffer(),`\r\n\r\nThen an error occurred in the following section.\r\n`.composite(compositeParams)`\r\n\r\nerror\r\n```\r\nArgument of type 'Promise<{ input: Buffer; left: number; top: number; }>[]'  is not assignable to parameter of type 'OverlayOptions[]' \r\nProperty  'Promise<{ input: Buffer; left: number; top: number; }>'  is missing in type 'OverlayOptions' \r\n```\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2023-07-21T10:59:48Z",
        "body": "If your map function is `async` then you'll probably need to `await` it approximately here:\r\n```diff\r\n-     const compositeParams = imagePaths.map(async image => {\r\n+     const compositeParams = await Promise.all(imagePaths.map(async image => {\r\n```"
      },
      {
        "user": "HarunoOi",
        "created_at": "2023-07-22T12:16:27Z",
        "body": "We were able to achieve this!\r\n\r\nApart from the module, it took me a long time due to my lack of coding knowledge.\r\nThanks for telling me about it."
      }
    ]
  },
  {
    "number": 3716,
    "title": "How to compress an image file?",
    "created_at": "2023-06-30T09:42:06Z",
    "closed_at": "2023-07-05T21:46:30Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3716",
    "body": "I want to compress an Image file to reduce its size, keeping the aspect ratio and all same as before. How to do this?\r\n\r\nhere is the code where I am renaming the file that is to be uploaded:\r\n\r\n```\r\nconst uploadMiddleware = multer({\r\n  storage: multers3({\r\n    s3: s3,\r\n    bucket: myBucket,\r\n    acl: \"public-read\",\r\n    contentType: multers3.AUTO_CONTENT_TYPE,\r\n    key: function (req, file, cb) {\r\n      cb(null, Date.now().toString());\r\n    },\r\n  }),\r\n});\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3716/comments",
    "author": "shm-dsgn",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-06-30T12:24:47Z",
        "body": "This is a rather general question that requires more detail for anyone to help you. Perhaps share some code that you've tried, what worked, what didn't work, which formats you're using, some sample images that did or did not behave in the way you were expecting.\r\n\r\nYou might have more luck asking on a general programming site such as StackOverflow, although people will ask for more detail there too."
      }
    ]
  },
  {
    "number": 3696,
    "title": "Is it possible to access trim offsets for all sides and not just top and left?",
    "created_at": "2023-06-12T18:44:45Z",
    "closed_at": "2023-06-12T19:20:04Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3696",
    "body": "## Question about an existing feature\r\n\r\n### What are you trying to achieve?\r\n\r\nFor my specific use case I need to have access to the size that was trimmed from all sides and not just top and left (trimOffsetTop, trimOffsetLeft) returned by the trim method.\r\n\r\nThe main reason is that I need to save the original position that the actual content had within the transparent background in its original canvas, so that I'm able to \"recreate\" the image if needed for example, by repositioning the content in a different canvas later.\r\n\r\nIn my cases there is no guarantee the top/bottom transparent space are equal, and the same applies to left/right as well.\r\n\r\nIs it possible to achieve this with sharp right now? I could not find any related issues or discussions and I'm yet to read through the source code.\r\n\r\nSomething tells me I should be able to achieve this without sharp, before trimming, but I didn't want to come up with a solution that acts different than the `trim` and end up with inconsistent saved data vs output.\r\n\r\nThanks!\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3696/comments",
    "author": "gugiserman",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-06-12T18:57:18Z",
        "body": "You can calculate this using the input and output dimensions.\r\n```\r\nright offset = input width - output width - left offset\r\nbottom offset = input height - output height - top offset\r\n```"
      },
      {
        "user": "gugiserman",
        "created_at": "2023-06-12T19:20:03Z",
        "body": "> You can calculate this using the input and output dimensions.\r\n> \r\n> ```\r\n> right offset = input width - output width - left offset\r\n> bottom offset = input height - output height - top offset\r\n> ```\r\n\r\nI'm dumb!\r\nThanks!"
      }
    ]
  },
  {
    "number": 3684,
    "title": "about contrast",
    "created_at": "2023-05-25T13:02:27Z",
    "closed_at": "2023-05-31T14:23:27Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3684",
    "body": "Sharp did not find a `contrast(n, cb)` method similar to Jimp\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3684/comments",
    "author": "yonbin",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-05-25T13:55:20Z",
        "body": "Please see #3487"
      },
      {
        "user": "yonbin",
        "created_at": "2023-05-31T05:30:38Z",
        "body": "Thanks"
      }
    ]
  },
  {
    "number": 3580,
    "title": "build configure",
    "created_at": "2023-03-02T12:48:36Z",
    "closed_at": "2023-03-31T17:31:54Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3580",
    "body": "I found some problems about vips. I want to rebuild sharp.js. How to build sharp.js on mac\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3580/comments",
    "author": "doudouodong",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-03-02T12:58:49Z",
        "body": "Please provide **significantly** more information about the problem(s) you found, what you've tried so far, what documentation you followed, what versions are involved etc."
      },
      {
        "user": "lovell",
        "created_at": "2023-03-31T17:31:54Z",
        "body": "Closing due to lack of information but please feel free to reopen with more details if further help is required."
      }
    ]
  },
  {
    "number": 3559,
    "title": "can remove the specified background color?",
    "created_at": "2023-02-13T06:20:58Z",
    "closed_at": "2023-02-13T08:02:14Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3559",
    "body": "Hi,can remove the specified background color replace by transparent? ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3559/comments",
    "author": "shawon1220",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-02-13T08:02:14Z",
        "body": "Please see #1648"
      }
    ]
  },
  {
    "number": 3552,
    "title": "How can I tell libvips, via the sharp API, what filename I want it to use in the tmp directory for any given file?  ",
    "created_at": "2023-02-08T14:45:29Z",
    "closed_at": "2023-02-28T09:35:06Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3552",
    "body": "I have a use case where I need to be able to have libvips store things in `/tmp` in a deterministic filename per image.  Is there a way via the sharp API that I can do this?  I know that libvips in theory supports this, but we're using sharp rather than directly using libvips.  \r\n\r\nThe reason for this is because when we get the `no space left on device` error, files seem to get orphaned in `/tmp`.  But I can't just clear `/tmp` because other processes might be using it.  But if I could name the files deterministically then I'd know specifically which things I can safely clear.  \r\n\r\nThis is in an AWS edge lambda where I only have 512 MB of tmp storage, but other instances of the lambda might also be using tmp.  That's why I cannot just delete everything in tmp.  ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3552/comments",
    "author": "rfornea",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-02-08T19:32:39Z",
        "body": ">  I know that libvips in theory supports this,\r\n\r\nAre you referring to the `TMPDIR` and/or `VIPS_DISC_THRESHOLD` environment variables? They should \"just work\", the same as they already do when running `vips` at the command line."
      },
      {
        "user": "lovell",
        "created_at": "2023-02-28T09:35:06Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 3533,
    "title": "Error: Processed image is too large for the JPEG format",
    "created_at": "2023-01-17T12:18:48Z",
    "closed_at": "2023-01-17T12:21:58Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3533",
    "body": "      let sharp_baseOpt = {\r\n        width: 1920,\r\n        height: 86041,\r\n        channels: 4,\r\n        background: {\r\n          r: 255,\r\n          g: 255,\r\n          b: 255,\r\n          alpha: 1,\r\n        },\r\n      };\r\nawait sharp({ create: baseOpt }).jpeg().toFile(filepath_test);\r\n\r\nthen error like \r\nError: Processed image is too large for the JPEG format\r\n\r\nbut await sharp({ create: baseOpt }).png().toFile(filepath_test);\r\n\r\nthe result is ok ,why?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3533/comments",
    "author": "82318179",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-01-17T12:21:58Z",
        "body": "#3362"
      }
    ]
  },
  {
    "number": 3530,
    "title": "How to compress the specified size",
    "created_at": "2023-01-16T09:05:33Z",
    "closed_at": "2023-02-28T09:34:06Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3530",
    "body": "\r\nFor example, I have a picture of 2m, and I want to compress it to 155kb, but I cannot compress it to the specified value accurately by modifying the quality.\r\n\r\nI am constantly modifying the value of the quality through  binary search method, and compressing multiple times to obtain a value approximately to the specified size.\r\n\r\nmy code\r\n```node\r\nasync function getQualityBySize(data) {\r\n    var maxQuality = 100;\r\n    var minQuality = 1;\r\n    var compressFinish = false;\r\n    var times = 1;\r\n    var size = data.size;\r\n    var quality = data.quality;\r\n    var granularity = Math.floor(size) * 0.1 \r\n    const total = 8;\r\n\r\n    while (!compressFinish && times <= total)  {\r\n        \r\n        const buf = await compress(data);\r\n        let imgSize = Math.ceil(buf.size / 1024);\r\n\r\n        if (size === imgSize) {\r\n            compressFinish = true;\r\n            return;\r\n        }\r\n\r\n        \r\n        if (imgSize > size) {\r\n            maxQuality = quality;\r\n        }\r\n\r\n        if (imgSize < size) {\r\n            if (size - imgSize <= granularity) {\r\n                compressFinish = true;\r\n                return;\r\n            }\r\n            minQuality = quality;\r\n        }\r\n\r\n        quality = Math.ceil((maxQuality + minQuality) / 2);\r\n        console.log(\"quality:\", quality);\r\n\r\n        if (maxQuality - minQuality < 2) {\r\n            compressFinish = true;\r\n            return;\r\n        }\r\n\r\n        times++;\r\n    }\r\n    return new Error(\"can't compress to the specified size \");\r\n}\r\n\r\n// compress\r\nasync function compress(data) {\r\n    const img = sharp(data.localFileSourcePath);\r\n    const meta = await img.metadata();\r\n     \r\n     const buf = await (['gif', 'raw', 'tile'].includes(meta.format) \r\n     ? img.resize(data.width, data.height, {fit: 'inside'}).toFile(data.localFileDestPath).catch(err=>{return err;}) \r\n     : img.resize(data.width, data.height, {fit: 'inside'})[meta.format]({quality: data.quality}).toFile(data.localFileDestPath)).catch(err=>{return err;});\r\n     console.log(\"buf:\", buf);\r\n     return buf;\r\n}\r\n```\r\n\r\n\r\nIs there any problem with this code?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3530/comments",
    "author": "charliecen",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2023-01-16T09:18:52Z",
        "body": "I don't see where this code is modifying `data.quality`. Did you intend the following?\r\n\r\n```diff\r\n-         quality = Math.ceil((maxQuality + minQuality) / 2);\r\n+         data.quality = Math.ceil((maxQuality + minQuality) / 2);\r\n```\r\n\r\nThis is probably more of a general programming question for a site such as StackOverflow."
      },
      {
        "user": "charliecen",
        "created_at": "2023-01-16T09:34:27Z",
        "body": "@lovell  Thanks for your reply, modified data.quality.\r\nprint log:\r\n```\r\nThe specified compressed size is: 120 kb\r\ncompressed result {\r\n  format: 'jpeg',\r\n  width: 950,\r\n  height: 712,\r\n  channels: 3,\r\n  premultiplied: false,\r\n  size: 62686\r\n}\r\nThe size after the first compression is: 62 kb\r\ndata.quality: 75\r\ncompressed result {\r\n  format: 'jpeg',\r\n  width: 950,\r\n  height: 712,\r\n  channels: 3,\r\n  premultiplied: false,\r\n  size: 62686\r\n}\r\nThe size after the 2nd compression is: 62 kb\r\ndata.quality: 88\r\ncompressed result {\r\n  format: 'jpeg',\r\n  width: 950,\r\n  height: 712,\r\n  channels: 3,\r\n  premultiplied: false,\r\n  size: 62686\r\n}\r\nThe size after the 3rd compression is: 62 kb\r\ndata.quality: 94\r\ncompressed result {\r\n  format: 'jpeg',\r\n  width: 950,\r\n  height: 712,\r\n  channels: 3,\r\n  premultiplied: false,\r\n  size: 62686\r\n}\r\nThe size after the 4th compression is: 62 kb\r\ndata.quality: 97\r\ncompressed result {\r\n  format: 'jpeg',\r\n  width: 950,\r\n  height: 712,\r\n  channels: 3,\r\n  premultiplied: false,\r\n  size: 62686\r\n}\r\nThe size after the 5th compression is: 62 kb\r\ndata.quality: 99\r\ncompressed result {\r\n  format: 'jpeg',\r\n  width: 950,\r\n  height: 712,\r\n  channels: 3,\r\n  premultiplied: false,\r\n  size: 62686\r\n}\r\nThe size after the 6th compression is: 62 kb\r\n```\r\n\r\nquality is change, but the size remains the same"
      },
      {
        "user": "lovell",
        "created_at": "2023-01-27T17:42:16Z",
        "body": "If you still require help, please provide complete code and sample image(s) that allows someone else to reproduce, perhaps as a standalone repo."
      },
      {
        "user": "lovell",
        "created_at": "2023-02-28T09:34:06Z",
        "body": "Closing due to inactivity but please feel free to reopen with the requested details if further help is required."
      }
    ]
  },
  {
    "number": 3488,
    "title": "[Error: VipsJpeg: Invalid SOS parameters for sequential JPEG ]",
    "created_at": "2022-12-13T14:27:06Z",
    "closed_at": "2023-01-16T11:57:25Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3488",
    "body": "Im still experiencing this error in latest version of Sharp with a Samsung S22, and even when using failOn: 'none'\r\n\r\n[Error: VipsJpeg: Invalid SOS parameters for sequential JPEG\r\n]\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3488/comments",
    "author": "mattcwebster",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-12-13T14:52:00Z",
        "body": "Please provide a minimal, standalone code sample, without other dependencies, that demonstrates this problem\r\n\r\nPlease provide sample image(s) that help explain this problem\r\n\r\n(These questions were in the issue template that was ignored/deleted.)\r\n"
      },
      {
        "user": "Dadibom",
        "created_at": "2022-12-16T07:03:04Z",
        "body": "I am seeing the same issue, I don't know anything about which images cause it unfortunately, just wanting to confirm that the error occurs"
      },
      {
        "user": "lovell",
        "created_at": "2022-12-16T13:42:38Z",
        "body": "For anyone else coming here, please see #1578 for context.\r\n\r\nAssuming the input is trusted, you can use the following approach to deal with invalid images generated by shoddy Samsung firmware.\r\n```js\r\nsharp(input, { failOn: 'error' })...\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2023-01-16T11:57:24Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      },
      {
        "user": "ackmanx",
        "created_at": "2023-01-21T19:23:14Z",
        "body": "Thanks for the info. Using the `failOn` option with `error` worked for me on being able to resize and save as a thumbnail from the shoddy Samsung original."
      }
    ]
  },
  {
    "number": 3466,
    "title": "Recommended config file for 2022",
    "created_at": "2022-11-22T17:50:50Z",
    "closed_at": "2023-03-22T19:43:19Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3466",
    "body": "I'm looking for recommended config file for small application, mainly mobile 3G devices, is there any place I can find these config examples? Sharp config file contains 50+ parameters and it's just too long to test manually (especially these `quality` settings which is really subjective) and I hope somebody already did this",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3466/comments",
    "author": "caxapexac",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-12-20T18:08:26Z",
        "body": "This is a wide topic and most output-related settings are for the underlying image format libraries so this might be better suited to a more general discussion site such as StackOverflow."
      },
      {
        "user": "caxapexac",
        "created_at": "2022-12-21T04:53:15Z",
        "body": "This question would be closed on SO in nanosecond as 'too broad', thats why Im asking here\n\nCould you please share just something that is a bit closer to recommended settings than nothing? "
      },
      {
        "user": "lovell",
        "created_at": "2022-12-21T10:13:31Z",
        "body": "I'm glad you realise it's a broad topic. Perhaps you could narrow it down with a specific image, specific code that you've tried, and a specific set of expectations about the output."
      },
      {
        "user": "caxapexac",
        "created_at": "2022-12-21T14:02:29Z",
        "body": "Ive already narrowed it down to 'mobile web browsing'. Its implicitly lossy png+webp for small screens and slow internet speed. How can I narrow it further?"
      }
    ]
  },
  {
    "number": 3457,
    "title": "Enabling HEIF/HEIC support on Windows sharp@0.31.2",
    "created_at": "2022-11-15T11:52:37Z",
    "closed_at": "2022-12-20T18:00:11Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3457",
    "body": "I  built libvips 8.13.3  with hevc supports in windows ,and copy DLL files into on 'sharp 0.31.2' node_modules/sharp/build/Release , but not work for heic images(libvips works in command line )\r\n in sharp 0.28.3 , copy dlls works. can you help me?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3457/comments",
    "author": "zczcyc0201",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-11-15T12:08:15Z",
        "body": "You're welcome to try copying DLLs around, but I cannot help or provide any support for this."
      }
    ]
  },
  {
    "number": 3429,
    "title": "Is it possible to convert an SVG with remote images to another format like JPG?",
    "created_at": "2022-11-03T14:12:38Z",
    "closed_at": "2022-11-03T14:21:39Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3429",
    "body": "I have tried using the toFormat transformation but I'm just getting an empty JPG as a result. ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3429/comments",
    "author": "Lucasvo1",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-11-03T14:16:46Z",
        "body": "No, please see #1871"
      }
    ]
  },
  {
    "number": 3416,
    "title": "Is there any way to specify the output file names for tile() method?",
    "created_at": "2022-10-22T07:55:03Z",
    "closed_at": "2022-11-14T11:30:04Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3416",
    "body": "I tried all the parameters of this `tile()` method, but it couldn't specify the name of every generated file. \r\nSo I tried to use `fs.rename` to modify the file name after all files were generated\r\n` fs.rename` was very slow. `tile()` cost only 800ms, but `fs.rename` took 1300ms\r\n\r\nby the way,  i tried `extract()` in a loop to do the same thing like `tile()`,  i can use `extract()`  to specify output file name,  but it seems like very very slow to cut a large image by using extract\r\n\r\nany help?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3416/comments",
    "author": "ouzhou",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-10-22T08:04:55Z",
        "body": "Is there a reason for a new issue rather than continue the discussion in #3405?"
      },
      {
        "user": "lovell",
        "created_at": "2022-11-14T11:30:04Z",
        "body": "Closing as this has been discussed in #3405"
      }
    ]
  },
  {
    "number": 3403,
    "title": "How do I output multiple resized images in multiple formats?",
    "created_at": "2022-10-11T01:19:02Z",
    "closed_at": "2022-10-11T16:31:03Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3403",
    "body": "So far I have been able to figure out how to take in an image and output multiple sizes, like so:\r\n\r\n```js\r\nconst sharp = require('sharp')\r\n\r\nconst image = `beach`;\r\nconst format = `jpg`;\r\n\r\nconst resize = size => sharp(`${image}.jpg`)\r\n  .resize({ width: size })\r\n  .toFile(__dirname + `/processed/${image}-${size}.${format}`)\r\n;\r\n\r\nPromise\r\n  .all([2160, 1920, 1440, 1080, 720, 480, 320].map(resize))\r\n  .then(() => {\r\n    console.log('Image resizing is complete.');\r\n  });\r\n```\r\n\r\n...and it works just fine.\r\n\r\nNow I want to be able to output multiple formats of each resized image as well (`avif` is the preferred choice, but `jpg` is the fallback kind of thing), but can't figure it out...\r\n\r\nI've tried this so far:\r\n\r\n```js\r\nconst sharp = require('sharp')\r\n\r\nconst image = `beach`;\r\nconst format = [`jpg`, `avif`]\r\n\r\nconst resize = size => sharp(`${image}.jpg`)\r\n  .resize({ width: size })\r\n  .toFile(__dirname + `/processed/${image}-${size}.${format[0]}`)\r\n  .toFile(__dirname + `/processed/${image}-${size}.${format[1]}`)\r\n;\r\n\r\nPromise\r\n  .all([2160, 1920, 1440, 1080, 720, 480, 320].map(resize))\r\n  .then(() => {\r\n    console.log('Image resizing is complete.');\r\n  });\r\n```\r\n\r\n...but it seems that I cannot chain two `toFile`'s together?\r\n\r\nBeen googling around but have not found anything yet...\r\n\r\nAny help is greatly appreciated, thank you XD",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3403/comments",
    "author": "rchrdnsh",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-10-11T07:33:22Z",
        "body": "Perhaps try something like (untested):\r\n```js\r\nconst resize = (width) =>\r\n  Promise.all(\r\n    format.map((f) =>\r\n      sharp(`${image}.jpg`)\r\n        .resize({ width })\r\n        .toFile(__dirname + `/processed/${image}-${width}.${f}`)\r\n    )\r\n  );\r\n```\r\n"
      },
      {
        "user": "rchrdnsh",
        "created_at": "2022-10-11T16:31:03Z",
        "body": "aha! that worked great...i think i understand...for each width do a map of each format... \r\n\r\nI don't know anything about `Promise.all` however, so i will go learn about it now, but thank you :-)"
      }
    ]
  },
  {
    "number": 3400,
    "title": "How to combine multiple tiff files into a single tiff file using nodeJS ",
    "created_at": "2022-10-05T13:30:15Z",
    "closed_at": "2022-10-05T13:41:29Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3400",
    "body": "\r\nWhat are you trying to achieve?\r\n\r\nI want to merge/concatenate a multi-tiff(multiple pages) file into a single tiff file for the nodeJs project.\r\nI didn't find any examples in the API documentation that seem to show this. I am looking for an example of how to process each page of a multi-page TIFF and merge into single file. If there is an example in the documentation that I've missed, please point me in the right direction. If there isn't, can someone please help me figure this out?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3400/comments",
    "author": "Sanjotarm",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-10-05T13:41:29Z",
        "body": "This was asked, using almost identical wording, a few minutes ago in #3399. I assume you and @rajeesab know each other so will close this question. Please don't double-post."
      }
    ]
  },
  {
    "number": 3382,
    "title": "Sharp is reloading page",
    "created_at": "2022-09-23T11:56:22Z",
    "closed_at": "2022-11-03T14:19:41Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3382",
    "body": "Hello.\r\n\r\nI'm extracting, resizing and saving image with Sharp. Everything works fine.\r\nThe problem is I'm sending a request from client with axios and page is reloading by itself when request responded.\r\nWhen I remove \"toFile\" function, it doesn't reloads page.\r\nI couldn't understand what's going on, any ideas?\r\n\r\n`\r\nawait axios.post('/api', { crop: cropArea, image: image }).then(resp => {\r\n      console.log(resp.data)\r\n })\r\n`\r\n\r\n`\r\nawait sharp(buffer)\r\n    .extract(crop)\r\n    .toFormat('png')\r\n    .resize(650, 650)\r\n    .toFile(`image.png`)\r\n    .then(() => {\r\n      res.send('OK')\r\n    }).catch(err => {\r\n      res.send('ERR')\r\n })\r\n`",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3382/comments",
    "author": "tankotun",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-09-23T12:44:18Z",
        "body": "Are you sure this relates to sharp? The phrase \"page is reloading\" sounds like your client side code running in a web browser.\r\n\r\nIf you still require help please provide complete, standalone code without any other dependencies that allows someone else to reproduce."
      },
      {
        "user": "lovell",
        "created_at": "2022-11-03T14:19:41Z",
        "body": "Closing due to inactivity but please feel free to reopen with more details if further help is required."
      }
    ]
  },
  {
    "number": 3343,
    "title": "Sharp randomly stalling when nesting sharp processes with composite",
    "created_at": "2022-08-26T14:49:56Z",
    "closed_at": "2022-09-27T13:56:49Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3343",
    "body": "Hi, I've noticed that some kind of race condition seems to happen when composing an image with another sharp instance, like this:\r\n\r\n```\r\nlet outer = sharp(....)\r\nouter.composite([\r\n  await sharp(....)\r\n  .toBuffer()\r\n])\r\nawait outer.toBuffer()\r\n```\r\n\r\nPlease notice that the outer sharp instance is first instantiated but not finalized, and the inner sharp instance runs between instantiation and finalization.\r\n\r\nThis way, the process randomly stalls, having the nested promise to return (the inner image), but not the outer one. I'm using the latest 0.30.7 version of sharp, and node v18.8.0.\r\n\r\nI've fixed this reliably by moving the inner image processing before instantiation, like this:\r\n\r\n```\r\nlet inner = await sharp(....).toBuffer()\r\nlet outer = sharp(....)\r\nouter.composite([\r\n  inner\r\n])\r\nawait outer.toBuffer()\r\n```\r\n\r\nIs this bug known? Please let me know if I can help somehow.\r\n\r\nThanks",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3343/comments",
    "author": "aletorrado",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-08-27T08:03:42Z",
        "body": "Please can you provide complete, standalone code that allows someone else to reproduce."
      },
      {
        "user": "lovell",
        "created_at": "2022-09-27T13:56:22Z",
        "body": "Closing due to inactivity but please feel free to reopen with the requested details if further help is required."
      }
    ]
  },
  {
    "number": 3299,
    "title": "How sharpness works with multi-page PDFs?",
    "created_at": "2022-07-20T15:12:38Z",
    "closed_at": "2022-07-21T07:40:12Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3299",
    "body": "Hi,\r\nFirst of all, thank you for this library, it's really great!\r\n\r\nI'm wondering how is the sharpness calculated for PDF file?\r\n\r\nFor example, I have a PDF file with a few pages inside, I read it with `sharp` and convert to one large image. \r\nWhen I check it for the sharpness, what will I get: some average value for all the pages, minimal sharpness of the most blurred page or something else?\r\n\r\nSorry if there is an answer somewhere, couldn't find it.\r\nBest regards!",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3299/comments",
    "author": "4m4rel",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-07-21T07:25:15Z",
        "body": "The following will calculate the sharpness of all pages combined (imagine they have been stitched together top to bottom).\r\n```js\r\nconst { sharpness } = await sharp(input, { pages: -1 }).stats();\r\n```\r\nIf you want averages/min/max etc., you'll need to make one call per page and calculate yourself:\r\n```js\r\nconst sharpnessFirstPage = (await sharp(input, { page: 0 }).stats()).sharpness;\r\nconst sharpnessSecondPage = (await sharp(input, { page: 1 }).stats()).sharpness;\r\n...\r\n```"
      },
      {
        "user": "4m4rel",
        "created_at": "2022-07-21T07:40:12Z",
        "body": "Yeah, I did that, but the operation was much slower.\r\n\r\nSo, if we have a PDF where one page is completely blurred and all the others fine, we get sharpness value just a little bit lower, but not the one that says \"You might have a problem with blurred page in this file\"...\r\n\r\nOk, I understood your point. Thanks a lot for the answer!"
      }
    ]
  },
  {
    "number": 3288,
    "title": "Make source quality setting available",
    "created_at": "2022-07-08T18:06:27Z",
    "closed_at": "2022-07-09T13:22:53Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3288",
    "body": "## Feature request\r\n\r\n### What are you trying to achieve?\r\n\r\nMy original issue is with a program (from another person) that makes thumbnails of avatars. The quality was left at the default (80), but my JPEG-avatar needs at least 90 to not look awful. The obvious solution is to increase the quality, but that makes many other avatars needlessly large.\r\n\r\nSome image formats, for example JPEG, save the quality setting in their metadata. Others, like WebP, save whether it is compressed lossy or lossless. It would be nice if sharp would expose that information, maybe even use it as default quality setting for the output image.\r\n\r\n### When you searched for similar feature requests, what did you find that might be related?\r\n\r\n#3260 is kind of similar, but only about animated images.\r\n\r\n### What would you expect the API to look like?\r\n\r\nI don't know since i don't program with sharp, i encountered it as a user of a program that uses it.\r\n\r\n### What alternatives have you considered?\r\n\r\n1. Always use a high quality setting — wastes space\r\n2. Get the meta data some other way — it seems to make more sense to expose it in sharp since a metadata function already exists and i think it is useful for others, too.\r\n\r\n### Please provide sample image(s) that help explain this feature\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3288/comments",
    "author": "tastytea",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-07-08T18:39:35Z",
        "body": "Please see #908"
      }
    ]
  },
  {
    "number": 3282,
    "title": "Max file size for image?",
    "created_at": "2022-07-04T16:52:02Z",
    "closed_at": "2022-07-04T18:17:07Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3282",
    "body": "Is there a function like ImageMagick jpeg:extent where the output file size will not be greater than the set amount? I've not been able to find an answer after reading the documents.\r\n\r\nExample in ImageMagick (in php):\r\n```\r\n$this->imagickService->setOption('jpeg:size', '1540x1540');\r\n$this->imagickService->setOption('jpeg:extent', '600kb');\r\n```\r\nThis produces images within the dimensions but not greater than 600kb in size.\r\nThanks for any feedback.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3282/comments",
    "author": "rbruhn",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-07-04T18:17:06Z",
        "body": "Please see #3219 #3163 #2916 #2627 #1667"
      }
    ]
  },
  {
    "number": 3277,
    "title": "How can I composite an image to bottom right with margin",
    "created_at": "2022-06-29T16:33:51Z",
    "closed_at": "2022-07-27T09:44:59Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3277",
    "body": "I want to composite an image to another image with gravity southeast with 10px margin.\r\nhow can I do it?\r\nI have checked the documentation, there are only `top`, `left` options which are not applicable to gravity.\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3277/comments",
    "author": "shtse8",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-06-29T18:41:59Z",
        "body": "Hi, from the information provided here my best guess would be that you'll need to calculate `top` and `left` based on the image dimensions.\r\n\r\nI note the issue template was ignored/deleted. It requested the following information, which is the sort of thing that you'll need to provide for further help.\r\n\r\n* Please provide a minimal, standalone code sample, without other dependencies, that demonstrates this question\r\n* Please provide sample image(s) that help explain this question\r\n"
      },
      {
        "user": "shtse8",
        "created_at": "2022-06-30T08:25:41Z",
        "body": "Please help.\r\n\r\n```ts\r\nconst logoBuffer = await sharp('./logo.jpg')\r\n  .resize(100, 100)\r\n  .toBuffer()\r\n\r\nconst image = await sharp('./image.jpg')\r\n  .composite([{\r\n    input: logoBuffer, // Can I put Sharp object here?\r\n    gravity: 'southeast'\r\n    // I want bottom right with 10px margin\r\n  }])\r\n  .jpg()\r\n```\r\n\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2022-07-01T07:24:02Z",
        "body": "The `gravity` option aligns the edges of images, but this scenario doesn't require that to be the case.\r\n\r\nIf you know the dimensions of 'image.jpg' then you can calculate the values for `top` and `left`.\r\n\r\n* top = height of image - height of logo - height of margin\r\n* left = width of image - width of logo - width of margin\r\n"
      },
      {
        "user": "shtse8",
        "created_at": "2022-07-01T07:39:32Z",
        "body": "> The `gravity` option aligns the edges of images, but this scenario doesn't require that to be the case.\r\n> \r\n> If you know the dimensions of 'image.jpg' then you can calculate the values for `top` and `left`.\r\n> \r\n> * top = height of image - height of logo - height of margin\r\n> * left = width of image - width of logo - width of margin\r\n\r\nI'm afraid I can't get the image size as I am using stream input.\r\nis it any easier way to achieve this? and any reason why there are no `bottom`, `right` while there are `top`, `left` properties. or having `origin` property is cool too."
      },
      {
        "user": "lovell",
        "created_at": "2022-07-01T07:53:59Z",
        "body": "Perhaps you could add a transparent margin to your logo, then it can be aligned to the edges."
      },
      {
        "user": "shtse8",
        "created_at": "2022-07-05T11:13:14Z",
        "body": "That's what I am doing to composite with margin. I just feel like so stupid by adding margin to logo before compositing. Seem like I need to extend the image larger to use up more memory and do the composition. I strongly hope that we can have more controls on compositing."
      },
      {
        "user": "lovell",
        "created_at": "2022-07-27T09:44:59Z",
        "body": "An enhancement has been opened for this at #3309 so please subscribe there for any updates."
      }
    ]
  },
  {
    "number": 3276,
    "title": "Sharp toFile doesn't save files to local machine when deployed on Heroku, it does work in localhost",
    "created_at": "2022-06-29T11:05:24Z",
    "closed_at": "2022-06-29T12:22:32Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3276",
    "body": "Hello,\r\n\r\nI'm trying to save uploaded images on the local disk, which is a mounted disk.\r\n\r\nDuring upload tests on localhost it works perfectly fine, the images are directly appearing on the local disk.\r\nWhen it's deployed on Heroku, the code executes without any error message, but the images don't appear at all on the local disk.\r\n\r\nThe folder structure is already in place, so there is no need to create new folders.\r\n\r\nWhat am I missing here?\r\n\r\n\r\n`\r\n\"node\": \"14.15.5\"\r\n\"sharp\": \"^0.30.7\"\r\n\"Windows 10\": \"build 19043.1766\"\r\n`\r\n\r\n// Resize images\r\nconst resizeImages = async (req, res, next) => {\r\n  // Get Property Data\r\n  const propURL = new URL(req.headers.referer)\r\n  const propertyData = propURL.searchParams\r\n  const propertyCode = propertyData.get(\"code\")\r\n  const imgFolder = IMG-${propertyCode}\r\n  const destination = Z:\\\\App\\\\Library\\\\${propertyCode}\\\\Inventory Website\\\\${imgFolder}\r\n\r\n  // Check for image files\r\n  if (!req.files) return next()\r\n\r\n  // Array images\r\n  req.body.images = []\r\n\r\n  await Promise.all(\r\n    req.files.map(async (file) => {\r\n      const filename = file.originalname.replace(/\\..+$/, \"\")\r\n      const newFilename = RENAME-${filename}-${Date.now()}.jpg\r\n      const targetPath = ${destination}\\\\${newFilename}\r\n      await sharp(file.buffer).resize(2048).toFormat(\"webp\").toFile(targetPath)\r\n      req.body.images.push(newFilename)\r\n    })\r\n  )\r\n  next()\r\n}",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3276/comments",
    "author": "yoontaemin",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-06-29T12:11:51Z",
        "body": "The paths in this code look like they are for Windows, but Heroku uses Linux and a different filesystem layout, so they are unlikely to work.\r\n\r\nI also notice there's no error handling, which might explain why you're not seeing any errors."
      },
      {
        "user": "yoontaemin",
        "created_at": "2022-06-29T12:18:23Z",
        "body": "> The paths in this code look like they are for Windows, but Heroku uses Linux and a different filesystem layout, so they are unlikely to work.\r\n> \r\n> I also notice there's no error handling, which might explain why you're not seeing any errors.\r\n\r\nHello, thank you for your reply.\r\n\r\nMy goal is to save the files locally on a Windows OS, while running the code on Heroku. Do I still in this case need to reformat the paths to Linux filesystem layout?"
      },
      {
        "user": "lovell",
        "created_at": "2022-06-29T12:22:32Z",
        "body": "> My goal is to save the files locally on a Windows OS, while running the code on Heroku.\r\n\r\nThis isn't possible, is unrelated to sharp and is way beyond anything I can help with. Good luck."
      }
    ]
  },
  {
    "number": 3275,
    "title": "Input file is missing: ./title_imgs/title-1.svg",
    "created_at": "2022-06-28T08:40:24Z",
    "closed_at": "2022-07-22T23:38:30Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3275",
    "body": "the code like this：\r\n\r\nthis.title1buffer = await sharp('./title_imgs/title-1.svg').resize({ height: 55 }).png().toBuffer();\r\n\r\nThe SVG file under this directory exists, but an error is reported like this：\r\nInput file is missing: ./title_imgs/title-1.svg\r\n\r\nThis error occurs in version 0.30.7",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3275/comments",
    "author": "82318179",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-06-28T11:39:09Z",
        "body": "Are you sure the file exists? You're using a relative path - is it relative to the current working directory (which is not necessarily the same as relative to the current JS script/file)?"
      },
      {
        "user": "lovell",
        "created_at": "2022-07-22T23:38:30Z",
        "body": "Closing due to inactivity but please feel free to reopen with more details if further help is required."
      }
    ]
  },
  {
    "number": 3272,
    "title": "Converting svg (buffer) to gif doesn't export animations",
    "created_at": "2022-06-21T09:37:55Z",
    "closed_at": "2022-06-21T11:28:00Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3272",
    "body": "Hello,\r\n\r\nI am trying to export an svg to a gif output but animations are not exported. \r\nIs there something I am missing? Is this feature supported?\r\n\r\n`    \r\nconst gif = await sharp(Buffer.from(decodedSVG), { animated: true }).gif({ delay: 1000, force: true }).toBuffer();\r\n`",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3272/comments",
    "author": "gianlucamazza",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-06-21T11:28:00Z",
        "body": "Please see #3248"
      }
    ]
  },
  {
    "number": 3215,
    "title": "How text draw by svg automatic enter new line when full width",
    "created_at": "2022-05-06T03:17:34Z",
    "closed_at": "2022-05-06T09:50:26Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3215",
    "body": "This is my code to drawing the text \r\n`\r\n const svgImage = \"\r\n        <svg width=\"${data.width}\" height=\"${data.height}\">\r\n          <style>\r\n          .title { fill: ${data.color || \"black\"}; font-size: ${data.fontSize || \"10px\"}}\r\n          </style>\r\n          <text x=\"0\" y=\"${data.fontSize || 10}}\" text-anchor=\"start\" class=\"title\">${data.text}</text>\r\n        </svg>\r\n        \"\r\n`\r\nIssue is if data.text too long , it will be disappear , not enter the new line.\r\nHow can i do it?\r\nEx: data.text = '123456789'\r\nit only show '12345' . I would like the rest text will be entered new line.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3215/comments",
    "author": "hieuntcasso",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-05-06T09:50:26Z",
        "body": "Please see the future possible enhancement at #512"
      }
    ]
  },
  {
    "number": 3206,
    "title": "composite animated GIF ",
    "created_at": "2022-04-26T12:56:07Z",
    "closed_at": "2022-04-26T13:13:07Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3206",
    "body": "Hello everybody. \r\nI'm trying to create an animated gif using the composite function which allows to overlay images. \r\nThe overlay works but the image is not animated while each file has an animation. \r\nDoes anyone have an idea or an example of code that works? \r\n\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3206/comments",
    "author": "ether-wan",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-04-26T13:13:07Z",
        "body": "Please see #2680"
      }
    ]
  },
  {
    "number": 3195,
    "title": "I want to resize my apng file, but I need help.",
    "created_at": "2022-04-18T09:34:13Z",
    "closed_at": "2022-04-18T09:36:28Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3195",
    "body": "this is my codes.\r\n\r\n```javascript\r\nconst sharp = require('sharp');\r\nconst fs = require('fs/promises');\r\n\r\nasync function start() {\r\n  const src = await fs.readFile('./src/0023ac17-e520-4ae4-9308-500608d5fad8.png'); // apng file\r\n\r\n  const sample = await sharp(src, { animated: true })\r\n    .resize({ width: 320, height: 320, fit: 'fill', fastShrinkOnLoad: false })\r\n    .toFile('./dist/0023ac17-e520-4ae4-9308-500608d5fad8.png'); // only resized first frame, like thumbnail...\r\n}\r\n\r\nstart();\r\n```\r\n\r\nWhat I expected is that the apng file is saved with only the size changed.\r\nHowever, only the first frame was saved with the changed size. How do I resize and save all frames?\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3195/comments",
    "author": "dogemad",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-04-18T09:36:28Z",
        "body": "Please see future possible enhancement #2375"
      }
    ]
  },
  {
    "number": 3174,
    "title": "How to delete the white background, then make it transparent PNG?",
    "created_at": "2022-04-02T08:58:21Z",
    "closed_at": "2022-04-18T08:24:05Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3174",
    "body": "I have a white background pic , I hope delete the white background,convert to PNG format.\r\nHow should I write the code ?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3174/comments",
    "author": "826327700",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-04-02T10:12:16Z",
        "body": "Please can you provide sample images (input, expected output) that help explain your question."
      },
      {
        "user": "lovell",
        "created_at": "2022-04-18T08:24:05Z",
        "body": "Closing due to inactivity but please feel free to reopen with the requested details if further help is required."
      }
    ]
  },
  {
    "number": 3143,
    "title": "webp always same file size",
    "created_at": "2022-03-18T13:28:14Z",
    "closed_at": "2022-03-18T15:19:48Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3143",
    "body": "\r\n### What are you trying to achieve?\r\nIm using sharp and want to convert our png/jpg images to webp.\r\ndid some testing to see if i can shrink the file size a bit but always get the same size.\r\n\r\nSome example i used to test if i can get smaller images\r\n\r\n    .resize({ width: IMAGE_WIDTH })\r\n    .toFormat('webp')\r\n    .webp({quality: 100})\r\n    .toBuffer();\r\n\r\n    .resize({ width: IMAGE_WIDTH })\r\n    .webp({quality: 75})\r\n    .toFormat('webp')\r\n    .toBuffer();\r\n\r\n    .resize({ width: IMAGE_WIDTH })\r\n    .toFormat('webp')\r\n    .webp({ nearLossless: true, quality: 50 })\r\n    .toBuffer();\r\n\r\nI'm quite new to this so maybe this is a correct behavior.\r\njust curious if i'm doing something wrong\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3143/comments",
    "author": "wkng",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-03-18T14:34:57Z",
        "body": "Please can you provide a sample input image and the complete code that allows someone else to reproduce different output image file sizes."
      },
      {
        "user": "wkng",
        "created_at": "2022-03-18T15:19:37Z",
        "body": "Did some mor testing now after lunch and my images has gone from  1mb to 100kb so maybe it was an cache in aws gateway.. i i i will close the issue"
      }
    ]
  },
  {
    "number": 3089,
    "title": "Reducing memory usage",
    "created_at": "2022-02-11T19:20:45Z",
    "closed_at": "2022-03-12T09:37:46Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3089",
    "body": "### What are you trying to achieve?\r\nI'm processing batches of 200-400MB TIFF files on an instance with 1GB of memory. It is occasionally not enough. I'm trying to understand what I can do better to manage memory.\r\n\r\n### Have you searched for similar questions?\r\nYes, I've landed on #138 and related issues regarding streaming. But I'm not sure if this is the best approach.\r\n\r\nMy use case requires me to clone and downsample the entire image to be analyzed. I then use the analysis results for processing the full-size image. If I am to change the file to a stream, I may not be able to split it into two parts (one, downsized, for analysis and one for processing).\r\n\r\nI currently start the instance on `node:14-alpine` container with `--optimize_for_size --max_old_space_size=320 --gc_interval=50`. Other than streaming, I'm also considering adding an artificial delay between jobs to ensure that the memory has time to empty out.\r\n\r\nI would really appreciate some guidance here. Thank you so much!\r\n\r\n### Are you able to provide a minimal, standalone code sample that demonstrates this question?\r\n```javascript\r\n\r\n// create a reduced-size image sample\r\nconst data = await sharp(image).clone().resize(500).toBuffer();\r\n\r\n// this object will store values that will be used for full-size image manipulation\r\nconst prescriptions = {};\r\n\r\n// determine values for full-size image manipulation\r\nconst channelNames = [\"red\", \"green\", \"blue\"];\r\nconst prescriptionsCalculators = channelNames.map(async (channel) => {\r\n  const forAnalysis = await sharp(data)\r\n  .extractChannel(channel)\r\n  .toColorspace(\"b-w\")\r\n  .blur(1)\r\n  .toBuffer();\r\n\r\n  const stats = await sharp(forAnalysis).stats();\r\n  const { channels } = stats;\r\n\r\n  const range = [channels[0].min, channels[0].max];\r\n  const linear = levels(range[0], range[1]);\r\n\r\n  prescriptions[channel] = { linear, range };\r\n  return await linear;\r\n});\r\nawait Promise.all(prescriptionsCalculators);\r\n\r\n// use the above data to process full-size image\r\nconst channels = {};\r\nconst channelEffects = channelNames.map(async (channel) => {\r\n  const result = sharp(reversed)\r\n    .extractChannel(channel)\r\n    .toColorspace(\"b-w\")\r\n    .linear(...prescriptions[channel].linear)\r\n    .toBuffer();\r\n  channels[channel] = result;\r\n  return result;\r\n});\r\nawait Promise.all(channelEffects);\r\n\r\n// reassemble channels into RGB\r\nconst positive = sharp(await channels[\"red\"]).joinChannel([\r\n  await channels[\"green\"],\r\n  await channels[\"blue\"],\r\n]);\r\n\r\nreturn positive;\r\n```\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3089/comments",
    "author": "dmitrizzle",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2022-02-18T21:34:14Z",
        "body": "The quickest way to reduce memory usage would be to switch from RAM to filesystem. Have you tried replacing any of the `toBuffer` calls with `toFile`?"
      },
      {
        "user": "dmitrizzle",
        "created_at": "2022-02-24T05:41:09Z",
        "body": "Thank you for the tip, @lovell! I tried replacing a few calls and memory usage seems to be a little more constrained."
      }
    ]
  },
  {
    "number": 3027,
    "title": "How set Date taken, modify and create dates using withMetaData?",
    "created_at": "2021-12-24T16:02:51Z",
    "closed_at": "2022-05-23T13:14:15Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3027",
    "body": "I want to change these properties using sharp js\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3027/comments",
    "author": "loverdeveloper",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-12-24T20:49:53Z",
        "body": "Are you able to provide a minimal, standalone code sample that demonstrates this question?\r\n\r\nAre you able to provide a sample image that helps explain the question?"
      },
      {
        "user": "lovell",
        "created_at": "2022-05-23T13:14:15Z",
        "body": "Closing due to inactivity but please feel free to reopen with more details if further help is required."
      }
    ]
  },
  {
    "number": 3011,
    "title": "Sharp promises finishes before the file is written to disk?",
    "created_at": "2021-12-12T03:47:00Z",
    "closed_at": "2022-01-10T09:17:49Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3011",
    "body": "I have seen this behaviour of sharp. The section of my code that works on sharp executes and promises gets full filled yet sharp keeps writing images and when sharp finishes then the program ends. Is this expected or due to some bug in my code?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3011/comments",
    "author": "navanshu",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-12-12T08:56:53Z",
        "body": "Please can you provide a complete, minimal, standalone code sample that allows someone else to reproduce this."
      },
      {
        "user": "navanshu",
        "created_at": "2021-12-23T16:23:31Z",
        "body": "Hi @lovell ,\r\nSure please go over this code\r\n```typescript\r\n// This code won't actually work is some missing code. Let me know what to do\r\n// fileSelector.ts\r\n// a for loop starts, I am processing one folder at a time\r\n\r\nimport FastGlob, { Entry } from 'fast-glob';\r\n\r\ninterface activityT {\r\n    total: number;\r\n    increment: number;\r\n}\r\n\r\nconst activity: activityT = {\r\n total: number,\r\n increment: number\r\n}\r\n\r\nawait Promise.all(\r\n async (itrms) => {\r\n // do some calculations\r\n await imageConverter(imageBuffer, path);\r\n } \r\n) \r\n\r\n// for loop ends\r\n\r\n// imageConverter\r\n\r\nasync function imageConverter(image: Buffer, dirent: Required<Entry>, activity: activity) {\r\n\r\n const Instance = sharp(image);\r\n\r\n    const { hasAlpha } = await Instance.metadata();\r\n\r\n    let avif = Instance.clone().avif(Conversion.options.avif);\r\n    let webp = Instance.clone().webp(Conversion.options.webp);\r\n\r\n    let pngJpg;\r\n\r\n    if (hasAlpha) {\r\n        pngJpg = Instance.clone().png(Conversion.options.png);\r\n    } else {\r\n        pngJpg = Instance.clone().jpeg(Conversion.options.jpeg);\r\n    }\r\n\r\n    const Avif = produceRenditions(avif, 'avif', dirent, activity);\r\n    const Webp = produceRenditions(webp, 'webp', dirent, activity);\r\n    const pJpg = produceRenditions(pngJpg, hasAlpha ? 'png' : 'jpg', dirent, activity);\r\n\r\n    await Promise.resolve([\r\n        Avif,\r\n        Webp,\r\n        pJpg\r\n    ]);\r\n\r\n}\r\n\r\nasync function produceRenditions(Instance: sharp.Sharp, format: string, src: Required<Entry>, activity: activity) {\r\n\r\n    const dirs = await makeDestDirs(src);\r\n    const name = src.name.split('.').slice(0, -1).join('.') + '.' + format;\r\n\r\n\r\n    await Promise.all(\r\n        dirs.map(async ([path, res]) => {\r\n            await Instance.clone().resize(res).toFile(path + '/' + name);\r\n            activity.increment = activity.increment + 1;\r\n\r\n            console.log(activity.increment, '/', activity.total); // So this line prints the number of images that has been converted\r\n        })\r\n    );\r\n\r\n}\r\n\r\n // after all this process is done then I do\r\n\r\nconsole.log('Done');\r\n\r\n// Suprisingly Done gets printed before the image conversion ques finishes so the output is like\r\n```\r\nThis is sample log of this program.\r\n```log\r\n....\r\n....\r\n51 / 100\r\n52 / 100\r\n...\r\n...\r\n98 / 100\r\nDone\r\n99 / 100\r\n100 / 100\r\n\r\n```\r\n\r\nThen the program quits. \r\nI have seen this specific behavior of sharp for quite some time.\r\nI am running windows 11, node 17 and v0.29.3 sharp"
      },
      {
        "user": "lovell",
        "created_at": "2021-12-23T16:41:15Z",
        "body": "Try the following change to your code:\r\n```diff\r\n-    await Promise.resolve([\r\n+    await Promise.all([\r\n```\r\n"
      },
      {
        "user": "navanshu",
        "created_at": "2021-12-24T05:57:49Z",
        "body": "Hi @lovell \r\nOkay I didn't notice I was using Promise.resolve. \r\nI don't really use it, maybe it was part of the old code.\r\nI will update with the results soon."
      },
      {
        "user": "lovell",
        "created_at": "2022-01-10T09:17:49Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 3003,
    "title": "Tiling a 5GB TIF: RangeError [ERR_INVALID_OPT_VALUE]: The value \"5479395327\" is invalid for option \"size\"",
    "created_at": "2021-12-06T20:47:35Z",
    "closed_at": "2022-01-10T09:17:29Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/3003",
    "body": "Are you using the latest version? Is the version currently in use as reported by `npm ls sharp` the same as the latest version as reported by `npm view sharp dist-tags.latest`?\r\n0.29.3\r\n\r\nWhat are the steps to reproduce?\r\n\r\nI am trying to tile a 5gb TIF from an S3 Bucket.\r\nI recreated a working example locally, reading the file partially into a CombinedStream and piping it to sharp\r\n\r\nError:\r\n\r\n```\r\nRangeError [ERR_INVALID_OPT_VALUE]: The value \"5479395327\" is invalid for option \"size\"\r\n    at Function.allocUnsafe (buffer.js:386:3)\r\n    at Function.concat (buffer.js:567:25)\r\n    at Sharp._flattenBufferIn (E:\\work\\siteplan\\siteplan-lambda\\tiling\\node_modules\\sharp\\lib\\input.js:194:40)\r\n    at Sharp.<anonymous> (E:\\work\\siteplan\\siteplan-lambda\\tiling\\node_modules\\sharp\\lib\\output.js:846:16)\r\n    at Object.onceWrapper (events.js:421:28)\r\n    at Sharp.emit (events.js:327:22)\r\n    at Sharp.EventEmitter.emit (domain.js:467:12)\r\n    at finish (internal/streams/writable.js:657:10)\r\n    at processTicksAndRejections (internal/process/task_queues.js:80:21) {\r\n  code: 'ERR_INVALID_OPT_VALUE'\r\n}\r\n```\r\n\r\nWhat is the expected behaviour?\r\n\r\nAre you able to provide a minimal, standalone code sample, without other dependencies, that demonstrates this problem?\r\n\r\n```\r\n    const sharpStream = sharp({\r\n        limitInputPixels: false,\r\n        sequentialRead: true\r\n    });\r\n\r\n    const partSize = 16000000;\r\n    const combinedStream = CombinedStream.create();\r\n    const contentLength = fs.statSync('test_file.tif').size;\r\n    let currentByte = 0;\r\n\r\n    while (currentByte <= contentLength) {\r\n        const s1 = fs.createReadStream('test_file.tif', {\r\n            start: currentByte,\r\n            end: currentByte + partSize\r\n        });\r\n        currentByte += partSize + 1;\r\n        combinedStream.append(s1);\r\n    }\r\n\r\n    combinedStream.pipe(sharpStream);\r\n\r\n    await sharpStream.jpeg().tile({\r\n        layout: 'google',\r\n        size: 256\r\n    }).toFile('output_folder');\r\n```\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/3003/comments",
    "author": "beig",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-12-06T21:00:06Z",
        "body": "You've probably hit the memory limit of Node.js. For huge inputs like this I recommend using the local filesystem and providing a path to sharp."
      },
      {
        "user": "lovell",
        "created_at": "2022-01-10T09:17:29Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 2975,
    "title": "pipeline await and toBuffer",
    "created_at": "2021-11-15T18:59:31Z",
    "closed_at": "2021-12-12T20:52:23Z",
    "labels": [
      "question",
      "cookbook"
    ],
    "url": "https://github.com/lovell/sharp/issues/2975",
    "body": "I am trying to pipe an input stream to a sharp pipeline and get a buffer out of it.\r\nTo be able to handle the input stream errors, i thought i could do this:\r\n\r\n```\r\nconst sharp = require('sharp');\r\nconst pipeline = require('util').promisify(require('stream').pipeline);\r\nconst got = require('got');\r\n\r\nasync function getThumbnailBuffer(uri) {\r\n\tconst pil = sharp().resize({\r\n\t\tfit: \"inside\",\r\n\t\theight: 64\r\n\t}).toFormat('webp', {\r\n\t\tquality: 50\r\n\t});\r\n\tconst pipe = await pipeline(got.stream(uri), pil);\r\n\tconst buf = await pil.toBuffer();\r\n\treturn buf; // i know i can return pil.toBuffer(), i do this to show where we wait\r\n};\r\n```\r\n\r\nhowever that doesn't work - `await pipeline` doesn't return when no error is thrown.\r\nOn the other hand, it correctly (meaning `try { await getThumbnailBuffer(url); }` works) throws an error (from got.stream) when there is one.\r\n\r\nI also tried this but toBuffer is not a stream, so it can't work:\r\n```\r\n\treturn await pipeline(got.stream(uri), pil.toBuffer());\r\n```\r\n\r\nInstead i had to do that:\r\n\r\n```\r\nconst sharp = require('sharp');\r\nconst pipeline = require('util').promisify(require('stream').pipeline);\r\nconst got = require('got');\r\n\r\nmodule.exports = async function (uri) {\r\n\tconst pil = sharp().resize({\r\n\t\tfit: \"inside\",\r\n\t\theight: 64\r\n\t}).toFormat('webp', {\r\n\t\tquality: 50\r\n\t});\r\n\tlet toBuff;\r\n\tsetTimeout(async () => {\r\n\t\ttoBuff = pil.toBuffer();\r\n\t});\r\n\tawait pipeline(got.stream(uri), pil);\r\n\tconst buf = await toBuff;\r\n\treturn buf; // i know i can return toBuff, i do this to show where we wait\r\n};\r\n```\r\n\r\nthis works and also catches (in a way compatible with async/await) errors.\r\nHowever it's ugly.\r\nIt's hard to tell if it comes from\r\n- node\r\n- got\r\n- sharp\r\nbut right now i'm inclined to think the need to call \"toBuffer\" to trigger the stream is odd.\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2975/comments",
    "author": "kapouer",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-11-15T19:24:15Z",
        "body": "A `sharp` instance implements a `Duplex` stream so won't emit the `close` event (and therefore resolve the \"promisified\" logic here) until it knows the destination of the output, as this might be another `WritableStream`.\r\n\r\nPerhaps an alternative approach might be to `await` the input and output sides concurrently, something like (untested):\r\n```js\r\nconst [pipe, buf] = await Promise.all([\r\n  pipeline(got.stream(uri), pil),\r\n  pil.toBuffer()\r\n]);\r\n```"
      },
      {
        "user": "kapouer",
        "created_at": "2021-11-15T20:57:11Z",
        "body": "Yes ! that's so much nicer ! Even better, this works too:\r\n```\r\nconst [buf] = await Promise.all([\r\n  pil.toBuffer(),\r\n  pipeline(got.stream(uri), pil)\r\n]);\r\n```\r\nmaybe it would help so much if it was given as an example somewhere in the documentation.\r\nEDIT: i made sure this actually works and also actually throws correctly in case of input stream error."
      },
      {
        "user": "lovell",
        "created_at": "2021-12-12T20:52:23Z",
        "body": "Glad you got it working. I've tagged this as `cookbook` for inclusion in future possible document relating to problem-oriented solutions (as opposed to API-level reference)."
      }
    ]
  },
  {
    "number": 2973,
    "title": "Sharp get crash when run on docker with node:12-alpine",
    "created_at": "2021-11-15T11:44:47Z",
    "closed_at": "2021-11-15T14:09:41Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2973",
    "body": "\r\nI'm using the sharp version 0.26.3 to resize my images, when I run my application on local (using Windows 11), it working fine but when I deploy the code to server using docker with node:12-alpine image, my application crash when sharp resize uploaded image without any exception.\r\nI was tried to set cache to false or set cache to  sharp.cache({ memory: 0, files: 0, items: 0 }) but nothing helpful.\r\nMy size image code\r\n const image = await sharp(`${destPath}/${fileName}`)\r\n              .resize({ height })\r\n              .toFormat('jpeg')\r\n              .toFile(localStoragePath);",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2973/comments",
    "author": "sonnguyenjom",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-11-15T11:49:27Z",
        "body": "This is probably #2570, please can you upgrade to the latest version."
      },
      {
        "user": "sonnguyenjom",
        "created_at": "2021-11-15T14:09:41Z",
        "body": "> This is probably #2570, please can you upgrade to the latest version.\r\n\r\nafter after the latest version, it working correctly now. Thanks"
      }
    ]
  },
  {
    "number": 2948,
    "title": "toFormat resulting in error: \"Cannot read property 'toLowerCase' of undefined\" ",
    "created_at": "2021-10-26T13:01:36Z",
    "closed_at": "2021-11-08T15:33:32Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2948",
    "body": "Are you using the latest version? Is the version currently in use as reported by `npm ls sharp` the same as the latest version as reported by `npm view sharp dist-tags.latest`?\r\n\r\nYes\r\n\r\nWhat are the steps to reproduce?\r\n\r\nUsing this code, I get the error in toFormat.  If I comment out the toFormat, all is well:\r\n```\r\n    const options = {\r\n      fit: fit.cover,\r\n      background: { r: 0, g: 0, b: 0, alpha: 1 },\r\n      withoutEnlargement: true\r\n    };\r\n    const readableStream = this.getReadableFromURL(filePath);\r\n    const smallWritableStream = this.getSmallWritable(filePath);\r\n    const largeWritableStream = this.getLargeWritable(filePath);\r\n    const pipeline = sharp();\r\n    pipeline.clone()\r\n      .resize(150, 150, options)\r\n      .toFormat(format.jpg)\r\n      .pipe(smallWritableStream);\r\n    pipeline.clone()\r\n      .resize(300, 300, options)\r\n      .toFormat(format.jpg)\r\n      .pipe(largeWritableStream);\r\n    readableStream.pipe(pipeline);\r\n```\r\n\r\nThis happens with any image, png or jpg\r\n\r\nWhat is the expected behaviour?\r\n\r\nAble to convert png files to jpg\r\n\r\nAre you able to provide a minimal, standalone code sample, without other dependencies, that demonstrates this problem?\r\n\r\nAre you able to provide a sample image that helps explain the problem?\r\n\r\nWhat is the output of running `npx envinfo --binaries --system`?\r\n\r\nPS D:\\Users\\ed\\IdeaProjects\\WebstormProjects\\evidentia> npx envinfo --binaries --system\r\n\r\n  System:\r\n    OS: Windows 10 10.0.22000\r\n    CPU: (24) x64 AMD Ryzen 9 3900X 12-Core Processor\r\n    Memory: 34.55 GB / 63.93 GB\r\n  Binaries:\r\n    Node: 14.17.5 - D:\\Program Files\\nodejs\\node.EXE\r\n    Yarn: 1.22.11 - ~\\AppData\\Roaming\\npm\\yarn.CMD\r\n    npm: 6.14.14 - D:\\Program Files\\nodejs\\npm.CMD\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2948/comments",
    "author": "ed4becky",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-10-31T16:19:16Z",
        "body": "Perhaps try the following change to your code to ensure the value passed to `toFormat` is defined.\r\n```diff\r\n- .toFormat(format.jpg)\r\n+ .toFormat(sharp.format.jpeg)\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2021-11-08T15:33:32Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 2943,
    "title": "Error: Input file has corrupt header: pngload: too many text chunks]",
    "created_at": "2021-10-24T14:56:22Z",
    "closed_at": "2021-10-24T15:03:12Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2943",
    "body": "Sharp was working great but for few png images it throws this error - \"Error: Input file has corrupt header: pngload: too many text chunks\" and i am not able to find any way to fix it, is it possible to fix it? i don't have any idea what this error is, this error was thrown for some usual png files, i don't know what is wrong those pngs, they were like other all pngs, i would be grateful if someone can give me any solution for it.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2943/comments",
    "author": "TalibAzhar",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-10-24T15:03:11Z",
        "body": "Please see #2917"
      }
    ]
  },
  {
    "number": 2939,
    "title": "Move after detecting image breakage",
    "created_at": "2021-10-21T05:09:23Z",
    "closed_at": "2021-11-25T11:46:32Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2939",
    "body": "Hello. I tested it to see if it detects broken images while using sharp, and it seems to detect it well. But even if the image is broken, resizing works and even moving, is there an option to prevent this? Or is it intentional?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2939/comments",
    "author": "JuTiger-Lee",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-10-21T07:28:09Z",
        "body": "Please can you provide more context to your question such as example image(s), minimal code sample, expected vs actual output."
      },
      {
        "user": "lovell",
        "created_at": "2021-11-25T11:46:32Z",
        "body": "Closing due to inactivity but please feel free to reopen with more details if further help is required."
      }
    ]
  },
  {
    "number": 2916,
    "title": "Add output option to limit file size",
    "created_at": "2021-10-04T09:20:37Z",
    "closed_at": "2021-10-04T14:14:52Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2916",
    "body": "**What are you trying to achieve?**\r\nI want to limit resulting file size\r\n\r\n**Have you searched for similar feature requests?**\r\nYes\r\n\r\n**What would you expect the API to look like?**\r\nI.e. with png format, additional field in options,\r\n`.png({ limitFileSize: 200000 })` (in bytes or kilobytes)\r\n\r\n**What alternatives have you considered?**\r\nI've googled a lot and found only alternatives for frontend, but these not applicable for Node.js\r\n\r\n**Is there a sample image that helps explain?**\r\nAny image\r\n\r\n**Additional**\r\nNow I made a workaround with binary search but for any iteration it performs redundant compressing and in the worst case number of redundant compressings reaches 9.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2916/comments",
    "author": "Aliaksandr-Kasko-JazzTeam",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-10-04T12:34:38Z",
        "body": "Please can you explain a little more about this. Are you suggesting that processing should be stopped and an Error thrown when the size of the compressed file exceeds the limit?"
      },
      {
        "user": "Aliaksandr-Kasko-JazzTeam",
        "created_at": "2021-10-04T13:31:07Z",
        "body": "No. I suggest you to detect (without performing compression) optimal compression level and/or quality to reach limitfileSize. There's no need to throw an Error."
      },
      {
        "user": "lovell",
        "created_at": "2021-10-04T14:14:52Z",
        "body": "Thanks, the only way to know the output file size is to encode the image, so this would require brute force. You mentioned you're already using binary search for this, which seems like a sensible approach, and I'd recommend others who might need this do the same."
      },
      {
        "user": "lqzhgood",
        "created_at": "2021-11-16T02:52:05Z",
        "body": "this features I need that as well. \r\nI think add `.png({ limitFileSize: 200000 })` to `sharp` is better "
      },
      {
        "user": "KishorJena",
        "created_at": "2024-06-01T15:07:22Z",
        "body": "this is very useful. there are many cases where we need the image file to be less then given file size while keeping it close to size limit to have highest quality possible ."
      }
    ]
  },
  {
    "number": 2871,
    "title": "i am trying to convert heic image into jpeg ",
    "created_at": "2021-08-31T14:04:00Z",
    "closed_at": "2021-09-23T10:04:25Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2871",
    "body": "source: bad seek to 41473\\\\nheif: Unsupported feature: Unsupported codec (4.3000)\r\n\r\nin AWS Lambda I don't want to install other dependencies globally \r\n\r\nis there any solution?\r\n\r\nmy aim is just convert image heic to jpeg\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2871/comments",
    "author": "bhandurejitu",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-08-31T14:11:00Z",
        "body": "The prebuilt binaries provided by sharp do not support the patent-encumbered HEIC format so you'll need to find an alternative solution."
      }
    ]
  },
  {
    "number": 2853,
    "title": "sharp.format.avif returns undefined",
    "created_at": "2021-08-20T12:53:17Z",
    "closed_at": "2021-08-20T15:07:36Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2853",
    "body": "I am using latest version of sharp (0.29.0) and I noticed that ``sharp.format.avif`` returns undefined. Would you please investigate?\r\n\r\nBest regards,\r\nAngel Kiryazov",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2853/comments",
    "author": "akiryazov",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-08-20T15:05:13Z",
        "body": "Hi, please see the `sharp.format.heif` property (AVIF files are HEIF files that use AV1 compression).\r\n```sh\r\n$ node -p \"require('sharp').format.heif\"\r\n{\r\n  id: 'heif',\r\n  input: { file: true, buffer: true, stream: true },\r\n  output: { file: true, buffer: true, stream: true }\r\n}\r\n```"
      },
      {
        "user": "akiryazov",
        "created_at": "2021-08-20T15:07:36Z",
        "body": "Yes, I figured that out. Just wanted to point if this is an actual defect so you can take further action if needed :)\r\n\r\nThanks for your quick answer!\r\n\r\nBest regards,\r\nAngel Kiryazov"
      }
    ]
  },
  {
    "number": 2831,
    "title": "Sharp work on older OSX?",
    "created_at": "2021-08-09T01:06:42Z",
    "closed_at": "2021-09-05T08:23:05Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2831",
    "body": "I have a Mac <10.13. Is there a process to make the sharp module work on such a device? It keeps stating the sharp module is incompatible with the version of my operating system. ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2831/comments",
    "author": "DaBodey",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-08-09T19:21:34Z",
        "body": "If you're able to use Homebrew then you might have success installing libvips first via `brew install vips` then install sharp."
      },
      {
        "user": "lovell",
        "created_at": "2021-09-05T08:23:05Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 2826,
    "title": "Can't rezize to a width larger than 701px",
    "created_at": "2021-08-05T16:18:24Z",
    "closed_at": "2021-09-06T11:55:52Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2826",
    "body": "Thank you for the very useful module!\r\nI'm trying to resize an image with Sharp v0.28.3, in an AWS lambda function. The original image has an intrinsic size of 3938 × 5907 px. I call the resize function with the width argument only like this: resize(width).  I pass the width value in the url. The lambda function works with widths below or equal to 701px and it fails with response status 503 when the width is higher. I saw no limit to the width argument's value in the documentation. I wonder what's causing the failure.\r\nHere's the full response : \r\n_\r\n\r\n_> 503 ERROR\r\n> The request could not be satisfied.\r\n> The Lambda function associated with the CloudFront distribution is invalid or doesn't have the required permissions. We can't connect to the server for this app or website at this time. There might be too much traffic or a configuration error. Try again later, or contact the app or website owner.\r\n> If you provide content to customers through CloudFront, you can find steps to troubleshoot and help prevent this error by reviewing the CloudFront documentation._\r\n\r\n_\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2826/comments",
    "author": "yass-a",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-08-05T16:33:48Z",
        "body": "This is very, very likely to be a problem with the configuration of your Lambda, and therefore unrelated to sharp."
      },
      {
        "user": "lovell",
        "created_at": "2021-09-05T08:24:40Z",
        "body": "@yass-a Were you able to make any progress with this?"
      },
      {
        "user": "yass-a",
        "created_at": "2021-09-05T15:09:01Z",
        "body": "Thank you for asking. I don't know well enough about AWS configs to confirm whether the problem is there. I noticed that the lambda function execution times out after 30 seconds every time I request from Sharp to resize to a value of width x length above 296000. So I decided not to exceed that value and let the browser extend the images when needed. I didn't have enough time for a better solution and I had to move to work on others projects."
      }
    ]
  },
  {
    "number": 2813,
    "title": "Sharp not working as expected with electron-packager",
    "created_at": "2021-07-26T18:47:57Z",
    "closed_at": "2022-07-27T10:24:22Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2813",
    "body": "I am creating an electron app, which on `npm start` works perfectly, but when I try to build the same with the electron-packager, the following error pops on on clicking the exe file.\r\n\r\n\r\n  A JavaScript error occurred in the main process\r\n  Uncaught Exception\r\n  Error\r\n  Something went wrong installing the \"sharp\"module\r\n  The specified module could not be found.\r\n\r\nmy package.json :\r\n```{\r\n  \"name\": \"manan\",\r\n  \"version\": \"1.0.0\",\r\n  \"description\": \"A minimal Electron application\",\r\n  \"main\": \"main.js\",\r\n  \"scripts\": {\r\n    \"start\": \"electron .\",\r\n    \"pack\": \"electron-builder --dir\",\r\n    \"dist\": \"electron-builder\",\r\n    \"buildWin\": \"electron-packager . WhatsBulker --platform=win32 --arch=x64 --electronVersion=13.1.7 --app-version=1.0.0 --build-version=2.0.0 --prune=false --overwrite=true && electron ./package.js\"\r\n  },\r\n  \"author\": \"manan\",\r\n  \"devDependencies\": {\r\n    \"electron\": \"^13.1.7\",\r\n    \"electron-builder\": \"^22.11.7\",\r\n    \"electron-winstaller\": \"^5.0.0\"\r\n  },\r\n  \"dependencies\": {\r\n    \"body-parser\": \"^1.19.0\",\r\n    \"ejs\": \"^3.1.6\",\r\n    \"electron-store\": \"^8.0.0\",\r\n    \"express\": \"^4.17.1\",\r\n    \"jquery\": \"^3.6.0\",\r\n    \"multer\": \"^1.4.2\",\r\n    \"node-fetch\": \"^2.6.1\",\r\n    \"underscore\": \"^1.13.1\",\r\n    \"venom-bot\": \"^3.0.21\",\r\n    \"xlsx\": \"^0.17.0\"\r\n  }\r\n}\r\n```\r\n\r\nEnvironment Details:\r\n\r\n```\r\nSystem:\r\n    OS: Windows 10 10.0.22000 //(Windows 11 Dev Channel)\r\n    CPU: (8) x64 Intel(R) Core(TM) i5-9300H CPU @ 2.40GHz\r\n    Memory: 764.69 MB / 7.88 GB\r\n  Binaries:\r\n    Node: 14.17.1 - C:\\Program Files\\nodejs\\node.EXE\r\n    Yarn: 1.22.10 - ~\\AppData\\Roaming\\npm\\yarn.CMD\r\n    npm: 7.17.0 - ~\\node_modules\\.bin\\npm.CMD\r\n```\r\n\r\n\r\n\r\nHere I am using venom-bot which has internal dependency of the sharp module.\r\n\r\nmy build command :\r\n`electron-packager . WhatsBulker --platform=win32 --arch=x64 --electronVersion=13.1.7 --app-version=1.0.0 --build-version=2.0.0 --prune=false --overwrite=true && electron ./package.js`\r\n\r\npackage.js (used to produce a installer):\r\n\r\n```\r\nvar installer = require('electron-winstaller');\r\nvar path      = require('path');\r\nconst dialog  = require('electron').dialog;\r\n\r\nconsole.log(\"packaging into a exe...\\n\");\r\nresultPromise = installer.createWindowsInstaller({\r\n    appDirectory:    './AppName-win32-ia32',\r\n    outputDirectory: './installers/final',\r\n    exe:             'AppName.exe',\r\n    setupExe:        'FinalExeName.exe',\r\n    noMsi:           true,\r\n    iconUrl:         'IconUrl',\r\n    setupIcon:       'IconPath'\r\n});\r\n\r\nresultPromise.then(function () {\r\n    console.log(\"Installer created\");\r\n    dialog.showMessageBox({\r\n        type:    'info',\r\n        title:   'electron-winstaller',\r\n        message: \"Installer created\",\r\n        buttons: ['ok']\r\n    });\r\n    require('electron').app.quit();\r\n});\r\n```\r\n\r\nSharp Version : sharp@0.28.3 \r\nLatest Version : sharp@0.28.3\r\n\r\nPlease help if anyone has figured out my problem. Thanks.\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2813/comments",
    "author": "manankarani",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-07-27T10:25:07Z",
        "body": "This is probably the same as #2764. The combo of Windows + Node-API + electron-rebuild isn't quite supported by Electron."
      }
    ]
  },
  {
    "number": 2812,
    "title": "get the output metadata before applying .toFile()",
    "created_at": "2021-07-26T15:07:50Z",
    "closed_at": "2021-08-19T14:42:25Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2812",
    "body": "when resizing an image like this:\r\n```\r\n// img is a Sharp instance, the original image is 500X500\r\nimg.resize(100).metadata().then(info=>console.log(info))\r\n```\r\nthe above code will log the original image metadata like this `{width: 500, ......}`\r\nto output the resized version to a file we can do the following\r\n```\r\nimg.resize(100).toFile('new-file.jpg').then(info=>console.log(info))\r\n```\r\nnow it logs the resized version metadata like this `{width: 100, ...}`\r\n\r\nthat's fine, but sometimes we need the new metadata to dynamically set the output file path like this\r\n\r\n```\r\nimg.resize.metadata().toFile(({input, output})=>{\r\n return `new-file/${input.width}X${input.height}-output.formal.input.format`\r\n})\r\n```\r\nnote that we used both the input and output metadata, and now `.toFile()` accepts a function instead of a string\r\n`.metadata()` now returns two objects, the original and new metadata.\r\n\r\nthe resizes dimensions may not be available when applying `.toFile()` because we can dismiss one of the two dimensions.\r\n\r\n\r\n`.on()` doesn't help, because it may emit after `.toFile()` finish its work, so it may be useless\r\n\r\n```\r\nimg.resize(100).on('info',meta=>meta).toFile(`file-${meta.width}X${meta.height}`)\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2812/comments",
    "author": "its-dibo",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-07-26T20:47:28Z",
        "body": "Hi, perhaps you could use a temporary file and rename?\r\n```js\r\nconst { rename } = require('fs/promises');\r\nconst temp = 'temp.jpg';\r\n\r\nsharp(input)\r\n  .resize(100)\r\n  .toFile(temp)\r\n  .then(({ width, height }) => rename(temp, `file-${width}X${height}.jpg`))\r\n  .then( ... );\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2021-08-19T14:42:25Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 2790,
    "title": "Provide synchronous calls",
    "created_at": "2021-07-10T11:32:57Z",
    "closed_at": "2021-08-19T14:44:52Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2790",
    "body": "My application was using synchronous calls.  Because of sharp, and its asynchronous calls, I have rewritten the application to run asynchronous.  This created a lot of extra microtasks, which slow down the overall execution of the application.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2790/comments",
    "author": "dilyanpalauzov",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-07-10T14:42:00Z",
        "body": "Is there a benchmark we can use to provide evidence of how much overhead is added by using async/await/Promises in the context of image processing? Have you tried using callbacks, which will avoid microtasks?"
      },
      {
        "user": "dilyanpalauzov",
        "created_at": "2021-07-10T15:03:58Z",
        "body": "Callbacks to do not help me, since I want to continue once the image processing is done.  There are no evidence for the image processing.  Irrespective of the image processing, when I rewrite my application to use asynchronous calls, it slows significantly down, even when no image processing is done.  Rewriting the application to use async functions is necessary, since the sharp functions are async."
      },
      {
        "user": "lovell",
        "created_at": "2021-08-19T14:44:52Z",
        "body": "I'd be happy to look into this further should someone provide evidence of how much overhead such microtasks add, but my assumption would be that there are much \"hotter\" code paths to optimise first. Closing for now, but please feel free to re-open with evidence if further help is required."
      }
    ]
  },
  {
    "number": 2776,
    "title": "PNG to JPEG: how to keep high quality",
    "created_at": "2021-06-30T15:19:13Z",
    "closed_at": "2021-06-30T19:35:23Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2776",
    "body": "Hello ! \r\n\r\nI'm trying to convert PNG image buffer to a JPEG image buffer.\r\nIt's working but I have a quality loss when I'm displaying the JPEG from Buffer.\r\n\r\nHere my simple code to convert PNG to JPEG:\r\n```javascript\r\nformatted = await sharp(pngImgBuffer)\r\n      .toFormat('jpeg')\r\n      .jpeg({ quality: 100, chromaSubsampling: '4:4:4', force: true })\r\n      .toBuffer(); // JPEG buffer\r\n```\r\n\r\nAnd the reading part (with resize):\r\n```javascript\r\nresized = await sharp(jpegImgBuffer)\r\n      .resize(width, height)\r\n      .toFormat('jpeg')\r\n      .jpeg({ quality: 100, chromaSubsampling: '4:4:4', force: true })\r\n      .toBuffer();\r\n```\r\n\r\nIs there something wrong in my code ? Or something else to do to improve the quality of the result ?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2776/comments",
    "author": "simon-tannai",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-06-30T15:39:13Z",
        "body": "PNG is a lossless format whereas JPEG is a lossy format, so you'll always lose some detail when encoding with the latter, even at maximum \"quality\".\r\n\r\n(This applies to all software that creates JPEG images, not just sharp.)"
      },
      {
        "user": "simon-tannai",
        "created_at": "2021-06-30T16:06:44Z",
        "body": "Many thanks @lovell  for your fast reply ! :) \r\n\r\nSo, I suppose I have to keep the PNG format or switch to the WebP format if I want to keep a good image quality ? "
      },
      {
        "user": "lovell",
        "created_at": "2021-06-30T18:27:35Z",
        "body": "If preventing any loss of original detail is important in your scenario, then yes, the use of PNG or lossless WebP will meet that need."
      },
      {
        "user": "simon-tannai",
        "created_at": "2021-06-30T19:35:23Z",
        "body": "Well, many thanks @lovell  👍 "
      }
    ]
  },
  {
    "number": 2749,
    "title": "Sharp have issue with pkg package",
    "created_at": "2021-06-10T09:34:45Z",
    "closed_at": "2021-07-10T20:16:15Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2749",
    "body": "I used sharp with pkg package ( pkg creates an exe file from an express app), but I received an error complaining about the sharp package. Can it be related to the node version used in sharp?\r\nany advice will be appreciated.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2749/comments",
    "author": "mohammadsultani",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-06-10T10:42:39Z",
        "body": "Please can you provide a complete, minimal, standalone repo that allows someone else to reproduce the problem."
      },
      {
        "user": "lovell",
        "created_at": "2021-07-10T20:16:15Z",
        "body": "Closing due to inactivity but please feel free to reopen with the requested details if further help is required."
      }
    ]
  },
  {
    "number": 2718,
    "title": " VipsJpeg: Corrupt JPEG data: premature end of data segment",
    "created_at": "2021-05-16T18:24:59Z",
    "closed_at": "2021-05-16T18:44:44Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2718",
    "body": "I am trying to resize an array of images here is my code:\r\nconst Sharp = require('sharp');\r\nconst fs = require('fs');\r\n\r\nconst transformer = Sharp().resize(300);\r\n\r\n\r\nconst addFoto = async (request, h) => {\r\n  const fotos = [].concat(request.payload.fotoFile);\r\n  const smallerFotos = Promise.all(fotos.map(async (foto) => {\r\n    const writeStream = fs.createWriteStream(foto.hapi.filename);\r\n    return foto.pipe(transformer).pipe(writeStream);\r\n  }));\r\nthe code works when the array length is one\r\nbut fails when more than file is in the array \r\nfiles are jpeg\r\nthanks\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2718/comments",
    "author": "mibuen",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-05-16T18:33:20Z",
        "body": "You'll need to create a new sharp instance per input.\r\n```diff\r\n- const transformer = Sharp().resize(300);\r\n+ const transformer = () => Sharp().resize(300);\r\n\r\n  const addFoto = async (request, h) => {\r\n  const fotos = [].concat(request.payload.fotoFile);\r\n  const smallerFotos = Promise.all(fotos.map(async (foto) => {\r\n  const writeStream = fs.createWriteStream(foto.hapi.filename);\r\n- return foto.pipe(transformer).pipe(writeStream);\r\n+ return foto.pipe(transformer()).pipe(writeStream);\r\n  }));\r\n```"
      },
      {
        "user": "mibuen",
        "created_at": "2021-05-16T18:44:44Z",
        "body": "it works!\r\nthank you very much"
      }
    ]
  },
  {
    "number": 2698,
    "title": "Error: extract_area: bad extract area if display not main display in Windows",
    "created_at": "2021-05-06T16:06:54Z",
    "closed_at": "2021-05-07T14:24:22Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2698",
    "body": "Hello. \r\n\r\n**Issue**: On a windows machine, when I am working with 2 displays, when I try to `extract` and then save `toBuffer` on a display which is not the main display, I get the following error: `Error: extract_area: bad extract area` . However, the same code works perfectly fine if I make that display as my main display.\r\n\r\n**Expected Behavior**: I want to be able to `extract` and save `toBuffer` on a display which is not the main display.\r\n\r\n**Sample Code**\r\n\r\n```\r\n    let bounds = { x: 2496, y: 25, width: 968, height: 702 }\r\n    const cropped = await sharp(screenshotImg);\r\n    const metadata = await cropped.metadata();\r\n    const height = Math.min(metadata.height,bounds.height);\r\n    const width = Math.min(metadata.width, bounds.width);\r\n    const left = Math.max(0, bounds.x);\r\n    const top = Math.max(0, bounds.y);\r\n    const result = cropped.extract({ left: left, top: top, width, height });\r\n    const bufferResult = await result.toBuffer();  // This line gives Error: extract_area: bad extract area\r\n    return sharp(bufferResult, { height, width, channels: 3 });\r\n```\r\nI checked that the extraction bounds are within the limits of the image that I am trying to extract from. \r\n\r\nAny help is appreciated. Please let me know if you require more info. Thanks",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2698/comments",
    "author": "samarth-bola",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-05-06T17:38:18Z",
        "body": "Please can you provide a sample input image that fails in this manner. Based on the sample code provided it should be at least 3464x727 in dimensions."
      },
      {
        "user": "samarth-bola",
        "created_at": "2021-05-06T18:13:14Z",
        "body": "> Please can you provide a sample input image that fails in this manner. Based on the sample code provided it should be at least 3464x727 in dimensions.\r\n\r\nThe input image is the screenshot of the display screen (resolution: 1200x1920) in .png format. So the dimensions of the input image is 1200x1920. That would be the same if its the main display or the secondary display. "
      },
      {
        "user": "lovell",
        "created_at": "2021-05-06T18:38:25Z",
        "body": "> I checked that the extraction bounds are within the limits of the image that I am trying to extract from.\r\n\r\nThe value of `left` in the code above will be 2496, which is already out of bounds for a 1200px wide image.\r\n\r\nPerhaps you could provide a sample repo with code and images that allows someone else to reproduce this."
      },
      {
        "user": "samarth-bola",
        "created_at": "2021-05-07T14:24:22Z",
        "body": "> > I checked that the extraction bounds are within the limits of the image that I am trying to extract from.\r\n> \r\n> The value of `left` in the code above will be 2496, which is already out of bounds for a 1200px wide image.\r\n> \r\n> Perhaps you could provide a sample repo with code and images that allows someone else to reproduce this.\r\n\r\nThe value of `left` was definitely the issue. It was out of bounds which was giving the error in the first place. Thanks a bunch for pointing it out."
      }
    ]
  },
  {
    "number": 2638,
    "title": "Metadata before and after Resize",
    "created_at": "2021-03-25T08:32:38Z",
    "closed_at": "2021-03-25T14:05:22Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2638",
    "body": "Hello, \r\n\r\nIs possible to get both metada from image resized in a single step ?\r\nIn other words, two metadata for same image, before and after resize, in a single step.\r\n\r\nTo get metadata after resize I use :\r\n\r\n```\r\n    sharp(imageBuffer)                              \r\n    \t.resize(800, 900, {                                           \r\n    \t\tfit: 'inside',                                              \r\n    \t\twithoutEnlargement: true                                    \r\n    \t})\r\n        .jpeg({ quality: 80 })\r\n    \t.toBuffer({ resolveWithObject: true })\r\n    \t.then(data => {\r\n               console.log(data);\r\n \t    })\r\n    \t.catch(err => {if (err) \r\n    \t{\r\n    \t    console.log(err);\r\n    \t    throw err;\r\n    \t}\r\n    });\r\n```\r\n\r\nTo get metada before resize I use `.metadata()`.\r\n\r\nBut how to get both metadata in a single step ?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2638/comments",
    "author": "softy2k",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-03-25T12:25:21Z",
        "body": "Perhaps try something like the following (untested):\r\n```js\r\nconst [ before, after ] = await Promise.all([\r\n  sharp(imageBuffer).metadata(),\r\n  sharp(imageBuffer).resize({ ... }).toBuffer({ resolveWithObject: true })\r\n]);\r\n```"
      },
      {
        "user": "softy2k",
        "created_at": "2021-03-25T13:24:05Z",
        "body": "Thanks **lovell**, work like a charm"
      }
    ]
  },
  {
    "number": 2589,
    "title": "JPG isn't progressive",
    "created_at": "2021-02-21T16:24:47Z",
    "closed_at": "2021-03-08T11:07:41Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2589",
    "body": "Hey,\r\nI'm using the following commands to manipulate a baseline JPG file and create a new one which should be progressive to.\r\n\r\n```\r\n     sharpInstance = sharp(filePath);\r\n     sharpInstance.rotate();\r\n     sharpInstance.resize({height: 2400, withoutEnlargement: true});\r\n     sharpInstance.toFormat(\"jpg\",{progressive:true});\r\n        \r\n     const buffer = await sharpInstance.toBuffer();\r\n     await sharp(buffer).toFile(filePath);\r\n```\r\n\r\nThe output file contains the following information:\r\n```\r\nfile test.jpg\r\ntest.jpg: JPEG image data, baseline, precision 8, 1800x2400, components 3\r\n```\r\n\r\nThe output file isn't progressive. I'm using version 0.27.1 and tested it on a Mac.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2589/comments",
    "author": "dnish",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-02-21T17:15:38Z",
        "body": "Hi, the contents of `buffer` will be a progressive JPEG, but `sharp(buffer).toFile(filePath)` processes that output via a new sharp instance, which will use the default of non-progressive output.\r\n\r\nTry:\r\n```diff\r\n- const buffer = await sharpInstance.toBuffer();\r\n- await sharp(buffer).toFile(filePath);\r\n+ await sharpInstance.toFile(filePath);\r\n```\r\nor:\r\n```diff\r\n- await sharp(buffer).toFile(filePath);\r\n+ await sharp(buffer).jpeg({ progressive: true }).toFile(filePath);\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2021-03-08T11:07:41Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 2549,
    "title": "What's the best way to do a buildpack of Sharp with mozjpeg and libimagequant on DigitalOcean App Platform?",
    "created_at": "2021-01-24T18:55:16Z",
    "closed_at": "2021-01-29T11:16:00Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2549",
    "body": "I have a small app to resize and optimize images and I'm trying to leave a dedicated server and move it to app platform of DigitalOcean. So I would like to understand what is the best way to install and mantain libvips with mozjpeg and libimagequant on app platform of DigitalOcean.\r\n\r\nThe package.json:\r\n\r\n```\r\n{\r\n    \"main\": \"src/server.js\",\r\n    \"scripts\": {\r\n        \"dev\": \"nodemon src/server.js\",\r\n        \"start\": \"node src/server.js\"\r\n    },\r\n    \"dependencies\": {\r\n        \"axios\": \"^0.21.1\",\r\n        \"cors\": \"^2.8.5\",\r\n        \"dotenv\": \"^8.2.0\",\r\n        \"express\": \"^4.17.1\",\r\n        \"helmet\": \"^4.4.1\",\r\n        \"imagemin\": \"^7.0.1\",\r\n        \"imagemin-gifsicle\": \"^6.0.1\",\r\n        \"nodemon\": \"^2.0.7\",\r\n        \"portfinder\": \"^1.0.28\",\r\n        \"sharp\": \"^0.27\"\r\n    },\r\n    \"engines\": {\r\n        \"node\": \">= 12.0.0\",\r\n        \"npm\": \">= 6.0.0\"\r\n    }\r\n}\r\n```\r\n\r\nThere is some way to using Sharp/libvips with mozjpeg and libimagequant without custom build, just with package.json and npm install?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2549/comments",
    "author": "nunowar",
    "comments": [
      {
        "user": "ArunJRK",
        "created_at": "2021-01-25T05:15:46Z",
        "body": "Same issue could not find a way to configure libvips with libimagequant. Do you know the general method of doing it?"
      }
    ]
  },
  {
    "number": 2532,
    "title": "Input buffer contains unsupported image format - only after comopsite",
    "created_at": "2021-01-13T18:19:52Z",
    "closed_at": "2021-01-14T07:54:36Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2532",
    "body": "I get this error message only after calling composite, here is my code:\r\n```\r\nvar png = sharp(buffer);\r\nvar data = await png.raw().toBuffer();\r\nvar alpha = Buffer.alloc(width * height);\r\n// ... some calculation to create alpha channel base on the data\r\npng.joinChannel(alpha, {\r\n    raw: {width, height, channels: 1}\r\n});\r\nif(createBluredLayer) {\r\n    var overlay = png.clone().blur(1)\r\n    png.composite([{\r\n        input: await overlay.toBuffer(),\r\n        top: 0,\r\n        left: 0,\r\n    }])\r\n}\r\nvar newBuffer = await png.toBuffer(); // this line triggers the error\r\n```\r\n\r\nSo, if createBluredLayer is false, all goes well, if it's true, I get the error when calling toBuffer().\r\nI don't understand how composite of the same image could change the format.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2532/comments",
    "author": "tan-tan-kanarek",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-01-13T19:02:27Z",
        "body": "In this code example, the response of `await overlay.toBuffer()` will be raw, uncompressed pixel data due to the use of `png.raw()` so you'll need to describe it via `raw`:\r\n\r\n```diff\r\npng.composite([{\r\n  input: await overlay.toBuffer(),\r\n+ raw: { width, height, channels },\r\n  top: 0,\r\n```\r\n\r\n"
      },
      {
        "user": "tan-tan-kanarek",
        "created_at": "2021-01-14T07:41:25Z",
        "body": "Thank you.\r\nI would like to optimize this code as much as possible as I do it a lot.\r\nIs there any difference, speed wise, if I create the overlay image using png.clone() or create a new one using the same buffer sharp(buffer)?"
      },
      {
        "user": "lovell",
        "created_at": "2021-01-14T07:54:36Z",
        "body": "`clone` is for Stream-based input, so if you're using Buffer-based input it probably won't help."
      },
      {
        "user": "tan-tan-kanarek",
        "created_at": "2021-01-14T09:01:30Z",
        "body": "I encounter now another error, composite2: images do not have same numbers of bands.\r\nMy new code looks as followed:\r\n```\r\nvar png = sharp(buffer);\r\nvar data = await png.raw().toBuffer();\r\nvar alpha = Buffer.alloc(width * height);\r\n\r\n// ... some calculation to create alpha channel base on the data\r\n\r\npng.joinChannel(alpha, {\r\n    raw: {width, height, channels: 1}\r\n})\r\n.png();\r\nif(createBluredLayer) {\r\n    var overlay = sharp(await png.toBuffer()).blur(1)\r\n    png.composite([{\r\n        input: await overlay.toBuffer(),\r\n        top: 0,\r\n        left: 0,\r\n    }])\r\n}\r\nvar newBuffer = await png.toBuffer(); // this line triggers the error\r\n```\r\n\r\nI want to use the calculated alpha channel on both layers, sharp one overlayed on blured one in order to create soft edges to the transparent image."
      }
    ]
  },
  {
    "number": 2524,
    "title": "Error TypeError: Cannot destructure property 'width' of 'image.bitmap' as it is undefined",
    "created_at": "2021-01-09T12:08:26Z",
    "closed_at": "2021-01-09T17:08:59Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2524",
    "body": "What are you trying to achieve?\r\nI was trying to resize images with the options that get passed through my API. The options are `width` and `height`.\r\n\r\nHave you searched for similar questions?\r\n- No.\r\n\r\nAre you able to provide a minimal, standalone code sample that demonstrates this question?\r\nExample code\r\n```\r\n// imageProcessor is `sharp` being injected as a dependency\r\nconst imageToResize = await imageProcessor(filepath)\r\n      .resize({ width: modifiedWidth, height: modifiedHeight })\r\n      .toFile(outputFile)\r\n```\r\n`modifiedWidth` and `modifiedHeight` are the `width` and `height` values that I convert to numbers using the `Number()` object wrapper.\r\n\r\nAre you able to provide a sample image that helps explain the question?\r\n- No.\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2524/comments",
    "author": "iyosayi",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2021-01-09T15:44:58Z",
        "body": "Please can you provide a *complete*, minimal, standalone code sample that demonstrates this question? I suspect the error is occurring in code not shown here."
      },
      {
        "user": "iyosayi",
        "created_at": "2021-01-09T17:08:59Z",
        "body": "Okay, you were right, I did a little more digging and found the error. Closing this issue."
      }
    ]
  },
  {
    "number": 2507,
    "title": "Excluding some metadata",
    "created_at": "2020-12-30T12:40:51Z",
    "closed_at": "2021-01-20T21:16:44Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2507",
    "body": "Is it possible to specify which metadata to include when using (.withmetadata), in my case I need to exclude XMP?\r\n\r\nYour help will be highly appreciated.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2507/comments",
    "author": "abdul-ashour",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-12-30T13:31:01Z",
        "body": "Please see #650"
      },
      {
        "user": "chrs-myrs",
        "created_at": "2020-12-30T13:50:17Z",
        "body": "What we need to do here is remove the EXIF embedded thumbnails.  They add several kb to each image after resizing, which is not great when you are trying to efficiently server 100's of millions of images each day.  Perhaps this would be better served by allowing sharp to control the stripping/generation of thumbnails"
      },
      {
        "user": "lovell",
        "created_at": "2021-01-20T21:16:44Z",
        "body": "Please subscribe to #650 for updates."
      }
    ]
  },
  {
    "number": 2488,
    "title": "Affine chained with extract does not seem to work",
    "created_at": "2020-12-18T07:00:37Z",
    "closed_at": "2021-01-26T12:57:12Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2488",
    "body": "With \r\n```\r\nlet s = sharp(source); // 1920x1080px image\r\ns.affine([\r\n                    [2, 0],\r\n                    [0, 2],\r\n                ])\r\n.extract({\r\n                width: 1000,\r\n                height: 1000,\r\n                left:0,\r\n                top: 0,\r\n            })\r\ntoFile('out/affine_test.jpg')\r\n```\r\n\r\nI get a jpg that is 2000x2000px. The extracted area is top left as expected, but twice as big.\r\n\r\nIs this a bug, or am I not understanding Sharp correctly?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2488/comments",
    "author": "casperno",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-12-18T16:59:00Z",
        "body": "Hi, you'll need to split this into two pipelines, something like:\r\n```js\r\nsharp(source)\r\n  .affine([\r\n    [2, 0],\r\n    [0, 2],\r\n  ])\r\n  .toBuffer()\r\n  .then((data) =>\r\n    sharp(data)\r\n      .extract({\r\n        width: 1000,\r\n        height: 1000,\r\n        left: 0,\r\n        top: 0,\r\n      })\r\n      .toFile(\"out.jpg\")\r\n  );\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2021-01-26T12:57:12Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      },
      {
        "user": "casperno",
        "created_at": "2021-01-26T13:01:26Z",
        "body": "Hi, \r\n\r\nSorry for not responding before. \r\nThanks, your answer is clarifying. But I still can't see when you need to split into a new pipeline. \r\nI'm using Sharp to generate frames for video, so speed is of the essens — another pipe seems to double processing time."
      }
    ]
  },
  {
    "number": 2464,
    "title": "Question",
    "created_at": "2020-11-26T21:19:00Z",
    "closed_at": "2020-12-22T13:03:23Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2464",
    "body": "Is it possible to reduce RAM usage by Sharp?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2464/comments",
    "author": "ghost",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-11-27T08:50:28Z",
        "body": "Please see #955 for the canonical discussion about this."
      },
      {
        "user": "lovell",
        "created_at": "2020-12-22T13:03:23Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 2445,
    "title": "VipsJpeg: Invalid SOS parameters for sequential",
    "created_at": "2020-11-18T11:18:28Z",
    "closed_at": "2020-11-18T11:37:47Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2445",
    "body": "Hi, I use sharp (javascript) to resize images to webp and jpg from time to time I get this error without any idea why this is happening:\r\n\r\nERROR\tcatch message : VipsJpeg: Invalid SOS parameters for sequential JPEGVipsJpeg: out of order read at line 0vips2png: unable to write to target\r\n\r\nDoes somebody know why it's happening?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2445/comments",
    "author": "gilcohen",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-11-18T11:37:47Z",
        "body": "Please see #1578\r\n```js\r\nsharp(input, { failOnError: false })...\r\n```"
      }
    ]
  },
  {
    "number": 2442,
    "title": "Webp vs. JPEG sizes?",
    "created_at": "2020-11-15T21:45:42Z",
    "closed_at": "2020-11-27T14:00:23Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2442",
    "body": "I am a newbie for image processing.  To my understanding, webp is supposed to have smaller size than jpeg.  However, from my experiment, this is not the case after converting to both format using Sharp.\r\n\r\nI am actually getting smaller sizes when converting to JPEG.  \r\nHere is my configurations:\r\n```\r\nsharp().resize({ width: 300 }).jpeg({ quality: 100 })\r\nsharp().resize({ width: 300 }).webp({ lossless: true })\r\n```\r\nOriginal PNG size is 937 KB.\r\nConverted JPEG is 408.7 KB\r\nConverted WEBP is 584.9 KB\r\n\r\nFor resized smaller images are the same result.  \r\nAm I missing something or this is expected?\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2442/comments",
    "author": "RoosterH",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-11-16T11:59:58Z",
        "body": "Hi, JPEG is always lossy, even at a \"quality\" of 100.\r\n\r\nA fairer comparison might be:\r\n```diff\r\n  sharp().resize({ width: 300 }).jpeg({ quality: 100 })\r\n- sharp().resize({ width: 300 }).webp({ lossless: true })\r\n+ sharp().resize({ width: 300 }).webp({ quality: 100 })\r\n```"
      },
      {
        "user": "RoosterH",
        "created_at": "2020-11-16T17:27:45Z",
        "body": "lovell,\r\n\r\nThanks a lot.  After trying \r\n```\r\n sharp().resize({ width: 300 }).webp({ quality: 100 })\r\n```\r\nThe size was reduced to 217.3 KB.  This indeed is a great reduction!"
      }
    ]
  },
  {
    "number": 2407,
    "title": "Consuming a lot of memory while processing images",
    "created_at": "2020-10-11T16:51:35Z",
    "closed_at": "2020-11-05T10:54:50Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2407",
    "body": "Unfortunately I do not speak English well. therefore I am writing through a translator.\r\nWhen I use sharp for image processing and turn off the cache, each image takes up memory.\r\nTracking memory consumption via pm2. And when I load a large image through api, it can increase memory consumption by 15-20mb.\r\n\r\nNode: 14.11.0\r\n\r\n```js\r\nconst sharp = require('sharp');\r\nsharp.cache(false);\r\n///\r\nawait sharp(_image[0].data).jpeg({ progressive: true }).toBuffer()\r\n                    .then(async (buffer) => {\r\n                        await fs.writeFile(`${workspaceRoot}/public/publication_${_datetime}_user${_id}_350_350.jpeg`, await sharp(buffer).resize(350, 350).toBuffer());\r\n                        return await fs.writeFile(`${workspaceRoot}/public/publication_${_datetime}_user${_id}_orig.jpeg`, buffer)\r\n                    })\r\n```\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2407/comments",
    "author": "Artur-Frank",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-10-11T17:27:46Z",
        "body": "Hi, did you see #955, which is the canonical guide to perceived memory issues? If not, please make sure you've read and understood all of it."
      },
      {
        "user": "lovell",
        "created_at": "2020-11-05T10:54:50Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 2392,
    "title": "await does not work?",
    "created_at": "2020-10-02T00:45:11Z",
    "closed_at": "2020-10-02T16:02:17Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2392",
    "body": "My code:\r\n\r\n```\r\nconst fs = require('fs');\r\nconst sharp = require('sharp');\r\n\r\nconst src = '/tmp/input.jpg';\r\nconst dst = '/tmp/output.jpg';\r\n\r\n(async () => {\r\n    await sharp(src).resize(100, 100).toFile(dst);\r\n    await fs.chmod(dst, 0o666);\r\n})();\r\n\r\n```\r\nI have got an error:\r\n`exception: Error: ENOENT: no such file or directory, chmod '/tmp/output.jpg'`\r\n\r\nIt looks like chmod runs before the sharp has been done its job.\r\n\r\nAny ideas?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2392/comments",
    "author": "m00nk",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-10-02T08:47:42Z",
        "body": "Hi, `fs.chmod` does not return a Promise, so this might be the cause. Perhaps add a try/catch block around each use of `await`?"
      },
      {
        "user": "m00nk",
        "created_at": "2020-10-02T11:26:10Z",
        "body": "I have tried this:\r\n\r\n```\r\n(async () => {\r\n    await sharp(src).resize(100, 100).toFile(dst);\r\n    await fs.promises.chmod(dst, 0o666);\r\n})();\r\n```\r\n\r\nand had the same result - chmod runs before the output file has been created."
      },
      {
        "user": "lovell",
        "created_at": "2020-10-02T11:42:58Z",
        "body": "Please can you provide complete information about the versions, platform, OS etc. involved."
      },
      {
        "user": "m00nk",
        "created_at": "2020-10-02T12:39:44Z",
        "body": "Linux Mint (Ubuntu), Node 12.18, sharp 0.26.0"
      },
      {
        "user": "lovell",
        "created_at": "2020-10-02T12:59:06Z",
        "body": "Thanks, I cannot reproduce this. Is there anything unusual about the /tmp filesystem on this machine? Does using a non-tmp path work? What happened when you added the separate try/catch blocks around each use of await?"
      },
      {
        "user": "m00nk",
        "created_at": "2020-10-02T14:03:02Z",
        "body": "I have found very strange behavior. The code:\r\n\r\n```js\r\nconsole.log('START');\r\n\r\nconst proc = sharp(srcImg);\r\n// some other code is here\r\nproc\r\n\t.toFile(dstImg)\r\n\t.then(info => { console.log('INFO', info);})\r\n\t.catch(err => { console.log('ERR', err);});\r\n\r\ntry{\r\n\tawait proc;\r\n\tconsole.log('DONE PROC');\r\n}\r\ncatch(e){ console.log('EXCEPTION', e); }\r\n\r\nconsole.log('FINISHED');\r\n```\r\n\r\nI have got:\r\n```\r\nSTART\r\nDONE PROC\r\nFINISHED\r\nINFO {\r\n   format: 'jpeg',\r\n   width: 250,\r\n   height: 90,\r\n   channels: 3,\r\n   premultiplied: false,\r\n   size: 8098\r\n }\r\n```\r\n\r\nSo last console.log runs before the image has been created. But if I use \"the chain\" like:\r\n\r\n```js\r\nconst proc = sharp(srcImg)\r\n\t.toFile(dstImg)\r\n\t.then(info => {\tconsole.log('INFO', info);\t})\r\n\t.catch(err => {\tconsole.log('ERR', err);\t});\r\n```\r\ninstead of\r\n```js\r\nconst proc = sharp(srcImg);\r\nproc.toFile(dstImg)\r\n\t.then(info => { console.log('INFO', info);})\r\n\t.catch(err => { console.log('ERR', err);});\r\n```\r\nI have got:\r\n\r\n```\r\nSTART\r\nINFO {\r\n   format: 'jpeg',\r\n   width: 250,\r\n   height: 90,\r\n   channels: 3,\r\n   premultiplied: false,\r\n   size: 8098\r\n}\r\nDONE PROC\r\nFINISHED\r\n```\r\n\r\nIn this way all works right - last console.log runs AFTER the image has been created.\r\n\r\nCan you explain this behaviour? I am not very good in JS, so maybe I do something wrong, but in my opinion that behoviour is very odd. \r\n\r\nThank you.\r\n\r\nPS.\r\nAll code above placed inside async function. "
      },
      {
        "user": "lovell",
        "created_at": "2020-10-02T14:12:50Z",
        "body": "Your code is mixing up Promise chains and await/try/catch notation.\r\n\r\nThe call to `toFile()` returns a Promise, so that's what you must `await`, e.g. `await proc.toFile(dstImg)`\r\n\r\nYou can't await a sharp instance itself, so e.g. `await proc` is incorrect (it resolves straight away)."
      },
      {
        "user": "m00nk",
        "created_at": "2020-10-02T15:40:20Z",
        "body": "Ah, yes. Thank you ))"
      }
    ]
  },
  {
    "number": 2381,
    "title": "Help for improve the performance on composite",
    "created_at": "2020-09-23T08:33:13Z",
    "closed_at": "2020-10-13T04:05:33Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2381",
    "body": "Hi, I'm using `sharp` for add markers on image and this part take 3-4 seconds.\r\n\r\nI found that too slow, Do you have an improvement for reduce this time.\r\n\r\n```js\r\n  const image = sharp(input);\r\n  const composites = positions.map((item) => {\r\n    return {\r\n      input: item.number ? getTaskPin(item.number) : getPointer(),\r\n      top: item.x,\r\n      left: item.y,\r\n    };\r\n  });\r\n\r\n  return image\r\n    .metadata()\r\n    .then(function (metadata) {\r\n      const orientation = isLandscape(metadata.width, metadata.height);\r\n\r\n      return image\r\n        .composite(composites)\r\n        .rotate(orientation ? 90 : 0)\r\n        .sharpen()\r\n        .jpeg()\r\n        .toBuffer();\r\n    });\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2381/comments",
    "author": "fbonhomm",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-09-23T10:56:36Z",
        "body": "Hi, did you see #2286 ?"
      }
    ]
  },
  {
    "number": 2378,
    "title": "Pseudo error: Image to composite must have same dimensions or smaller.",
    "created_at": "2020-09-22T17:27:42Z",
    "closed_at": "2020-09-23T10:00:14Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2378",
    "body": "The operation `composite` should allow greater images than the source image.\r\nIt should use the source image dimensions.\r\n\r\nFor example: \r\n\r\n```js\r\nappIcon = appIcon.composite([{ input: badge }]);\r\n```\r\n\r\nBtw.: The badge is a svg of square 1024px. The app icon too. Same size and I get the error:\r\n`Error: Image to composite must have same dimensions or smaller`\r\nBut regardless of this \"bug\" it should just do the job using the appIcon dimensions.\r\n\r\nBackground: I have an app icon and want to overlay a badge image. In this case a svg with transparent background.\r\n\r\nI use `Buffer.from('<svg>...</svg>')` to create the image. And general it works with other operations.\r\nIf I resize it using `sharp(theBuffer).resize(1024, 1024).toBuffer()` the `composite` throws an error: \r\n`Unsupported input object.` 🤔 Weird... (both are buffers)\r\n\r\nUsing `sharp(theBuffer).png()` throws:\r\n`Expected width, height and channels for raw pixel input`\r\n\r\nI have no idea how to achieve the overlay composite operation.\r\n`sharp(input).composite([{ input: mask, blend: 'dest-in' }])` works. (another image with rounded corners.)\r\n\r\nVersion: `0.23.4` (because Node 10.x)\r\n\r\nMaybe this issue should get the label \"bug\", because both images has the same size of 1024 x 1024 px and it throws: `Image to composite must have same dimensions or smaller`\r\n\r\n`sharp(badge).toFile('test.png');` Creates a file with 1024x1024px. Same format like the app icon. But it does not work.\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2378/comments",
    "author": "infacto",
    "comments": [
      {
        "user": "chrisdeely",
        "created_at": "2020-09-22T18:37:06Z",
        "body": "Can you post a bit more of your sample code? It may be easier to diagnose in context. I just had a similar issue with the `Unsupported input object.` error and found that I was passing a `sharp` object instead of a `Buffer`.\r\n\r\nI am having a potentially similar issue with `composite()` as I want to overlay a small image on top of a larger background, but want to use a blur mode which will keep the overlay pixels intact. I attempted to use `source` which seems like it should work, but it actually removes all of the background image's pixels because the overlay image does not contain any data at those locations."
      },
      {
        "user": "lovell",
        "created_at": "2020-09-22T19:30:36Z",
        "body": "The most recent v0.26.1 of sharp supports Node.js 10 - please upgrade.\r\n\r\nIf you're still having problems please provide complete, standalone code and input images that might allow someone else to reproduce this."
      },
      {
        "user": "infacto",
        "created_at": "2020-09-23T09:17:00Z",
        "body": "Ok, I installed the version `0.26.1` now, with the same problem. (Node `10.22.0` Window 10 `2004`)\r\nI also decreased the overlay image to 420 x 420 px for the 1024 x 1024 px source image.\r\n\r\n> Error: Image to composite must have same dimensions or smaller\r\n\r\nI created a demo, but I cannot reproduce the bug there. Weird, because it's the same, except for the unrelated environment. 😞 Same images, same node version, same sharp version, same code. I also worked with sharp with such files before. I like it. But this bug is really annoying. I've wasted hours. ... I already reinstalled the `node_modules` and `package-lock.json`. ... I continue the debugging and post the result here.\r\n\r\nShort background at this moment. (Uploading demo project planned...)\r\n\r\n- App icon with size 1024 x 1024 px PNG.\r\n- Badge overlay 420 x 420 px (also tested with 1024 x 1024 px) transparent background. SVG\r\n\r\nSharp command:\r\n\r\n```js\r\nicon.composite([{ input: badge, top: 0, left: 0, blend: 'over' }])\r\n```\r\n\r\nIt works in the demo project, but not in my productive project. The error is just a lie.\r\nI also cropped the SVG. Because the elements (e.g. path) was overflow the viewport. This should not and was not the problem. ... I'm not allowed to upload the affected project. And the demo project - with the same code and images - does not have the bug. I going insane. 😭 ^^ ... debugging in progress. Is there a cache outside of the project but related to it? 🤔 \r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"
      },
      {
        "user": "infacto",
        "created_at": "2020-09-23T10:00:12Z",
        "body": "Ok 😓 I found the problem. It was the chained methods of sharp to resize the image. This is weird, because I thought that the resize after composite does not affect to the composite operation. My solution is to convert it to buffer between composite and resize.\r\n\r\n**does not work**\r\n\r\n```js\r\nconst badge = createBadge(); /* buffer */\r\nlet icon = sharp('./icon.png');\r\nicon = icon.composite([{ input: badge, top: 0, left: 0, blend: 'over' }]);\r\nicon = icon.resize(200, 200);\r\nicon.png().toFile('./result.png');\r\n```\r\n\r\nBecause the resize only affect to the source image. The composite seems to be completed after the resize. You can see it if you resize it with a size of greater that the badge. e.g. resize it to 512 px. You see that the badge is not resized.\r\n\r\n**this works**\r\n\r\n```js\r\nconst badge = createBadge(); /* buffer */\r\nlet icon = await sharp('./icon.png').toBuffer();\r\nicon = await sharp(icon).composite([{ input: badge, top: 0, left: 0, blend: 'over' }]).toBuffer();\r\nicon = await sharp(icon).resize(200, 200).toBuffer();\r\nsharp(icon).png().toFile('./result.png');\r\n```\r\n\r\nUse `toBuffer` to snapshot the state.\r\nQ: Why not chained directly? A: Because if-conditions in the original code.\r\nQ: Why does my demo project work? You said: Same code. A: Yes, but focused on the composite method, because this was the error. I successively tested the code. I resized a lot of icons for Android. And some of them are smaller than the badge. And I didn't know that the composite is executed after resize, even if the order is composite().resize(). ...\r\n\r\nAgain: The resize after composite resizes the source image (icon) only. And the composite is executed after that. In this case, the resize method changed the size of the source image to 200px and executes the composite with the badge of 420px.\r\nNote that `toBuffer` is async. I think this is the reason for sharp to behave like that. But I'm sure someone else can explain this better. Anyway... It works now. It's great that sharp can use svg and composite for dynamic auto-generated stuff. ❤️ \r\n"
      },
      {
        "user": "grdnkln",
        "created_at": "2021-01-03T04:42:14Z",
        "body": "I've been struggling with this for days. Thank you for your insight and letting me finally solve the issue.\r\n\r\nI was trying to create a dynamic \"compass\" with a red arrow overlayed ontop using code like the below:\r\n\r\n```        // Generate a compass graphic\r\n        newimage = await sharp(imgdir + '/sprites/compass.png')\r\n            .flatten()\r\n            .composite([{input: imgdir + '/sprites/redarrow.png'}])\r\n            .resize(icon_size, icon_size)\r\n            .raw()\r\n            .toBuffer()\r\n```\r\n\r\nAnd I was constantly getting the \"Image to composite must have same dimensions or smaller\", even though the 'redarrow.png' file was definitely smaller than 'compass.png'. Like you I was assuming that doing a resize() after the composite() wouldn't affect anything.\r\n\r\nChanged my code to the following and it works fine:\r\n\r\n```        // Generate the compass graphic\r\n        compass2 = await sharp(imgdir + '/sprites/compass.png')\r\n            .composite([{input: imgdir + '/sprites/redarrow.png'}])\r\n            .toBuffer()\r\n\r\n       newimage = await sharp(compass2)\r\n            .flatten()\r\n            .resize(icon_size, icon_size)\r\n            .raw()\r\n            .toBuffer()\r\n```\r\n\r\nI don't understand why this is the case, it seems like a bug to me.\r\n\r\n"
      },
      {
        "user": "jeanbmar",
        "created_at": "2021-06-18T10:43:28Z",
        "body": "@lovell the issue was probably closed too fast by the author.  \r\nCalling `composite(...).resize(...).png()` (and possibly other methods considering @grdnkln example) will trigger an error if the post-composite image size is smaller than the composite input image size.\r\nLooks like composite is applied after every other change in the chain."
      },
      {
        "user": "lovell",
        "created_at": "2021-06-18T15:53:54Z",
        "body": "You'll need to use two pipelines when resizing and compositing."
      },
      {
        "user": "june07",
        "created_at": "2021-11-15T19:13:09Z",
        "body": "> You'll need to use two pipelines when resizing and compositing.\r\n\r\nJust ran into this myself.  Great project by the way... thanks.  Is that documented somewhere and I just missed it?  "
      },
      {
        "user": "foaudkajj",
        "created_at": "2022-02-25T07:17:30Z",
        "body": "I have struggled with this problem for hours.\r\nThanks.\r\n\r\n\r\n> Ok 😓 I found the problem. It was the chained methods of sharp to resize the image. This is weird, because I thought that the resize after composite does not affect to the composite operation. My solution is to convert it to buffer between composite and resize.\r\n> \r\n> **does not work**\r\n> \r\n> ```js\r\n> const badge = createBadge(); /* buffer */\r\n> let icon = sharp('./icon.png');\r\n> icon = icon.composite([{ input: badge, top: 0, left: 0, blend: 'over' }]);\r\n> icon = icon.resize(200, 200);\r\n> icon.png().toFile('./result.png');\r\n> ```\r\n> \r\n> Because the resize only affect to the source image. The composite seems to be completed after the resize. You can see it if you resize it with a size of greater that the badge. e.g. resize it to 512 px. You see that the badge is not resized.\r\n> \r\n> **this works**\r\n> \r\n> ```js\r\n> const badge = createBadge(); /* buffer */\r\n> let icon = await sharp('./icon.png').toBuffer();\r\n> icon = await sharp(icon).composite([{ input: badge, top: 0, left: 0, blend: 'over' }]).toBuffer();\r\n> icon = await sharp(icon).resize(200, 200).toBuffer();\r\n> sharp(icon).png().toFile('./result.png');\r\n> ```\r\n> \r\n> Use `toBuffer` to snapshot the state. Q: Why not chained directly? A: Because if-conditions in the original code. Q: Why does my demo project work? You said: Same code. A: Yes, but focused on the composite method, because this was the error. I successively tested the code. I resized a lot of icons for Android. And some of them are smaller than the badge. And I didn't know that the composite is executed after resize, even if the order is composite().resize(). ...\r\n> \r\n> Again: The resize after composite resizes the source image (icon) only. And the composite is executed after that. In this case, the resize method changed the size of the source image to 200px and executes the composite with the badge of 420px. Note that `toBuffer` is async. I think this is the reason for sharp to behave like that. But I'm sure someone else can explain this better. Anyway... It works now. It's great that sharp can use svg and composite for dynamic auto-generated stuff. ❤️\r\n\r\n"
      },
      {
        "user": "zenstok",
        "created_at": "2023-03-10T17:40:47Z",
        "body": "I can confirm as well, if you try to apply resize on a composite image it will not work even though you know the images are the same size or lower.\r\nIn my case this didn't work:\r\n```\r\nsharp(sharpLayers.shift())\r\n  .composite(sharpLayers)\r\n  .resize({ width: 640, height: 860 })\r\n  .toFile(`output.png`);\r\n  ```\r\n\r\nBut this worked:\r\n```\r\nsharp(sharpLayers.shift())\r\n  .composite(sharpLayers)\r\n  .toBuffer()\r\n  .then((buffer) =>\r\n    sharp(buffer)\r\n      .resize({ width: 640, height: 860 })\r\n      .toFile(`output.png`),\r\n  );"
      }
    ]
  },
  {
    "number": 2345,
    "title": "Gaussian Noise in sharp",
    "created_at": "2020-08-28T14:32:09Z",
    "closed_at": "2020-08-31T18:14:37Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2345",
    "body": "I'm trying to add gaussian noise an image but can't find the function in sharp.js.\r\nIt exists in libvips, but can it also be added to / accessed from sharp.js?\r\n\r\nI'm pretty new here and still finding my way, so please do redirect me if needed. Thanks in advance!",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2345/comments",
    "author": "jbveepee",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-08-28T17:51:23Z",
        "body": "Hi, did you see #725 ?"
      },
      {
        "user": "jbveepee",
        "created_at": "2020-08-31T14:06:46Z",
        "body": "Hi Mr. Lovell, thanks for your reply. Would it be better to reply on 725?\r\nAgain, new to git... Apologies if this is bad form.\r\n\r\nI came across 725 Thursday but did not know what to do with the information. At this point I'm only trying to get conclusive information on whether it is currently possible. 725 states a dependency on #470. (Resolved since 01/04/2017) and is marked as an enhancement mentioning it needs exposing from libvips.\r\n\r\nIf it's not possible yet, I'm happy to try and contribute though I do not know C... Willing to give it a good old try though. :-)\r\n\r\nAll the best!"
      },
      {
        "user": "lovell",
        "created_at": "2020-08-31T18:14:37Z",
        "body": "#725 is a future possible enhancement. PRs are always welcome If you're able to help.\r\n\r\nI'll close this issue - let's continue to track this at #725. "
      }
    ]
  },
  {
    "number": 2328,
    "title": "store the base64 images",
    "created_at": "2020-08-18T14:08:44Z",
    "closed_at": "2020-08-19T09:07:56Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2328",
    "body": "I have a `base64` image in my request and want to store this on the file as `png` file \r\n\r\nHow should I do this?\r\n\r\nIn document I read it said I should send file to the `sharp` and as you know `base64` is just an string and I need to store data as `png` or `jpg` file on server",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2328/comments",
    "author": "farshadfahimi",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-08-18T15:53:44Z",
        "body": "Please see #104"
      }
    ]
  },
  {
    "number": 2323,
    "title": "image upload problem",
    "created_at": "2020-08-15T06:56:18Z",
    "closed_at": "2020-08-15T13:05:14Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2323",
    "body": "Here is my code for image resize upload.\r\n(nodjs chat program)\r\nbut I have problem windows10/chrom84 , ie11 and edge brower.(desktop)\r\ndevtools says \"net::ERR_CONTENT_LENGTH_MISMATCH 200 (OK)\"\r\nimages file resize o.k and file saves o.k\r\nbut in browser shows broken images, so I refresh the browser, then show images.\r\nsmall images file upload are o.k but large images files sometimes have problem (over 1,2 ~10mb)\r\nso, I removed line where sharp resizing code. It's all right.\r\n\r\ndose anyone have idea?\r\n\r\n------------------------------------------\r\n\r\nconst imageUpload = async(data) => {\r\n    const { IMAGEPATH } = require('../path');\r\n\r\n    let extras = {};\r\n\r\n    if (data.messageData.message.extras) {\r\n        for (let i = 0; i<data.messageData.message.extras.length; i++) {\r\n            const FileName = data.messageData.channel + '/' + Date.now() + i + \".png\";\r\n\r\n            await fs.writeFileSync(IMAGEPATH + data.chat.path + FileName, data.messageData.message.extras[i], \"binary\", (err) => {\r\n                if (err) throw err;\r\n            });\r\n\r\n            await sharp(IMAGEPATH + data.chat.path + FileName)\r\n                .rotate()\r\n                .resize({\r\n                    width: 800\r\n                })\r\n                .toBuffer((err, buffer) => {\r\n                    fs.writeFileSync(IMAGEPATH + data.chat.path + FileName, buffer, (e) => {\r\n                        if (e) throw e;\r\n                    });\r\n                });\r\n\r\n            extras[i] = FileName;\r\n        }\r\n    }\r\n\r\n    return extras;\r\n};\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2323/comments",
    "author": "aramis2345",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-08-15T13:05:14Z",
        "body": "This looks like a networking problem unrelated to sharp. Perhaps try Stack Overflow or similar."
      }
    ]
  },
  {
    "number": 2316,
    "title": "Error: Expected width, height and channels for raw pixel input",
    "created_at": "2020-08-11T14:54:44Z",
    "closed_at": "2020-08-25T21:20:27Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2316",
    "body": "I need to calculate the size of the image, create a square with size based on images' size and then put image on created square\r\n\r\nGetting an error with that code:\r\n`Error: Expected width, height and channels for raw pixel input`\r\n\r\n```js\r\nconst sharp = require('sharp');\r\n\r\nconst testImg = sharp('test.jpg');\r\n\r\nconst imgMin = 800;\r\n\r\ntestImg.metadata()\r\n    .then(function (metadata) {\r\n    let imgMax = imgMin > metadata.width && imgMin > metadata.height ?\r\n    imgMin : metadata.width > metadata.height ? metadata.width : metadata.height;\r\n    return sharp({\r\n        create: {\r\n            width: imgMax,\r\n            height: imgMax,\r\n            channels: 3,\r\n            background: {r: 0, g: 255, b: 255}\r\n        }\r\n    })\r\n    .jpeg()\r\n    .toBuffer();\r\n}).then( function (data) {\r\n    sharp(data)\r\n    .composite([{\r\n        input: testImg,\r\n        gravity: 'centre'\r\n    }]).jpeg()\r\n});\r\n\r\n```\r\n\r\nWhen I'm trying to set raw options, I'm getting an error:\r\n`Error: Unsupported input '[object Object]' of type object when also providing options of type object`\r\n\r\nPart of code with raw parameters:\r\n```js\r\n.then( function (data) {\r\n    sharp(data)\r\n    .composite([{\r\n        input: testImg,\r\n        gravity: 'centre',\r\n        raw: {\r\n            width: 800,\r\n            height: 800,\r\n            channels: 3\r\n        }\r\n    }]).jpeg()\r\n});\r\n\r\n```\r\n\r\n\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2316/comments",
    "author": "vladizs",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-08-12T12:47:13Z",
        "body": "Hi, the `input` parameter of `composite` accepts a Buffer or a String but you're trying to pass a sharp instance.\r\n\r\n```diff\r\n- input: testImg,\r\n+ input: 'test.jpg',\r\n```\r\n\r\nIf the image you're passing is JPEG (and therefore not raw, uncompressed pixel data) then you don't need to provide `raw` as an parameter."
      },
      {
        "user": "lovell",
        "created_at": "2020-08-25T21:20:27Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 2308,
    "title": "Videos with sharp",
    "created_at": "2020-07-26T14:54:45Z",
    "closed_at": "2020-07-26T20:03:41Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2308",
    "body": "Hello,\r\n\r\nIs possible to use **sharp** to resize videos in **.mp4** extension?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2308/comments",
    "author": "lucianoacsilva",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-07-26T20:03:41Z",
        "body": "No. A tool such as `ffmpeg` would be appropriate for this."
      }
    ]
  },
  {
    "number": 2304,
    "title": "Calling Sharp inside a worker",
    "created_at": "2020-07-21T20:56:55Z",
    "closed_at": "2020-07-22T06:54:14Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2304",
    "body": "First time Sharp is initialize inside the worker everythings works like charm.\r\nSecond time i've this error\r\n```\r\n(sharp:202758): GLib-GObject-WARNING **: 21:52:58.828: cannot register existing type 'VipsObject'\r\n\r\n(sharp:202758): GLib-CRITICAL **: 21:52:58.828: g_once_init_leave: assertion 'result != 0' failed\r\n\r\n(sharp:202758): GLib-GObject-CRITICAL **: 21:52:58.828: g_type_register_static: assertion 'parent_type > 0' failed\r\n\r\n(sharp:202758): GLib-CRITICAL **: 21:52:58.828: g_once_init_leave: assertion 'result != 0' failed\r\n\r\n```\r\n\r\nWhat is the output of running `npx envinfo --binaries --system`?\r\n\r\n System:\r\n    OS: Linux 5.4 Ubuntu 20.04 LTS (Focal Fossa)\r\n    CPU: (4) x64 Intel(R) Core(TM) i3 CPU       M 330  @ 2.13GHz\r\n    Memory: 429.58 MB / 7.58 GB\r\n    Container: Yes\r\n    Shell: 5.0.17 - /bin/bash\r\n  Binaries:\r\n    Node: 14.3.0 - ~/.nvm/versions/node/v14.3.0/bin/node\r\n    npm: 6.14.6 - ~/.nvm/versions/node/v14.3.0/bin/npm\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2304/comments",
    "author": "ishigo1987",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-07-21T21:24:20Z",
        "body": "Hi, did you see #2263?"
      },
      {
        "user": "ishigo1987",
        "created_at": "2020-07-22T06:54:14Z",
        "body": "Nope, i see now and your trick works , thank you"
      }
    ]
  },
  {
    "number": 2278,
    "title": "base64编码字符串不正确的时候，try/catch没有捕获到error",
    "created_at": "2020-07-03T08:55:37Z",
    "closed_at": "2020-07-04T11:00:37Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2278",
    "body": "客户端\r\nlet buff = fs.readFileSync(fileName)\r\nlet base64Str = buff.toString('base64')\r\nbase64Str = base64Str.substring(0, base64Str.length - 100) （base64Str.length > 100)\r\n\r\n服务端\r\ntry {\r\n  let buffer = Buffer.from(base64Str, 'base64')\r\n  let img = sharp(buffer)\r\n  await img.metadata()\r\n  sharp(buffer).resize(width, height)\r\n} catch (error) {\r\n  \r\n}\r\n\r\n有输出\r\nUncaught Error: VipsJpeg: Premature end of JPEG file\r\nVipsJpeg: out of order read at line 1008\r\n\r\n但是我没有在catch里面捕获到error，请问下是什么原因？",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2278/comments",
    "author": "tangna",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-07-03T13:05:41Z",
        "body": "Does the following change, to `await` a call to `toBuffer`, ensure the error is caught?\r\n```diff\r\n- sharp(buffer).resize(width, height)\r\n+ await sharp(buffer).resize(width, height).toBuffer()\r\n```\r\nIf not, please provide a complete, standalone code sample and image that allows someone else to reproduce this problem."
      },
      {
        "user": "tangna",
        "created_at": "2020-07-03T15:42:46Z",
        "body": "谢谢，这样是可以的。\r\n之前，我是想用sharp(buffer).resize(width, height)返回stream，然后上传到Aliyun OSS，而不用转成buffer；\r\n这样有办法吗？\r\n\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2020-07-03T20:42:35Z",
        "body": "The use of Stream-based output means you can no longer \"catch\" errors, instead you'll need to listen for the error event.\r\n```diff\r\n- sharp(buffer).resize(width, height)\r\n+ sharp(buffer).resize(width, height).on('error', err => { ... })\r\n```\r\n\r\n(This is a Node.js concept rather than being specific to sharp.)"
      },
      {
        "user": "tangna",
        "created_at": "2020-07-04T01:15:19Z",
        "body": "明白了，谢谢"
      }
    ]
  },
  {
    "number": 2277,
    "title": "处理IOS图片的Orientation / Processing the orientation of IOS pictures",
    "created_at": "2020-07-02T07:43:14Z",
    "closed_at": "2020-07-06T07:10:49Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2277",
    "body": "如何使用sharp的rotate方法进行旋转为正确的方向",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2277/comments",
    "author": "wangguanl",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-07-02T10:29:26Z",
        "body": "> How to use sharp's rotate method to rotate to the correct direction\r\n\r\nAre you able to provide a minimal, standalone code sample that demonstrates this question?\r\n您是否能够提供一个最小的独立代码示例来说明此问题？\r\n\r\nAre you able to provide a sample image that helps explain the question?\r\n您是否可以提供示例图片来帮助解释该问题？"
      }
    ]
  },
  {
    "number": 2273,
    "title": "Is it possible to reverse composition to the original images ?",
    "created_at": "2020-06-30T12:12:54Z",
    "closed_at": "2020-07-27T07:36:42Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2273",
    "body": "**What are you trying to achieve?**\r\n> I'm trying to use sharp composition feature to encode and decode PNG images\r\nI need to reduce the images size on its way to the server.\r\nThe Idea is to take the original PNG images, encode it to WebP composition.\r\nAnd then extract it to get the original images.\r\n\r\n**Have you searched for similar questions?**\r\n> I did a research in general for such implementation \r\n\r\n**Are you able to provide a minimal, standalone code sample that demonstrates this question?**\r\n> NA\r\n\r\n**Are you able to provide a sample image that helps explain the question?**\r\n\r\n> NA\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2273/comments",
    "author": "ariklevin",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-06-30T12:58:49Z",
        "body": "Hi, please can you provide some sample before and after images (and ideally the code to generate them) to help explain this question."
      },
      {
        "user": "ariklevin",
        "created_at": "2020-06-30T13:57:40Z",
        "body": "Hi,\r\n\r\nYou are right, I was not clear because in the back of my head I thought about encode \\ decode and using composite it misleading.\r\n\r\nMy idea is to use stacked webp images to reduce network bandwidth.\r\nI thought that maybe I can use your great project for this task. \r\n\r\n**Example:** \r\nLets say I have two images and I use the composite like so: (The composition will save the images as separate layers with delta only)\r\n\r\nclient side encode the images\r\n```\r\nsharp('test1.webp')\r\n  .composite([{ input: 'test2.webp', layer: true }])\r\n  .toBuffer()\r\n  .then(function(outputBuffer) { \r\n      // buffer containing the images as stuck\r\n      // saving the image to disk out.image\r\n });\r\n```\r\n\r\nserver side decode the images\r\n```\r\nsharp('out.image')\r\n  .uncomposite([ layer: true }])\r\n  .then(function(images) { \r\n      // images = [test1.webp, test2.webp]\r\n });\r\n```\r\n\r\nThank you,\r\n-Arik"
      },
      {
        "user": "lovell",
        "created_at": "2020-06-30T15:55:33Z",
        "body": "The composite operation is non-reversible - it does not layer images but rather \"flattens\" images onto one another."
      },
      {
        "user": "lovell",
        "created_at": "2020-07-27T07:36:42Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 2267,
    "title": "How i can use output path to upload images in Google Cloud?",
    "created_at": "2020-06-22T00:32:49Z",
    "closed_at": "2020-07-16T13:26:09Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2267",
    "body": "I need upload images to Google Cloud, but when i try appear this error:\r\n[Error: ENOENT: no such file or directory, stat './myfilename.jpg']\r\nBut the file exists local in machine. The code is bellow.\r\n\r\n\r\nawait sharp(imagePath).resize(500, 500).toFile(imageResizedPath);\r\nawait storage.bucket(firebaseConfig.storageBucket)\r\n                    .upload(imageResizedPath, {\r\n                        gzip: true,\r\n                        metadata: { cacheControl: 'public, max-age=31536000' }\r\n                    });\r\n\r\nSomebody help me please?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2267/comments",
    "author": "dieg0almeida",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-06-22T09:50:33Z",
        "body": "Please can you provide a complete, standalone code sample, perhaps as a separate repo, that allows someone else to consistently reproduce the problem.\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2020-07-16T13:26:09Z",
        "body": "Closing due to inactivity but please feel free to reopen with more details if further help is required."
      }
    ]
  },
  {
    "number": 2250,
    "title": "[Question] Extract pdf pages in multiple images",
    "created_at": "2020-06-07T20:29:37Z",
    "closed_at": "2020-06-08T17:54:20Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2250",
    "body": "Is it possible to convert a multi page PDF to multiple images without recalling sharp() with the appropriate options?\r\nLike:\r\npage 1 > 1.jpeg\r\npage 2 > 2.jpeg \r\netc..\r\n\r\nMany thanks!",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2250/comments",
    "author": "PlopTheReal",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-06-08T09:15:37Z",
        "body": "No. It's unlikely being able to do so would be more performant, plus would introduce complexity."
      },
      {
        "user": "PlopTheReal",
        "created_at": "2020-06-08T17:54:20Z",
        "body": "ok thanks for your reply."
      }
    ]
  },
  {
    "number": 2241,
    "title": "Are tiled/pyramidal TIFF supported as input? And is single tile extraction from it possible?",
    "created_at": "2020-06-04T09:52:59Z",
    "closed_at": "2020-06-05T08:28:14Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2241",
    "body": "Hi,\r\n\r\nI'm currently using sharp as an image format converter: it's fluent API is very nice to use. I've read about its tiled output capabilities, but found nothing about tiled/pyramidal TIFF input (which I take for granted) and single tile extraction from it.\r\n\r\nGiven that my source images are tiled/pyramidal TIFFs, from which I extract single tiles using libtiff depending on level/zoom and tile's coordinates, I was wondering if sharp is capable of handling this in some way.\r\n\r\nThanks in advance,\r\nPaco.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2241/comments",
    "author": "ConPac",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-06-04T19:39:23Z",
        "body": "Hi, this is being discussed in #2222 \r\n\r\n(You'll also need a globally-installed libvips compiled with support for OpenSlide.)"
      },
      {
        "user": "ConPac",
        "created_at": "2020-06-05T08:28:14Z",
        "body": "Thanks @lovell, I'll keep an eye on #2222."
      }
    ]
  },
  {
    "number": 2236,
    "title": "The options for \"binaries cannot be used\" ",
    "created_at": "2020-06-01T12:16:30Z",
    "closed_at": "2020-06-05T00:58:00Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2236",
    "body": "I have same issue known as \"xx binaries cannot be used xxx\"  with docker.\r\nThe best solution is that install in docker container. But, I am try to install outside docker. \r\n\r\nSo, I find alternative solution.\r\n```js\r\nrm -rf node_modules/sharp\r\nnpm install --arch=x64 --platform=linux --target=8.10.0 sharp\r\n```\r\nIs `--arch` and `--platform` npm spec? I don't see the spec in official document.\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2236/comments",
    "author": "hg-pyun",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-06-01T15:07:35Z",
        "body": "Please can you provide (quite a bit) more information about what you are trying to achieve."
      }
    ]
  },
  {
    "number": 2228,
    "title": "Using composite to join to images into a larger one, possible?",
    "created_at": "2020-05-27T21:58:43Z",
    "closed_at": "2020-05-29T02:16:35Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2228",
    "body": "I was reading through issues and was trying to find out what the best way to go about \"stacking\" an image on top of another to make one larger image containing the provided 2 images.  What I gathered was to use a larger blank image, then composite the 2 desired images on to it.  Is this still the best way to do this currently?  Thanks for any help.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2228/comments",
    "author": "justuscook",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-05-28T13:30:12Z",
        "body": "Are you able to provide a minimal, standalone code sample that demonstrates this question?\r\n\r\nAre you able to provide a sample image that helps explain the question?\r\n"
      },
      {
        "user": "justuscook",
        "created_at": "2020-05-29T02:16:35Z",
        "body": "I just tried it out, and was able to get it working for my case.  I am downloading images into a buffer, but it would be almost the same for a local image.  Maybe this will help the next person looking:\r\n```\r\nsharp({\r\n            create: {\r\n                width: 128,\r\n                height: 256,\r\n                background: {alpha: 1, r: 255, g: 0, b: 0},\r\n                channels: 4\r\n            }\r\n        })\r\n        .composite(\r\n            [\r\n            {input: image1Buffer,top: 0, left: 0},{input: image2Buffer, top: 128 , left: 0}\r\n        ])\r\n        .png()\r\n        .toFile('testImage.png');\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2020-05-29T09:08:30Z",
        "body": "Thank you for providing a code sample. The possible future enhancement discussed in #1580 will help this scenario."
      }
    ]
  },
  {
    "number": 2227,
    "title": "Why (and where!) does color space conversion happen?",
    "created_at": "2020-05-27T16:08:44Z",
    "closed_at": "2020-08-19T20:56:59Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2227",
    "body": "Hello!\r\n\r\nI'm currently using Sharp to resize/crop/change quality on images. One thing I noticed (as have others by open issues), is that Sharp always changes the color space of an image to sRGB. In the source, it looks like this conversion happens as a 'safety' in multiple places. I'm currently looking at modifying Sharp (and eventually sending you a PR!) to do a couple things:\r\n\r\n1. Add a flag (either on the constructor or in another spot) that maintains the color profile of an image. We occasionally deal with AdobeRGB or Display P3 images. These are in the sRGB colorspace, and I think I have a proof-of-concept working for preventing the color profile conversion in `pipeline.cc`.\r\n2. Add a flag that maintains the color space of an image. This I'm having trouble with, because there seems to be several places where the color space gets converted to sRGB. I am occasionally getting images in other color spaces (e.g. CMYK) and due to the fact that I'm running Sharp on a Lambda@Edge, I only have limited space for other modules. My path forward for #2 is either:\r\n - Use a flag that ignores all the places where images are converted to sRGB\r\n - Create a flag/options object on `toColourspace` (e.g. `maintain: true`) that when set, guesses the colorspace of the image and sets the colorspace to it there.\r\n\r\nI'm looking for your feedback on the potential changes above as well as any advice to making (2.1) happen, as I feel like that solution would be the more straightforward for implementers of the two.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2227/comments",
    "author": "stephenwoods",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-05-28T23:05:10Z",
        "body": "Hello, thank you for offering to help improve sharp.\r\n\r\nThe first task to probably to tackle #1317 and provide the option (in that issue explicit, but likely to become implicit when #1323 is implemented) to switch the internal processing colourspace from non-linear sRGB to linear scRGB so that linear input/output profiles such as AdobeRGB and P3 can be used."
      },
      {
        "user": "lovell",
        "created_at": "2020-08-19T20:56:59Z",
        "body": "I think this is covered by #1323 so let's track it there."
      }
    ]
  },
  {
    "number": 2214,
    "title": "flatten does not work after using composite",
    "created_at": "2020-05-18T15:30:55Z",
    "closed_at": "2020-06-12T10:33:37Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2214",
    "body": "> Are you using the latest version? Is the version currently in use as reported by `npm ls sharp` the same as the latest version as reported by `npm view sharp dist-tags.latest`?\r\n\r\nyes, at the time of writing this is version `0.25.3`\r\n\r\n> What are the steps to reproduce?\r\n\r\n1. create image A \r\n2. flatten, raw and toBuffer image A\r\n3. create image B\r\n4. composite A onto B\r\n5. flatten, raw and toBuffer image B\r\n6. image B still has 4 channels, and the wrong data size (opposed to image A, which flattened correctly)\r\n\r\n> What is the expected behaviour?\r\n\r\nWhen `flatten` is used, the resulting image is expected to have 3 channels.\r\n\r\n\r\n> Are you able to provide a minimal, standalone code sample, without other dependencies, that demonstrates this problem?\r\n\r\n```javascript\r\nconst sharp = require(\"sharp\");\r\nconst size = 96;\r\n\r\n/* create image A: */\r\nsharp({\r\n        create: {\r\n            width:  size,\r\n            height: size,\r\n            channels: 4,\r\n            background: { r: 100, g: 50, b: 0, alpha: 1.0 }\r\n        }\r\n    })\r\n    .flatten()\r\n    .raw()\r\n    .toBuffer({ resolveWithObject: true })\r\n    .then( buff => {\r\n        /* works fine until here, now lets merge this image onto a new one */\r\n        console.log( `Simple Create (expect size: ${size*size*3}):`, buff.info )\r\n\r\n        /* broken */\r\n        sharp({\r\n                /* create image B */\r\n                create: {\r\n                    width:  size,\r\n                    height: size,\r\n                    channels: 4,\r\n                    background: { r: 0, g: 100, b: 0, alpha: 1.0 }\r\n                }\r\n            })\r\n            .composite([{\r\n                /* merge A onto B */\r\n                input: buff.data,\r\n                raw: buff.info\r\n            }])\r\n            .flatten() // this seems to be ignored\r\n            .raw()\r\n            .toBuffer({ resolveWithObject: true })\r\n            .then( buff => console.log( `Composite is not flat (expect size: ${size*size*3}):`, buff.info ) );\r\n    });\r\n```\r\n\r\nOutput:\r\n```\r\nSimple Create (expect size: 27648): { format: 'raw',\r\n  width: 96,\r\n  height: 96,\r\n  channels: 3,\r\n  premultiplied: false,\r\n  size: 27648 }\r\nComposite is not flat (expect size: 27648): { format: 'raw',\r\n  width: 96,\r\n  height: 96,\r\n  channels: 4,\r\n  premultiplied: true,\r\n  size: 36864 }\r\n```\r\n\r\n> Are you able to provide a sample image that helps explain the problem?\r\n\r\nI think in this case this step does not help, I care purely about the buffer size\r\n\r\n> What is the output of running `npx envinfo --binaries --system`?\r\n\r\n```\r\n  System:\r\n    OS: Linux 5.6 Arch Linux\r\n    CPU: (8) x64 Intel(R) Core(TM) i7-4820K CPU @ 3.70GHz\r\n    Memory: 1.21 GB / 15.59 GB\r\n    Container: Yes\r\n    Shell: 5.8 - /usr/bin/zsh\r\n  Binaries:\r\n    Node: 10.20.1 - /usr/bin/node\r\n    Yarn: 1.22.4 - /usr/bin/yarn\r\n    npm: 6.14.5 - /usr/bin/npm\r\n```\r\n\r\nSubmitting bugs makes me feel bad, so I wanna make sure to say thank you for providing this great library ;)",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2214/comments",
    "author": "GeraldWodni",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-05-25T09:50:25Z",
        "body": "Hi, you'll need to split the flatten into a separate pipeline, something like the following (untested):\r\n\r\n```javascript\r\nconst raw =  {\r\n  width: size,\r\n  height: size,\r\n  channels: 4\r\n};\r\n/* create image B */\r\nconst create = {\r\n  ...raw,\r\n  background: { r: 0, g: 100, b: 0, alpha: 1.0 }\r\n};\r\nsharp({ create })\r\n  .composite([\r\n    {\r\n      /* merge A onto B */\r\n      input: buff.data,\r\n      raw\r\n    }\r\n  ])\r\n  .raw()\r\n  .toBuffer()\r\n  .then((data) => sharp(data, { raw }).flatten().raw().toBuffer())\r\n  .then( ... )\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2020-06-12T10:33:37Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 2206,
    "title": "Create Watermark",
    "created_at": "2020-05-13T12:24:58Z",
    "closed_at": "2020-12-07T19:47:02Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2206",
    "body": "What are you trying to achieve? - I want to write a text inside a image.\r\n\r\nHave you searched for similar feature requests? - Yes, but I didn't find relevant solution in this library, there is Jimp nut we want to use Sharp.\r\n\r\nWhat would you expect the API to look like? Not Sure as of now.\r\n\r\nWhat alternatives have you considered? - Jimp.\r\n\r\nIs there a sample image that helps explain?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2206/comments",
    "author": "sahilpaudel-pe",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-09-17T10:23:03Z",
        "body": "Are you able to provide a sample image that helps explain the question?"
      },
      {
        "user": "lovell",
        "created_at": "2020-12-07T19:47:02Z",
        "body": "Closing due to inactivity but please feel free to reopen with the requested details if further help is required."
      }
    ]
  },
  {
    "number": 2193,
    "title": "Using nohalo/lohalo for downscaling",
    "created_at": "2020-05-03T04:55:14Z",
    "closed_at": "2020-05-03T13:05:15Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2193",
    "body": "What are you trying to achieve?\r\nNoHalo downscaler kernel\r\n\r\n\r\nHello. Searching issues leads me to believe this used to be supported, but I can't find the exact moment it was dropped or the rationale for it?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2193/comments",
    "author": "Xaekai",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-05-03T12:45:59Z",
        "body": "HI, \"nohalo\" is considered an interpolator rather than a kernel in libvips. The `vips_resize` function internally switched from using `vips_affine` and interpolators to `vips_reduce` and kernels from libvips v8.3.0 (Jan 2016) onwards.\r\n\r\nCustom interpolators such as \"nohalo\" are still available via `vips_affine`, but this is not exposed in sharp - see #2095 for the future possible enhancement to do so."
      },
      {
        "user": "Xaekai",
        "created_at": "2020-05-03T13:05:15Z",
        "body": "Thank you. I believe that closes this issue, since the question is \"what happened to nohalo.\"\r\nHave a great day."
      }
    ]
  },
  {
    "number": 2184,
    "title": "Can't compress a 24 bit jpg to an 8 bit jpg",
    "created_at": "2020-04-27T07:50:22Z",
    "closed_at": "2020-04-27T21:19:35Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2184",
    "body": "What are you trying to achieve?\r\ncompress a 24 bit jpg to an 8 bit jpg\r\n\r\nHave you searched for similar feature requests?\r\nyes, couldn't find anything\r\n\r\nWhat would you expect the API to look like?\r\n\r\nawait sharp(in).depth(8).toFile(out);\r\n\r\nWhat alternatives have you considered?\r\npngquant but it's only for png files\r\n\r\nIs there a sample image that helps explain?\r\nno",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2184/comments",
    "author": "quinton-ashley",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-04-27T09:07:59Z",
        "body": "Hi, JPEG images use 8 bits per channel, so a 24-bit JPEG is three-channel RGB and an 8-bit JPEG is single-channel greyscale.\r\n\r\n(JPEG images can also use 12 bits per channel, but those are very rare and most software does not support them.)"
      },
      {
        "user": "quinton-ashley",
        "created_at": "2020-04-27T21:19:35Z",
        "body": "Oh my bad, thanks for the explanation and for sharp! It's really good :)"
      }
    ]
  },
  {
    "number": 2181,
    "title": "Resized images showing type: text/html",
    "created_at": "2020-04-23T12:34:43Z",
    "closed_at": "2020-05-18T10:21:56Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2181",
    "body": "The site is running on a Linode server using ubunto. The image is uploaded fine, showing image/jpeg. It is then resized down to four different sizes. These do not show on the page and when you right click and show image info, it says Type: text/html. If I download the resized image and look at it in Photoshop, it shows OK with the correct type. \r\n\r\nI'm using 0.25.2 and it has worked intermittently locally.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2181/comments",
    "author": "brian-harrison",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-04-23T12:48:09Z",
        "body": "Are you able to provide a minimal, standalone code sample that demonstrates this question?\r\n\r\nAre you able to provide a sample image that helps explain the question?\r\n"
      },
      {
        "user": "brian-harrison",
        "created_at": "2020-04-24T08:56:05Z",
        "body": "It's a very simple function. Only working with jpegs\r\nI can give you access to the site to see what happens.\r\n\r\n\r\n`const sharp = require (\"sharp\")\r\n\r\nmodule.exports = {\r\n\tresizeImage(uploadedImage, destinationFile, destinationFolder, orientation, usedFor) {\r\n\r\n\t\tlet widthHeight = 'width';\r\n\r\n\t\tif ( usedFor === 'carousel' ) {\r\n\t\t\twidthHeight = 'height';\r\n\r\n\t\t} else if ( orientation === 'u' && usedFor === 'page' ) {\r\n\t\t\twidthHeight = 'height';\r\n\t\t}\r\n\r\n\t\treturn sharp(uploadedImage)\r\n\t\t\t.resize({ [widthHeight]: parseInt(destinationFolder, 10) })\r\n\t\t\t.toFile(destinationFile)\r\n\t}\r\n};`"
      },
      {
        "user": "lovell",
        "created_at": "2020-04-24T09:14:38Z",
        "body": "I suspect the problem is in code not shown here. Please can you provide a complete code sample that allows someone else to reproduce the problem, perhaps as a standalone repo."
      },
      {
        "user": "lovell",
        "created_at": "2020-05-18T10:21:56Z",
        "body": "Closing due to inactivity but please feel free to reopen with more details if further help is required."
      }
    ]
  },
  {
    "number": 2178,
    "title": "Extract area that may go out of bounds",
    "created_at": "2020-04-22T14:51:54Z",
    "closed_at": "2020-04-24T14:46:03Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2178",
    "body": "I was wondering if anyone was able to use `.extract` on a region that goes out of bounds. I know you have `.extend` but is there a way to `.extract` but if it fails `.extend` then `.extract`?  Because sometimes I won't know how much to extend without being wasteful.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2178/comments",
    "author": "iomturner",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-04-24T09:16:24Z",
        "body": "Did you see the future possible enhancement at #1907?"
      },
      {
        "user": "iomturner",
        "created_at": "2020-04-24T14:46:03Z",
        "body": "Ah no I didn't that sounds great. Closing this issue."
      }
    ]
  },
  {
    "number": 2163,
    "title": "Conversion some time leading to blur on images",
    "created_at": "2020-04-13T19:19:03Z",
    "closed_at": "2020-04-14T05:52:38Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2163",
    "body": "TLDR; Using blur filter randomly blurs the images which are not to be blurred.\r\nI am converting images into 5 resolutions and blurring the lowest resolution on i.e. 200px wid only. but some how some random images gets blurred. Using blur is high priority to reduce images size. Calling convert image function using calbackify.\r\n`\r\nvar WebpOptions = {\r\n    reductionEffort: 4,\r\n    quality: 70,\r\n}\r\n\r\nvar JpegOptions = {\r\n    quantisationTable: 8,\r\n    quality: 60,\r\n    trellisQuantisation: true,\r\n    overshootDeringing: true,\r\n    chromaSubsampling: '4:2:0'\r\n}\r\nasync function convertImage(Map) {\r\n\r\n    var promises = [];\r\n    var logs = [];\r\n\r\n    if (typeof (Map) !== 'object')\r\n        throw Error(`Given Map ${Map} data is not in the form of an object`);\r\n\r\n    for (let [key, value] of Object.entries(Map)) {\r\n\r\n        var files = fs.readdirSync(key);\r\n\r\n        for (let i = 0; i < files.length; i++) {\r\n            let ls = fs.lstatSync(`${key}${files[i]}`)\r\n            if (ls.isFile())\r\n                files[i] = {\r\n                    name: files[i],\r\n                    path: `${key}${files[i]}`,\r\n                    size: ls.size\r\n                };\r\n            else\r\n                files[i] = null;\r\n        }\r\n\r\n        for (var i = 0; i < files.length; i++) {\r\n            if (files[i] === null)\r\n                continue;\r\n            var filename = path.basename(files[i].name).split('.');\r\n            filename[0] = filename[0].replace(/ /g, '_');\r\n\r\n            var res = [2000, 1000, 800, 600, 100];\r\n\r\n            for (let j = 0; j < res.length; j++) {\r\n                let target = path.resolve(`${value}${res[j]}/`);\r\n                if (!fs.existsSync(target)) {\r\n                    console.log(`MKDIR ${target}`);\r\n                    fs.mkdirSync(target, { recursive: true });\r\n                }\r\n            }\r\n\r\n            var Image = sharp(files[i].path).resize(res[0]);\r\n            \r\n            var pipeline = Image.clone().webp(WebpOptions)\r\n\r\n            for (let j = 0; j < res.length; j++) {\r\n                let target = `${value}${res[j]}/${filename[0]}.webp`;\r\n                if (res[j] == 100) {\r\n\r\n                    let rendition = pipeline;\r\n                    let size = res[j]\r\n                    promises.push(blurImage(rendition, size, target))\r\n                }\r\n                else {\r\n\r\n                    let rendition = pipeline;\r\n                    let size = res[j]\r\n                    promises.push(fineImage(rendition, size, target))\r\n\r\n                }\r\n            }\r\n\r\n            pipeline = Image.clone().jpeg(JpegOptions)\r\n\r\n            for (let j = 0; j < res.length; j++) {\r\n                let target = `${value}${res[j]}/${filename[0]}.jpg`;\r\n                if (res[j] == 100) {\r\n\r\n                    let rendition = pipeline;\r\n                    let size = res[j]\r\n                    promises.push(blurImage(rendition, size, target))\r\n                }\r\n                else {\r\n\r\n                    let rendition = pipeline;\r\n                    let size = res[j]\r\n                    promises.push(fineImage(rendition, size, target))\r\n\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    function fineImage(rendition, size, target) {\r\n        return rendition\r\n            .clone()\r\n            .metadata()\r\n            .then(metadata => rendition\r\n                .resize(size, null, { fastShrinkOnLoad: false })\r\n                .toFile(target)\r\n                .then(info => { return { info, target, metadata, shape : 'fine' }; }))\r\n            .catch(err => console.log(err));\r\n    }\r\n\r\n    function blurImage(rendition, size, target) {\r\n        return rendition\r\n            .clone()\r\n            .metadata()\r\n            .then(metadata => rendition\r\n                .resize(size, null, { kernel: sharp.kernel.cubic, fastShrinkOnLoad: true })\r\n                .blur(20)\r\n                .toFile(target)\r\n                .then(info => { return { info, target, metadata, shape : 'blur' }; }))\r\n            .catch(err => console.log(err));\r\n    }\r\n\r\n    return await Promise.all(promises)\r\n        .then((values) => {\r\n            values.forEach((value) => console.log(value.target+ ' ' + value.shape))\r\n            return differenceTime(Benchmark)\r\n        });\r\n}\r\n`\r\n\r\nSystem:\r\n    OS: Linux 5.3 Ubuntu 18.04.4 LTS (Bionic Beaver)\r\n    CPU: (4) x64 Intel(R) Core(TM) i5-6200U CPU @ 2.30GHz\r\n    Memory: 6.45 GB / 15.48 GB\r\n    Container: Yes\r\n    Shell: 4.4.20 - /bin/bash\r\n  Binaries:\r\n    Node: 12.16.1 - ~/.nvm/versions/node/v12.16.1/bin/node\r\n    npm: 6.14.4 - ~/.nvm/versions/node/v12.16.1/bin/npm\r\n\r\nSome random webp and Jpg Images are coming blurred. If you use blur filter. If you dont use blur filter all images are fine.\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2163/comments",
    "author": "navanshu",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-04-13T20:02:14Z",
        "body": "Hi, there's a race condition in this code. The `rendition` object passed to the `blurImage` function is modified asynchronously.\r\n\r\n```diff\r\nfunction blurImage(rendition, size, target) {\r\n    return rendition\r\n        .clone()\r\n        .metadata()\r\n        .then(metadata => rendition\r\n+           .clone()\r\n            .resize(size, null, { kernel: sharp.kernel.cubic, fastShrinkOnLoad: true })\r\n```"
      },
      {
        "user": "navanshu",
        "created_at": "2020-04-14T05:52:38Z",
        "body": "Thankyou so much. I fixed it."
      }
    ]
  },
  {
    "number": 2156,
    "title": "Input buffer contains unsupported image format when using on Lambda",
    "created_at": "2020-04-10T12:27:28Z",
    "closed_at": "2020-04-13T23:50:18Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2156",
    "body": "Hi! \r\nI am using Sharp to resize an image before uploading to S3, on a Lambda function.\r\nEvery time the function get invoked it fails and sends back `Input buffer contains unsupported image format` error.\r\n\r\nI have checked if Sharp support the image using the format method and it supports every images format I tried.\r\n\r\nI am using the code below to resize and upload:\r\n```\r\nconst resizeAndCropImage = async (img: Buffer): Promise<Buffer> => {\r\n  return sharp(img)\r\n    .resize(CONFIG.IMAGE_WIDTH, CONFIG.IMAGE_HEIGHT, {\r\n      fit: 'cover',\r\n      position: 'center'\r\n    })\r\n    .toBuffer()\r\n}\r\n\r\nexport const uploadImage = async (file: Image, filePath: string): Promise<void> => {\r\n  try {\r\n    const img = await resizeAndCropImage(file.data)\r\n    const params = {\r\n      Bucket: process.env.S3_BUCKET_NAME,\r\n      Key: filePath,\r\n      Body: img,\r\n      ContentType: file.mimetype,\r\n      ACL: 'public-read'\r\n    }\r\n    await s3.upload(params).promise()\r\n  } catch (error) {\r\n    throw error\r\n  }\r\n}\r\n```\r\nIf I use file.data instead of img in the s3 upload params, it works fine.\r\nCan someone please tell me if I am missing something here?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2156/comments",
    "author": "gk-devteam",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-04-11T08:35:42Z",
        "body": "Are you able to provide a minimal, standalone code sample, without other dependencies, that demonstrates this problem?\r\n\r\nAre you able to provide a sample image that helps explain the problem?\r\n"
      },
      {
        "user": "gk-devteam",
        "created_at": "2020-04-13T00:42:23Z",
        "body": " @lovell Thank you for your answer. \r\nI am trying to separate the code so I can share a sample as soon as I can."
      },
      {
        "user": "gk-devteam",
        "created_at": "2020-04-13T23:50:18Z",
        "body": "@lovell \r\nI fixed my problem but I have no idea how....The code is exactly the same, but changed a few things on AWS side and it works now...\r\nReally makes me hate AWS a bit more each time.\r\n\r\nAnyway, thanks again for this great plugin, and for trying to help me this quickly!"
      },
      {
        "user": "solomonmulatu",
        "created_at": "2024-09-30T07:45:19Z",
        "body": "@gk-devteam \r\ncan you share what things you changed on aws?\r\n"
      }
    ]
  },
  {
    "number": 2155,
    "title": "Question about trim/composite/resize",
    "created_at": "2020-04-09T01:28:21Z",
    "closed_at": "2020-04-24T09:18:36Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2155",
    "body": "Hi,\r\nI have a sample script that takes an input png image, and trims transparency from right and left, and then re-centers the content onto an image of identical to original aspect ratio. (Like imagine the image has text with transparency which is left or right aligned). So the script below works. \r\n```\r\n#!/usr/local/bin/node\r\nconst sharp = require('sharp');\r\n\r\n(async () => {\r\n    const buf = await sharp('./input.png').resize(300).toBuffer();\r\n    const img = sharp(buf);\r\n    const metadata = await img.metadata();\r\n    const overlay = await img\r\n        .trim().rotate(180)\r\n        .trim().rotate(0)\r\n        .toBuffer();\r\n    const options = {\r\n        create: {\r\n            width: metadata.width,\r\n            height: metadata.height,\r\n            background: {r: 0, g: 0, b: 0, alpha: 0},\r\n            channels: 4\r\n        }\r\n    };\r\n    await sharp(options)\r\n        .composite([{\r\n            input: overlay,\r\n            gravity: 'center'\r\n        }]).toFile('./output.png');\r\n    console.log('wrote the image file');\r\n}) ();\r\n```\r\n\r\nEDIT: I got it to resize properly, so now Im wondering if I can do this without creating two temporary buffers. Can this be done fully streaming?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2155/comments",
    "author": "kevinludwig",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-04-09T18:58:02Z",
        "body": "Please see #179 for future possible enhancements relating to Stream-based I/O."
      },
      {
        "user": "lovell",
        "created_at": "2020-04-24T09:18:36Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 2141,
    "title": "libvips with mozjpeg?",
    "created_at": "2020-03-26T21:29:45Z",
    "closed_at": "2020-03-27T14:59:25Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2141",
    "body": "How can I ensure that libvips installed/used by sharp is actually compiled with mozjpeg?\r\nCan I install a libvips that uses mozjpeg? Or force sharp to use a different libvips comes with mozjpeg?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2141/comments",
    "author": "strarsis",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-03-27T09:50:48Z",
        "body": "Hi, did you see #586?"
      },
      {
        "user": "strarsis",
        "created_at": "2020-03-27T12:02:44Z",
        "body": "@lovell: Is it possible to add some lines to the project npm to automate this?\r\nIdeally `npm install` would build libvips with mozjpeg and ensure `sharp` uses this build."
      },
      {
        "user": "lovell",
        "created_at": "2020-03-27T14:59:25Z",
        "body": "No, sorry, you'll have to install this yourself."
      },
      {
        "user": "bruno-xo7",
        "created_at": "2020-09-15T09:14:35Z",
        "body": "What is the problem with mozjpeg to not be chosen as the standard lib for jpeg in sharp?\r\n(just asking)"
      }
    ]
  },
  {
    "number": 2080,
    "title": "With multiple resize() chained together only the last seems to apply.",
    "created_at": "2020-02-13T09:31:57Z",
    "closed_at": "2020-02-14T11:33:57Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2080",
    "body": "Trying to produce a simple pixelise filter, my plan was to just chain two resizes together, but sharp (or possibly libvips ) seems to optimize and only apply the last resize in the chain.\r\n\r\n\r\nWhat are the steps to reproduce?\r\n\r\n```\r\nfunction pixelise(){\r\n\tsharp( \"input.jpg\").metadata( (e,md) => {\r\n\t\tsharp(\"input.jpg\").resize( { width: Math.round( md.width / 100 ) } )\r\n                                            .resize( { width: md.width , kernel:'nearest' })\r\n                                            .toFile(\"output.jpg\")\r\n\t})\r\n}\r\n\r\npixelise()\r\n```\r\n\r\n\r\nWhat is the expected behaviour?\r\n\r\nOutput image should be 'pixelised'.\r\n\r\nAre you able to provide a standalone code sample, without other dependencies, that demonstrates this problem?\r\n\r\nyes\r\n\r\nAre you able to provide a sample image that helps explain the problem?\r\n\r\nfeed any image in...\r\n\r\n\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2080/comments",
    "author": "MonkeyNinja",
    "comments": [
      {
        "user": "MonkeyNinja",
        "created_at": "2020-02-13T10:42:40Z",
        "body": "I have a workaround, extra steps but it appears to work.\r\nBut it feels like a bug that the multiple resize gets ignored.\r\n\r\n```\r\nfunction pixelise(){\r\n\r\n\tconst img = sharp( \"input.jpg\")\r\n\r\n\timg.metadata( (e,md) => {\r\n\t\tw = Math.round( md.width / 10 )\r\n\t\tsharp(\"input.jpg\")\r\n\t\t\t.resize( { width: w } )\r\n\t\t\t.raw()\r\n\t\t\t.toBuffer( { resolveWithObject: true })\r\n\t\t.then( ( b , inf ) => {\r\n\t\t\tsharp( b.data , { raw: { width: b.info.width , height: b.info.height , channels: b.info.channels } } )\r\n\t\t\t.resize( { width: md.width , kernel:'nearest' })\r\n\t\t\t.toFile(\"output.jpg\")\r\n\t\t})\r\n\t})\r\n}\r\n\r\npixelise()\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2020-02-13T10:49:11Z",
        "body": "The use of two pipelines to perform two resize operations is correct as the pipeline is processed when output is requested."
      }
    ]
  },
  {
    "number": 2069,
    "title": "Sharp .recomb function get original matrix",
    "created_at": "2020-02-03T14:56:48Z",
    "closed_at": "2020-02-03T15:05:55Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2069",
    "body": "What are you trying to achieve?\r\nI am trying to apply a recomb matrix to a JPEG image\r\n\r\nHave you searched for similar questions?\r\nYes\r\n\r\nSo from what I could understand, .recomb applies brightness to the RGB and their respective 3 tones. I need to know if there is a way I can fetch the image's current matrix and recomb it using it's previous matrix and my own generated offset.\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2069/comments",
    "author": "IuriRiquesoDias",
    "comments": [
      {
        "user": "IuriRiquesoDias",
        "created_at": "2020-02-03T15:05:55Z",
        "body": "I figured it out. To get the original matrix, simply use the following array:\r\n\r\n[1, 0, 0]\r\n[0, 1, 0]\r\n[0, 0, 1]"
      },
      {
        "user": "nemoDreamer",
        "created_at": "2022-01-03T02:38:44Z",
        "body": "Some kind of guide or basic info on what recomb actually _does_ and what each point in the matrix represents would be really helpful... Not even the `VImage` library has _any_ information and searching for combinations of \"image recomb recombination matrix\" returns very obscure results or results related to DNA recombination...\r\n\r\nHad to finally figure out via trial and error how I could use this to turn my 50% gray into a specific color, thanks in part to @IuriRiquesoDias's answer, and intuiting that it must be the three channels and their respective mixes."
      }
    ]
  },
  {
    "number": 2063,
    "title": "revert options.formatOut back to 'input' ?",
    "created_at": "2020-01-30T16:39:56Z",
    "closed_at": "2020-03-08T14:38:38Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2063",
    "body": "**What are you trying to achieve?**\r\nI want to switch back to options.formatOut == 'input' after working with raw data (call to raw(), which sets options.formatOut to 'raw') without triggering the Error: Unsupported output format but also using a neat method as part of the object, rather than modifying the value of options.formatOut to 'input'\r\n\r\n**Have you searched for similar feature requests?**\r\nYes, and I see some related issues, but I don't see any that mention \r\n\r\n**What would you expect the API to look like?**\r\n```\r\n/**\r\n * Use the default options for output image.\r\n *\r\n * @example\r\n * // Output initial data from JPEG input\r\n * const { data, info } = await sharp('input.jpg')\r\n *   .input()\r\n *   .toFile('./output.jpg');\r\n *\r\n * @returns {Sharp}\r\n */\r\nfunction input () {\r\n  return this._updateFormatOut('input');\r\n}\r\n```\r\n\r\n**What alternatives have you considered?**\r\n```sharp_image.options.formatOut = 'input';```\r\n\r\n**Is there a sample image that helps explain?**\r\nNo.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2063/comments",
    "author": "jasonkhanlar",
    "comments": [
      {
        "user": "jasonkhanlar",
        "created_at": "2020-01-30T16:49:14Z",
        "body": "My use case for this is maintaining a single pipeline, such as this:\r\n```\r\nlet image_input = sharp('./input.png').ensureAlpha();\r\nlet raw_input = await image_input.raw().toBuffer();\r\n// extract pixel information\r\n// modify raw pixel data\r\n// then save modified raw image to a new file\r\n// here is where this would be useful:\r\n//   image_input.input().toFile('./output.png');\r\n// instead of\r\nimage_input.options.fileOut = '';\r\nimage_input.toFile('./output.png');\r\n\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2020-01-30T22:26:50Z",
        "body": "Please can you provide a complete, standalone code sample that generates the `Unsupported output format` error."
      },
      {
        "user": "lovell",
        "created_at": "2020-03-08T14:38:15Z",
        "body": "Closing due to inactivity but please feel free to reopen with more details if further help is required."
      }
    ]
  },
  {
    "number": 2055,
    "title": "Compositing 101",
    "created_at": "2020-01-24T13:41:24Z",
    "closed_at": "2020-02-24T19:03:11Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2055",
    "body": "What are you trying to achieve?\r\nWant to put an image, in the center of a blank new image of a given size.\r\n\r\nHave you searched for similar questions? Yes. \r\n\r\nHere is what I got:\r\n```\r\nconst blankImage = await sharp({\r\n            create: {\r\n                width: 600,\r\n                height: 600,\r\n                channels: 4,\r\n                background: \"rgba(255, 255, 255, 0)\",\r\n            },\r\n        })\r\n            .png()\r\n            .toBuffer();\r\n\r\nconst overlay = await sharp(inputImage);\r\n\r\nconst composite = sharp(blankImage)\r\n            .composite([{ input: overlay }])\r\n            .png()\r\n            .toBuffer();\r\n\r\nreturn composite;\r\n```\r\n\r\nThis throws me a \r\n```(node:56302) UnhandledPromiseRejectionWarning: Error: Expected width, height and channels for raw pixel input\r\n    at Sharp._createInputDescriptor (/Users/gyula/workspace/radioplayer/generate-logos-lambda/node_modules/sharp/lib/input.js:61:15)\r\n    at /Users/gyula/workspace/radioplayer/generate-logos-lambda/node_modules/sharp/lib/composite.js:105:19\r\n    at Array.map (<anonymous>)\r\n    at Sharp.composite (/Users/gyula/workspace/radioplayer/generate-logos-lambda/node_modules/sharp/lib/composite.js:98:35)```\r\n\r\nWhat am I douing wrong? Could you please provide an example to solve this?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2055/comments",
    "author": "gyula-s",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-01-24T18:20:45Z",
        "body": "To composite `inputImage` over a blank image, try something like the following:\r\n\r\n```javascript\r\nconst composited = await sharp({\r\n  create: {\r\n    width: 600,\r\n    height: 600,\r\n    channels: 4,\r\n    background: \"rgba(255, 255, 255, 0)\"\r\n  }\r\n})\r\n  .composite([{ input: inputImage }])\r\n  .png()\r\n  .toBuffer();\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2020-02-24T19:03:11Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further assistance is required."
      }
    ]
  },
  {
    "number": 2053,
    "title": "toFile does not save all files.",
    "created_at": "2020-01-24T09:32:33Z",
    "closed_at": "2020-01-27T09:20:40Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2053",
    "body": "Using sharp for reading the image from the buffer. Resizing it then saving with toFile function, but when I check the directory, there are only 4 or 6, or 7 or the exact 8 of the 8 sent images saved.\r\n\r\nawait sharp(file.buffer)\r\n          .resize(dimensions.width, dimensions.height + 1)     \r\n          .resize(dimensions.width, dimensions.height)\r\n          .toFormat(dimensions.type)                       \r\n          .toFile(dir + `/${filename}` + fileFormat);",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2053/comments",
    "author": "AlexandrHovsepyan",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-01-24T10:59:28Z",
        "body": "Please can you provide a complete, standalone code sample that allows someone else to reproduce this problem."
      },
      {
        "user": "AlexandrHovsepyan",
        "created_at": "2020-01-24T11:23:24Z",
        "body": "`const multer = require('multer');\r\nconst sharp = require('sharp');\r\nconst imageSize = require('image-size');\r\n\r\nconst storage = multer.memoryStorage();\r\n\r\nexports.mediaResizeFiles = async (req, res, next) => {\r\nawait Promise.all(\r\nreq.files.map(async file => {\r\nlet userId = req.user._id;\r\nlet data = req.user._id + '-' + Date.now();\r\nlet filename = crypto.createHash('md5').update(data).digest(\"hex\");\r\nlet fileFormat = path.extname(file.originalname);\r\nlet directory = '';\r\n\r\n            if (file.mimetype.startsWith('image')) {\r\n                \r\n                directory = 'image';\r\n                 let dir = createMediaDir(userId, directory);\r\n\r\n                let dimensions = imageSize(file.buffer);\r\n            \r\n                await sharp(file.buffer)\r\n                        .resize(dimensions.width, dimensions.height + 1)\r\n                        .resize(dimensions.width, dimensions.height) \r\n                        .toFormat(dimensions.type)                      \r\n                        .toFile(dir + `/${filename}` + fileFormat);\r\n              }\r\n      })\r\n}`\r\n\r\nThis is the main part of the code related to the issue."
      },
      {
        "user": "lovell",
        "created_at": "2020-01-24T13:12:10Z",
        "body": "This bit of code, unrelated to sharp, will not generate unique filenames:\r\n```\r\nlet data = req.user._id + '-' + Date.now();\r\nlet filename = crypto.createHash('md5').update(data).digest(\"hex\");\r\n```"
      },
      {
        "user": "AlexandrHovsepyan",
        "created_at": "2020-01-24T14:51:55Z",
        "body": "I am sorry, I think there is a misunderstanding. Do you mean that in the 8 files there the cache (md5) is being matched with the each other?"
      },
      {
        "user": "lovell",
        "created_at": "2020-01-24T16:13:29Z",
        "body": "The value of `filename` is an md5 hash of a timestamp so is not guaranteed to be unique."
      },
      {
        "user": "AlexandrHovsepyan",
        "created_at": "2020-01-27T07:39:53Z",
        "body": "After changes, I believe everything is fine now. Thank you for everything. "
      }
    ]
  },
  {
    "number": 2025,
    "title": "Composite input array as sharp objects",
    "created_at": "2020-01-07T13:57:19Z",
    "closed_at": "2020-03-01T20:35:41Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2025",
    "body": "Hi.\r\n\r\nI want to use composite function, but I want to provide sharp objects instead of string (path)/buffer. The purpose is to boost speed for price of memory usage. Keeping sharp instances in memory whole time.\r\n\r\n```js\r\nlet img1 = sharp('1.png')\r\nlet img2 = sharp('2.png')\r\n\r\nsharp('blank.png')\r\n  .composite([\r\n    { input: img1, left: 10, top: 10 },\r\n    { input: img2, left: 50, top: 50 }\r\n  ])\r\n  .toFile('output.png')\r\n  .then(() => { console.log('done'); })\r\n  .catch(err => { console.error(err); })\r\n```\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2025/comments",
    "author": "stefanak-michal",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2020-01-07T18:28:05Z",
        "body": "libvips (and therefore sharp) decompresses pixel data on-demand so I'm unsure of the usefulness of this - all it would probably end up doing is taking a reference to the same input.\r\n\r\nIf RAM isn't a problem then I'd just use Buffer objects for this purpose as this is usually, but not always, faster than disk IO.\r\n\r\nIf you're compositing one or more of the same images repeatedly then use of filesystem paths can take greater advantage of libvips' operation cache so might be faster.\r\n\r\nPerhaps you could create a performance test using the existing approaches to help you determine if your scenario is IO or CPU bound."
      },
      {
        "user": "stefanak-michal",
        "created_at": "2020-01-08T05:44:02Z",
        "body": "I tried buffer as a first thing. It didn't improve my speed, because he is also creating sharp instance and loading buffer into it, that means copying data from memory to memory. If using buffer will use reference instead, it will be great.\r\n\r\nI'll take a look if it's possible to make a performance test. "
      },
      {
        "user": "lovell",
        "created_at": "2020-03-01T14:32:35Z",
        "body": "@stefanak-michal Were you able to make any progress with this?"
      },
      {
        "user": "stefanak-michal",
        "created_at": "2020-03-01T15:47:16Z",
        "body": "> @stefanak-michal Were you able to make any progress with this?\r\n\r\nNo. I picked up another approach. I hold pictures as buffers in memory and for putting them together I'm using canvas. It's fastest solution from all options I've tried."
      }
    ]
  },
  {
    "number": 2003,
    "title": "Input file contains unsupported image format",
    "created_at": "2019-12-06T15:00:25Z",
    "closed_at": "2019-12-11T17:36:43Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/2003",
    "body": "Respected sir,\r\n                 I am using sharp for the first time and really it is a fast and accurate and fulfilling my work so thanks for it, but it is giving me an awkward error and i do not know how to resolve it .\r\nIssue : when i select image let  1.jpg for the first time after restating my node server it gives me an error 'Input file contains unsupported image format' though it supports .jpg format then again i select the same image again and again same issue and after 3-4 try it accepts the same image and stored perfectly fine with resize in my folder.\r\n\r\nI am not getting why i am getting this issue and this is not an error cause it is accepting the same image and sometimes does not support same image.\r\nsometimes it accepts the same image in first time and sometimes 10-12 try would be there i am using it in my live web application and i am just loving it now but with this issue i can not run it more.\r\n\r\nAny help would be great.\r\ncode :\r\n\r\nsharp(filePath)\r\n\t\t    .resize(null,400)\r\n\t\t    .toBuffer()\r\n\t\t    .then( data => {\r\n\t\t        fileSystem.writeFileSync(statusPath+staImageName, data);       \r\n\t\t    })\r\n\t\t    .catch( error => {                    \r\n\t    \t}); ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/2003/comments",
    "author": "sinhagyandeep",
    "comments": [
      {
        "user": "sinhagyandeep",
        "created_at": "2019-12-06T15:02:01Z",
        "body": "@lovell  can you please help me in this ?"
      },
      {
        "user": "lovell",
        "created_at": "2019-12-09T21:24:02Z",
        "body": "Hello, if this code works sometimes but not others, then my best guess would be that some logic in your other code not shown here is concurrently writing to or updating the contents of `filePath` at the same time as attempting to process the file."
      },
      {
        "user": "sinhagyandeep",
        "created_at": "2019-12-11T08:11:58Z",
        "body": "sharp(req.files.txtImage.tempFilePath)\r\n\t\t    .resize(null,400)\r\n\t\t    .toBuffer()\r\n\t\t    .then( data => {\r\n\t\t        fileSystem.writeFileSync(statusPath+staImageName, data);\r\n\t\t        insertQuery.staColor\t=\t\"\";\r\n\t\t    \tinsertQuery.staImage \t=\tstaImageName;\r\n\t\t    \tfileSystem.readdir(tempImagePath, function(error, files){\r\n\t\t\t\t  \tif(error){\r\n\t\t\t\t  \t\tconsole.log('statusRoute |  Error While Deleting Temp Image'+ error);\r\n\t\t\t\t      \treq.flash('error', 'Error While Deleting Temp Image');\r\n\t\t\t\t      \tres.redirect('/status');\r\n\t\t\t\t  \t}else{\r\n\t\t\t\t  \t\tfor (var file of files) {\r\n\t\t\t\t\t    \tfileSystem.unlink((tempImagePath+file), function(error,result) {\r\n\t\t\t\t\t\t      if (error){\r\n\t\t\t\t\t\t      \tconsole.log('statusRoute |  Error While Deleting Temp Image'+ error);\r\n\t\t\t\t\t\t      \treq.flash('error', 'Error While Deleting Temp Image');\r\n\t\t\t\t\t\t      \tres.redirect('/status');\r\n\t\t\t\t\t\t      }else{\r\n\t\t\t\t\t\t      \t\r\n\t\t\t\t\t\t      }\r\n\t\t\t\t\t    \t});\r\n\t\t\t\t  \t\t}\r\n\t\t\t\t  \t\taddStatus();\r\n\t\t\t\t  \t}\r\n\t\t\t\t});\r\n\t\t    })\r\n\t\t    .catch( error => {\r\n\t\t    \tconsole.log ('Type'+req.files.txtImage.mimetype);\r\n\t\t        console.log('statusRoute |  Error In Uploading Status Image'+ error);\r\n\t\t      \treq.flash('error', 'Error While Uploading Status Image');\r\n\t\t      \tres.redirect('/status');\r\n\t    \t});\r\n\r\nThis is the full code sir i am using tempFilePath to reduce the size and write it again to destination folder and after it successful write i am deleting the tempFilePath automatically . can you please help after this code to me.\r\nThanks @lovell "
      },
      {
        "user": "lovell",
        "created_at": "2019-12-11T11:02:30Z",
        "body": "It looks like there's a possible race condition in your code. The logic that is deleting all the files in `tempImagePath` can occur whilst one or more of those same files, referenced by `req.files.txtImage.tempFilePath`, is still being processed.\r\n\r\nThis sort of question isn't directly about sharp and is more suited to a site like StackOverflow."
      },
      {
        "user": "sinhagyandeep",
        "created_at": "2019-12-11T16:48:55Z",
        "body": "@lovell  I have searched a lot about it on stackoverflow and all help pages after all i asked it to you but i think you are right too.I need to check code again.\r\nThanks for the help sir it means a lot when a person like you reply to new one thank you so much sir."
      }
    ]
  },
  {
    "number": 1995,
    "title": "Stream pipe with metadata",
    "created_at": "2019-12-02T16:04:38Z",
    "closed_at": "2019-12-02T21:47:29Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1995",
    "body": "Hi.\r\nIs it possible to rewrite this code with stream api? (without using buffers)\r\n\r\n```\r\n    const image = sharp(imageBuffer);\r\n    const metadata = await image.metadata();\r\n\r\n    return image\r\n      .resize({\r\n        width\r\n      })\r\n      .jpeg({\r\n        quality: 87\r\n      })\r\n      .toBuffer({ resolveWithObject: true })\r\n      .then(({ data: shot, info }) => processData(shot, info.width / metadata.width));\r\n```\r\nSo here i need original image width and image width after transformation to calculate aspect ratio\r\n\r\nThanks.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1995/comments",
    "author": "dreambit",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-12-02T21:47:29Z",
        "body": "Please see #236"
      }
    ]
  },
  {
    "number": 1963,
    "title": "Why did bumping Sharp fix this issue",
    "created_at": "2019-11-10T21:56:13Z",
    "closed_at": "2019-11-24T09:04:48Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1963",
    "body": "Not really an issue since I've fixed this, but wanted to know why the fix actually fixed it.\r\nNode 12, Win7 x64, Electron 7 (ABI 75)\r\n\r\nI'm using `image-thumbnail` which relies on Sharp, in a React/Electron 7/Webpack app, and on installation, it uses sharp 0.22.1 which gave this gyp error on compile:\r\n\r\n` e:\\github\\rootnav3\\node_modules\\sharp\\src\\stats.cc(130): error C2661: 'v8::Object::Set': no overloaded function takes 2 arguments [E:\\Github\\RootNav3\\node_modules\\sharp\\build\\sharp.vcxproj]`\r\n\r\nwhich results in:\r\n```\r\ngyp ERR! build error\r\n    gyp ERR! stack Error: `C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\BuildTools\\MSBuild\\15.0\\Bin\\MSBuild.exe` failed with exit code: 1\r\n    gyp ERR! stack     at ChildProcess.onExit (C:\\Program Files\\nodejs\\node_modules\\npm\\node_modules\\node-gyp\\lib\\build.js:194:23)\r\n    gyp ERR! stack     at ChildProcess.emit (events.js:210:5)\r\n    gyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:272:12)\r\n    gyp ERR! System Windows_NT 6.1.7601\r\n    gyp ERR! command \"C:\\\\Program Files\\\\nodejs\\\\node.exe\" \"C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp\\\\bin\\\\node-gyp.js\" \"rebuild\"\r\n```\r\nI could get this to build by going into Sharp's folder and gyp configure/building which resulted in ABI mismatches. I think I could `electron-rebuild` this to get a \"Module did not self-register\" after that, but I had to be _in_ Sharp's folder when calling rebuild, else the gyp error occured.\r\n\r\nA load of testing lead me to change the Sharp dep from 0.22.1 to 0.23.2, npm install in module folder, built fine, electron rebuilt, ta da, success. So I forked the repo and bumped version and it compiles fine now on its own.\r\n\r\nSo, why did bumping from 0.22.1 to 0.23.2 fix this gyp error? I read 0.22.1 was where Node 12 support was added, and I feel like it's too early in the installation to run into Electron ABI errors. Curiousity needs satisfying here (also so I can PR this into the real module with a good reason). I don't know a whole lot about how native modules _actually work_ in regards to gyp etc.\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1963/comments",
    "author": "Chagrilled",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-11-11T11:09:44Z",
        "body": "The ABI versions refer to the Node ABI and not the V8 API or ABI. The version of V8 in Electron does not quite line up with the version of V8 in Node.\r\n\r\nThis means you might sometimes see compiler deprecation warnings from V8 in a given Node ABI that become compiler errors from an \"Node ABI compatible\" Electron.\r\n\r\nThis affects all native Node.js modules and is not unique to sharp."
      },
      {
        "user": "lovell",
        "created_at": "2019-11-24T09:04:48Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further help is required."
      }
    ]
  },
  {
    "number": 1961,
    "title": "Is it possible to .resize() an animated GIF?",
    "created_at": "2019-11-09T15:23:14Z",
    "closed_at": "2019-11-09T15:56:44Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1961",
    "body": "Hi,\r\n\r\nI tried to find this in the documentation, but couldn't really find it anywhere.\r\n\r\nWith other packages such as Imagemagik, you're able to effectively turn an animated GIF into a composite of images and then resize them individually - at the end putting them back into the original \"sequence\". Just wondering if this is possible with Sharp and if there's an example around. \r\n\r\nThanks.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1961/comments",
    "author": "eddiejibson",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-11-09T15:56:44Z",
        "body": "Please see #1372 for a future possible enhancement to allow GIF output."
      }
    ]
  },
  {
    "number": 1940,
    "title": "Get metadata from resized/modified image.",
    "created_at": "2019-10-28T02:20:55Z",
    "closed_at": "2019-10-29T03:30:15Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1940",
    "body": "What are you trying to achieve?\r\nI want to get width, height and size in file system from a resized image. I've tried using the `metadata` method, but it gives me information about the original image, not the resized image. I wonder if that is possible without having to re-open the image after storing it.\r\n\r\nHave you searched for similar questions?\r\nYes :)\r\n\r\nAre you able to provide a standalone code sample that demonstrates this question?\r\n```\r\n// Resize the image.\r\nvar transform = await sharp().resize(resizeOptions).jpeg({ quality: 90 }).toFormat('jpg')\r\nfile.stream.pipe(transform)\r\n\r\n// Save the image on the file system.\r\nawait Drive.disk('spaces').put(path, transform, {\r\n  ACL: 'public-read',\r\n  ContentType: 'image/jpg'\r\n})\r\n\r\n// Get image metadata\r\nconst metadata = await transform.metadata()\r\nconsole.log(metadata) // This gives me the original image metadata\r\n```\r\n\r\nAre you able to provide a sample image that helps explain the question?\r\nI don't believe it is necessary.\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1940/comments",
    "author": "maverick504",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-10-28T10:33:36Z",
        "body": "Hi, in your sample code, `transform` refers to the input sharp instance rather than the output JPEG data. You'll need to add a call to `toBuffer()` to generate the output image, something like (untested):\r\n\r\n```diff\r\n  // Resize the image.\r\n- var transform = await sharp().resize(resizeOptions).jpeg({ quality: 90 }).toFormat('jpg')\r\n+ const transform = sharp().resize(resizeOptions).jpeg({ quality: 90 }).toFormat('jpg')\r\n  file.stream.pipe(transform)\r\n+ const output = await transform.toBuffer()\r\n\r\n  // Save the image on the file system.\r\n- await Drive.disk('spaces').put(path, transform, {\r\n+ await Drive.disk('spaces').put(path, output, {\r\n    ACL: 'public-read',\r\n    ContentType: 'image/jpg'\r\n  })\r\n\r\n  // Get image metadata\r\n- const metadata = await transform.metadata()\r\n+ const metadata = await sharp(output).metadata()\r\n```"
      },
      {
        "user": "maverick504",
        "created_at": "2019-10-29T01:05:46Z",
        "body": "It works! Thank you very much!"
      }
    ]
  },
  {
    "number": 1930,
    "title": "Build against a more recent ilmbase?",
    "created_at": "2019-10-22T09:43:18Z",
    "closed_at": "2019-10-23T01:43:37Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1930",
    "body": "Upon updating Arch Linux, Sharp has missing libraries:\r\n\r\n```\r\nldd node_modules/sharp/build/Release/sharp.node\r\nlibIlmImf-2_3.so.24 => not found\r\nlibImath-2_3.so.24 => not found\r\nlibHalf.so.24 => not found\r\nlibIex-2_3.so.24 => not found\r\nlibIexMath-2_3.so.24 => not found\r\nlibIlmThread-2_3.so.24 => not found\r\n```\r\n\r\nFiles like the following are now present:\r\n/usr/lib/libIlmImf-2_4.so.24\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1930/comments",
    "author": "ethernomad",
    "comments": [
      {
        "user": "ethernomad",
        "created_at": "2019-10-22T09:53:39Z",
        "body": "I was able to fix this locally by creating symlinks in my /usr/lib dir."
      },
      {
        "user": "lovell",
        "created_at": "2019-10-22T20:04:20Z",
        "body": "Hi, sharp does not provide prebuilt binaries that include ilmbase so I suspect you're using a global libvips compiled with OpenEXR support. You'll need to either run `ldconfig` or recompile sharp if there are minor/major version increments to globally-installed shared libraries upon which libvips depends."
      },
      {
        "user": "ethernomad",
        "created_at": "2019-10-23T01:43:37Z",
        "body": "Okay thanks!"
      }
    ]
  },
  {
    "number": 1922,
    "title": "Combine rotate and resize operation results unexpected image resolution.",
    "created_at": "2019-10-18T03:37:14Z",
    "closed_at": "2019-11-24T09:01:19Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1922",
    "body": "Image resolution is not correct after rotate and resize. \r\n\r\nFor example, the original image resolution is 3000(w) x 2000(h).\r\nwhat I am going to do is resize the image to 750(w) x 500(h) then rotate image by 90 degree. So the image resolution should be 500(w) x 750(h). Code is:\r\n\r\n```\r\nimage.resize({ height: 500 }).rotate(90).then(...);\r\n```\r\n\r\nHowever, the resolution of image results at 333(w) x 500(h).\r\nSeems like the rotate operation is done before resize no matter the operation order is.\r\n\r\nI have confirmed if I separate this two operation into two script to process, I will got the correct image resolution.   So I believe a bug is in there.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1922/comments",
    "author": "jasli2",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-10-31T08:38:04Z",
        "body": "Hello, you may be interested in the discussion at #241 about improvements to operation ordering in the API."
      },
      {
        "user": "lovell",
        "created_at": "2019-11-24T09:01:19Z",
        "body": "I hope this information helped. Please feel free to re-open with more details if further help is required."
      }
    ]
  },
  {
    "number": 1902,
    "title": "Extract after extract",
    "created_at": "2019-10-05T13:37:02Z",
    "closed_at": "2019-10-06T20:14:45Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1902",
    "body": "Is it possible?\r\n\r\nI have one image and want to exctract region one after one.\r\n\r\n````\r\nconst image = () => sharp(data).extract({\r\n          left: paddingLeft,\r\n          top: paddingTop,\r\n           width: W,\r\n          height: H\r\n       });\r\n\r\nimage().toFile(destination);\r\nimage().extract({ \r\nleft: pleft, \r\ntop: pTop,\r\n width: pw, height: ph\r\n            }).toFile(destination2);\r\n````\r\n\r\nbut second instans do not see the first extract(). It crops original image.\r\n\r\n  ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1902/comments",
    "author": "Alexufo",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-10-06T19:56:59Z",
        "body": "Hi, you'll need to use two pipelines for this, something like (untested):\r\n```javascript\r\nconst image1 = await image().toBuffer();\r\nsharp(image1).extract({ ... }).toFile(destination2);\r\n```"
      },
      {
        "user": "Alexufo",
        "created_at": "2019-10-06T20:14:45Z",
        "body": "Yes. Thanks. I did\r\n\r\n```\r\n                const cropped = await sharp(data).extract({\r\n                    left: paddingLeft,\r\n                    top: paddingTop,\r\n                    width: pW,\r\n                    height: pH\r\n                }).toBuffer();\r\n\r\n                const img1 = await sharp(cropped).toFile()\r\n                const Img2 = await sharp(cropped).extract({}).toFile()\r\n```"
      }
    ]
  },
  {
    "number": 1881,
    "title": "Different sizes after rotation by degree",
    "created_at": "2019-09-23T12:58:12Z",
    "closed_at": "2019-10-25T13:19:59Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1881",
    "body": "I'm rotating multiple images synchronously with same size using `resize()` function. Here's my code:\r\n\r\n    const back = path.resolve(__dirname, './raw/path/toImage');\r\n     const front = path.resolve(__dirname, './raw/path/toOtherImage');\r\n     const degrees = [\r\n      { degree: 45, x: 150, y: 100 },\r\n      { degree: 90, x: 150, y: 300 },\r\n      { degree: 47, x: 150, y: 500 },\r\n      { degree: 98, x: 150, y: 700 },\r\n      { degree: 37, x: 150, y: 900 },\r\n      { degree: 0, x: 150, y: 1100 },\r\n      { degree: 19, x: 150, y: 1300 },\r\n    ]\r\n\r\n    const knobsCallback = degree =>\r\n      sharp(front)\r\n        .rotate(degree.degree, { background: 'transparent' })\r\n        .resize(300, 300)\r\n        .toFile(degree.degree + 'out.png') // Here's I'm gettin different sized images...\r\n\r\n    const knobsModel = async degree => {\r\n      return {\r\n        input: await knobsCallback(degree),\r\n        top: degree.x,\r\n        left: degree.y\r\n      }\r\n    }\r\n\r\n    const getKnobs = async () => await Promise.all(degrees.map(degree => knobsModel(degree)))\r\n\r\n    getKnobs().then(async knobs => {\r\n      sharp(back)\r\n        .composite(knobs)\r\n        .toFile('output.png')\r\n    })\r\n\r\nMy problem is I've got different sized outputs by given degree. I mean if I rotate an image to 90 degree the size(300x300) don't change. but if I rotate the image to 45 degree the size(424x424) changes. If I rotate the image to 98 degree the image's size is changing to 339x339 even if I use `resize(300,300)`. How can I avoid this resizing? I want same size for all my images",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1881/comments",
    "author": "Mustafax06",
    "comments": [
      {
        "user": "Mustafax06",
        "created_at": "2019-09-24T07:11:39Z",
        "body": "I've tried another library and it gave me the same result. So this issue is not depend to the library I think. Anyone faced with this issue before?"
      },
      {
        "user": "lovell",
        "created_at": "2019-10-25T13:19:59Z",
        "body": "Hope you found an answer. If not, this is probably a general question more suited to Stack Overflow."
      }
    ]
  },
  {
    "number": 1873,
    "title": "How to know when an image is already compressed or doesn't need to be compress ?",
    "created_at": "2019-09-17T09:04:50Z",
    "closed_at": "2019-10-02T19:27:21Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1873",
    "body": "Hello,\r\nLike the title said, is it possible to know when an image doesn't need to be compress ? \r\nBecause, if I reupload an already compressed file, I dont want it to be compressed again.\r\n\r\nOther question, in my project, we let users upload their images in different formats and size, for you, what is the best settings ? \r\n\r\nFor now, I have this settings for the jpeg : \r\n\r\n`sharp().jpeg({ progressive:true, quality: 80, force: true })`\r\n\r\nIs this the best way ?\r\n\r\nThanks a lot for your time and effort in this module !",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1873/comments",
    "author": "Bastien-Henry",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-09-17T19:24:13Z",
        "body": "If the question here is _\"how do I know the 'quality' value used for a given JPEG?\"_ then please see #908 for why this is not possible."
      },
      {
        "user": "lovell",
        "created_at": "2019-10-02T19:27:21Z",
        "body": "Hope this helped, please reopen with more details if not."
      }
    ]
  },
  {
    "number": 1808,
    "title": "Error: Input buffer contains unsupported image format on composite",
    "created_at": "2019-07-25T22:40:57Z",
    "closed_at": "2019-07-31T15:17:00Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1808",
    "body": "Hi\r\nI have created a function which gets an image buffer(jpeg, png...).\r\nIt should resize images and depending from options also make them circle.\r\nThe code is working on my local machine.\r\nIt's also working on the server without circle block, but getting following error on the server for circle images:\r\n` Error: Input buffer contains unsupported image format `\r\nCan you please help me? Is it happening because of some packages versions difference?\r\n\r\n```\r\nconst sharp = require('sharp');\r\n\r\nmodule.exports = async function (image, options) {\r\n    let img = sharp(image);\r\n    const imgInfo = await img.metadata();\r\n    let format = options.format || imgInfo.format;\r\n\r\n    if (options.circle) {\r\n        const circle = new Buffer(\r\n            `<svg style=\"background-color: white\">\r\n                <circle cy=\"${options.height / 2}\" cx=\"${options.width / 2}\" r=\"${options.width / 2}\" />\r\n            </svg>`\r\n        );\r\n\r\n        format = 'png';\r\n        img.composite([{ input: circle, blend: 'dest-in' }]);\r\n    }\r\n\r\n    switch (format) {\r\n        case 'png':\r\n            img = img.png({ quality: options.quality || 100 });\r\n            break;\r\n        default:\r\n            img = img.jpeg({ quality: options.quality || 100 });\r\n    }\r\n\r\n    return img\r\n        .resize(options.width, options.height)\r\n        .toBuffer();\r\n};\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1808/comments",
    "author": "susannaHayrapetyan",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-07-26T08:36:25Z",
        "body": "The output of `console.log(sharp.format)` will tell you which image formats are supported at runtime.\r\n\r\nIf you're using the prebuilt binaries these include librsvg. If you're relying on a globally-installed libvips this may be different."
      },
      {
        "user": "susannaHayrapetyan",
        "created_at": "2019-07-31T15:17:00Z",
        "body": "@lovell thank you, works now :)"
      }
    ]
  },
  {
    "number": 1801,
    "title": "I spend whole days to install sharp. Please help me!",
    "created_at": "2019-07-22T19:45:20Z",
    "closed_at": "2019-08-22T10:28:29Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1801",
    "body": "What is the output of running `npm install --verbose sharp`?\r\n\r\n[root@ip-172-31-30-243 ec2-user]# npm install sharp\r\n\r\n> sharp@0.22.1 install /home/ec2-user/node_modules/sharp\r\n> (node install/libvips && node install/dll-copy && prebuild-install) || (node-gyp rebuild && node install/dll-copy)\r\n\r\n/home/ec2-user/node_modules/simple-get/index.js:18\r\n    const { hostname, port, protocol, auth, path } = url.parse(opts.url)\r\n          ^\r\n\r\nSyntaxError: Unexpected token {\r\n    at exports.runInThisContext (vm.js:53:16)\r\n    at Module._compile (module.js:373:25)\r\n    at Object.Module._extensions..js (module.js:416:10)\r\n    at Module.load (module.js:343:32)\r\n    at Function.Module._load (module.js:300:12)\r\n    at Module.require (module.js:353:17)\r\n    at require (internal/module.js:12:17)\r\n    at Object.<anonymous> (/home/ec2-user/node_modules/sharp/install/libvips.js:10:19)\r\n    at Module._compile (module.js:409:26)\r\n    at Object.Module._extensions..js (module.js:416:10)\r\nsh: node-gyp: command not found\r\nnpm WARN ec2-user@1.0.0 No description\r\nnpm WARN ec2-user@1.0.0 No repository field.\r\n\r\nnpm ERR! file sh\r\nnpm ERR! code ELIFECYCLE\r\nnpm ERR! errno ENOENT\r\nnpm ERR! syscall spawn\r\nnpm ERR! sharp@0.22.1 install: `(node install/libvips && node install/dll-copy && prebuild-install) || (node-gyp rebuild && node install/dll-copy)`\r\nnpm ERR! spawn ENOENT\r\nnpm ERR!\r\nnpm ERR! Failed at the sharp@0.22.1 install script.\r\nnpm ERR! This is probably not a problem with npm. There is likely additional logging output above.\r\n\r\nnpm ERR! A complete log of this run can be found in:\r\nnpm ERR!     /root/.npm/_logs/2019-07-22T19_38_49_581Z-debug.log\r\n\r\n\r\nWhat is the output of running `npx envinfo --binaries --languages --system --utilities`?\r\n\r\n\r\n  System:\r\n    OS: Linux 4.14 Amazon Linux AMI 2018.03\r\n    CPU: (2) x64 Intel(R) Xeon(R) Platinum 8175M CPU @ 2.50GHz\r\n    Memory: 219.01 MB / 959.51 MB\r\n    Shell: 4.2.46 - /bin/bash\r\n  Binaries:\r\n    Node: 8.10.0 - ~/.nvm/versions/node/v8.10.0/bin/node\r\n    npm: 6.10.1 - ~/.nvm/versions/node/v8.10.0/bin/npm\r\n  Utilities:\r\n    CMake: 2.8.12.2 - /usr/bin/cmake\r\n    Make: 3.82 - /usr/bin/make\r\n    GCC: 4.8.5 - /usr/bin/gcc\r\n    Git: 2.14.5 - /usr/bin/git\r\n  Servers:\r\n    Apache: 2.4.39 - /usr/sbin/apachectl\r\n  IDEs:\r\n    Nano: 2.5.3 - /bin/nano\r\n    Vim: 8.0 - /usr/bin/vim\r\n  Languages:\r\n    Bash: 4.2.46 - /bin/bash\r\n    Perl: 5.16.3 - /usr/bin/perl\r\n    PHP: 7.0.33 - /usr/bin/php\r\n    Python: 2.7.16 - /usr/bin/python\r\n    Ruby: 2.0.0 - /usr/bin/ruby\r\n  Databases:\r\n    MySQL: 10.1.40 (MariaDB) - /usr/bin/mysql\r\n    SQLite: 3.7.17 - /usr/bin/sqlite3\r\n\r\n\r\nHave you ensured the platform and version of Node.js used for `npm install` is the same as the platform and version of Node.js used at runtime?\r\n\r\n[root@ip-172-31-30-243 ec2-user]# node -v\r\nv8.10.0\r\n\r\n[root@ip-172-31-30-243 ec2-user]# npm -v\r\n6.10.1\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1801/comments",
    "author": "Fogrunner",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-07-22T19:55:09Z",
        "body": "The `SyntaxError: Unexpected token {` message suggests Node.js 4 or earlier is being used at install time so there are probably multiple, conflicting versions of Node.js on this machine."
      }
    ]
  },
  {
    "number": 1794,
    "title": "I don't know the difference between these two codes. input missing error.",
    "created_at": "2019-07-18T05:32:14Z",
    "closed_at": "2019-07-19T05:33:26Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1794",
    "body": "What are you trying to achieve?\r\nI'd like to know the difference between the two codes I've tried in an image size situation.\r\n\r\nHave you searched for similar questions?\r\nYes But I couldn't get a clear answer.\r\n\r\nAre you able to provide a standalone code sample that demonstrates this question?\r\nyes\r\n \r\nAre you able to provide a sample image that helps explain the question?\r\nyes \r\n\r\n\r\nthis code work\r\n```\r\nsharp('./vvvanillA.jpg')\r\n    .resize(200)\r\n    .jpeg()\r\n    .toBuffer()\r\n    .then( data => {\r\n        fs.writeFileSync('./yellow.jpg', data);\r\n    })\r\n    .catch( err => {\r\n        console.log(err);\r\n    }); \r\n```\r\n\r\nThis code does not work and causes an error.\r\n\"input missing\"\r\n\r\n```  \r\nfs.readdir(dirname, function(err , filenames) {\r\n    if (err) {\r\n      return;\r\n    }\r\n    filenames.forEach(function(filename) {\r\n      fs.readFile(dirname + \"/\" + filename, 'utf-8', async function(err, content) {\r\n        if(filename.includes(\"jpg\")){\r\n          sharp(content).resize(300, 400).toFile(\"transformed.jpg\").then((info) => {\r\n            fs.writeFileSync('test1.jpg', info);\r\n          }).catch(err=>console.log(err));\r\n        }\r\n\r\n        if (err) {\r\n          return;\r\n        }\r\n      });\r\n    });\r\n  });\r\n```\r\n\r\nHello. \r\nI have a question.\r\n\r\nThe second code has an error and the first code works properly.\r\n\r\nI don't know the difference between these two codes.\r\nFrom the list of differences that appear to be explicit, \r\nThe input of the first code directly refers to the file.\r\nThe second code is the content used in the callback using readFile.\r\n\r\nI tried debugging to solve the error.\r\nWhat I deduced is that...\r\nThe idea is that the content from the callback of the second code fs.readFile is not the input of the desired form in the sharp.\r\n\r\nSo I tried to check the sourcode but I couldn't check the source code of the sharp because it was not js.\r\n\r\nI want you to let me know the error in my code. \r\n\r\nThank you.\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1794/comments",
    "author": "Dailyscat",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-07-18T09:31:56Z",
        "body": "Hi, this code has a race condition where multiple instance of sharp can all write to \"transformed.jpg\" at the same time. Also, the resolved `info` is an Object containing metadata rather than image data.\r\n\r\nThis sort of question might be more appropriate for StackOverflow."
      },
      {
        "user": "Dailyscat",
        "created_at": "2019-07-18T15:54:20Z",
        "body": "Thank you very much. I saw the error 'missing input'. And I thought it was an error caused by different input values that are accepted by 'sharp' when it is executed with readfile and directly by 'path'."
      }
    ]
  },
  {
    "number": 1790,
    "title": "Resize and Composite happen out of order",
    "created_at": "2019-07-12T16:25:58Z",
    "closed_at": "2019-08-14T19:30:33Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1790",
    "body": "**What is the output of running `npx envinfo --binaries --languages --system --utilities`?**\r\n```\r\n  System:\r\n    OS: Linux 4.19 Debian GNU/Linux 10 (buster) 10 (buster)\r\n    CPU: (4) x64 Intel(R) Core(TM) i7-6600U CPU @ 2.60GHz\r\n    Memory: 720.52 MB / 7.09 GB\r\n    Container: Yes\r\n    Shell: 5.7.1 - /bin/zsh\r\n  Binaries:\r\n    Node: 10.16.0 - /usr/bin/node\r\n    Yarn: 1.12.3 - /usr/bin/yarn\r\n    npm: 6.9.0 - /usr/bin/npm\r\n  Utilities:\r\n    CMake: 3.13.4 - /usr/bin/cmake\r\n    Make: 4.2.1 - /usr/bin/make\r\n    GCC: 8.3.0 - /usr/bin/gcc\r\n    Git: 2.20.1 - /usr/bin/git\r\n  Languages:\r\n    Bash: 5.0.3 - /bin/bash\r\n    Go: 1.11.6 - /usr/bin/go\r\n    Elixir: 1.8.2 - /usr/bin/elixir\r\n    Java: 1.8.0_201 - /usr/bin/javac\r\n    Perl: 5.28.1 - /usr/bin/perl\r\n    Python: 2.7.16 - /usr/bin/python\r\n    Ruby: 2.5.5 - /usr/bin/ruby\r\n    Rust: 1.17.0 - /home/f0x/.cargo/bin/rustup\r\n```\r\n\r\n**What are the steps to reproduce?**\r\nHaving a resize operation after a composite, will result in the composite happening on the resized image.\r\n\r\n**What is the expected behaviour?**\r\nThe composite should happen first, because it's earlier in the line. After that, the image should get the resize\r\n\r\n**Are you able to provide a standalone code sample, without other dependencies, that demonstrates this problem?**\r\n```\r\nconst sharp = require('sharp');\r\nsharp({create: {height: 100, width: 100, channels: 3, background: 'red'}})\r\n\t.composite([{input: {create: {width: 10, height: 10, channels: 3, background: 'green'}}, gravity: \"southwest\"}])\r\n\t.resize({width: 300, height: 300})\r\n\t.toFile(\"out.png\")\r\n```\r\n\r\nThe green square will still be 10x10 pixels, instead of being resized with the original image.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1790/comments",
    "author": "f0x52",
    "comments": [
      {
        "user": "f0x52",
        "created_at": "2019-07-12T16:28:33Z",
        "body": "This also happens when using `extend`"
      },
      {
        "user": "lovell",
        "created_at": "2019-07-17T09:41:20Z",
        "body": "Hi, you'll need to break this into two pipelines, something like:\r\n```javascript\r\nconst composited = await sharp({create: {height: 100, width: 100, channels: 3, background: 'red'}})\r\n  .composite([{input: {create: {width: 10, height: 10, channels: 3, background: 'green'}}, gravity: \"southwest\"}])\r\n  .png();\r\n  .toBuffer();\r\n\r\nsharp(composited)\r\n  .resize({width: 300, height: 300})\r\n  .toFile(\"out.png\");\r\n```"
      },
      {
        "user": "joepie91",
        "created_at": "2019-07-17T20:57:20Z",
        "body": "This seems like either an implementation bug or an API bug to me, rather than a question. When a fluent API is offered, surely it is reasonable to expect that inherently-ordered operations expressed with it are actually processed in the specified order?\r\n\r\nI can understand that it might be necessary on a *technical* level to break it into two pipelines, but isn't that something that the library should be doing internally as-needed? This way it seems like a leaky abstraction to me, where you need to know exactly how something is internally processed to know where it is valid to use a particular operation."
      },
      {
        "user": "lovell",
        "created_at": "2019-07-17T21:10:09Z",
        "body": "@joepie91 Please see #241"
      }
    ]
  },
  {
    "number": 1779,
    "title": "code only seems to work if intermediate file is used?",
    "created_at": "2019-07-04T16:41:18Z",
    "closed_at": "2019-07-08T16:40:53Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1779",
    "body": "I have a chunk of code as follows:\r\n\r\n```\r\n      var img = sharp(path)\r\n  \r\n      // Extract the grayscale channel?\r\n      // and save as 'newGrey.png'\r\n      var grey = img.extractChannel(0)\r\n      await grey.toColorspace(\"b-w\")\r\n(1)        .toFile(\"newGrey-\"+ client.clientID + client.counter +\".png\")\r\n\r\n      // Load new alpha and join\r\n      let filename = 'transparencies/'+client.rasterConfig.transparency+'.png'\r\n      //console.log(filename)\r\n(2)      await sharp('newGrey-'+ client.clientID + client.counter + '.png')\r\n        .toColorspace(\"b-w\")\r\n        .joinChannel(filename)\r\n        .toBuffer((err, data, info) => { \r\n\r\n```\r\n\r\nThis code works.  \r\n\r\nBut as you can see, I'm basically writing the file to a temp image at point (1), then reload that same temp image at point (2).  This seems totally like it should be redundant.  But if I remove the toFile at (1) and the load at (2), I don't get the same resultant image.\r\n\r\nWhat am I misunderstanding here?\r\n\r\nThanks\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1779/comments",
    "author": "avpavp",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-07-06T12:47:26Z",
        "body": "Hi, if you're using the channel operations then yes, intermediate images will be required. You could use raw, uncompressed pixel data, something like:\r\n```javascript\r\nconst { width, height } = await sharp(path)\r\n  .metadata();\r\n\r\nconst greyscale = await sharp(path)\r\n  .extractChannel(0)\r\n  .toColorspace(\"b-w\")\r\n  .raw()\r\n  .toBuffer();\r\n\r\nconst result = await sharp(greyscale, { raw: { width, height, channels: 1 })\r\n  .toColorspace(\"b-w\")\r\n  .joinChannel(filename)\r\n  .toBuffer();\r\n```"
      },
      {
        "user": "avpavp",
        "created_at": "2019-07-08T16:40:53Z",
        "body": "Ah - thanks for the tip.  I've managed to get this working - with your help!\r\n"
      }
    ]
  },
  {
    "number": 1778,
    "title": "Usage with Axios?",
    "created_at": "2019-07-04T14:39:06Z",
    "closed_at": "2019-07-05T06:15:53Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1778",
    "body": "I'm currently trying to download an image using Axios and then resize the result and save it locally via Node in a GraphQL resolver.\r\n\r\nThis is the block of code I'm working with:\r\n```javascript\r\naxios.get(url)\r\n                .then((response) => {\r\n                    const { set, collector_number } = response.data;\r\n                    const sourceUrl = response.data.image_uris.border_crop;\r\n                    const filename = `${set}/${collector_number}.png`;\r\n                    axios.get(sourceUrl, { responseType: 'arraybuffer' })\r\n                        .then((res) => {\r\n                            console.log(`Resizing Image!`)\r\n                            sharp(res)\r\n                                .resize(226, 321)\r\n                                .toFile(`../cardimg/${filename}`)\r\n                                .then(() => {\r\n                                    console.log(`Image downloaded and resized!`)\r\n                                })\r\n                                .catch((err) => {\r\n                                    console.log(`Couldn't process: ${err}`);\r\n                                })\r\n                        })\r\n                })\r\n```\r\n\r\nWhen I execute the code (via GraphQL Mutation), it throws an error saying that states `Input file is missing`.\r\n\r\nNot sure if it's misuse of Axios, or if I'm doing something wrong with Sharp.\r\n\r\nAny suggestions?   I was originally worried that I needed to mess with the format of the response coming from the HTTP request, but from what I can gather, I'm doing it correctly.  \r\n\r\nThanks in advance!\r\n\r\nI've used `console.log` to ensure that it's definitely grabbing an image and the URL is correct, so that's already been tested, so the `sourceUrl` is indeed grabbing an image, I'm just not sure how to properly do anything -with-  the data that I'm grabbing.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1778/comments",
    "author": "czbak3r",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-07-04T15:06:24Z",
        "body": "I think Axios returns an object on which the `data` property is of interest:\r\n\r\n```diff\r\n-    .then((res) => {\r\n+    .then(({ data }) => {\r\n```"
      },
      {
        "user": "czbak3r",
        "created_at": "2019-07-04T16:25:15Z",
        "body": "You're right!\r\n\r\nI used `.data` on the first Axios request but not the second one.\r\n\r\nOversight.  Oops.\r\n\r\nThank you!\r\n\r\nI'll double check after work.  :)"
      },
      {
        "user": "ChristianRich",
        "created_at": "2022-11-29T07:27:09Z",
        "body": "Doh... I just fell into the exact same trap and ended up here :-)"
      }
    ]
  },
  {
    "number": 1774,
    "title": "Limit jpeg quality to that of source image",
    "created_at": "2019-07-02T14:24:35Z",
    "closed_at": "2019-07-19T20:47:22Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1774",
    "body": "If the source image has a quality of 60 and I've set it to 50, then it should decrease to the limit of 50. But if the source image is 40, then perhaps it shouldn't increase to 50 in the output image.\r\n\r\nI have files that are actually increasing in size after running them through sharp because my jpeg quality setting is higher than the source's, even though nothing else changes. I suppose there's no benefit to increasing the quality beyond what the source provides.\r\n\r\nCould there be something (similar to the `withoutEnlargement` parameter for `resize` function) like `withoutIncrease` for `jpeg` function? And maybe a `same` parameter to make the quality of the output image the same as the source image without increasing or decreasing it?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1774/comments",
    "author": "rightaway",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-07-02T21:03:24Z",
        "body": "Please see #908 for why this is not possible."
      }
    ]
  },
  {
    "number": 1767,
    "title": "is sharp(undefined, { raw: ... }) valid? if not, it would be handy to have it error.",
    "created_at": "2019-06-27T16:40:02Z",
    "closed_at": "2019-06-27T22:21:29Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1767",
    "body": "I had some issues where I was trying to do some processing with sharp, and was getting stuck inside a promise that never resolved or rejected.  Turns out that I was accidentally passing in undefined variables as the first parameter to sharp(), and it took me quite a while to locate that as the culprit because there was no error or warning or anything.\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1767/comments",
    "author": "ericblade",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-06-27T22:21:29Z",
        "body": "Let's track this in #1768 as it's the same thing and benefits from a code sample."
      }
    ]
  },
  {
    "number": 1766,
    "title": "Resize doesn't come out with exact height for fit inside option",
    "created_at": "2019-06-27T05:22:12Z",
    "closed_at": "2019-07-19T20:47:04Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1766",
    "body": "What are you trying to achieve?\r\nResize image with exact width and height with fit `inside` however I'm getting one pixel smaller which is height 447 instead of 448 (which is what is in parameter for resize command)\r\n\r\nHave you searched for similar questions?\r\nYes in issues but cannot find one\r\n\r\nAre you able to provide a standalone code sample that demonstrates this question?\r\n```\r\n.resize({\r\n        width: 347,\r\n        height: 448,\r\n        fit: sharp.fit.inside\r\n})\r\n```\r\n\r\nAre you able to provide a sample image that helps explain the question?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1766/comments",
    "author": "jaekunchoi",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-06-27T22:18:02Z",
        "body": "Please can you provide an input image and complete, standalone code sample that exhibits this behaviour."
      },
      {
        "user": "lovell",
        "created_at": "2019-07-19T20:47:04Z",
        "body": "Closing due to inactivity but please feel free to reopen with more details if further help is required."
      }
    ]
  },
  {
    "number": 1765,
    "title": "toFile() does not warn if folder does not exist",
    "created_at": "2019-06-25T07:43:24Z",
    "closed_at": "2019-06-25T09:41:12Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1765",
    "body": "What is the output of running `npx envinfo --binaries --languages --system --utilities`?\r\n  System:\r\n    OS: Linux 4.9 Alpine Linux undefined\r\n    CPU: (2) x64 Intel(R) Core(TM) i7-6500U CPU @ 2.50GHz\r\n    Memory: 1.45 GB / 1.93 GB\r\n    Container: Yes\r\n    Shell: Unknown - /bin/ash\r\n  Binaries:\r\n    Node: 10.15.3 - /usr/bin/node\r\n    npm: 6.4.1 - /usr/bin/npm\r\n\r\nUsing latest gazf/alpine-sharp docker image.\r\n\r\n### What are the steps to reproduce?\r\n\r\nUse sharp().composite.toFile(file) where the file path is a directory that does not exist.\r\nThe file outputting fails, without error or warning.\r\n\r\n### What is the expected behaviour?\r\n\r\nI feel like I should have got some feedback that the output was failing because the folder did not exist.\r\n\r\n### Are you able to provide a standalone code sample, without other dependencies, that demonstrates this problem?\r\n\r\n```\r\nasync function compositeDiff(file, width) {\r\n  var margin = 10;\r\n  sharp(diffDir + file)\r\n      .extend({\r\n        top: 0,\r\n        bottom: 0,\r\n        left: 0,\r\n        right: ((width + margin) * 2)\r\n      })\r\n      .composite([\r\n          {\r\n            input: referenceDir + resizedDir + file,\r\n            left: width + margin,\r\n            top: 0\r\n          },\r\n          {\r\n            input: testDir + resizedDir + file,\r\n            left: (width + margin) * 2,\r\n            top: 0\r\n          },\r\n      ])\r\n      .toFile(comparisonDir + file)\r\n}\r\n```\r\n\r\nCalling this function in a script that is called from a docker-compose command using the gazf/alpine-sharp image produces no error or warning output, but outputs no file.\r\nInserting a mkdir at the start of the function fixes the problem of no file being outputted.\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1765/comments",
    "author": "jonathanjfshaw",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-06-25T07:52:09Z",
        "body": "Hi, I see the following error when attempting to write to a non-existent directory via `toFile()`:\r\n```\r\nError: vips__file_open_write: unable to open file \"does-not-exist/output.jpg\" for writing\r\nunix error: No such file or directory\r\n```\r\nPerhaps some error handling is required in the code that calls the `compositeDiff()` function shown in this example? In addition, you're not returning the promise chain - try the following:\r\n\r\n```diff\r\n-  sharp(diffDir + file)\r\n+  return sharp(diffDir + file)\r\n```\r\nor \r\n```diff\r\n-  sharp(diffDir + file)\r\n+  await sharp(diffDir + file)\r\n```\r\n\r\nPlease see #639 #874 #1052"
      },
      {
        "user": "jonathanjfshaw",
        "created_at": "2019-06-25T09:41:12Z",
        "body": "Yeah, I'm no js dev, so probably just mishandling errors and promises. "
      }
    ]
  },
  {
    "number": 1762,
    "title": "how to fix Something went wrong installing the “sharp” module and Cannot find module '../build/Release/sharp.node' in expo",
    "created_at": "2019-06-23T11:15:47Z",
    "closed_at": "2019-06-23T11:19:20Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1762",
    "body": "What are you trying to achieve?\r\n\r\nHave you searched for similar questions?\r\n\r\nAre you able to provide a standalone code sample that demonstrates this question?\r\n\r\nAre you able to provide a sample image that helps explain the question?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1762/comments",
    "author": "saidhappy010",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-06-23T11:19:20Z",
        "body": "Please see #1696"
      },
      {
        "user": "saidhappy010",
        "created_at": "2019-06-24T10:27:09Z",
        "body": "@lovell Thank you very much"
      },
      {
        "user": "huykon",
        "created_at": "2019-11-27T02:00:33Z",
        "body": "still have error :( "
      }
    ]
  },
  {
    "number": 1749,
    "title": "remove metadata tag",
    "created_at": "2019-06-12T10:26:36Z",
    "closed_at": "2019-06-26T19:28:32Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1749",
    "body": "Is there a way to remove metadata tag e.g. `Orientation` or would that be a task for different lib e.g. `exif`?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1749/comments",
    "author": "przemyslawpluta",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-06-12T12:02:11Z",
        "body": "Please see #650 for a future possible enhancement to set custom metadata."
      }
    ]
  },
  {
    "number": 1743,
    "title": "detect a grayscale image",
    "created_at": "2019-06-06T10:41:27Z",
    "closed_at": "2019-06-06T12:01:39Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1743",
    "body": "I'm trying to detect a grayscale image with a google firebase function. I tried this way:  #284 \r\n\r\nAtm I'm not able to call the maxColourDistance Function. (function is undefined)\r\n\r\nHow can I call the function or is there a different way? ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1743/comments",
    "author": "felicks",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-06-06T12:01:39Z",
        "body": "Hi, I've commented on #284 - let's continue to track this there."
      }
    ]
  },
  {
    "number": 1742,
    "title": "NEF & CR2 raw files to JPG",
    "created_at": "2019-06-05T13:32:34Z",
    "closed_at": "2019-06-06T07:31:21Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1742",
    "body": "Is there a way to convert `NEF` & `CR2` raw files from DSLR camera to `JPG` with sharp?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1742/comments",
    "author": "przemyslawpluta",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-06-05T13:58:28Z",
        "body": "Hi, did you see #616?"
      },
      {
        "user": "przemyslawpluta",
        "created_at": "2019-06-06T07:31:20Z",
        "body": "Thanks."
      },
      {
        "user": "przemyslawpluta",
        "created_at": "2019-06-06T20:02:53Z",
        "body": "@lovell would the functionality similar to `extractJpgFromRaw` or `extractPreview` in `exiftool`be possible in `sharp`?"
      }
    ]
  },
  {
    "number": 1717,
    "title": "Error while trying to use composite",
    "created_at": "2019-05-23T18:21:47Z",
    "closed_at": "2019-05-27T10:18:27Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1717",
    "body": "I'm trying to use composite like this:\r\n\r\n```\r\nconst sharpFile = this.electronService.sharp(null, options);\r\n\r\nconst pagePhotos = page.allPhotos.map(photo => {\r\n  return {\r\n    input: photo.photo.sizes[0].localPath,\r\n    top: Math.round(photo.y),\r\n    left: Math.round(photo.x)\r\n  };\r\n});\r\n\r\nconsole.log(pagePhotos);\r\n\r\nconst pageBuffer = sharpFile.composite(pagePhotos).toBuffer();\r\n\r\n// localPath is something like this\r\n// \"/Users/username/Library/Application Support/projectname/projects/PKTFB45BW/photos/FKYCARH45MQ-1000.jpg\"\r\n```\r\n\r\nI'm getting this error\r\n\r\n```\r\nUnhandled Promise rejection: Input buffer contains unsupported image format ; Zone: <root> ; Task: null ; Value: Error: Input buffer contains unsupported image format Error: Input buffer contains unsupported image format\r\n\r\nError: Input buffer contains unsupported image format\r\n```\r\n\r\nWhat am I doing wrong?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1717/comments",
    "author": "GunterJameda",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-05-23T19:52:17Z",
        "body": "Hi, I might need a more complete code sample. What is `options` set to?"
      },
      {
        "user": "GunterJameda",
        "created_at": "2019-05-24T09:20:38Z",
        "body": "Options is set to this:\r\n\r\n```\r\nconst options: SharpOptions = {\r\n  create:\r\n    {\r\n      width: Math.floor(page.width * page.zoom),\r\n      height: Math.floor(page.height * page.zoom),\r\n      channels: 3,\r\n      background: ColorUtil.hex2rgb(page.backgroundColor)\r\n    }\r\n  };\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2019-05-24T15:23:41Z",
        "body": "Thanks. Is `photo.photo.sizes[0].localPath` a string? Are you able to provide an image that fails in this manner?"
      },
      {
        "user": "GunterJameda",
        "created_at": "2019-05-24T15:27:50Z",
        "body": "Yes. As I previously said, it is a string like this:\r\n\r\n`/Users/username/Library/Application Support/projectname/projects/PKTFB45BW/photos/FKYCARH45MQ-1000.jpg`\r\n\r\nAll images fail, to be precise. I don't understand why, since the path is absolute."
      },
      {
        "user": "lovell",
        "created_at": "2019-05-24T15:33:02Z",
        "body": "Please can you provide a complete, standalone code sample/repo that exhibits this behaviour."
      },
      {
        "user": "GunterJameda",
        "created_at": "2019-05-24T15:40:10Z",
        "body": "The code I just provided is as complete as it can be, but I'll write it all together and make some adjustments to be a working one.\r\n\r\n```\r\nconst options: SharpOptions = {\r\n  create:\r\n    {\r\n      width: 2000,\r\n      height: 1000,\r\n      channels: 3,\r\n      background: {r:0,g:0,b:0}\r\n    }\r\n  };\r\n\r\nconst photos = [\r\n'/Users/username/Library/Application Support/projectname/projects/PKTFB45BW/photos/A.jpg',\r\n'/Users/username/Library/Application Support/projectname/projects/PKTFB45BW/photos/B.jpg',\r\n'/Users/username/Library/Application Support/projectname/projects/PKTFB45BW/photos/C.jpg'\r\n];\r\n\r\nconst sharpFile = this.electronService.sharp(null, options);\r\n\r\nconst pagePhotos = photos.map((photo, index) => {\r\n  return {\r\n    input: photo,\r\n    top: 100 + 100 * index,\r\n    left: 100 + 100 * index\r\n  };\r\n});\r\n\r\nconst pageBuffer = sharpFile.composite(pagePhotos).toBuffer();\r\n```\r\n\r\nI'm not sure if this will do the trick."
      },
      {
        "user": "lovell",
        "created_at": "2019-05-24T16:57:42Z",
        "body": "I'm unable to reproduce this problem using the provided code snippet.\r\n\r\nThe original report was an \"Unhandled Promise rejection\" so I can only suggest you add some error handling to your code to help narrow down exactly where the problem is occurring.\r\n\r\nPerhaps there's some code not shown here that also uses sharp? What is `pageBuffer` (which is a Promise, not a Buffer) used for? "
      },
      {
        "user": "GunterJameda",
        "created_at": "2019-05-24T17:05:10Z",
        "body": "It was thenned, after that and then the buffer would be injected in sharp again.\r\n\r\nEDIT: below is another possible pain point. It is not the `then` code.\r\n\r\nI was initially trying to change this snippet (which works all fine)\r\n\r\n```\r\nconst pageBuffer: Promise<Buffer> = page.allPhotos.reduce<Promise<Buffer>>((bufferPromise: Promise<Buffer>, framePhoto) =>\r\n      bufferPromise.then((buffer => this.electronService.sharp(framePhoto.photo.sizes[0].localPath)\r\n        .rotate(undefined, {\r\n          background: { r: 0, g: 0, b: 0 }\r\n        })\r\n        .resize(\r\n          Math.round(framePhoto.width - framePhoto.borderThickness * 2),\r\n          Math.round(framePhoto.height - framePhoto.borderThickness * 2))\r\n        .extend({\r\n          top: framePhoto.borderThickness,\r\n          left: framePhoto.borderThickness,\r\n          right: framePhoto.borderThickness,\r\n          bottom: framePhoto.borderThickness\r\n        })\r\n        .toBuffer()\r\n        .then(frameBuffer => this.electronService.sharp(buffer).overlayWith(\r\n          frameBuffer,\r\n          {\r\n            top: Math.round(framePhoto.y),\r\n            left: Math.round(framePhoto.x)\r\n          }).toBuffer())\r\n      ) as any)\r\n      , sharpFile.jpeg().toBuffer() as any as Promise<Buffer>);\r\n```\r\n\r\nto `composite` method, which didn't work at all and threw that error. I tried to catch the error and the message was unclear, anyway. Here it is:\r\n\r\n`Error: Input buffer contains unsupported image format`"
      },
      {
        "user": "lovell",
        "created_at": "2019-05-25T09:15:43Z",
        "body": "Thank you for providing a more complete code sample.\r\n\r\nIf you've used `create` to create a new, blank image but have not specified any output format e.g. via `png()` etc. then the data returned by `toBuffer()` will be raw, uncompressed pixel data.\r\n\r\nIt looks like you might be feeding the resolved value of `pageBuffer` back into a new sharp instance, so you'll need to describe that raw data.\r\n\r\n```javascript\r\nsharp(rawBuffer, { raw: { width, height, channels }})...\r\n```"
      },
      {
        "user": "GunterJameda",
        "created_at": "2019-05-27T10:18:27Z",
        "body": "Thank you for your help!\r\nIt solved the issue! :)"
      }
    ]
  },
  {
    "number": 1712,
    "title": "Using with AWS Lambda 10.x appears to be broken",
    "created_at": "2019-05-21T21:23:47Z",
    "closed_at": "2019-05-22T17:29:48Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1712",
    "body": "After installing locally (On OS X) using:\r\n```\r\nnpm install --arch=x64 --platform=linux --target=10.15.3\r\n```\r\n\r\nOn uploading to AWS lambda, attempting to load the module with:\r\n\r\n```\r\nconst sharp = require('sharp');\r\n```\r\n\r\nCauses:\r\n\r\n```\r\nError: Cannot find module './constructor'\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1712/comments",
    "author": "JonRowe",
    "comments": [
      {
        "user": "wesselvdv",
        "created_at": "2019-05-22T08:44:07Z",
        "body": "I am actually running this successfully on AWS Lambda with nodejs10.x (10.15), only thing for me is that resizing doesn't seem to work."
      },
      {
        "user": "JonRowe",
        "created_at": "2019-05-22T08:45:53Z",
        "body": "@wesselvdv did you have to anything beyond `npm install` ? / what platform did you build it from?"
      },
      {
        "user": "lovell",
        "created_at": "2019-05-22T09:03:36Z",
        "body": "@JonRowe Does the `node_modules/sharp/lib/constructor.js` file exist in your deployment zip file? Are you using a bundler such as webpack? Does Node 8 work?"
      },
      {
        "user": "wesselvdv",
        "created_at": "2019-05-22T09:08:39Z",
        "body": "@JonRowe It's actually working for me, I mistakenly attributed the resize failure to sharp. I am using a Dockerfile as builder which uses `amazonlinux:2` as base. I am even running the entire lambda through Webpack (incl. Sharp)."
      },
      {
        "user": "JonRowe",
        "created_at": "2019-05-22T17:30:14Z",
        "body": "Sorry, turns out this was user error in the install process, my build script didn't add all the files. Apologies for the waste of time!"
      }
    ]
  },
  {
    "number": 1711,
    "title": "setting libvip version",
    "created_at": "2019-05-21T19:21:09Z",
    "closed_at": "2019-06-26T19:15:29Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1711",
    "body": "I have a privately hosted repo of libvips, 8.6.4.\r\n\r\nIs there a way I can use libvips 8.6.4 when I set my sharp dist base instead of the one stated in the package.json?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1711/comments",
    "author": "someotherdata",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-05-21T20:49:38Z",
        "body": "You'll either need to change the `package.json` or the URL if you're using an older version of libvips with a newer version of sharp.\r\n\r\nBeware that if you're doing this you won't be able to rely on the prebuilt sharp binaries as they are linked against a specific version of libvips. They might appear to work but ABI inconsistencies and therefore undefined behaviour is likely."
      }
    ]
  },
  {
    "number": 1706,
    "title": "composite blend mode \"in\" causing resulting color different from source color if the destination is not opaque (alpha is less than 1)",
    "created_at": "2019-05-19T05:38:41Z",
    "closed_at": "2019-06-02T10:54:17Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1706",
    "body": "What is the output of running `npx envinfo --binaries --languages --system --utilities`?\r\n  System:\r\n    OS: macOS 10.14.4\r\n    CPU: (8) x64 Intel(R) Core(TM) i7-4850HQ CPU @ 2.30GHz\r\n    Memory: 420.60 MB / 16.00 GB\r\n    Shell: 3.2.57 - /bin/bash\r\n  Binaries:\r\n    Node: 8.11.1 - /usr/local/bin/node\r\n    Yarn: 1.3.2 - /usr/local/bin/yarn\r\n    npm: 5.6.0 - /usr/local/bin/npm\r\n  Utilities:\r\n    Git: 2.18.0 - /usr/local/bin/git\r\n  Languages:\r\n    Bash: 3.2.57 - /bin/bash\r\n    Java: 1.8.0_60 - /usr/bin/javac\r\n    Perl: 5.18.2 - /usr/bin/perl\r\n    PHP: 7.2.7 - /usr/local/bin/php\r\n    Python: 2.7.15 - /usr/local/bin/python\r\n    Ruby: 2.3.7 - /usr/bin/ruby\r\nWhat are the steps to reproduce?\r\n\r\n1/ create color rectangle with { r: 127, g: 255, b: 127, alpha: 1 } to use as the source\r\n2/ create semi transparent rect with { r: 0, g: 0, b: 0, alpha: 0.8 } to use as the destination\r\napply the source to the destination by composite with blend mode \"in\"\r\n\r\nWhat is the expected behaviour?\r\n\r\nthe outcome should have the color of the source and the alpha of the destination { r: 127, g: 255, b: 127, alpha: 0.8}, instead, the result is  { r: 158, g: 255, b: 158, alpha: 0.8}.\r\n\r\nAre you able to provide a standalone code sample, without other dependencies, that demonstrates this problem?\r\n\r\nsharp({\r\n  create: {\r\n    width: 300,\r\n    height: 200,\r\n    channels: 4,\r\n    background: { r: 127, g: 255, b: 127, alpha: 1 }\r\n  }\r\n})\r\n.png()\r\n.toBuffer()\r\n.then(colorPanel=>{\r\n  sharp({\r\n    create: {\r\n      width: 300,\r\n      height: 200,\r\n      channels: 4,\r\n      background : { r: 0, g: 0, b: 0, alpha: 0.8 }\r\n    },\r\n  })\r\n  .composite([\r\n    {\r\n      input: colorPanel,\r\n      blend: 'in'\r\n    }\r\n  ])\r\n  .toFile('img/test.png')\r\n})\r\n\r\nAre you able to provide a sample image that helps explain the problem?\r\n\r\nAll the images can be created with code",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1706/comments",
    "author": "MrNghia123",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-05-19T12:54:34Z",
        "body": "Hi, this looks like the same problem as #1676, which relates to brighter-than-expected output pixel values when the alpha channel is semi-transparent."
      }
    ]
  },
  {
    "number": 1695,
    "title": "How to skip images unsupported format",
    "created_at": "2019-05-11T03:21:15Z",
    "closed_at": "2019-05-13T17:51:14Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1695",
    "body": "Hi\r\n\r\n\r\nI am getting the **Input file contains unsupported image format** Error. How can I skip images that supposedly are not the correct format?\r\n\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1695/comments",
    "author": "stefanomonteiro",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-05-11T09:57:38Z",
        "body": "You'll probably need to add some error handling to your code.\r\n\r\nYou've not provided any sample code here but `toFile()` or `toBuffer()` will either reject or pass an error to the callback depending on the context in which they are used."
      },
      {
        "user": "stefanomonteiro",
        "created_at": "2019-05-11T17:18:00Z",
        "body": "Thanks\r\n\r\nI used node `path.extname(file)` and conditioned the code to run if the file is of extension I want to work with.\r\n\r\n```\r\nfs.readdir(path, function(err, files) {\r\n    files.forEach(function(file) {\r\n      if (path.extname(file) === \".jpg\" || path.extname(file) === \".png\") {\r\n          ////CODE\r\n      }\r\n```"
      }
    ]
  },
  {
    "number": 1692,
    "title": "How is the best way to update Sharp?",
    "created_at": "2019-05-08T22:06:22Z",
    "closed_at": "2019-05-09T12:43:15Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1692",
    "body": "I would like to know what is the best way to update sharp to the latest version on production server.\r\n\r\nThanks.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1692/comments",
    "author": "nunowar",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-05-09T08:23:03Z",
        "body": "How do you currently update other dependencies? What have you tried? What didn't work?"
      },
      {
        "user": "nunowar",
        "created_at": "2019-05-09T12:43:15Z",
        "body": "It was problem of permission. With just `npm update` it's works perfect. Thanks."
      }
    ]
  },
  {
    "number": 1681,
    "title": "Image compositing very slow",
    "created_at": "2019-04-29T19:17:26Z",
    "closed_at": "2019-06-02T10:53:16Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1681",
    "body": "Hey there :-),\r\nI'm trying to render a lot of images, each containing about ~256 images itself, using sharp's composite.\r\nI'm collecting all the input images and their top-/ left-coordinates using into an array, and passing that into _sharp.composite_ afterwards.\r\nThe problem is that sharp seems to be _very_ slow when compositing. Again, it's about ~256 input images into a 256x256px png (every base image is 16x16)px.\r\nI tried some different image libraries.\r\nUsing Jimp I got about 8 images/ second, Mapbox got me about 50 images/ second, but sharp only gives me 1 to 2 images/ second. I'm using the same base code to collect the images for every different image library.\r\n\r\nI was wondering, is sharp's strength only in resizing images or am I doing something wrong? Is there something I can configure to improve performance?\r\nOtherwise, sharp is more than perfect and does everything I want, so I would want to reduce the list of dependencies and just stick to sharp...\r\n\r\nI hope you have an amazing week,\r\nclarkx86 :)",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1681/comments",
    "author": "clvrk",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-04-30T08:35:47Z",
        "body": "Hi, what you describe here sounds more like stitching images without overlap rather than compositing so the proposed feature of #1580 might better provide what you're looking for."
      },
      {
        "user": "jcupitt",
        "created_at": "2019-04-30T09:17:15Z",
        "body": "Hello, the x/y offset feature was added to composite in 8.7, and implemented in the simplest way you can imagine. It's been rewritten for 8.8 (due in a few weeks) and should be quicker now.\r\n\r\nI made a tiny benchmark in Python:\r\n\r\n```\r\n#!/usr/bin/python3\r\n\r\nimport sys\r\nimport random\r\nimport pyvips\r\n\r\nbg = pyvips.Image.new_from_file(sys.argv[1])\r\nfg = [pyvips.Image.new_from_file(filename) for filename in sys.argv[2:]]\r\nxes = [random.randint(0, bg.width - 16) for i in range(len(fg))]\r\nyes = [random.randint(0, bg.height - 16) for i in range(len(fg))]\r\n\r\nfor i in range(100):\r\n    bg.composite(fg, \"over\", x=xes, y=yes).copy_memory()\r\n```\r\n\r\nThat's compositing args 2+ on top of arg1 100 times. I can run it like this:\r\n\r\n```\r\n$ vips crop ~/pics/wtc.jpg base.jpg 0 0 256 256\r\n$ vips crop ~/pics/PNG_transparency_demonstration_1.png x.png 150 150 16 16 \r\n$ for i in {0..256}; do cp x.png $i.png; done\r\n$ time ../composite-many.py base.jpg *.png\r\nreal\t0m9.067s\r\nuser\t0m15.710s\r\nsys\t0m0.407s\r\n```\r\n\r\nSo about 11 per second. With 8.7, I see:\r\n\r\n```\r\n$ time ../composite-many.py base.jpg *.png\r\nreal\t0m17.563s\r\nuser\t0m42.677s\r\nsys\t0m0.768s\r\n```\r\n\r\nAbout 6 per second.\r\n\r\nYou'll see a larger speedup with larger images -- 256x256 is too small for the libvips threading system to be very effective."
      },
      {
        "user": "jcupitt",
        "created_at": "2019-05-01T15:39:20Z",
        "body": "I remembered one more possibility: composite uses g++ vector arithmetic to generate SIMD code. If your gcc is too old of if your CPU does not support 4xfloat SIMD, it may not work and it'll fall back to a slower vanilla C path.\r\n\r\nCheck for this in configure output:\r\n\r\n```\r\nchecking for gcc with working vector support... yes\r\nchecking for C++ vector shuffle... yes\r\nchecking for C++ vector arithmetic... yes\r\nchecking for C++ signed constants in vector templates... yes\r\n```"
      },
      {
        "user": "jcupitt",
        "created_at": "2019-05-01T15:40:57Z",
        "body": "And @lovell is correct of course, `arrayjoin` will be much faster if you are simply making a grid of small images."
      }
    ]
  },
  {
    "number": 1675,
    "title": "Upgrading from 0.21.3 to 0.22.1 leads to: \"undefined symbol: cairo_tag_end\" - When using LD_PRELOAD with Electron",
    "created_at": "2019-04-28T00:05:07Z",
    "closed_at": "2019-04-29T22:39:22Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1675",
    "body": "### What is the output of running `npx envinfo --binaries --languages --system --utilities`?\r\n\r\n```\r\n  System:\r\n    OS: Linux 4.10 Linux Mint 18.3 (Sylvia)\r\n    CPU: (2) x64 Intel(R) Core(TM) i5-4690K CPU @ 3.50GHz\r\n    Memory: 1.16 GB / 3.84 GB\r\n    Container: Yes\r\n    Shell: 4.3.48 - /bin/bash\r\n  Binaries:\r\n    Node: 10.15.1 - /usr/bin/node\r\n    Yarn: 1.13.0 - /usr/bin/yarn\r\n    npm: 6.4.1 - /usr/bin/npm\r\n  Utilities:\r\n    Make: 4.1 - /usr/bin/make\r\n    GCC: 5.4.0 - /usr/bin/gcc\r\n    Git: 2.7.4 - /usr/bin/git\r\n  Languages:\r\n    Bash: 4.3.48 - /bin/bash\r\n    Perl: 5.22.1 - /usr/bin/perl\r\n    Python: 2.7.12 - /usr/bin/python\r\n    Ruby: 2.3.1 - /usr/bin/ruby\r\n\r\n```\r\n\r\n### What are the steps to reproduce?\r\n\r\n`cross-env LD_PRELOAD=./node_modules/sharp/vendor/lib/libz.so electron [some args]`\r\n\r\n### What is the expected behaviour?\r\n\r\nLD_PRELOAD magically fixes everything like it did with `Sharp@0.21.3`, if that's possible.\r\n\r\n### Are you able to provide a standalone code sample, without other dependencies, that demonstrates this problem?\r\n\r\nYes I believe so. If a fix or workaround aren't immediately apparent, I think I can put together a repo for this. This doesn't seem to be reproducible though when using LD_PRELOAD on a machine with `zlib@1.2.11` already installed though, so actually such a repo might have OS level requirements to reproduce.\r\n\r\n### Are you able to provide a sample image that helps explain the problem?\r\n\r\nThings don't get that far.\r\n\r\n### Other info\r\n\r\n**Electron** 4.1.5\r\n\r\nLove the prebuilt images for Electron 4 and 5! I found some references to this error on the web, but nothing that seemed to point me towards anything actionable",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1675/comments",
    "author": "Nantris",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-04-29T10:22:18Z",
        "body": "Hi, this error relates to cairo. Are you using `node-canvas` also? If so, how is it's cairo dependency installed?"
      },
      {
        "user": "Nantris",
        "created_at": "2019-04-29T17:15:37Z",
        "body": "Thanks for your reply @lovell. We're not using of `node-canvas`.\r\n\r\nIn case there's anything we can do to work-around Cairo, we're just using `Sharp` for conversion of `jpg` and `png` to `webp` and nothing more.\r\n\r\nWould putting together a repo be the best next step to figure this out? Is there anything else that comes to mind? \r\n\r\nThanks again @lovell!"
      },
      {
        "user": "lovell",
        "created_at": "2019-04-29T17:47:32Z",
        "body": "Thanks, I can see that it is the `electron` binary itself that depends on the Linux system's libcairo shared libraries:\r\n```sh\r\n$ npm install electron\r\n$ ldd node_modules/electron/dist/electron | grep cairo\r\n\tlibpangocairo-1.0.so.0 => /usr/lib/x86_64-linux-gnu/libpangocairo-1.0.so.0 (0x00007f8797a95000)\r\n\tlibcairo.so.2 => /usr/lib/x86_64-linux-gnu/libcairo.so.2 (0x00007f8797902000)\r\n\tlibcairo-gobject.so.2 => /usr/lib/x86_64-linux-gnu/libcairo-gobject.so.2 (0x00007f87953d2000)\r\n```\r\nIf you're already setting `LD_PRELOAD` then try adding sharp's libcairo to it also (I think multiple paths are space-delimited)."
      },
      {
        "user": "Nantris",
        "created_at": "2019-04-29T22:39:22Z",
        "body": "@lovell, you are amazing!\r\n\r\nThat got me 99% of the way there! When I preloaded just those though, I got `undefined symbol: pango_font_description_get_variations`. Tacking `libpango` to the front of my `LD_PRELOAD` was the final missing link.\r\n\r\nFor anyone else who runs into this, the full `LD_PRELOAD` you'll need is probably:\r\n\r\n```\r\nLD_PRELOAD=node_modules/sharp/vendor/lib/libpango-1.0.so.0:node_modules/sharp/vendor/lib/libcairo.so.2:node_modules/sharp/vendor/lib/libpangocairo-1.0.so.0:node_modules/sharp/vendor/lib/libcairo-gobject.so.2:node_modules/sharp/vendor/lib/libz.so\r\n```\r\n\r\nI'm pretty sure you can whitespace to separate multiple paths, but I used colons. \r\n\r\nThank you again so much for everything!\r\n\r\nPS, to anyone using the code I included, I don't really know if I followed best practices with linking to `.so.0`, or if I should have just linked to `.so`. I just stopped tinkering when it worked. So far, no issues."
      }
    ]
  },
  {
    "number": 1667,
    "title": "Resize using size (bytes) constraints",
    "created_at": "2019-04-23T12:01:13Z",
    "closed_at": "2019-06-02T10:52:45Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1667",
    "body": "How do I enforce maximum constraints on pictures? I'd like to force the following constraints:\r\n\r\n1) maximum resolution is 1000x1000\r\n2) maximum size in bytes is 2 megabytes.\r\n\r\nIf either of these constraints are broken, I'd like sharp to do some magic, and ensure the constraints still work.\r\n\r\nI've written code to handle the \"maximum resolution of 1000x1000\" and it is working fine, but how do I enforce the 2 megabytes limit (how do I know how much do I need to down-scale the image in order to get to the 2 megabytes limit)?\r\n\r\n```\r\nasync function resizePhoto({photo, maxWidth, maxHeight, maxSizeInBytes}) {\r\n\r\n    const base64 = photo.split('base64,')[1].trim();\r\n\r\n    const bufferBase64 = Buffer.from(base64, 'base64');\r\n    const photoSharp = sharp(bufferBase64)\r\n\r\n    let metadata = await photoSharp.metadata();\r\n\r\n    if (metadata.width > maxWidth || metadata.height > maxHeight) {\r\n\r\n        const ratio = metadata.width / metadata.height; \r\n\r\n        if (metadata.width > metadata.height) {\r\n            photoSharp.resize(maxWidth, maxWidth / ratio);\r\n        } else {\r\n            photoSharp.resize(maxHeight * ratio, maxHeight);\r\n        }\r\n    }\r\n\r\n    metadata = await photoSharp.metadata();\r\n\r\n    if (metadata.size > maxSizeInBytes) {\r\n        // TODO;\r\n       // what now?\r\n    }\r\n\r\n    return photoSharp\r\n        .toBuffer()\r\n}\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1667/comments",
    "author": "chr4ss1",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-04-23T13:48:12Z",
        "body": "Are you looking to limit input bytes or output bytes? In the example above the former could be based on the size of the input Buffer but the latter would be almost impossible to know without performing the decompress-process-compress pipeline.\r\n\r\nIs there an example of something else that provides a similar feature to what you're looking for? What does \"do some magic\" mean? "
      },
      {
        "user": "chr4ss1",
        "created_at": "2019-04-26T08:40:20Z",
        "body": "I am looking to limit the output bytes. \r\n\r\nMy use case is following: I have mobile app users who can upload pictures. These pictures need to have specific constraints because they will be shown to other users, and I want to ensure no big images get through that take up a lot of bandwidth and load slowly.\r\n\r\nInstead of just throwing error to them \"Hey, the uploaded file is too big\", I was thinking, instead, I could do some auto-processing that can compress it enough to make it pass the constraint.\r\n\r\nI am not sure with the \"magic\", but I understand the problem. I guess I could run divide and conquer style algorithm with the decompress-process-compress pipeline until I find a image resolution that satisfies (I assume resolution of picture is directly related to the output bytes):\r\n\r\ncompressedOutputSize <= maxOutputSizeInBytes\r\ncompressedOutputSize >= maxOutputSizeInBytes * 0.9\r\n\r\nunless there is more common way to approach this problem. "
      },
      {
        "user": "przemyslawpluta",
        "created_at": "2019-05-12T13:05:47Z",
        "body": "This should do the trick. It would retry resize of the buffer and lower quality until required limit reached. Obviously it would be nicer if that would be done internally by sharp without the need to rerun resize each time.\r\n\r\n```js\r\nasync function constraintImage(buffer, quality = 82, drop = 2) {\r\n\r\n    const done = await sharp(buffer).resize({\r\n        width: 1000,\r\n        height: 1000,\r\n        fit: sharp.fit.inside\r\n    }).jpeg({\r\n        quality\r\n    }).toBuffer();\r\n\r\n    if (done.byteLength > 2000000) {\r\n        return constraintImage(buffer, quality - drop);\r\n    }\r\n\r\n    return done;\r\n}\r\n```"
      }
    ]
  },
  {
    "number": 1655,
    "title": "input an image with cmyk color spaces but output with srgb",
    "created_at": "2019-04-12T08:44:13Z",
    "closed_at": "2019-05-02T17:45:00Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1655",
    "body": "What are you trying to achieve?\r\nprocess an image with cmyk color spaces，just resize it, but got color spaces with srgb, something wrong with me?\r\n\r\n```javascript\r\nconst img = sharp('tmp1.jpg');\r\nimg.metadata().then(info => {\r\n    console.log(info.space) //cmyk got\r\n    img.jpeg({\r\n        quality: 100\r\n    })\r\n    .resize({width:100, height:100})\r\n    .withMetadata()\r\n    .toFile('tmp2.jpg')\r\n    .then( info => {\r\n        sharp('tmp2.jpg')\r\n           // .toColorspace('cmyk') //doesn't matter\r\n            .metadata().then(info => {\r\n                console.log(info.space)// srgp got\r\n            })\r\n    })\r\n})\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1655/comments",
    "author": "guxima",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-04-12T08:49:56Z",
        "body": "Hello, please subscribe to #1323 for updates to this future enhancement."
      }
    ]
  },
  {
    "number": 1650,
    "title": "for writing unix error: No such file or directory",
    "created_at": "2019-04-08T07:26:45Z",
    "closed_at": "2019-05-02T17:44:29Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1650",
    "body": "What is the output of running `npx envinfo --binaries --languages --system --utilities`?\r\n```\r\nnpx: installed 1 in 0.893s\r\n\r\n  System:\r\n    OS: Linux 4.18 Ubuntu 18.10 (Cosmic Cuttlefish)\r\n    CPU: (4) x64 Intel(R) Core(TM) i5-7500 CPU @ 3.40GHz\r\n    Memory: 14.86 GB / 31.29 GB\r\n    Container: Yes\r\n    Shell: 4.4.19 - /bin/bash\r\n  Binaries:\r\n    Node: 11.13.0 - ~/.nvm/versions/node/v11.13.0/bin/node\r\n    npm: 6.7.0 - ~/.nvm/versions/node/v11.13.0/bin/npm\r\n  Utilities:\r\n    Make: 4.2.1 - /usr/bin/make\r\n    GCC: 8.2.0 - /usr/bin/gcc\r\n    Git: 2.19.1 - /usr/bin/git\r\n  Languages:\r\n    Bash: 4.4.19 - /bin/bash\r\n    Perl: 5.26.2 - /usr/bin/perl\r\n    Python: 2.7.15+ - /usr/bin/python\r\n    Ruby: 2.5.1p57 - /usr/bin/ruby\r\n```\r\n\r\n**What are the steps to reproduce?**\r\nWhen there is no directory, I get an error.\r\n```\r\nError\r\nvips__file_open_write: unable to open file \"public/d39fbdae-7809-47d2-8946-047f3c06457c/image/jpeg/2019/3/5/dbc876b6-ff23-454b-b013-1f806bea6a82.jpeg\" for writing\r\nunix error: No such file or directory\r\n```\r\nWhen I make a second request, it is successful.\r\n\r\nAre you able to provide a standalone code sample, without other dependencies, that demonstrates this problem?\r\n```\r\nexports.create = async function (req, res, next) {\r\n    try {\r\n\r\n        ...\r\n        let ext = commonUtils.getExtension(req.file.mimetype);\r\n        let filename = commonUtils.getFileName(ext);\r\n        let destination = commonUtils.getFilePath(req.body.profile_id, req.file.mimetype);\r\n        let local_path = path.join(destination, filename);\r\n\r\n       await mkdirp(destination);\r\n\r\n        let tmb_local_path = path.join(destination, \r\n       commonUtils.getTmbFileName(constants.AVATAR_DEFAULT_MIN_THUMBNAIL_WIDTH, \r\n       filename));\r\n\r\n        await resize.sharpCropAvatar(req.file.buffer, local_path);\r\n        await resize.sharpResize(\r\n            req.file.buffer,\r\n            tmb_local_path,\r\n            constants.AVATAR_DEFAULT_MIN_THUMBNAIL_WIDTH,\r\n            constants.AVATAR_DEFAULT_MIN_THUMBNAIL_WIDTH);\r\n         ...\r\n        \r\n        return res.status(201).send(serializer);\r\n    } catch (err) {\r\n        err.status = 500;\r\n        return next(err);\r\n    }\r\n};\r\n```\r\n```\r\nlet sharpResize = (sourcePath, targetPath, width, height) => {\r\n    return sharp(sourcePath)\r\n        .withMetadata()\r\n        .resize(width, height)\r\n        .toFile(targetPath);\r\n};\r\n```\r\n```\r\nlet sharpCropAvatar = (inputFile, targetPath) => {\r\n    return sharp(inputFile)\r\n        .withMetadata()\r\n        .resize(config.AVATAR_DEFAULT_SIZE, config.AVATAR_DEFAULT_SIZE)\r\n        .toFile(targetPath);\r\n};\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1650/comments",
    "author": "folt",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-04-08T08:55:20Z",
        "body": "Hi, the logic for `await mkdirp(destination)` is not shown here but my best guess would be that it hasn't really finished creating all of the directories when it resolves. Perhaps it is using a slow network mount?"
      },
      {
        "user": "folt",
        "created_at": "2019-04-08T09:40:25Z",
        "body": "> Hi, the logic for `await mkdirp(destination)` is not shown here but my best guess would be that it hasn't really finished creating all of the directories when it resolves. Perhaps it is using a slow network mount?\r\n\r\nI think that ubunta does not have time to create a directory."
      },
      {
        "user": "folt",
        "created_at": "2019-04-08T09:58:38Z",
        "body": "I found a solution for myself\r\nI replaced\r\n```await mkdirp(destination)```\r\non\r\n```\r\nif (!fs.existsSync(destination)) {\r\n    await helper.mkDir(destination)\r\n}\r\n```\r\nhelper.js \r\n```\r\nconst mkDir = (path) =>\r\n    new Promise((res, rej) => {\r\n        fs.mkdir(path, {recursive: true}, function (err) {\r\n            if (err) rej(err);\r\n            res(true);\r\n        });\r\n    });\r\n```"
      }
    ]
  },
  {
    "number": 1647,
    "title": " Incompatible library version: libvips-cpp.dylib requires version 10.0.0 or later, but libtiff.5.dylib provides version 9.0.0",
    "created_at": "2019-04-05T14:38:45Z",
    "closed_at": "2019-04-05T15:29:44Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1647",
    "body": "What is the output of running `npx envinfo --binaries --languages --system --utilities`?\r\n```\r\n System:\r\n    OS: macOS High Sierra 10.13.6\r\n    CPU: (4) x64 Intel(R) Core(TM) i7-5650U CPU @ 2.20GHz\r\n    Memory: 414.53 MB / 8.00 GB\r\n    Shell: 3.2.57 - /bin/bash\r\n  Binaries:\r\n    Node: 11.3.0 - /usr/local/bin/node\r\n    Yarn: 1.12.3 - /usr/local/bin/yarn\r\n    npm: 6.4.1 - /usr/local/bin/npm\r\n  Utilities:\r\n    CMake: 3.13.1 - /usr/local/bin/cmake\r\n    Make: 3.81 - /usr/bin/make\r\n    GCC: 4.2.1 - /usr/bin/gcc\r\n    Git: 2.20.0 - /usr/local/bin/git\r\n  Languages:\r\n    Bash: 3.2.57 - /bin/bash\r\n    Perl: 5.18.2 - /usr/bin/perl\r\n    PHP: 7.1.23 - /usr/bin/php\r\n    Python: 2.7.15 - /usr/local/bin/python\r\n    Ruby: 2.3.7p456 - /usr/bin/ruby\r\n```\r\n\r\nAfter an update from sharp 0.20.8 to 0.22.0 I got this unexpected error while running my application. It looks funny, I though that sharp was using its own libraries stored in the vendor directory, so I don't understand if this is related to some other libtiff library present.\r\n\r\nI use     `\"electron-builder\": \"20.39.0\"`,  to pack everything together, this is the error I get launching: `electron-webpack dev`\r\n```\r\nError: dlopen(/Users/bianco/Src/AppWebPack/node_modules/sharp/build/Release/sharp.node, 1): Library not loaded: @rpath/libtiff.5.dylib\r\n    Referenced from: /Users/bianco/Src/AppWebPack/node_modules/sharp/vendor/lib/libvips-cpp.42.dylib\r\n    Reason: Incompatible library version: libvips-cpp.dylib requires version 10.0.0 or later, but libtiff.5.dylib provides version 9.0.0\r\n      at process.module.(anonymous function) [as dlopen] (ELECTRON_ASAR.js:160:31)\r\n      at Object.Module._extensions..node (internal/modules/cjs/loader.js:722:18)\r\n      at Object.module.(anonymous function) [as .node] (ELECTRON_ASAR.js:160:31)\r\n      at Module.load (internal/modules/cjs/loader.js:602:32)\r\n      at tryModuleLoad (internal/modules/cjs/loader.js:541:12)\r\n      at Function.Module._load (internal/modules/cjs/loader.js:533:3)\r\n      at Module.require (internal/modules/cjs/loader.js:640:17)\r\n      at require (internal/modules/cjs/helpers.js:20:18)\r\n      at bindings (/Users/bianco/Src/AppWebPack/node_modules/bindings/bindings.js:112:48)\r\n      at Object.<anonymous> (/Users/bianco/Src/AppWebPack/node_modules/sharp/lib/constructor.js:10:34)\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1647/comments",
    "author": "BiancoA",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-04-05T15:13:22Z",
        "body": "Hello, has libtiff (or vips) been installed globally via Homebrew? If so, has `brew update && brew upgrade` been run?\r\n\r\nAre there any other native dependencies of your Electron app that might require libtiff?"
      },
      {
        "user": "BiancoA",
        "created_at": "2019-04-05T15:16:10Z",
        "body": "hello,\r\n\r\nupdating the globally installed libtiff doesn't make any difference, I don't have visp installed.\r\n\r\nI have another native dependency that requires libtiff, I am trying to update that also. It is weird anyway that there is a conflict between the two, since they have different paths"
      },
      {
        "user": "lovell",
        "created_at": "2019-04-05T15:24:29Z",
        "body": "Whichever dependency requires their libtiff shared library first will \"win\" for this is the shared library game."
      },
      {
        "user": "BiancoA",
        "created_at": "2019-04-05T15:26:57Z",
        "body": "The issue is solved updating the libtiff in the other native dependency. Thanks for the support!"
      }
    ]
  },
  {
    "number": 1642,
    "title": "Detecting whether withoutEnlargement is fired or not",
    "created_at": "2019-04-04T15:35:22Z",
    "closed_at": "2019-04-05T09:02:03Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1642",
    "body": "## What are you trying to achieve?\r\nI am trying to create a set of sizes under the original size.  \r\n\r\nThe withoutEnlargement option works in that it does not scale up the image, however, ideally there would be a flag or something when doing toFile/toBuffer to say that the image was larger than the original image. \r\n\r\nThe problem I have at the moment is that I'm doing the following;\r\n\r\n```js\r\nsharp(tmpFilePath)\r\n        .resize(width, null, {\r\n          withoutEnlargement: true\r\n        })\r\n        .toFile(thumbPath)\r\n        .then((a) => {\r\n// Upload file to GCS\r\n});\r\n```\r\n\r\nAnd I would like to NOT create the new file in GCS if it is just the same as the original size, that way I don't have a file called '2000-image.jpg' when the width is actually 1500.\r\n\r\nIs there something I'm missing, or an extra callback parameter or something that would allow me to know in the `then` function so I could decide not to upload it. \r\n\r\n## Have you searched for similar questions?\r\nYes\r\n\r\n## Are you able to provide a standalone code sample that demonstrates this question?\r\nNot immediately, but I can if needed.\r\n\r\n## Are you able to provide a sample image that helps explain the question?\r\nAny image under the size you're trying to resize to. \r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1642/comments",
    "author": "Dayjo",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-04-04T18:09:50Z",
        "body": "Hello, in your code example the `a` parameter passed to `then()` is an object that includes the post-resize dimensions. Perhaps add a test for `a.width` being less than `width`?"
      },
      {
        "user": "Dayjo",
        "created_at": "2019-04-05T08:17:56Z",
        "body": "@lovell wonderful, that's a perfect solution thank you :) \r\n\r\nWould it be safe to use;\r\n\r\n```js\r\n.toFile(thumbPath)\r\n        .then((img) => {\r\n          if (img.width == width) {\r\n               ....\r\n```"
      }
    ]
  },
  {
    "number": 1635,
    "title": "resize() after composite() cause error",
    "created_at": "2019-03-29T17:33:36Z",
    "closed_at": "2019-04-03T08:36:57Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1635",
    "body": "Hi,\r\n\r\nThere is a wierd issue when Im trying to `resize()` after `composite()`, the source is:\r\n\r\n```javascript\r\nsharp({\r\n    create: {\r\n        width: 789,\r\n        height: 789,\r\n        channels: 4,\r\n        background: '#bfff00'\r\n    }\r\n}).png().composite([{ input: content }]).resize(192).toBuffer((err, data) => {\r\n    if (err)\r\n        return callback(err);\r\n    this.emitFile(target, data);\r\n    callback(null, '');\r\n});\r\n```\r\n\r\nAnd it halted with *Image to composite must have same dimensions or smaller*.\r\n\r\nIf I deleted `.resize(192)`, it works fine.\r\n\r\nIf I deleted `.png()`, the same error would be occurred again.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1635/comments",
    "author": "snakevil",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-03-30T10:26:55Z",
        "body": "You'll need to break this into two pipelines, something like (untested):\r\n```javascript\r\nsharp({\r\n  create: {\r\n    width: 789,\r\n    height: 789,\r\n    channels: 4,\r\n    background: '#bfff00'\r\n  }\r\n})\r\n  .composite([{\r\n    input: content\r\n  }])\r\n  .png()\r\n  .toBuffer()\r\n  .then(data => sharp(data)\r\n    .resize(192)\r\n    .toBuffer()\r\n  )\r\n  .then( ... );\r\n```"
      },
      {
        "user": "snakevil",
        "created_at": "2019-04-03T08:36:57Z",
        "body": "Yup. I finally solved that with two instances :-p"
      },
      {
        "user": "ZiangYan",
        "created_at": "2019-09-25T07:24:44Z",
        "body": "I've encountered the same problem when performing resizing after composition.\r\n\r\nThanks @lovell , this solution indeed works.\r\n\r\nBut I'm still curious about why a naive combination like\r\n\r\n```\r\nsharp(data).composite(...).resize(...)\r\n```\r\n doesn't work"
      },
      {
        "user": "johannwagner",
        "created_at": "2019-09-28T09:45:35Z",
        "body": "I also ran into this issue.\r\n\r\nI think, the issue is, that the call order is not used in the different transformations. So it is not important, if you do resize and composite or composite and resize."
      },
      {
        "user": "djardine",
        "created_at": "2020-01-08T02:00:08Z",
        "body": "Think @johannwagner is correct above, but regardless of the call order, to me it would seem to make more sense if the resize() is applied to the final composite image, not just the input base image, but not sure how others feel about that....?"
      },
      {
        "user": "slikts",
        "created_at": "2020-05-08T09:48:50Z",
        "body": "This is somewhat non-intuitive; a logical expectation would be that compositing images together would also allow them being processed together."
      }
    ]
  },
  {
    "number": 1625,
    "title": "AWS Elasticbeanstalk Upgrade Issue",
    "created_at": "2019-03-25T16:31:14Z",
    "closed_at": "2019-04-07T21:11:18Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1625",
    "body": "Hi,\r\n\r\nI'm trying to upgrade a live node application that resides in AWS Elastcibeanstalk from v8.12.0 to v10.13.0\r\nand the only issue that I see is caused by sharp complaining about being built with a different version.\r\n\r\nHere's the error:\r\n\r\nError: The module '/var/app/current/node_modules/sharp/build/Release/sharp.node'\r\nwas compiled against a different Node.js version using\r\nNODE_MODULE_VERSION 57. This version of Node.js requires\r\nNODE_MODULE_VERSION 64. Please try re-compiling or re-installing\r\nthe module (for instance, using `npm rebuild` or `npm install`).\r\n\r\nI can't upgrade our prod aws elb instances because of this issue.\r\n\r\nPlease help :)",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1625/comments",
    "author": "abelabbesnabi",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-03-25T23:57:34Z",
        "body": "The version of Node used at runtime should match that at install time.\r\n\r\nLike my software, I offer my advice *on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND* but what you describe here sounds like a ~terrible~ sub-optimal way to upgrade a production system."
      }
    ]
  },
  {
    "number": 1604,
    "title": "Error: Input file is missing or of an unsupported image format on some requests",
    "created_at": "2019-03-09T17:20:46Z",
    "closed_at": "2019-03-11T11:21:54Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1604",
    "body": "Hello,\r\nThis code for image upload and compression works in most cases but some requests fail ((Number of fails increase in load testing) with error: 'Error: Input file is missing or of an unsupported image format'\r\n\r\nI checked the path whenever this error appears. The file really exists and is usable. Also this error does not appear for all requests. The exception occurs when I give the temp file path (saved to disk via streams to reduce memory footprint) to sharp.\r\n\r\n```\r\n'use strict';\r\n\r\nconst fs = require('fs');\r\nconst fsx = require('fs-extra');\r\nconst path = require('path');\r\nconst sharp = require('sharp');\r\nconst Config = require('../config/image');\r\nconst Rand = require('../utils/random');\r\nconst TAG = '\\services\\image';\r\nfunction readImageStream(buffer, owner, tempFileName){\r\n\tconst tempFilepath = Config.UPLOAD_PATH+'tmp\\\\'+owner+'\\\\'+tempFileName;\r\n\treturn new Promise(function(resolve, reject){\r\n\t\t//const readStream = fs.createReadStream(buffer);\r\n\t\tconst readStream = buffer;\r\n\t\tconst writeStream = fs.createWriteStream(tempFilepath);\r\n\t\tlet output;\r\n\t\treadStream.on('data', function(chunk){\r\n\t\t\twriteStream.write(chunk, {flags: 'a', encoding:null, mode:0o666});\r\n\t\t});\r\n\t\treadStream.on('end', function(){\r\n\t\t\tconst path = writeStream.path;\r\n\t\t\twriteStream.end();\r\n\t\t\tresolve(path);\r\n\t\t});\r\n\t\treadStream.on('error', function(err){\r\n\t\t\tconsole.log(\"Error in reading image stream \" + TAG, err);\r\n\t\t\treject(err);\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction checkImageDimensions(owner, filename){\r\n\tconst path = Config.UPLOAD_PATH + \"tmp\\\\\"+ owner + \"\\\\\" + filename;\r\n\treturn new Promise(function(resolve, reject){\r\n\t\t\r\n\t\tsharp(path)\r\n\t\t\t.metadata()\r\n\t\t\t.then(function(info){\r\n\t\t\t\tif(info.width < 100 || info.height <100 || \r\n\t\t\t      (info.width / info.height < 0.5) ||\r\n\t\t\t\t  (info.height / info.width < 0.5)){\r\n\t\t\t\t\t\treject('Bad image size');\r\n\t\t}\r\n\t\telse{\r\n\t\t\tresolve();\r\n\t\t}\r\n\t\t})\r\n\t\t.catch(function(err){\r\n\t\t\tconsole.log(\"Error in image size check \" + TAG, err);\r\n\t\t\treject(err);\r\n\t\t})\r\n\t}); \r\n}\r\n\r\nexports.Save = async function(owner, buffer){\r\n\tconst tempDir = Config.UPLOAD_PATH+\"tmp\\\\\"+owner;\r\n\tconst tempFileName1 = Rand.UUID() + Config.EXTENSION; //Creates UUID for filename\r\n\tconst tempFileName2 = Rand.UUID() + Config.EXTENSION;\r\n\tconst tempPath = tempDir + \"\\\\\"+tempFileName1;\r\n\tconst ensureDirExists = await fsx.ensureDir(Config.UPLOAD_PATH+ \"tmp\\\\\"+owner);\r\n\t//await checkMaxTempSize(owner);\r\n\tawait readImageStream(buffer, owner, tempFileName1);\r\n\tawait checkImageDimensions(owner, tempFileName1);\r\n\ttry{\r\n\t\tawait sharp(tempPath)\r\n\t\t\t\t\t.resize(800, 494, {\r\n\t\t\t\t\t\t\t\t\t\tkernel: sharp.kernel.nearest,\r\n\t\t\t\t\t\t\t\t\t\tfit: 'contain',\r\n\t\t\t\t\t\t\t\t\t\tbackground: { r: 255, g: 255, b: 255}\r\n\t\t\t\t\t\t\t\t\t}).toFile(Config.UPLOAD_PATH+ \"tmp\\\\\"+owner+ \"\\\\\" + tempFileName2, {quality:80});\r\n\t\t\t\treturn {\r\n\t\t\t\t\t\tfilename: tempFileName2\r\n\t\t\t\t};\r\n\t}\r\n\tcatch(err){\r\n\t\tconsole.log(\"Error in image compression \" + TAG, err);\r\n\t\treturn err;\r\n\t}\r\n} \r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1604/comments",
    "author": "danialkhansari",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-03-09T20:18:38Z",
        "body": "Hi, there's a race condition in the following section of your code, unrelated to sharp:\r\n```javascript\r\nreadStream.on('end', function(){\r\n\tconst path = writeStream.path;\r\n\twriteStream.end();\r\n\tresolve(path);\r\n});\r\n```\r\nThe call to `writeStream.end()` is not synchronous so `resolve` could occur before `writeStream` has finished writing to and closing the underlying file descriptor.\r\n\r\nInstead listen for the `close` event on `writeStream` before resolving."
      },
      {
        "user": "gergo0720",
        "created_at": "2019-03-09T23:31:23Z",
        "body": "Hi, I've experienced the same issue. In some cases it works properly, but it often happens to get the error mentioned above. I've tried to check the details of a \"working\" image and a \"non-working\" image. The only difference is the file-type. For not working images we have:\r\n\r\nFile Type: JPEG image data, **JFIF standard 1.02**\r\n\r\nMy current settings to resize is:\r\n\r\n`sharp(filePath)\r\n\t\t\t.withMetadata()\r\n\t\t\t.resize(200, 200, {\r\n\t\t\t\twithoutEnlargement: true\r\n\t\t\t})\r\n\t\t\t.png()\r\n\t\t\t.toFile(newFilePath);`\r\n\r\nI am using the latest version, but also tried an earlier one (0.20.5). The result was the same.\r\n\r\nI hope we can figure this out, and thanks in advance."
      },
      {
        "user": "lovell",
        "created_at": "2019-03-09T23:41:14Z",
        "body": "@gergo0720 Please open a new issue with a standalone code sample and example input image that consistently fails."
      },
      {
        "user": "danialkhansari",
        "created_at": "2019-03-11T09:05:21Z",
        "body": "Thanks a million @lovell I spent almost a month on solving the issue and tried many possibilities, finally I suspected about internal streams that sharp use to open files. It now works like a charm. God bless you man!"
      }
    ]
  },
  {
    "number": 1602,
    "title": "png resizing only working first time",
    "created_at": "2019-03-08T01:57:51Z",
    "closed_at": "2019-04-20T18:44:00Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1602",
    "body": "node: 10.13.0\r\nsharp: 0.21.3\r\n\r\nI try to transform JPEG und PNG in an AWS hosted docker image. I have no problems with JPEG, but with PNG. Some rezises work great, some not. When I resize to mutch images in nearly the same time I got more / only errors. On my dev machine (less memory then production) i got mutch more errors. Is maybe the memory the cause of the problem? If so, how i can avoid it? \r\n\r\n```\r\nError: vipspng: libpng read error\r\nvips2png: unable to write \"/tmp/8axpnNmv3-original.png\"\r\n```\r\n\r\nDockerfile\r\n```\r\nFROM node:10.13.0-alpine\r\n\r\nRUN mkdir -p /usr/src/app\r\nRUN mkdir -p /usr/src/app/backend\r\nRUN mkdir -p /usr/src/app/frontend\r\n\r\nRUN apk add --no-cache \\\r\n    tzdata \\\r\n    git \\\r\n    python \\\r\n    build-base\r\n\r\nENV TZ Europe/Berlin\r\n\r\nWORKDIR /usr/src/app\r\n\r\nCOPY backend /usr/src/app/backend\r\nCOPY package.json /usr/src/app\r\nCOPY frontend /usr/src/app/frontend\r\n\r\nRUN npm config set unsafe-perm true\r\nRUN npm install forever -g\r\nRUN npm install\r\n\r\nEXPOSE 80\r\n\r\nCMD [ \"forever\", \"backend/server.js\", \"-f\"]\r\n```\r\n\r\nnodejs\r\n```\r\nsharp(srcBuffer)\r\n      .jpeg({ quality: 75, force: false })\r\n      .png({ compressionLevel: 9, force: false })\r\n      .resize(sharpConf)\r\n      .toFile(destPath);\r\n```\r\n\r\nI also tried debian as docker base image, no change at all. \r\n\r\n\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1602/comments",
    "author": "tschiela",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-03-08T11:55:46Z",
        "body": "Hello, the `vipspng: libpng read error` message suggests an input PNG image is corrupt/invalid. Are you able to provide an input PNG that consistently fails in this manner?"
      },
      {
        "user": "lovell",
        "created_at": "2019-04-01T19:57:12Z",
        "body": "@tschiela Were you able to make any progress with this?"
      },
      {
        "user": "AllSeeingEye",
        "created_at": "2021-09-09T21:27:48Z",
        "body": "I'm getting the same error, and it seems that libpng just cannot be used in parallel threads."
      },
      {
        "user": "lovell",
        "created_at": "2021-09-09T21:30:28Z",
        "body": "@AllSeeingEye Please can you open a new issue and provide complete, standalone code and sample image(s) that allow someone else to reproduce."
      }
    ]
  },
  {
    "number": 1596,
    "title": "How to install sharp for AWS Lambda from musl-based Linux (Alpine, Void)",
    "created_at": "2019-03-01T17:04:39Z",
    "closed_at": "2019-03-08T18:16:32Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1596",
    "body": "Using Alpine Docker image to build and deploy AWS lambda function.\r\n\r\nTrying this command to install proper pre-compiled binaries:\r\n```sh\r\nrm -rf node_modules/sharp && SHARP_IGNORE_GLOBAL_LIBVIPS=1 npm i --arch=x64 --platform=linux --target=8.10.0 sharp\r\n```\r\n\r\nBut installation automatically detects Alpine Linux and downloads wrong binaries( `musl` )\r\n\r\nWhich leads to this error when running this lambda function:\r\n\r\n```json\r\n{\r\n  \"errorMessage\": \"libc.musl-x86_64.so.1: cannot open shared object file: No such file or directory\",\r\n  \"errorType\": \"Error\",\r\n  \"stackTrace\": [\r\n    \"Module.load (module.js:565:32)\",\r\n    \"tryModuleLoad (module.js:505:12)\",\r\n    \"Function.Module._load (module.js:497:3)\",\r\n    \"Module.require (module.js:596:17)\",\r\n    \"require (internal/module.js:11:18)\",\r\n    \"bindings(/var/task/node_modules/bindings/bindings.js:112:48)\",\r\n    \"Object.<anonymous> (/var/task/node_modules/sharp/lib/constructor.js:10:34)\",\r\n    \"Module._compile (module.js:652:30)\",\r\n    \"Object.Module._extensions..js (module.js:663:10)\"\r\n  ]\r\n}\r\n```\r\n\r\nIf there is a way to specify that I want to use specific binaries like `libvips-8.7.0-linux-x64.tar.gz` instead of `libvips-8.7.0-linuxmusl-x64.tar.gz`?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1596/comments",
    "author": "dbachko",
    "comments": [
      {
        "user": "dbachko",
        "created_at": "2019-03-01T18:43:14Z",
        "body": "@lovell maybe it's possible to add `family` param in [platform.js](/lovell/sharp/blob/master/lib/platform.js#L8) to allow a user to specify it in addition to auto-detection mechanism?"
      },
      {
        "user": "lovell",
        "created_at": "2019-03-01T22:31:32Z",
        "body": "Hello, I'm not sure I understand the use of the musl-based Alpine to prepare code for the glibc-based AWS Lambda runtime environment. That's going to cause problems for any native dependencies, not just sharp."
      }
    ]
  },
  {
    "number": 1585,
    "title": "Conver http response images with .webp to .jpg",
    "created_at": "2019-02-21T16:42:59Z",
    "closed_at": "2019-03-10T00:02:39Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1585",
    "body": "Hi, I need help setting up sharp in converting pictures from webp to jpg | png ... when responding from the server.\r\n\r\nexample -\r\nlet response;\r\n  const request = http.get (\"/ test / test.webp\", resp => {\r\n             response = resp;\r\n         })\r\n\r\n// ***********************\r\n// .webp to jpg\r\n  const writeableStream = fs.createWriteStream ('test.jpg');\r\nresponse.pipe (???). pipe (writeableStream);\r\n\r\nI tried many options with the documentation, but nothing came of it.\r\nIs it possible with this library?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1585/comments",
    "author": "taraa62",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-02-22T19:36:51Z",
        "body": "Hello, you can create a Transform Stream that reads image data from a Readable Stream and writes JPEG data to a Writable Stream using something like:\r\n```javascript\r\nconst jpegTransformer = sharp().jpeg();\r\n```\r\nThis could then be used as:\r\n```javascript\r\nreadableStream.pipe(jpegTransformer).pipe(writeableStream);\r\n```\r\nIn your example I think you'll need to move the use of `response` into the `http.get` callback to ensure it is defined.\r\n```javascript\r\nhttp.get(\"/test/test.webp\", response => {\r\n  const writeableStream = fs.createWriteStream('test.jpg');\r\n  response.pipe(jpegTransformer).pipe(writeableStream);\r\n});\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2019-03-10T00:02:39Z",
        "body": "Hope this helped."
      },
      {
        "user": "taraa62",
        "created_at": "2019-03-10T14:58:11Z",
        "body": "Thanks for the answer, but the decision was not to convert the picture"
      }
    ]
  },
  {
    "number": 1584,
    "title": "Resize -> extract -> rotate leads to no rotate",
    "created_at": "2019-02-19T13:28:44Z",
    "closed_at": "2019-02-24T10:08:11Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1584",
    "body": "We have the following code:\r\n```js\r\nsharp()\r\n  .resize(600, 600)\r\n  .extract({ width: 200, height: 50, left: 0, top: 0 })\r\n  .rotate(90);\r\n```\r\n\r\nResult should be 50x200 however, it is 200x50 (rotate not applied).\r\n\r\nWhen we do `resize` in a different instance, then the result is 50x200 as expected:\r\n```js\r\nconst instance1 = sharp().resize(600, 600);\r\n  \r\nconst instance2 = sharp()\r\n  .extract({ width: 200, height: 50, left: 0, top: 0 })\r\n  .rotate(90);\r\n\r\ninstance1.pipe(instance2);\r\n```\r\n\r\nIs this an expected behaviour? If yes, what's the reason for this?\r\n\r\nSharp version: 0.21.3",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1584/comments",
    "author": "deftomat",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-02-19T14:26:37Z",
        "body": "Hello, the ordering of applying both a rotate and extract operation post-resize is currently fixed so the two-pipeline approach you suggest is correct. Please see #241 for discussion about a future possible additional API."
      },
      {
        "user": "deftomat",
        "created_at": "2019-02-21T07:34:27Z",
        "body": "Oh, thats sad. We need to construct pipelines dynamically and using a lot of new instances hit the CPU really badly. In our code it is like 30ms with 1 instance and 550ms with 3 instances 😢 "
      },
      {
        "user": "lovell",
        "created_at": "2019-02-22T22:08:05Z",
        "body": "I suspect much of that time will be spent in the (de)compression round trips. If you've not already done so, it'd be worth experimenting with raw, uncompressed data for the intermediate stages.\r\n\r\n```javascript\r\nconst instance1 = sharp().resize(600, 600).raw();\r\n  \r\nconst instance2 = sharp({ raw: { width: 600, height: 600, channels: 3 }})\r\n  .extract({ width: 200, height: 50, left: 0, top: 0 })\r\n  .rotate(90);\r\n\r\ninstance1.pipe(instance2);\r\n```"
      },
      {
        "user": "deftomat",
        "created_at": "2019-02-24T10:08:11Z",
        "body": "Awesome! Thanks, It helps a lot.\r\n"
      }
    ]
  },
  {
    "number": 1575,
    "title": "How do I draw a rectangle over an image?",
    "created_at": "2019-02-12T14:10:54Z",
    "closed_at": "2019-03-10T00:00:17Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1575",
    "body": "I need to mark a region of the image, I have not found any method that does it directly.\r\n\r\nShould I build my solution from the overlayWith ({create: ....})?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1575/comments",
    "author": "jsimoes1966",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-02-13T10:35:42Z",
        "body": "Hello, passing a Buffer containing an SVG with the shape(s) you need to `overlayWith` is probably the best approach."
      },
      {
        "user": "lovell",
        "created_at": "2019-03-10T00:00:17Z",
        "body": "Hope this helped."
      }
    ]
  },
  {
    "number": 1573,
    "title": "await sharp('/var/www/overwriteME.jpg') inside async function, references the same old pic",
    "created_at": "2019-02-10T22:16:16Z",
    "closed_at": "2019-02-11T17:39:37Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1573",
    "body": "I'm basically overwriting overwriteME.jpg inside\r\n\r\n```\r\nconst screenshotDesktop = require('screenshot-desktop')\r\nconst sharp = require('sharp');\r\n\r\n(async () => {\r\n\r\n      while (1 < 5){\r\n        var currentShot = screenshotDesktop.all()\r\n        .then(imgs => {\r\n            return  fs.writeFile(`/Users/ga/proj/overwriteME.jpg`, imgs[0], (err) => {\r\n                    if (err) throw err;\r\n                    crop();\r\n            });\r\n        });\r\n         await delay(1000);\r\n       }\r\n   async function crop(crop){\r\n\r\n       // original size from metadata\r\n       var resizedImage = await sharp('/Users/ga/proj/overwriteME.jpg');\r\n       var metadata = await resizedImage.metadata();\r\n       console.log(metadata);\r\n   };\r\n\r\n})();\r\n\r\n\r\nfunction delay(timeout) {\r\n  return new Promise((resolve) => {\r\n    setTimeout(resolve, timeout);\r\n  });\r\n}\r\n```\r\n\r\nI expected different metadata, as I'm taking screenshots of a video playing on the screen and overwriting overwriteME.jpg, and using Sharp to extract metadata.\r\n\r\nWhat actually happened was the same metadata was being returned, when I thought sharp would reflect the file changes.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1573/comments",
    "author": "whatsdis",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-02-11T08:59:04Z",
        "body": "Hello, please see #1497"
      }
    ]
  },
  {
    "number": 1568,
    "title": "Empty sharp image from Buffer",
    "created_at": "2019-02-06T08:36:15Z",
    "closed_at": "2019-03-10T00:00:01Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1568",
    "body": "When trying to create a Sharp from empty raw an error is returned. Even if all variables are specified.\r\n```node\r\nvar image = Buffer.alloc(0)\r\n// ...\r\n    await sharp(image, {raw: {width: 0, height: 0, channels: 3}})\r\n// Error: Expected width, height and channels for raw pixel input\r\n// at Sharp._createInputDescriptor (...\\node_modules\\sharp\\lib\\input.js:57:15)\r\n```\r\nWith size bigger than zero for each variable works fine",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1568/comments",
    "author": "metroyanno",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-02-06T09:14:16Z",
        "body": "Hello, this is by design, you need to start with at least a 1x1 image. What's the use case where you might need a 0x0 image?"
      },
      {
        "user": "metroyanno",
        "created_at": "2019-02-06T10:06:20Z",
        "body": "Drawing an image in `canvas` on the web"
      },
      {
        "user": "lovell",
        "created_at": "2019-02-06T11:30:59Z",
        "body": "Sorry, I don't understand, please can you provide more details and perhaps a worked example of what you'd expect the rest of the sharp pipeline to look like?"
      },
      {
        "user": "metroyanno",
        "created_at": "2019-02-06T11:37:43Z",
        "body": "My buffer contains an RGB image. Initially, the buffer size is 0 * 0 (* 3 channels) pixels. But after some period of time, it expands to a large X * Y value (* 3 channels) of pixels.\r\nOf course, I now understand that the library is not intended for empty images, but I would like to see the possibility of creating empty images"
      },
      {
        "user": "lovell",
        "created_at": "2019-02-09T11:49:26Z",
        "body": "Sorry, I'm still not sure I understand this scenario. What operations would you expect to work on a 0x0 image? What output formats support a 0x0 image? Are you aware of other image processing libraries that support 0x0 images?"
      },
      {
        "user": "lovell",
        "created_at": "2019-03-10T00:00:01Z",
        "body": "Closing due to inactivity but please re-open with more details of the scenario(s) where support for 0x0 images would be useful."
      },
      {
        "user": "Nantris",
        "created_at": "2021-08-14T20:23:26Z",
        "body": "@lovell I think there's probably a better way to approach this, but our use case would be for conditional compositing, to keep our code reusable. We have a shared function that processes a lot of images, but for a few we use `composite`  to add rounded edges.\r\n\r\nI strongly suspect there's a better alternative for this than a 0x0 image? Any advice?\r\n\r\n_____\r\n\r\n\r\n**Edit:**  We ended up using this as a default for images we didn't define a custom compositor configuration:\r\n\r\n```js\r\nconst defaultCompositor = async () => {\r\n  const input = await sharp({\r\n    create: {\r\n      width: 1,\r\n      height: 1,\r\n      channels: 4,\r\n      background: { r: 0, g: 0, b: 0, alpha: 0 },\r\n    },\r\n  }).toBuffer();\r\n  return [\r\n    {\r\n      input,\r\n      raw: {\r\n        width: 1,\r\n        height: 1,\r\n        channels: 4,\r\n      },\r\n      blend: 'over',\r\n    },\r\n  ];\r\n};\r\n```\r\n\r\nAlthough if any of this can be simplified further, I'd be happy to learn! Big thanks to @lovell for the great work!"
      }
    ]
  },
  {
    "number": 1561,
    "title": "Resize jpeg/webp without changing quality",
    "created_at": "2019-01-29T12:34:48Z",
    "closed_at": "2019-01-29T17:15:58Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1561",
    "body": "First, thanks for developing this great library Lovell. \r\nI was wondring if there is an option to resize an image without changing the quality. \r\n`sharp(buffer).resize(width).toBuffer()`\r\nAdding the jpeg function increases the filesize:\r\n`.jpeg({\r\n    quality: 100\r\n  })`\r\n`.metadata() ` doesnt show the initial quality. Not sure if that is even possible. I just saw that pain.net recognizes the quality.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1561/comments",
    "author": "midevnull",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-01-29T16:14:01Z",
        "body": "Hello, did you see #908?"
      },
      {
        "user": "midevnull",
        "created_at": "2019-01-29T17:10:49Z",
        "body": "@lovell Thank you very much. Found a solution in the linked issue."
      }
    ]
  },
  {
    "number": 1548,
    "title": "how to composite  many images buffer?",
    "created_at": "2019-01-16T10:03:18Z",
    "closed_at": "2019-01-27T19:46:38Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1548",
    "body": "const base = sharp({\r\n    create: baseOpt,\r\n}).jpeg()\r\nlet imgs = []\r\nfor(let i=1;i<=4;i++){\r\n    const result = fs.readFileSync(`./${i}.jpeg`)\r\n    imgs.push(result)\r\n}\r\nbase.overlayWith(imgs[0],{left:0,top:0}).overlayWith(imgs[1],{left:256,top:0})\r\n.toBuffer().then(data=>{\r\n    fs.writeFileSync('./111.jpeg',data)\r\n})\r\n\r\nwhen I composite by this methods, but the imgs[0] and imgs[1] can not composite to base? how to resolve?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1548/comments",
    "author": "chengdonglin",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-01-16T12:16:51Z",
        "body": "Hello, did you see #728? There are examples of how to do this in the linked issues."
      },
      {
        "user": "chengdonglin",
        "created_at": "2019-01-17T02:08:16Z",
        "body": "Thank very much, I have seed the #728, but when I composite 64 images by this methods, It takes 4s to complete the stitching. it is too slow, how to resolve ?"
      },
      {
        "user": "lovell",
        "created_at": "2019-01-17T10:09:17Z",
        "body": "You'll need to wait for #728."
      }
    ]
  },
  {
    "number": 1537,
    "title": "Is image shading can be done in sharp ?",
    "created_at": "2019-01-07T11:11:56Z",
    "closed_at": "2019-01-27T19:45:05Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1537",
    "body": "Hi ,\r\nI need to do the shading or shade or shadow operation on images .\r\nIs this operation or feathers available in sharp ?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1537/comments",
    "author": "vinaymuthanna0727",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-01-08T11:03:30Z",
        "body": "Hello, did you see #1490 ?"
      },
      {
        "user": "lovell",
        "created_at": "2019-01-27T19:45:05Z",
        "body": "Hope this helped, please feel free to re-open with more details if not."
      }
    ]
  },
  {
    "number": 1535,
    "title": "glib error on resize",
    "created_at": "2019-01-06T08:19:02Z",
    "closed_at": "2019-01-06T10:15:04Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1535",
    "body": "I am running node v10.5.0 on a shared hosting.\r\n\r\nCalling the resize api produces this error.\r\n\r\n```\r\nError: glib: Error creating thread: Resource temporarily unavailable\r\n\r\nEmitted 'error' event at:\r\n    at .../node_modules/sharp/lib/output.js:614:20\r\n\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1535/comments",
    "author": "asgharmusani",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-01-06T10:15:04Z",
        "body": "Hello, the \"shared hosting\" service has probably been configured to limit the number of threads you're able to spawn. This is a question for the provider - good luck!"
      },
      {
        "user": "asgharmusani",
        "created_at": "2019-01-09T16:46:23Z",
        "body": "setting the sharp with concurrency(1) resolved this error."
      }
    ]
  },
  {
    "number": 1534,
    "title": "overLaywith just need horizon center?",
    "created_at": "2019-01-06T03:50:55Z",
    "closed_at": "2019-01-27T19:44:52Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1534",
    "body": "Hi, \r\n   I am using sharp and it is awesome. I use sharp.overlayWith method to apply some texts into my image.\r\n   However, I just need the horizon center and I want to define the top by myself, is there any way to realize it? I know gravity:'center' can make it totally center within the image:) ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1534/comments",
    "author": "uyarn",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2019-01-06T10:20:17Z",
        "body": "Hello, if you know the dimensions of both images then you should be able to perform calculations for `top` and `left` instead of providing a `gravity`."
      },
      {
        "user": "lovell",
        "created_at": "2019-01-27T19:44:52Z",
        "body": "Hope this helped, please feel free to re-open with more details if not."
      }
    ]
  },
  {
    "number": 1506,
    "title": "/lib64/libz.so.1: version `ZLIB_1.2.9' not found",
    "created_at": "2018-12-12T12:25:16Z",
    "closed_at": "2018-12-13T08:18:37Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1506",
    "body": "Using Lambda function I added sharp my packages but it's returning this error:\r\n\r\n```\r\n{\r\n  \"errorMessage\": \"/lib64/libz.so.1: version `ZLIB_1.2.9' not found (required by /var/task/node_modules/sharp/build/Release/../../vendor/lib/libpng16.so.16)\",\r\n  \"errorType\": \"Error\",\r\n  \"stackTrace\": [\r\n    \"Object.Module._extensions..node (module.js:597:18)\",\r\n    \"Module.load (module.js:487:32)\",\r\n    \"tryModuleLoad (module.js:446:12)\",\r\n    \"Function.Module._load (module.js:438:3)\",\r\n    \"Module.require (module.js:497:17)\",\r\n    \"require (internal/module.js:20:19)\",\r\n    \"bindings (/var/task/node_modules/bindings/bindings.js:84:48)\",\r\n    \"Object.<anonymous> (/var/task/node_modules/sharp/lib/constructor.js:10:34)\",\r\n    \"Module._compile (module.js:570:32)\"\r\n  ]\r\n}\r\n```\r\nIt's a Node function of validating and re-designing images using canvas. \r\nPlease help! ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1506/comments",
    "author": "alatras",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-12-12T20:41:48Z",
        "body": "If you're using `node-canvas` then please see #843"
      },
      {
        "user": "alatras",
        "created_at": "2018-12-13T08:18:35Z",
        "body": "@lovell No, I am using `canvas`. However due to time restriction I ended up using another image library. Thank you!"
      }
    ]
  },
  {
    "number": 1494,
    "title": "node 11 support",
    "created_at": "2018-12-05T20:39:50Z",
    "closed_at": "2018-12-05T21:10:52Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1494",
    "body": "👍 / 👎 ?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1494/comments",
    "author": "barisusakli",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-12-05T21:09:56Z",
        "body": "Hello, you'll need to compile from source - please see #1464"
      },
      {
        "user": "barisusakli",
        "created_at": "2018-12-05T21:10:52Z",
        "body": "Thanks"
      }
    ]
  },
  {
    "number": 1481,
    "title": "Correct way to convert 1, 3 or 4-channel images to RGBA",
    "created_at": "2018-11-28T00:30:56Z",
    "closed_at": "2018-12-28T14:12:45Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1481",
    "body": "Sorry if this is a dumb question, but after hours of searching I couldn't find an answer, so I thought I'd try asking directly. I'm using sharp to decode source images into raw RGBA (downstream code wants that). The source images can be 1-channel grayscale, 3-channel RGB, or 4-channel RGBA images. What's the simplest and most reliable way to ensure that any of these types decode to a 4-channel RGBA buffer?\r\n\r\nAt first, we were doing:\r\n```javascript\r\n// sourceImageBuffer contains the bytes of the source image\r\nconst img = sharp(sourceImageBuffer);\r\nconst {width, height, hasAlpha} = await img.metadata();\r\nif (!hasAlpha) {\r\n  img.joinChannel(Buffer.alloc(width * height, 255), { raw: { width, height, channels: 1 }})\r\n}\r\nconst decodedBuffer = await img.raw().toBuffer();\r\n```\r\n\r\nThat works well for 3 and 4-channel images, but isn't working as expected for 1-channel grayscale images. That makes sense to me, as the `.joinChannel()` would add a second channel, not a fourth one.\r\n\r\nI was able to make it work using code like this, but it seems rather awkward and possibly inefficient to me:\r\n\r\n```javascript\r\n// .raw() seems to automatically decode 1-channel to 3\r\nlet decoded = await sharp(sourceImageBuffer).raw().toBuffer({ resolveWithObject: true});\r\nconst {width, height, channels} = decoded.info;\r\n\r\n// if there are still only 3 channels, add an opaque alpha channel\r\nif (channels === 3) {\r\n  decoded = await sharp(decoded.data, { raw: { width, height, channels }})\r\n      .joinChannel(Buffer.alloc(width * height, 255), { raw: { width, height, channels: 1 }})\r\n      .toBuffer({ resolveWithObject: true });\r\n}\r\n\r\n// decoded.data now has 4-channel RGBA bytes,\r\n// regardless of input image\r\n```\r\n\r\nThis code seems to work for 1, 3, or 4-channel source images. But I'm guessing there's an easier, more-elegant, and more-efficient way to accomplish this that I'm not seeing at the moment. Any advice/help you can provide would be most appreciated!",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1481/comments",
    "author": "dstearnsadobe",
    "comments": [
      {
        "user": "dstearnsadobe",
        "created_at": "2018-11-28T17:34:53Z",
        "body": "I also tried the approach of conditionally adding `.joinChannel()` after the `.raw()` step, like so:\r\n```javascript\r\nlet img = sharp(sourceImageBuffer);\r\nconst {width, height, channels} = await sharp.metadata();\r\n\r\nlet img = img.raw();\r\nif (channels < 4) {\r\n  img = img.joinChannel(Buffer.alloc(width * height, 255), { raw: { width, height, channels: 1 } });\r\n}\r\n\r\nlet decodedBuf = await img.toBuffer();\r\n```\r\nThis worked for 3 and 4-channel images, but the 1-channel grayscale image ended up all black. I thought this might work given that `.raw().toBuffer()` seems to convert the 1-channel grayscale image to 3-channel. But when I use `.toBuffer({ resolveWithObject: true })` and dump the `.info` property, it says that the decoded buffer only has 2 channels.\r\n\r\nI'm guessing that I'm just missing something here, and that there's some much easier way to accomplish this. If so, please let me know!"
      },
      {
        "user": "lovell",
        "created_at": "2018-11-30T10:26:45Z",
        "body": "Hello, adding a `toColorspace('srgb')` operation in there should force 3 channel output, which should deal with the possible 1 channel input.\r\n\r\nIn terms of a possible missing alpha channel, you'll be interested in the future possible enhancement at #1153."
      },
      {
        "user": "lovell",
        "created_at": "2018-12-28T14:12:45Z",
        "body": "Hope this helped, please re-open with more details if not."
      }
    ]
  },
  {
    "number": 1462,
    "title": "Add generated images to another generated images (particles, text)",
    "created_at": "2018-11-17T01:20:27Z",
    "closed_at": "2018-11-18T20:02:53Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1462",
    "body": "\r\n- Add multiple dots, lines or stars for example\r\n- Add multiple strings with differente rotation and color\r\n- Ability to select a pixel, get it's color or modify it\r\n\r\nIt was quite easy to do in PHP as far as I can remember but I cannot seem to make it in nodejs using the `sharp` library.\r\n\r\nDoes `sharp` have all the functions I need to achieve what I need? Or should I switch to imagemagick until this one catch up? I think sharp is quite faster though :thinking: \r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1462/comments",
    "author": "Extarys",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-11-17T12:25:46Z",
        "body": "Hello, if you need dots, lines, stars, rotated strings etc. perhaps consider using an SVG-based approach to build the image, then use sharp to convert the vector to a bitmap version for further pixel-based manipulation."
      },
      {
        "user": "Extarys",
        "created_at": "2018-11-18T20:02:53Z",
        "body": "Hmm ok thanks I'll see if it is a viable option."
      }
    ]
  },
  {
    "number": 1461,
    "title": "store an image 2 times",
    "created_at": "2018-11-15T15:19:36Z",
    "closed_at": "2018-11-15T21:03:17Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1461",
    "body": "I have to resize an image 2 times and store it in different files\r\nand most importantly i want them to be Promise based so i can await them\r\n\r\ncurrently i use this method which i doubt to be correct:\r\n\r\n```\r\nawait sharp(my_file)\r\n\t.jpeg({quality: 90, chromaSubsampling: '4:4:4'})\r\n\t.resize(200, 200)\r\n\t.toFile('200x200.jpg', (err, info) => {}); // save\r\n\r\nawait sharp(my_file)\r\n\t.jpeg({quality: 90, chromaSubsampling: '4:4:4'})\r\n\t.resize(40, 40)\r\n\t.toFile('40x40.jpg', (err, info) => {}); // save\r\n```\r\n\r\n\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1461/comments",
    "author": "Mehdi-Azmoudeh",
    "comments": [
      {
        "user": "Daiz",
        "created_at": "2018-11-15T15:57:14Z",
        "body": "`.toFile` returns a Promise when a callback isn't specified.\r\n\r\nIf you want to encode the two different varieties in parallel, you can just do the following:\r\n\r\n```javascript\r\nasync function encode(my_file) {\r\n  const src = sharp(my_file).jpeg({quality: 90, chromaSubsampling: \"4:4:4\"});\r\n  const i200 = src.resize(200, 200).toFile(\"200x200.jpg\");\r\n  const i40 = src.resize(40, 40).toFile(\"40x40.jpg\");\r\n  return Promise.all([i200, i40]);\r\n}\r\n```\r\n\r\nYou can also `await Promise.all([i200, i40])` in the above example, naturally, if you want it as part of a bigger function or pipeline."
      },
      {
        "user": "Mehdi-Azmoudeh",
        "created_at": "2018-11-15T18:54:19Z",
        "body": "Great! So I can use it like this:\r\n\r\n`await encode(my_file);`\r\n\r\nPerfect! many thanks."
      }
    ]
  },
  {
    "number": 1455,
    "title": "flip with extract (crop)",
    "created_at": "2018-11-13T20:23:19Z",
    "closed_at": "2019-01-05T15:26:15Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1455",
    "body": "hi,\r\nwhen i use flip or flop beside extract (crop), it results to wrong cropping area.\r\nactually it does the flip, but with same extract dimensions without any update on them to be matched with flip situation.\r\nany ideas?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1455/comments",
    "author": "Mehdi-Azmoudeh",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-11-13T21:52:58Z",
        "body": "Hello, you've not provided any sample code but if you need to flip-then-extract try something like the following:\r\n\r\n```javascript\r\nsharp(input)\r\n  .flip()\r\n  .toBuffer(data => sharp(data)\r\n    .extract( ... )\r\n    .toBuffer()\r\n  )\r\n  .then(data => { ... });\r\n```\r\n"
      },
      {
        "user": "Mehdi-Azmoudeh",
        "created_at": "2018-11-14T15:34:12Z",
        "body": "is this code true?\r\ni want it to behave like async await\r\nand do all those operations, and finally save it to file:\r\n\r\n```\r\nawait sharp(input)\r\n        .jpeg({quality: 90, chromaSubsampling: '4:4:4'})\r\n        .rotate(rotate)\r\n        .flop(scaleX)\r\n        .flip(scaleY)\r\n        .extract({left: x, top: y, width: w, height: h})\r\n        .resize(400, 400)\r\n        .toFile('output.jpg'), (err, info) => {}); // save\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2018-12-28T14:15:35Z",
        "body": "Using async/await this would look something like (untested):\r\n```javascript\r\nconst rotated = await sharp(input)\r\n  .rotate(rotate)\r\n  .flop(scaleX)\r\n  .flip(scaleY)\r\n  .toBuffer();\r\nconst info = await sharp(rotated)\r\n  .extract({ left: x, top: y, width: w, height: h })\r\n  .resize(400, 400)\r\n  .jpeg({ quality: 90, chromaSubsampling: '4:4:4' })\r\n  .toFile('output.jpg');\r\n```\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2019-01-05T15:26:15Z",
        "body": "Hope this helped, feel free to re-open with more details if not."
      }
    ]
  },
  {
    "number": 1450,
    "title": "Question: what's the optimum/cleanest way of overlaying multiple images using streams",
    "created_at": "2018-11-08T13:36:43Z",
    "closed_at": "2018-12-04T21:29:51Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1450",
    "body": "Hi,\r\n\r\njust wanted to post a question to get suggestions how to make code simpler and possible improve performance. We're composing multiple images as one, using read streams (originating from Cloud Storage bucket), here's our implementation:\r\n```\r\nconst composeImage = async imageReadStreams => {\r\n  const baseSharpInstance = sharp();\r\n  imageReadStreams[0].pipe(baseSharpInstance);\r\n  //  read image dimensions from the first read img\r\n  const metaData = await baseSharpInstance.metadata();\r\n\r\n  const options: sharp.SharpOptions = {\r\n    raw: {\r\n      width: metaData.width,\r\n      height: metaData.height,\r\n      channels: 4,\r\n    },\r\n  };\r\n\r\n  const base = baseSharpInstance.raw().toBuffer();\r\n\r\n  imageReadStreams.shift();\r\n  const buffer = await imageReadStreams.reduce((input, overlay) => {\r\n    return input.then(async data => {\r\n      const pipeline = sharp();\r\n      overlay.pipe(pipeline);\r\n      const asBuffer = await pipeline.raw().toBuffer();\r\n      return sharp(data, options)\r\n        .overlayWith(asBuffer, options)\r\n        .raw()\r\n        .toBuffer();\r\n    });\r\n  }, base);\r\n  return sharp(buffer, options);\r\n};\r\n```\r\nFunction returns new Sharp instance which is then used create different sizes & outputs from composed img. \r\n\r\nAny suggestions are highly appreciated!",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1450/comments",
    "author": "ovaris",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-11-10T22:49:14Z",
        "body": "Hello, this is probably about the best that can be achieved using Stream-based input with the current API.\r\n\r\nIf you haven't already seen it, #728 is tracking proposed improvements and there's an open PR for the groundwork at #1440."
      },
      {
        "user": "lovell",
        "created_at": "2018-12-04T21:29:51Z",
        "body": "Hope this helped, feel free to re-open if not."
      }
    ]
  },
  {
    "number": 1449,
    "title": "GLib-GObject-WARNING and GLib-GObject-CRITICAL",
    "created_at": "2018-11-06T20:47:20Z",
    "closed_at": "2018-11-10T22:49:38Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1449",
    "body": "Although my code executes fine and generates the file 100%, I am getting the following error messages:\r\n\r\n```\r\n(sharp:157048): GLib-GObject-WARNING **: 21:49:04.120: invalid uninstantiatable type '(null)' in cast to 'GObject'\r\n\r\n(sharp:157048): GLib-GObject-CRITICAL **: 21:49:04.120: g_object_set_qdata: assertion 'G_IS_OBJECT (object)' failed\r\n```\r\n\r\nMy code is as follow:\r\n\r\n```\r\nvar sharpImg = sharp('file1.png');\r\nsharpImg.metadata().then(function (metadata) {\r\n\tvar origWidth = metadata.width;\r\n\tvar origHeight = metadata.height;\r\n\treturn sharpImg.resize(Math.round(origWidth / 2), Math.round(origHeight / 2));\r\n}).then(function (data) {\r\n\tdata.toFile('file2.png', function (err, info) {\r\n\t\t// Done with err == null (No errors here)\r\n\t});\r\n});\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1449/comments",
    "author": "1Map",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-11-07T11:47:27Z",
        "body": "Hello, this looks like #1320 - are you using the latest version?"
      },
      {
        "user": "1Map",
        "created_at": "2018-11-07T15:38:22Z",
        "body": "I am using Sharp version ^0.20.8"
      },
      {
        "user": "lovell",
        "created_at": "2018-11-10T22:39:01Z",
        "body": "Are you able to reproduce with the latest v0.21.0 version?"
      },
      {
        "user": "1Map",
        "created_at": "2018-11-10T22:45:52Z",
        "body": "@lovell No, I upgraded to 0.21.0 and I was monitoring fro past day or so.  It seems the problem was fixed in the latest version, so you can go ahead and close this.  Thanks for the help."
      }
    ]
  },
  {
    "number": 1444,
    "title": "Error: extract_area: bad extract area",
    "created_at": "2018-11-01T15:53:45Z",
    "closed_at": "2018-11-05T17:01:19Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1444",
    "body": "I know this error did pop up already in the issue section, but I decided to open a new one, because based on the threads it seams that what I do should work, but it doesn't. Let me explain:\r\n\r\nI'm doing facial recognition, meaning I get the position and resolution where to find the face (bounding box). \r\n\r\n- The original image is: 1280x720\r\n- The face is of size: 236x235\r\n- And the position is: -0.03203125x0.15694444\r\n\r\nI know, a minus value. I get that since AWS Rekognition returns the position in %, which I then convert in to the final position in pixels. From time to time I'll get a negative number - maybe because of a rounding number issue. Regardless – I did put an if statement to check if I get a negative number, and if I do, I replace the value to `0`.\r\n\r\n```\r\n{ left: 0, top: 0, width: 236, height: 235 }\r\n```\r\n\r\nSince we are so close to the edge, I don't need to be that precise. Never the less I get `Error: extract_area: bad extract area`. How can that be? What am I missing?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1444/comments",
    "author": "davidgatti",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-11-01T16:49:18Z",
        "body": "Hello, please can you provide a complete, standalone code sample and image that exhibits this behaviour."
      },
      {
        "user": "davidgatti",
        "created_at": "2018-11-05T17:01:19Z",
        "body": "Sorry but for now I won't have the time to debug this :( "
      },
      {
        "user": "ackava",
        "created_at": "2021-11-22T11:22:11Z",
        "body": "@lovell This happens when extract box is outside of image.\r\n\r\nLets say image is `100,100` and when you say `extract( { left: 10, top: 10, width: 100, height: 100})`, it gives this error.\r\n\r\nThis can be resolved by either of following,\r\n1. Throw an error saying extract box falls outside of image bounds\r\n2. Trim extract box to image size, like in above example, width and height would become 90. So extracted image size would be 90x90.\r\n3. Or extracted image size would be the same but it would contain blank parts where extract box falls outside. This would be ideal, mostly in case of png, outside part could be transparent."
      }
    ]
  },
  {
    "number": 1424,
    "title": "Is sharp.js using GPU ?",
    "created_at": "2018-10-23T07:43:43Z",
    "closed_at": "2018-11-04T14:42:12Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1424",
    "body": "Hi,\r\n\r\nI'd like to buy very powerful machine to do basic operations with sharp.js on JPEGs and PNG ( with Alpha) images - composition, scaling, rotation. But I'm not sure whether I need to invest more into VGA, CPU and/or RAM.\r\nDoes sharp.js uses power of GPU under the hood ?\r\nIf answer is yes, then:\r\n- should I use any GPU specific API of sharp.js or need some flags while installing it ?\r\n- will there be any significant performance differences between Linux(Ubuntu 18) or Windows 10 machines \r\n\r\nThank you.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1424/comments",
    "author": "golojads",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-10-23T08:32:57Z",
        "body": "Please see #1202"
      }
    ]
  },
  {
    "number": 1420,
    "title": "dyld: lazy symbol binding failed: Symbol not found",
    "created_at": "2018-10-19T11:24:09Z",
    "closed_at": "2018-10-19T11:37:14Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1420",
    "body": "When I run my Electron application on macOS I get such errors right on start of my application, without even calling `sharp()`:\r\n```\r\ndyld: lazy symbol binding failed: Symbol not found: __ZN2v816FunctionTemplate3NewEPNS_7IsolateEPFvRKNS_20FunctionCallbackInfoINS_5ValueEEEENS_5LocalIS4_EENSA_INS_9SignatureEEEiNS_19ConstructorBehaviorENS_14SideEffectTypeE\r\n  Referenced from: /Users/appleuser/Documents/work/taggy/taggy-desktop/node_modules/sharp/build/Release/sharp.node\r\n  Expected in: flat namespace\r\n\r\ndyld: Symbol not found: __ZN2v816FunctionTemplate3NewEPNS_7IsolateEPFvRKNS_20FunctionCallbackInfoINS_5ValueEEEENS_5LocalIS4_EENSA_INS_9SignatureEEEiNS_19ConstructorBehaviorENS_14SideEffectTypeE\r\n  Referenced from: /Users/appleuser/Documents/work/taggy/taggy-desktop/node_modules/sharp/build/Release/sharp.node\r\n  Expected in: flat namespace\r\n```\r\n\r\nsharp v0.21.0",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1420/comments",
    "author": "SilencerWeb",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-10-19T11:35:10Z",
        "body": "Hello, did you see #1384 ?"
      },
      {
        "user": "SilencerWeb",
        "created_at": "2018-10-19T11:37:11Z",
        "body": "@lovell sorry, did see it :("
      },
      {
        "user": "jetlej",
        "created_at": "2018-12-22T16:11:49Z",
        "body": "I have the same issue. Any recommendations on what module should be included in the `electron-rebuild` command? "
      },
      {
        "user": "jetlej",
        "created_at": "2018-12-22T16:14:50Z",
        "body": "Got it. Just rebuilding sharp made it work: \r\n\r\n```\r\n\"scripts\": {\r\n  \"rebuild\": \"electron-rebuild -f -w sharp\"\r\n}\r\n```"
      },
      {
        "user": "EKami",
        "created_at": "2018-12-24T10:16:30Z",
        "body": "`electron-rebuild -f -w sharp` did not work for me for electron 4.0 :("
      },
      {
        "user": "philipptrenz",
        "created_at": "2018-12-25T11:20:39Z",
        "body": "For me it's the same as for @EKami, electron-rebuild leads to the above mentioned bug for the just released Electron 4.0. But maybe electron-rebuild does not yet support the 4.0 release?"
      },
      {
        "user": "ihormihal",
        "created_at": "2019-01-08T13:33:18Z",
        "body": "The same for Electron 3.1.0"
      },
      {
        "user": "EKami",
        "created_at": "2019-01-08T13:37:31Z",
        "body": "I think we'll need to open a new issue guys, this one is closed and no one will pay attention to it"
      }
    ]
  },
  {
    "number": 1417,
    "title": "Absolutely necessary files to run",
    "created_at": "2018-10-18T21:28:29Z",
    "closed_at": "2018-11-04T14:42:32Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1417",
    "body": "Hi,\r\n\r\nI'm trying to reduce the size of a build artifact and I'd like to know which files are absolutely necessary for sharp to run. There seem to be a lot of files in the `node_modules` subdir that are development related but I'm having a hard time figuring out which one I can get rid of.\r\n\r\nThanks",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1417/comments",
    "author": "tcz",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-10-19T09:35:02Z",
        "body": "Hello, as you've probably seen, `sharp` lists separate `devDependencies` from `dependencies` so at install time only the modules necessary for installation and runtime are added to `node_modules`. I suspect it's the former category you care about, the install time but not runtime dependencies.\r\n\r\nExcluding sharp itself, the following are the `dependencies` that take up most disk space.\r\n```sh\r\n$ npm install sharp\r\n$ du -sh node_modules/* | grep -v sharp | sort -rh\r\n588K\tnan\r\n196K\ttar\r\n188K\tmkdirp\r\n172K\treadable-stream\r\n136K\ttar-fs\r\n104K\tgauge\r\n100K\tminimist\r\n...\r\n```\r\nAt least the first 3 of these are, I think, currently used only at install-time so could probably be removed after `npm install` has completed. Beyond that you'd have to experiment - good luck!"
      }
    ]
  },
  {
    "number": 1415,
    "title": "Possible buffer memory leak on fedora/centos systems ",
    "created_at": "2018-10-18T14:29:43Z",
    "closed_at": "2018-12-04T21:33:39Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1415",
    "body": "I'm writing a application to index large amount of images.\r\n\r\nI'm getting large RSS (1.5 - 2gb after few hundred images) usage and it' is not going down. Heap is about 70mb.\r\n\r\nIf I run this code on my machine the RSS will just keep on growing.\r\n\r\ncurrent system: Fedora release 28 (Twenty Eight)\r\n http_parser: '2.8.0',\r\n  node: '10.1.0',\r\n  v8: '6.6.346.27-node.6',\r\n  uv: '1.20.2',\r\n  zlib: '1.2.11',\r\n  ares: '1.14.0',\r\n  modules: '64',\r\n  nghttp2: '1.29.0',\r\n  napi: '3',\r\n  openssl: '1.1.0h',\r\n  icu: '61.1',\r\n  unicode: '10.0',\r\n  cldr: '33.0',\r\n  tz: '2018c' \r\n\r\n\r\n```\r\nconst sharp = require('sharp');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\nconst async = require('async');\r\nsharp.cache(false);\r\n\r\n\r\nconst filePath  = process.argv.pop();\r\n\r\n\r\nfunction createArray(len){\r\n  const array = [];\r\n\r\n  for (let i = 0; i < len; i++){\r\n    array.push(i);\r\n  }\r\n\r\n  return array;\r\n}\r\n\r\nconst arr = createArray(10000);\r\n\r\nconst sourceBuffer = fs.readFileSync(filePath);\r\n\r\nasync function resize(source){\r\n  const image = sharp(source).toBuffer();\r\n  source = null;\r\n  return image;\r\n}\r\n\r\nfunction logMemory(){\r\n  const pr = process.memoryUsage();\r\n  const logObject = {};\r\n  for (let key in pr){\r\n    logObject[key] =  parseInt((pr[key] / 1024 / 1024).toFixed(0));\r\n  }\r\n\r\n  console.log(logObject)\r\n\r\n}\r\n\r\nasync.forEachLimit(arr, 1, async function (i){\r\n  let resizedImage = await resize(sourceBuffer);\r\n\r\n  resizedImage = null;\r\n  logMemory();\r\n}, function (err){\r\n\r\n  console.log('done', err)\r\n  setTimeout(logMemory, 3000)\r\n})\r\n```\r\n\r\nThe image is 24mb TIFF image\r\n\r\nusage is : node test.js 'file.tiff'",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1415/comments",
    "author": "agustik",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-10-18T14:37:14Z",
        "body": "Hello, did you see #955?"
      },
      {
        "user": "agustik",
        "created_at": "2018-10-18T14:49:06Z",
        "body": "@lovell Well, i read it like few hours ago .. \r\n\r\nBut sharp.concurrency(); seems to do the trick keeping the memory down ..\r\n\r\n\r\nI't might fix the issue. I'm going to commit the code on my procject and deploy on my test servers.. "
      },
      {
        "user": "agustik",
        "created_at": "2018-10-18T15:14:01Z",
        "body": "RSS is about 500-700mb in production right now (more than just sharp)\r\n\r\nconcurrency is 1;\r\nand cache is default enabled.\r\n\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2018-11-19T20:08:52Z",
        "body": "@agustik Were you able to make any progress with this?"
      },
      {
        "user": "agustik",
        "created_at": "2018-11-19T22:58:58Z",
        "body": "No problems that I know off after i set concurrency to 1. I'll check the stats on the production system"
      },
      {
        "user": "lovell",
        "created_at": "2018-12-04T21:33:39Z",
        "body": "Sounds like this problem has gone away but please re-open with more details if not."
      }
    ]
  },
  {
    "number": 1397,
    "title": "when I map data with code, both png and jpeg are converted with a white background though I have a condition to only do that when output ext is  jpeg or jpg",
    "created_at": "2018-10-01T16:15:39Z",
    "closed_at": "2018-10-02T19:53:23Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1397",
    "body": "I'm trying to convert a transparent logo to jpg and png.  As you can see in my code below, I check to see if the file output ext is jpeg or jpg and if it is, it change the background to white and flatten it. \r\n\r\nFor some strange reason, when I map data with function, both png and jpeg are converted with a white background though I have a condition to only do that when output ext is  jpeg or jpg\r\n\r\n\r\n\r\n\r\n```\r\nlet local_file = '/tmp/output/295aadfd-f837-4ffb-b3a0-4a407cca54e0.png'\r\n\r\nlet data = [[700,\r\n    null,\r\n    'width',\r\n    '/tmp/output/295aadfd-f837-4ffb-b3a0-4a407cca54e0_10',\r\n    'png'],\r\n    [700,\r\n        null,\r\n        'width',\r\n        '/tmp/output/295aadfd-f837-4ffb-b3a0-4a407cca54e0_10',\r\n        'jpg'],\r\n    [1000,\r\n        null,\r\n        'width',\r\n        '/tmp/output/295aadfd-f837-4ffb-b3a0-4a407cca54e0_10',\r\n        'png'],\r\n    [1000,\r\n        null,\r\n        'width',\r\n        '/tmp/output/295aadfd-f837-4ffb-b3a0-4a407cca54e0_10',\r\n        'jpg']]\r\n\r\n\r\nPromise.all(data.map(convert_image_sharp(local_file))).then(() => {\r\n                    console.log('image convert done');\r\n                });\r\n\r\n\r\n```\r\n\r\n\r\n```\r\nfunction convert_image_sharp(image_path) {\r\n    let image = sharp(image_path);\r\n    return data => image\r\n        .metadata()\r\n        .then(function (metadata) {\r\n            let inputs = beatify_input(data);\r\n            if (inputs['crop']) {\r\n                image.extract(inputs['crop'][0], inputs['crop'][1], inputs['crop'][2], inputs['crop'][3])\r\n            }\r\n            image.resize(inputs['width'], inputs['height']);\r\n            if (['jpg', 'jpeg'].includes(inputs['ext'])){\r\n                console.log(inputs['ext']);\r\n                image.background('white');\r\n                image.flatten();\r\n            }\r\n            return image.toFile(inputs['write_path']);\r\n        })\r\n\r\n}\r\n\r\n```\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1397/comments",
    "author": "wobeng",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-10-01T17:45:24Z",
        "body": "Hello, it's unclear what `data` refers to in the `convert_image_sharp` function. Are you able to provide a standalone, working code sample?"
      },
      {
        "user": "wobeng",
        "created_at": "2018-10-01T17:48:09Z",
        "body": "Hi @lovell I updated what data is"
      },
      {
        "user": "lovell",
        "created_at": "2018-10-01T19:05:24Z",
        "body": "The shared `image` instance is being mutated by each function invocation. You'll need to move the `sharp(image_path)` constructor into the anonymous function returned by `convert_image_sharp` to create a new sharp instance per function invocation.\r\n\r\n```diff\r\nfunction convert_image_sharp(image_path) {\r\n-    let image = sharp(image_path) ;\r\n-    return data => image\r\n+    return data => sharp(image_path)\r\n        .metadata()\r\n```"
      },
      {
        "user": "wobeng",
        "created_at": "2018-10-01T19:23:13Z",
        "body": "If I move the sharp(image_path) constructor into the anonymous function returned by convert_image_sharp, who can I access metadata? can you show me an example with metadata included"
      },
      {
        "user": "lovell",
        "created_at": "2018-10-01T20:22:35Z",
        "body": "The code sample provided doesn't appear to use `metadata` as provided by the call to `metadata()` so I'm not sure I understand what is needed. This might be more of a question for StackOverflow."
      },
      {
        "user": "wobeng",
        "created_at": "2018-10-01T20:26:45Z",
        "body": "Question:\r\n\r\nAfter I do sharp(image_path).metadata(), to get the sharp object back, do I need to use the constructor sharp(image_path) again\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2018-10-02T19:51:51Z",
        "body": "Here's a possible (untested) version of `convert_image_sharp` that should behave in a way that I have understood your `data.map` logic to expect.\r\n```javascript\r\nfunction convert_image_sharp(image_path) {\r\n  return () => {\r\n    const image = sharp(image_path);\r\n    const { crop, ext, width, height, write_path } = beatify_input(data);\r\n    if (crop) {\r\n      image.extract(...crop);\r\n    }\r\n    image.resize(width, height);\r\n    if (['jpg', 'jpeg'].includes(ext)) {\r\n      image.background('white').flatten();\r\n    }\r\n    return image.toFile(write_path);\r\n  };\r\n}\r\n```\r\nThis question is not really specific to sharp and is more of a general JavaScript coding question suited to a site such as StackOverflow."
      },
      {
        "user": "wobeng",
        "created_at": "2018-10-02T19:53:23Z",
        "body": "Got it and thank you :)\r\n\r\n forgive me...I had to learn node js within 48 hours"
      }
    ]
  },
  {
    "number": 1373,
    "title": "Sharp breaks on Ubuntu 18.04",
    "created_at": "2018-09-07T09:59:20Z",
    "closed_at": "2018-10-01T10:07:34Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1373",
    "body": "I have a droplet on Digital Ocean which runs Ubuntu 18.04.\r\nBefore this I was using Sharp on a server with Ubuntu 17.04 where it worked correctly.\r\nNow on my droplet it doesn't work and I receive this error:\r\n\r\n```javascript\r\nError: Cannot find module '../build/Release/sharp.node'\r\n1|scheepva |     at Function.Module._resolveFilename (internal/modules/cjs/loader.js:548:15)\r\n1|scheepva |     at Function.Module._load (internal/modules/cjs/loader.js:475:25)\r\n1|scheepva |     at Module.require (internal/modules/cjs/loader.js:598:17)\r\n1|scheepva |     at require (internal/modules/cjs/helpers.js:11:18)\r\n1|scheepva |     at Object.<anonymous> (/var/www/html/dev.verhalenvanger-hetscheepvaartmuseum/node_modules/sharp/lib/constructor.js:10:15)\r\n1|scheepva |     at Module._compile (internal/modules/cjs/loader.js:654:30)\r\n1|scheepva |     at Object.Module._extensions..js (internal/modules/cjs/loader.js:665:10)\r\n1|scheepva |     at Module.load (internal/modules/cjs/loader.js:566:32)\r\n1|scheepva |     at tryModuleLoad (internal/modules/cjs/loader.js:506:12)\r\n1|scheepva |     at Function.Module._load (internal/modules/cjs/loader.js:498:3)\r\n1|scheepva |     at Module.require (internal/modules/cjs/loader.js:598:17)\r\n1|scheepva |     at require (internal/modules/cjs/helpers.js:11:18)\r\n1|scheepva |     at Object.<anonymous> (/var/www/html/dev.verhalenvanger-hetscheepvaartmuseum/node_modules/sharp/lib/index.js:3:15)\r\n1|scheepva |     at Module._compile (internal/modules/cjs/loader.js:654:30)\r\n1|scheepva |     at Object.Module._extensions..js (internal/modules/cjs/loader.js:665:10)\r\n1|scheepva |     at Module.load (internal/modules/cjs/loader.js:566:32)\r\n```\r\n\r\n`1|scheepva |` comes from PM2 which keeps my Node.js running.\r\n\r\nAre you guys working on support for Ubuntu 18.04 or is there something I can do to fix this error?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1373/comments",
    "author": "meesrutten",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-09-07T10:08:27Z",
        "body": "Hello, sharp works fine on Ubuntu 18.04. If `build/Release/sharp.node` is missing then something probably went wrong during `npm install`."
      },
      {
        "user": "lovell",
        "created_at": "2018-10-01T10:07:34Z",
        "body": "Feel free to re-open with more information if this problem remains."
      },
      {
        "user": "tech-and-avinash",
        "created_at": "2019-08-21T09:02:25Z",
        "body": "I am using sharp v0.23.0 & libvips v0.0.2 with an electron app. It works fine in development mode... But came negative after taking build.... Once the code reaches sharp implemented method, my app crashes automatically. Later, I got to know that it is not supported with ubuntu 18.04. Whereas, in other platforms like windows & mac it works fine.... \r\n\r\nI use the following:-\r\nnode v10.16.0\r\nnpm 6.9.0\r\nPython 2.7.15+\r\nelectron: 4.0.8\r\n\r\nIs there any solution for this issue?\r\n\r\nMoreover i can find only libvips v0.0.2 & not v8.8.1 in npm. Could u pls guide me how to get it installed??\r\n\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2019-08-22T09:15:10Z",
        "body": "@Crazie-ash The \"libvips\" package published to npm is completely unrelated to sharp or libvips so can be removed from your dependencies."
      }
    ]
  },
  {
    "number": 1370,
    "title": "Segmentation fault using sharp.grayscale",
    "created_at": "2018-09-05T10:03:13Z",
    "closed_at": "2018-09-05T11:38:22Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1370",
    "body": "I have a NodeJS server that needs to return grayscale image buffers by reading them from internal storage. This is the code snippet:\r\n\r\n```       \r\nsharp('image.jpeg')\r\n    .grayscale()\r\n    .resize(height, width)       \r\n    .raw()\r\n    .toBuffer()\r\n    .then(data => {\r\n        // Use the data\r\n    })\r\n    .catch(err => console.log(err))\r\n```\r\n\r\nHowever, using the `grayscale` method results in random segmentation faults (but rather frequently: something like 1 out of 5 times):\r\n\r\n``` \r\nSegmentation fault (core dumped)\r\nnpm ERR! code ELIFECYCLE\r\nnpm ERR! errno 139\r\nnpm ERR! nv@2.0.1 start: `node src/server/nv-http.js`\r\nnpm ERR! Exit status 139\r\n``` \r\n\r\n- When the segmentation fault happens, neither the `then` or the `catch` methods get called\r\n- Writing `grayscale` before or after the `resize` function doesn't change the problem\r\n- Removing the `grayscale` method automatically solves the problem! (No more segmentation faults)\r\n\r\nMy configuration: Ubuntu 16.04 LTS on VMWare, node v8.11.3, sharp 0.20.7\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1370/comments",
    "author": "ralbertazzi",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-09-05T10:05:48Z",
        "body": "Hello, did you see #1344?"
      },
      {
        "user": "ralbertazzi",
        "created_at": "2018-09-05T11:38:22Z",
        "body": "Thanks a lot! I spent an hour looking to issues but of course I didn't find that one :)"
      }
    ]
  },
  {
    "number": 1369,
    "title": "Image size gets larger after `sharp(input).toBuffer()`",
    "created_at": "2018-09-05T02:37:28Z",
    "closed_at": "2018-09-05T08:21:09Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1369",
    "body": "Hello, I found the problem recently when I use sharp. The code below shows the demo:\r\n\r\n```js\r\nvar sharp = require('sharp');\r\n// the original size of test.png is 808244 Bytes\r\nsharp('./test.png').toBuffer((err, data, info) => {\r\n    console.log(info.size);  // 1145815\r\n})\r\n\r\nsharp('./test.png').toFile('processed.png', (err, info) => {\r\n    console.log(info.size); // still 1145815\r\n})\r\n```\r\n\r\nMy questions are:\r\n1. Why the image size gets Bigger since I did nothing except reading it with `sharp()` ?\r\n2. How to avoid the phenomenon？Is there any parameter I missed ?\r\n\r\nReally appreciate the help.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1369/comments",
    "author": "ChrisCindy",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-09-05T06:12:33Z",
        "body": "Please see #478."
      },
      {
        "user": "ChrisCindy",
        "created_at": "2018-09-05T08:21:09Z",
        "body": "thanks a lot."
      }
    ]
  },
  {
    "number": 1367,
    "title": "How to close the file?",
    "created_at": "2018-09-04T07:32:03Z",
    "closed_at": "2018-09-04T10:02:54Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1367",
    "body": "sharp('input.jpg')\r\n\r\nThe file is always locked\r\nUnable to delete\r\nHow to close an object?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1367/comments",
    "author": "yyx1111",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-09-04T09:34:37Z",
        "body": "Hello, please see #415"
      },
      {
        "user": "yyx1111",
        "created_at": "2018-09-04T09:59:44Z",
        "body": "before  sharp.cache( { files: 0 } );  It doesn't solve the problem\r\nsharp.cache(false);  ok\r\nThank you for your prompt reply."
      },
      {
        "user": "RichardBradley",
        "created_at": "2023-06-19T14:22:24Z",
        "body": "It would be nice if there were a way to explicitly close the file handle and dealloc the memory, separately from `cache(false)`, which I think isn't exactly the same thing"
      },
      {
        "user": "lovell",
        "created_at": "2023-06-19T15:30:05Z",
        "body": "@RichardBradley Use `sharp.cache({ files: 0 })` before you open any files to prevent file handles from being cached in the first place."
      }
    ]
  },
  {
    "number": 1356,
    "title": "Is fastShrinkOnLoad really faster?",
    "created_at": "2018-08-26T10:09:26Z",
    "closed_at": "2018-10-01T10:07:17Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1356",
    "body": "I have run multiple tests using two instances with the exact same set up except one has fastShrinkOnLoad option disabled and the one with option disabled is nearly always faster with jpeg images.\r\n\r\nIn fact the cases where I thought fastShrinkOnLoad would help, i.e. where reduction factor is large, saw the one with option disabled perform noticeably faster. Small factor resizes had almost the same result with some variance due to network flight I believe.\r\n\r\nMy images are about 2000x2000 perhaps that's why the performance improvement is not kicking in.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1356/comments",
    "author": "nicholas-littlelives",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-08-27T07:36:58Z",
        "body": "Hello, are you able to share some sample code, images and, if you're using something like EC2, the instance types that exhibit this behaviour so I can attempt to profile it?\r\n\r\nProducing smaller/thumbnail JPEG images with libvips is usually an IO-bound task on the input side, where the `fastShrinkOnLoad` feature will help as it reduces the work libjpeg has to do. Perhaps your scenario is somehow bound on the output side?"
      },
      {
        "user": "lovell",
        "created_at": "2018-10-01T10:07:17Z",
        "body": "Feel free to re-open with more information if this problem remains."
      }
    ]
  },
  {
    "number": 1347,
    "title": "Support Windows 32-bit",
    "created_at": "2018-08-21T23:45:01Z",
    "closed_at": "2018-09-05T06:16:35Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1347",
    "body": "Hi,\r\n\r\nWould like to know why sharp is not available on Windows 32-bit and if it's possible to get it work? \r\n\r\nThanks",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1347/comments",
    "author": "Tibus",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-08-22T07:54:44Z",
        "body": "Hello, did you see #379?"
      },
      {
        "user": "Tibus",
        "created_at": "2018-08-22T08:38:55Z",
        "body": "Yes but not compatible with electronJS"
      },
      {
        "user": "lovell",
        "created_at": "2018-08-22T09:07:05Z",
        "body": "64-bit Electron on Windows should be OK, but yes, if you need 32-bit Electron on Windows then you'll have to work that one out for yourself. Good luck!"
      },
      {
        "user": "aabuhijleh",
        "created_at": "2019-06-20T08:14:23Z",
        "body": "Hi @lovell, I also need to use 32-bit Electron on Windows. Do you have any suggestions on how to get sharp to work there or if there are other alternatives?\r\n\r\nI have tried jimp. It's ok but it's way too slow."
      }
    ]
  },
  {
    "number": 1327,
    "title": "Feature request: Apply custom filter",
    "created_at": "2018-08-09T20:00:10Z",
    "closed_at": "2018-09-05T06:15:44Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1327",
    "body": "Hi @lovell!\r\nThank you for this fantastic library!\r\n\r\nI have one question. Is it possible to apply custom filter like Instagram filters on readable stream in Node.js? I see that CamanJS gives the possibility to do this, but it uses different approach for image processing.\r\n\r\nI am not an expert of streams, but if it is be possible, I'd try to do it extending your library.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1327/comments",
    "author": "serhiipalash",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-08-11T08:09:31Z",
        "body": "Hello, I've not seen the internals of Caman but \"Instagram\" style filters are usually implemented via either a recombination matrix (#164) and/or altering brightness/saturation/hue (#609), both of which are future possible enhancements."
      }
    ]
  },
  {
    "number": 1322,
    "title": "reduce quality without reduce size",
    "created_at": "2018-08-04T15:48:29Z",
    "closed_at": "2018-09-05T06:51:35Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1322",
    "body": "It is possible to reduce image quality without reduce size. If yes, how ? if not you will provide this later ?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1322/comments",
    "author": "noyessie",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-08-04T18:52:31Z",
        "body": "Please can you provide more details about what you're trying to achieve, perhaps using a worked example?"
      },
      {
        "user": "lovell",
        "created_at": "2018-09-05T06:51:35Z",
        "body": "Please feel free to reopen with more details if help is still required."
      }
    ]
  },
  {
    "number": 1321,
    "title": "\"requires mozjpeg\", is this bundled up by default?",
    "created_at": "2018-08-03T22:26:31Z",
    "closed_at": "2018-09-05T06:50:08Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1321",
    "body": "I poked around to some previous issues and found that mozjpeg had to be installed separately. Yet when I used one of the 3 options that claim to require mozjpeg the resulting image is different.\r\n\r\nSo, is mozjpeg included? Or are these options using something else?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1321/comments",
    "author": "sean256",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-08-04T09:57:42Z",
        "body": "Hello, mozjpeg is not provided by the pre-compiled binaries. Are you able to provide two code samples that produce different results?"
      },
      {
        "user": "lovell",
        "created_at": "2018-09-05T06:50:08Z",
        "body": "Please feel free to re-open with code examples if more help is required."
      }
    ]
  },
  {
    "number": 1313,
    "title": "Use text inside svg will cause memory leak",
    "created_at": "2018-07-30T06:45:24Z",
    "closed_at": "2018-08-06T07:12:21Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1313",
    "body": "In a scene, I encountered this problem when I used SVG to synthesize text onto an image. \r\n\r\nThis is a simplified code:\r\n\r\n``` javascript\r\nconst sharp = require('sharp');\r\n\r\nlet count = 0;\r\nsetInterval(() => {\r\n    if (++count % 100 === 0) {\r\n        console.log(count, process.memoryUsage());\r\n    }\r\n\r\n    sharp(Buffer.from(`\r\n        <svg>\r\n            <text>example</text>\r\n        </svg>\r\n    `)).toBuffer();\r\n}, 100);\r\n```\r\n\r\nAfter 500, 1000, 2000 times：\r\n\r\n``` text\r\n500 { rss: 343126016,\r\n  heapTotal: 9256960,\r\n  heapUsed: 7043760,\r\n  external: 44416 }\r\n\r\n1000 { rss: 641712128,\r\n  heapTotal: 11354112,\r\n  heapUsed: 8856440,\r\n  external: 95232 }\r\n\r\n2000 { rss: 1231851520,\r\n  heapTotal: 12402688,\r\n  heapUsed: 10316248,\r\n  external: 125248 }\r\n```\r\n\r\nI guess the underlying code is causing this problem, but I'm not sure, so give you a feedback.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1313/comments",
    "author": "shasharoman",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-08-01T17:26:43Z",
        "body": "Hello, please see #955 (amongst other issues relating to RSS) for why this is unlikely to be a memory leak."
      },
      {
        "user": "shasharoman",
        "created_at": "2018-08-03T02:52:36Z",
        "body": "Thank you for your reply.\r\n\r\nI am not very familiar with the computer foundation. The original scene of this problem is that there is an HTTP interface in an application that uses sharp to synthesize images and text. After each call, the application RSS will grow and never drop, then I call the interface about 200. After that, the entire system (Centos 7.5, Memory: 2GB) is abnormal.\r\n\r\nThe surface reason I finally located is that svg+text mentioned above, I then changed the implementation method and there is no longer the problem of high RSS.\r\n\r\nThe new implementation is to convert text to a path representation as follows:\r\n\r\n``` javascript\r\nconst sharp = require('sharp');\r\n\r\nlet count = 0;\r\nsetInterval(() => {\r\n    if (++count % 100 === 0) {\r\n        console.log(count, process.memoryUsage());\r\n    }\r\n\r\n    // The content of path is the letter `o`, get it using opentype.js\r\n    sharp(Buffer.from(`\r\n        <svg>\r\n            <path d = \"M13.32 13.46L13.32 13.46Q13.32 16.66 11.68 18.51Q10.04 20.36 7.29 20.36L7.29 20.36Q4.51 20.36 2.88 18.51Q1.24 16.66 1.24 13.46L1.24 13.46Q1.24 10.26 2.88 8.40Q4.51 6.55 7.29 6.55L7.29 6.55Q10.04 6.55 11.68 8.40Q13.32 10.26 13.32 13.46ZM11.05 13.46L11.05 13.46Q11.05 10.92 10.05 9.68Q9.06 8.45 7.29 8.45L7.29 8.45Q5.50 8.45 4.51 9.68Q3.52 10.92 3.52 13.46L3.52 13.46Q3.52 15.92 4.51 17.19Q5.51 18.46 7.29 18.46L7.29 18.46Q9.05 18.46 10.05 17.21Q11.05 15.95 11.05 13.46Z\" />\r\n        </svg>\r\n    `)).toBuffer();\r\n}, 100);\r\n\r\n```\r\n\r\nAfter 500, 1000, 2000 times：\r\n\r\n\r\n``` text\r\n500 { rss: 33103872,\r\n  heapTotal: 8732672,\r\n  heapUsed: 5761608,\r\n  external: 16544 }\r\n\r\n1000 { rss: 33406976,\r\n  heapTotal: 8732672,\r\n  heapUsed: 6061008,\r\n  external: 42208 }\r\n\r\n2000 { rss: 35184640,\r\n  heapTotal: 8732672,\r\n  heapUsed: 6613104,\r\n  external: 68672 }\r\n```\r\n\r\nI think that no matter how RSS is defined, it should not cause the system to eventually crash without usable memory. This is why I came here to mention the issue."
      },
      {
        "user": "lovell",
        "created_at": "2018-08-03T09:21:10Z",
        "body": "Thanks for the extra info, I'll attempt to reproduce via valgrind."
      },
      {
        "user": "lovell",
        "created_at": "2018-08-04T13:34:16Z",
        "body": "I'm unable to reproduce this with the latest version of sharp on Linux using the \"simplified code\" of the first comment.\r\n```\r\n100 { rss: 47820800,\r\n  heapTotal: 8208384,\r\n  heapUsed: 5804256,\r\n  external: 16960 }\r\n500 { rss: 48328704,\r\n  heapTotal: 8732672,\r\n  heapUsed: 6690656,\r\n  external: 36384 }\r\n1000 { rss: 47693824,\r\n  heapTotal: 8732672,\r\n  heapUsed: 5918232,\r\n  external: 25344 }\r\n```\r\nWhich platform and versions are you using?"
      },
      {
        "user": "shasharoman",
        "created_at": "2018-08-06T04:07:59Z",
        "body": "I made a big mistake because my production environment is linux, and after a failure I used my own OS X (10.11.6) to locate and debug, and then guessed that using svg+text caused a memory leak.\r\n\r\nAfter reading your last reply, I continued to run \"simplified code\" on OS X. This time I ran 8000 times and the RSS size was about 4.8G, but this may be because my machine's available memory is too large.\r\n\r\nAfter that I went to the linux environment to run this code, the RSS size is always at 30M-40M, which forced me to think about the whole problem. I then used a complete local environment to test my application, making sure it should be an RSS issue. The last application crash was an exception caused by a shortage of system memory.\r\n\r\nAfter confirming that it is not a memory leak, I should focus on how to optimize RSS. I think the OS X memory leak probability is low and will not be used as a production environment, so this issue should be closed. If you are interested, you can also run \"Simplified Code\" in the OS X environment.\r\n\r\nThank you very much for providing such a good tool library."
      }
    ]
  },
  {
    "number": 1292,
    "title": "Remove alpha channel from png output",
    "created_at": "2018-07-11T14:35:08Z",
    "closed_at": "2018-07-22T19:49:44Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1292",
    "body": "Hi I try to compose an `icon.png` (with 4 channels) onto a background.\r\nRight now my solution is like this\r\n```js\r\nconst icon = sharp('icon.png').resize(size)\r\nsharp({ create: { width, height, background, channels: 4 } })\r\n  .overlayWith(await icon.toBuffer())\r\n  .toFile('output.png')\r\n```\r\n\r\nNow I sometimes need to remove the alpha channel from the `output.png`,\r\nI tried using `.flatten()` but the output image still has 4 channels.\r\nIt only worked when I also `.flatten()` the `icon` but then I get problems with the overlay.\r\n\r\nIs there a solution for this or do I have thought error somewhere?\r\nThank you for your help.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1292/comments",
    "author": "dertieran",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-07-11T16:38:30Z",
        "body": "Hello, sharp will flatten before adding the overlay. To flatten after, something like the following should work (untested):\r\n\r\n```javascript\r\nconst rgbaImage = await sharp({ create: { width, height, background, channels: 4 } })\r\n  .overlayWith(await icon.toBuffer())\r\n  .toBuffer();\r\n\r\nsharp(rgbaImage)\r\n  .flatten()\r\n  .toFile('output.png')\r\n```"
      },
      {
        "user": "dertieran",
        "created_at": "2018-07-12T16:00:40Z",
        "body": "Thanks a lot that worked 👍 \r\nI just needed to add `.png()` before converting it to a buffer otherwise I would get the\r\n```\r\nInput buffer contains unsupported image format\r\n```\r\nSo now it looks like this:\r\n```js\r\nconst icon = sharp('icon.png').resize(size)\r\nconst buffer = await sharp({ create: { width, height, background, channels: 4 } })\r\n  .overlayWith(await icon.toBuffer())\r\n  .png()\r\n  .toBuffer()\r\n\r\nsharp(buffer)\r\n  .flatten()\r\n  .toFile('output.png')\r\n```"
      }
    ]
  },
  {
    "number": 1284,
    "title": " write after end",
    "created_at": "2018-07-03T15:17:04Z",
    "closed_at": "2018-08-05T09:34:17Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1284",
    "body": "I'm trying to use sharp to (max) resize images. But I keep getting an error, am I doing something wrong?\r\n\r\n**Error**\r\n```\r\n write after end\r\n```\r\n\r\n**Code**\r\n```\r\n let stream = bucket.openDownloadStream(mongoID); \r\n stream = stream.pipe(sharp().resize(900, 900).max())\r\n stream.pipe(res)\r\n.on('error', responses.handleError(res, 500))\r\n.on('finish', function () {\r\n                res.end()\r\n});\r\n```\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1284/comments",
    "author": "danfergo",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-07-04T08:32:30Z",
        "body": "Hello, the error handler in this code is attached to `res`. Are you sure sharp is causing this? Perhaps the call to `res.end()` is superfluous?"
      },
      {
        "user": "lovell",
        "created_at": "2018-07-22T19:51:29Z",
        "body": "@danfergo Were you able to make any progress with this?"
      },
      {
        "user": "lovell",
        "created_at": "2018-08-05T09:34:17Z",
        "body": "Feel free to re-open with more details if further help is required."
      },
      {
        "user": "danfergo",
        "created_at": "2018-08-07T14:56:31Z",
        "body": "Hi Lovell,\r\nSorry for only being replying now, I've been working on other stuff.\r\nI've been now working on this, and I was able to do it by removing the finish handler and creating a temporary variable to hold the sharp transform.\r\n```\r\nconst stream = bucket.openDownloadStream(mongoID);\r\nconst transform = sharp().resize(900, 900).max();\r\nstream = stream.pipe(transform);\r\nstream.pipe(res)\r\n.on('error', responses.handleError(res, 500))\r\n```\r\nI don't know if babel was doing some optimization replacing the transform with a global constant or something like that, (wierd) but it is working now.\r\n\r\nAfter that, I had also comment **res.set('Content-Length', size)**, else the response would end sooner than the desired and the image would be cut at the bottom.\r\n\r\nGreat library! :heart: "
      }
    ]
  },
  {
    "number": 1280,
    "title": "Metadata not updated after rotate()",
    "created_at": "2018-06-28T03:44:35Z",
    "closed_at": "2018-06-28T18:14:49Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1280",
    "body": "If I have a file of dimensions 1999x1124, exif orientation=8, and I run it through sharp:\r\n```js\r\nsharp(file).rotate().metadata().then(metadata => console.log(metadata))\r\n```\r\nI get the original metadata.  I would have expected to see the new dimensions: (1124x1999)  I tried inserting `sharp.cache(false)` after rotating, but that had no effect.\r\n\r\nI suspect this is because the metadata function works \"without decoding any compressed image data,\" and it would need to read the buffer in order to redetermine it?  This seems broken to me.  Shouldn't the rotate() function update whatever source it's pulling this metadata from?\r\n\r\nPerhaps one non-breaking solution to this could be accepting a second options argument to the rotate method with a \"resolveWithObject\" flag that would work just like toBuffer, resolving an additional data object containing the new size after rotation.  I don't particularly like this idea design-wise, just brainstorming.\r\n\r\nMy use-case is, I need to resize an overlay image down to match the *rotated* image, prior to applying it.  I've had to resort to calling toBuffer twice: once to just fetch the dimensions, and then again after applying the overlay.  It's just really ugly and inefficient.  Here's the simplified version:\r\n```js\r\nfunction applyOverlay(file, overlayFile) {\r\n    return sharp(file)\r\n        .rotate()\r\n        .toBuffer({resolveWithObject: true})\r\n        .then(async ({data, info}) => {\r\n            const newWidth  = info.width;\r\n            const newHeight = info.height;\r\n\r\n            const overlay = await sharp(overlayFile)\r\n                .resize(newWidth, newHeight)\r\n                .max()\r\n                .toBuffer();\r\n\r\n            return sharp(data)\r\n                .overlayWith(overlay)\r\n                .toBuffer();\r\n        });\r\n}\r\n```\r\nIf there's some easier way to do this that I'm missing, by all means let me know where I've gone wrong.  Thanks!",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1280/comments",
    "author": "hackel",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-06-28T08:43:03Z",
        "body": "Hello, to perform a calculation based on EXIF Orientation without decoding pixel data, try something like the following (untested):\r\n```javascript\r\nsharp(file)\r\n  .metadata()\r\n  .then(({ width, height, orientation }) => {\r\n    const [newWidth, newHeight] = orientation < 5\r\n      ? [width, height]\r\n      : [height, width];\r\n    ...\r\n  });\r\n```"
      },
      {
        "user": "hackel",
        "created_at": "2018-06-28T18:06:08Z",
        "body": "Ha, well that is ridiculously simple, thanks.  I still think there's a case to be made for retrieving current metadata (or at least dimensions) at an arbitrary point in the pipeline, but this will work for my case."
      },
      {
        "user": "CptMaumau",
        "created_at": "2021-09-23T10:12:40Z",
        "body": "I recommend to do the opposite in case the metadata doesn't contain the orientation flag\r\n```\r\nconst [newWidth, newHeight] = orientation > 5\r\n  ? [metadata.height, metadata.width]\r\n  : [metadata.width, metadata.height];\r\n```"
      },
      {
        "user": "Apidcloud",
        "created_at": "2023-06-15T15:45:45Z",
        "body": "For what it's worth, just noticed the above snippet is not exactly the opposite (and therefore not entirely correct), as it missing the number 5 itself.\r\n\r\nIt should then be:\r\n```\r\nconst [newWidth, newHeight] = orientation >= 5\r\n  ? [metadata.height, metadata.width]\r\n  : [metadata.width, metadata.height];\r\n  ```"
      }
    ]
  },
  {
    "number": 1276,
    "title": "Suddenly getting Error: /lib64/libz.so.1: version `ZLIB_1.2.9' not found",
    "created_at": "2018-06-26T14:00:23Z",
    "closed_at": "2018-08-05T09:36:18Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1276",
    "body": "`Error: /lib64/libz.so.1: version 'ZLIB_1.2.9' not found'`\r\n\r\nCan't get around this issue as of my last deployment. Worked before just fine but no matter what I do I can not solve this issue.\r\n\r\nAlso keep getting a bunch of warnings like below:\r\n```\r\ngyp WARN EACCES user \"root\" does not have permission to access the dev dir \"/var/www/project/node_modules/sharp/.node-gyp/8.11.3\"\r\ngyp WARN EACCES attempting to reinstall using temporary dev dir \"/var/wwwproject/node_modules/sharp/.node-gyp\"\r\n```\r\n\r\nNode version: 8.11.3\r\n\r\nOperating System: CentOS Linux 7 (Core)\r\nCPE OS Name: cpe:/o:centos:centos:7\r\nKernel: Linux 3.10.0-693.el7.x86_64\r\nArchitecture: x86-64",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1276/comments",
    "author": "FranciZ",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-06-26T15:14:22Z",
        "body": "Hello, something must have changed between \"Worked before just fine\" and \"suddenly\". Was something upgraded? Perhaps a new native dependency such as `node-canvas` was added?\r\n\r\n`EACCES` errors are usually a sign that sudo/root is being used at `npm install` time, something I recommend avoiding. If you have to do this, use the `npm --unsafe-perm` flag."
      },
      {
        "user": "FranciZ",
        "created_at": "2018-06-26T16:25:14Z",
        "body": "Thank you for the quick reply!\r\n\r\n>Hello, something must have changed between \"Worked before just fine\" and \"suddenly\". Was something upgraded? Perhaps a new native dependency such as node-canvas was added?\r\n\r\nNot really. A very minor change was deployed looking at the diff and the API would not restart complaining about this issue. We have a simple deploy script that installs the API but the CentOS image is the same."
      },
      {
        "user": "lovell",
        "created_at": "2018-06-26T17:59:27Z",
        "body": "Please can you provide the output of running `ldd node_modules/sharp/build/Release/sharp.node` on this machine."
      },
      {
        "user": "shernshiou",
        "created_at": "2018-06-28T08:11:34Z",
        "body": "I got this problem as well\r\n\r\n```\r\nError: /lib/x86_64-linux-gnu/libz.so.1: version `ZLIB_1.2.9' not found (required by ../vendor/lib/libpng16.so.16)\r\n```\r\n\r\nNode version: 8.11.3\r\nOperating System: Ubuntu 16.04"
      },
      {
        "user": "lovell",
        "created_at": "2018-06-28T08:32:30Z",
        "body": "If `node-canvas` is another (transient) dependency, please see #843\r\n\r\nIf Electron is involved, please see #892"
      },
      {
        "user": "shernshiou",
        "created_at": "2018-06-28T08:45:58Z",
        "body": "@lovell thanks, got it working with the latest libz"
      },
      {
        "user": "lovell",
        "created_at": "2018-07-22T20:00:25Z",
        "body": "@FranciZ Were you able to make any progress with this?"
      },
      {
        "user": "kahurangitama",
        "created_at": "2018-12-11T17:47:46Z",
        "body": "Same problem.\r\nnode -v\r\nv10.13.0\r\nnode -e \"console.log(process.versions.zlib)\"\r\n1.2.11\r\n\r\n```\r\nldd node_modules/sharp/build/Release/sharp.node\r\n\tlinux-vdso.so.1 =>  (0x00007ffd7c3df000)\r\n\tlibvips-cpp.so.42 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libvips-cpp.so.42 (0x00007fb368097000)\r\n\tlibvips.so.42 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libvips.so.42 (0x00007fb367a5f000)\r\n\tlibglib-2.0.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libglib-2.0.so.0 (0x00007fb3676ea000)\r\n\tlibgobject-2.0.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libgobject-2.0.so.0 (0x00007fb367497000)\r\n\tlibstdc++.so.6 => /lib64/libstdc++.so.6 (0x00007fb367188000)\r\n\tlibm.so.6 => /lib64/libm.so.6 (0x00007fb366e86000)\r\n\tlibgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007fb366c70000)\r\n\tlibc.so.6 => /lib64/libc.so.6 (0x00007fb3668a2000)\r\n\tlibpng16.so.16 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libpng16.so.16 (0x00007fb366669000)\r\n\tlibz.so.1 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libz.so.1 (0x00007fb36644f000)\r\n\tlibtiff.so.5 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libtiff.so.5 (0x00007fb3661d9000)\r\n\tlibjpeg.so.8 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libjpeg.so.8 (0x00007fb365f5d000)\r\n\tlibgmodule-2.0.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libgmodule-2.0.so.0 (0x00007fb365d59000)\r\n\tlibrt.so.1 => /lib64/librt.so.1 (0x00007fb365b51000)\r\n\tlibexpat.so.1 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libexpat.so.1 (0x00007fb365925000)\r\n\tlibgsf-1.so.114 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libgsf-1.so.114 (0x00007fb3656da000)\r\n\tlibxml2.so.2 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libxml2.so.2 (0x00007fb3653f0000)\r\n\tliborc-0.4.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/liborc-0.4.so.0 (0x00007fb365159000)\r\n\tliblcms2.so.2 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/liblcms2.so.2 (0x00007fb364ef0000)\r\n\tlibgif.so.7 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libgif.so.7 (0x00007fb364ce7000)\r\n\tlibrsvg-2.so.2 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/librsvg-2.so.2 (0x00007fb3647e2000)\r\n\tlibgio-2.0.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libgio-2.0.so.0 (0x00007fb364429000)\r\n\tlibgdk_pixbuf-2.0.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libgdk_pixbuf-2.0.so.0 (0x00007fb3641fd000)\r\n\tlibcairo.so.2 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libcairo.so.2 (0x00007fb363ef7000)\r\n\tlibwebpmux.so.3 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libwebpmux.so.3 (0x00007fb363cec000)\r\n\tlibwebp.so.7 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libwebp.so.7 (0x00007fb363a53000)\r\n\tlibexif.so.12 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libexif.so.12 (0x00007fb36380c000)\r\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00007fb3635f0000)\r\n\tlibffi.so.6 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libffi.so.6 (0x00007fb3633e7000)\r\n\t/lib64/ld-linux-x86-64.so.2 (0x0000557a3197f000)\r\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x00007fb3631e3000)\r\n\tlibresolv.so.2 => /lib64/libresolv.so.2 (0x00007fb362fc9000)\r\n\tlibpangocairo-1.0.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libpangocairo-1.0.so.0 (0x00007fb362dbb000)\r\n\tlibpixman-1.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libpixman-1.so.0 (0x00007fb362afd000)\r\n\tlibpangoft2-1.0.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libpangoft2-1.0.so.0 (0x00007fb3628e6000)\r\n\tlibharfbuzz.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libharfbuzz.so.0 (0x00007fb362623000)\r\n\tlibpango-1.0.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libpango-1.0.so.0 (0x00007fb3623d9000)\r\n\tlibgthread-2.0.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libgthread-2.0.so.0 (0x00007fb3621d7000)\r\n\tlibfribidi.so.0 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libfribidi.so.0 (0x00007fb361fbb000)\r\n\tlibfontconfig.so.1 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libfontconfig.so.1 (0x00007fb361d6d000)\r\n\tlibfreetype.so.6 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libfreetype.so.6 (0x00007fb361ab3000)\r\n\tlibcroco-0.6.so.3 => /home/user/project/server/node_modules/sharp/build/Release/../../vendor/lib/libcroco-0.6.so.3 (0x00007fb361877000)\r\n```"
      }
    ]
  },
  {
    "number": 1266,
    "title": "Can i use this library to determine an image's sharpness?",
    "created_at": "2018-06-21T04:15:00Z",
    "closed_at": "2018-06-22T09:27:45Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1266",
    "body": "",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1266/comments",
    "author": "praveensastry",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-06-21T09:23:27Z",
        "body": "Please can you provide more details/links/example?"
      },
      {
        "user": "praveensastry",
        "created_at": "2018-06-22T08:01:23Z",
        "body": "I want to use this library to determine the image quality (if the image is blurry or not) of an image "
      },
      {
        "user": "lovell",
        "created_at": "2018-06-22T09:27:45Z",
        "body": "This sounds like a general image processing question more suited to Stack Overflow. Good luck!"
      }
    ]
  },
  {
    "number": 1260,
    "title": "What loader should I introduce to make it function properly, there is no error before the introduction",
    "created_at": "2018-06-14T07:19:15Z",
    "closed_at": "2018-06-28T23:37:34Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1260",
    "body": "ERROR in ./~/sharp/package.json\r\nModule parse failed: node_modules/sharp/package.json Unexpected token (2:8)\r\nYou may need an appropriate loader to handle this file type.\r\nSyntaxError: Unexpected token (2:8)\r\n    at Parser.pp$4.raise (node_modules/acorn/dist/acorn.js:2221:15)\r\n\r\nERROR in  /sharp/build/Release/sharp.node\r\nModule parse failed:/sharp/build/Release/sharp.node Unexpected character '�' (1:0)\r\nYou may need an appropriate loader to handle this file type.\r\nSyntaxError: Unexpected character '�' (1:0)\r\n @ ./~/sharp/lib/constructor.js 10:14-52\r\n\r\n\r\n\r\nWhat loader should I introduce to make it function properly, there is no error before the introduction\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1260/comments",
    "author": "lololsiyuan",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-06-14T11:06:39Z",
        "body": "Hello, is this using Webpack? If so, please see #932 and #794."
      },
      {
        "user": "lovell",
        "created_at": "2018-06-28T23:37:34Z",
        "body": "Hopefully this answered your question but please feel free to re-open if not. "
      }
    ]
  },
  {
    "number": 1254,
    "title": "build failed on nodejs 10.0",
    "created_at": "2018-06-07T05:41:25Z",
    "closed_at": "2018-06-07T09:40:03Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1254",
    "body": "build failed on nodejs 10.0\r\n\r\n`gyp info it worked if it ends with ok\r\ngyp info using node-gyp@3.6.2\r\ngyp info using node@10.4.0 | linux | x64\r\ngyp info spawn /usr/bin/python2\r\ngyp info spawn args [ '/usr/lib/node_modules/npm/node_modules/node-gyp/gyp/gyp_main.py',\r\ngyp info spawn args   'binding.gyp',\r\ngyp info spawn args   '-f',\r\ngyp info spawn args   'make',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   '/root/code/api/node_modules/fibers/build/config.gypi',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   '/usr/lib/node_modules/npm/node_modules/node-gyp/addon.gypi',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   '/root/.node-gyp/10.4.0/include/node/common.gypi',\r\ngyp info spawn args   '-Dlibrary=shared_library',\r\ngyp info spawn args   '-Dvisibility=default',\r\ngyp info spawn args   '-Dnode_root_dir=/root/.node-gyp/10.4.0',\r\ngyp info spawn args   '-Dnode_gyp_dir=/usr/lib/node_modules/npm/node_modules/node-gyp',\r\ngyp info spawn args   '-Dnode_lib_file=/root/.node-gyp/10.4.0/<(target_arch)/node.lib',\r\ngyp info spawn args   '-Dmodule_root_dir=/root/code/api/node_modules/fibers',\r\ngyp info spawn args   '-Dnode_engine=v8',\r\ngyp info spawn args   '--depth=.',\r\ngyp info spawn args   '--no-parallel',\r\ngyp info spawn args   '--generator-output',\r\ngyp info spawn args   'build',\r\ngyp info spawn args   '-Goutput_dir=.' ]\r\ngyp info spawn make\r\ngyp info spawn args [ 'BUILDTYPE=Release', '-C', 'build' ]\r\nmake: Entering directory '/root/code/api/node_modules/fibers/build'\r\n  CXX(target) Release/obj.target/fibers/src/fibers.o\r\n../src/fibers.cc: In function ‘v8::Handle<v8::String> uni::NewLatin1String(v8::Isolate*, const char*)’:\r\n../src/fibers.cc:122:64: error: no matching function for call to ‘v8::String::NewFromOneByte(v8::Isolate*&, const uint8_t*)’\r\n   return String::NewFromOneByte(isolate, (const uint8_t*)string);\r\n                                                                ^\r\nIn file included from /root/.node-gyp/10.4.0/include/node/node.h:63:0,\r\n                 from ../src/coroutine.h:1,\r\n                 from ../src/fibers.cc:1:\r\n/root/.node-gyp/10.4.0/include/node/v8.h:2760:51: note: candidate: static v8::MaybeLocal<v8::String> v8::String::NewFromOneByte(v8::Isolate*, const uint8_t*, v8::NewStringType, int)\r\n   static V8_WARN_UNUSED_RESULT MaybeLocal<String> NewFromOneByte(\r\n                                                   ^~~~~~~~~~~~~~\r\n/root/.node-gyp/10.4.0/include/node/v8.h:2760:51: note:   candidate expects 4 arguments, 2 provided\r\n../src/fibers.cc: In function ‘v8::Handle<v8::String> uni::NewLatin1Symbol(v8::Isolate*, const char*)’:\r\n../src/fibers.cc:126:64: error: no matching function for call to ‘v8::String::NewFromOneByte(v8::Isolate*&, const uint8_t*)’\r\n   return String::NewFromOneByte(isolate, (const uint8_t*)string);\r\n                                                                ^\r\nIn file included from /root/.node-gyp/10.4.0/include/node/node.h:63:0,\r\n                 from ../src/coroutine.h:1,\r\n                 from ../src/fibers.cc:1:\r\n/root/.node-gyp/10.4.0/include/node/v8.h:2760:51: note: candidate: static v8::MaybeLocal<v8::String> v8::String::NewFromOneByte(v8::Isolate*, const uint8_t*, v8::NewStringType, int)\r\n   static V8_WARN_UNUSED_RESULT MaybeLocal<String> NewFromOneByte(\r\n                                                   ^~~~~~~~~~~~~~\r\n/root/.node-gyp/10.4.0/include/node/v8.h:2760:51: note:   candidate expects 4 arguments, 2 provided\r\n../src/fibers.cc: In static member function ‘static void Fiber::DestroyOrphans()’:\r\n../src/fibers.cc:406:67: warning: ‘v8::String::Utf8Value::Utf8Value(v8::Local<v8::Value>)’ is deprecated: Use Isolate version [-Wdeprecated-declarations]\r\n      String::Utf8Value stack(uni::Deref(that.isolate, fatal_stack));\r\n                                                                   ^\r\nIn file included from /root/.node-gyp/10.4.0/include/node/v8.h:26:0,\r\n                 from /root/.node-gyp/10.4.0/include/node/node.h:63,\r\n                 from ../src/coroutine.h:1,\r\n                 from ../src/fibers.cc:1:\r\n/root/.node-gyp/10.4.0/include/node/v8.h:2846:28: note: declared here\r\n                   explicit Utf8Value(Local<v8::Value> obj));\r\n                            ^\r\n/root/.node-gyp/10.4.0/include/node/v8config.h:324:3: note: in definition of macro ‘V8_DEPRECATED’\r\n   declarator __attribute__((deprecated(message)))\r\n   ^~~~~~~~~~\r\n../src/fibers.cc: In static member function ‘static uni::FunctionType Fiber::New(const Arguments&)’:\r\n../src/fibers.cc:433:99: error: no matching function for call to ‘v8::Function::NewInstance(int, v8::Handle<v8::Value> [1])’\r\n     return uni::Return(uni::Deref(Isolate::GetCurrent(), tmpl)->GetFunction()->NewInstance(1, argv), args);\r\n                                                                                                   ^\r\nIn file included from /root/.node-gyp/10.4.0/include/node/node.h:63:0,\r\n                 from ../src/coroutine.h:1,\r\n                 from ../src/fibers.cc:1:\r\n/root/.node-gyp/10.4.0/include/node/v8.h:3905:44: note: candidate: v8::MaybeLocal<v8::Object> v8::Function::NewInstance(v8::Local<v8::Context>, int, v8::Local<v8::Value>*) const\r\n   V8_WARN_UNUSED_RESULT MaybeLocal<Object> NewInstance(\r\n                                            ^~~~~~~~~~~\r\n/root/.node-gyp/10.4.0/include/node/v8.h:3905:44: note:   candidate expects 3 arguments, 2 provided\r\n/root/.node-gyp/10.4.0/include/node/v8.h:3908:44: note: candidate: v8::MaybeLocal<v8::Object> v8::Function::NewInstance(v8::Local<v8::Context>) const\r\n   V8_WARN_UNUSED_RESULT MaybeLocal<Object> NewInstance(\r\n                                            ^~~~~~~~~~~\r\n/root/.node-gyp/10.4.0/include/node/v8.h:3908:44: note:   candidate expects 1 argument, 2 provided\r\n../src/fibers.cc:433:106: error: return-statement with a value, in function returning 'void' [-fpermissive]\r\n     return uni::Return(uni::Deref(Isolate::GetCurrent(), tmpl)->GetFunction()->NewInstance(1, argv), args);\r\n                                                                                                          ^\r\n../src/fibers.cc: In static member function ‘static void Fiber::RunFiber(void**)’:\r\n../src/fibers.cc:621:14: error: no matching function for call to ‘v8::TryCatch::TryCatch()’\r\n     TryCatch try_catch;\r\n              ^~~~~~~~~\r\nIn file included from /root/.node-gyp/10.4.0/include/node/node.h:63:0,\r\n                 from ../src/coroutine.h:1,\r\n                 from ../src/fibers.cc:1:\r\n/root/.node-gyp/10.4.0/include/node/v8.h:8388:12: note: candidate: v8::TryCatch::TryCatch(v8::Isolate*)\r\n   explicit TryCatch(Isolate* isolate);\r\n            ^~~~~~~~\r\n/root/.node-gyp/10.4.0/include/node/v8.h:8388:12: note:   candidate expects 1 argument, 0 provided\r\n../src/fibers.cc:628:66: warning: ‘static v8::Local<v8::Script> v8::Script::Compile(v8::Local<v8::String>, v8::ScriptOrigin*)’ is deprecated: Use maybe version [-Wdeprecated-declarations]\r\n     Script::Compile(uni::NewLatin1String(that.isolate, \"void 0;\"));\r\n                                                                  ^\r\nIn file included from /root/.node-gyp/10.4.0/include/node/v8.h:26:0,\r\n                 from /root/.node-gyp/10.4.0/include/node/node.h:63,\r\n                 from ../src/coroutine.h:1,\r\n                 from ../src/fibers.cc:1:\r\n/root/.node-gyp/10.4.0/include/node/v8.h:1237:38: note: declared here\r\n                        Local<Script> Compile(Local<String> source,\r\n                                      ^\r\n/root/.node-gyp/10.4.0/include/node/v8config.h:324:3: note: in definition of macro ‘V8_DEPRECATED’\r\n   declarator __attribute__((deprecated(message)))\r\n   ^~~~~~~~~~\r\n../src/fibers.cc:643:66: warning: ‘v8::Local<v8::Value> v8::TryCatch::StackTrace() const’ is deprecated: Use maybe version. [-Wdeprecated-declarations]\r\n       uni::Reset(that.isolate, fatal_stack, try_catch.StackTrace());\r\n                                                                  ^\r\nIn file included from /root/.node-gyp/10.4.0/include/node/v8.h:26:0,\r\n                 from /root/.node-gyp/10.4.0/include/node/node.h:63,\r\n                 from ../src/coroutine.h:1,\r\n                 from ../src/fibers.cc:1:\r\n/root/.node-gyp/10.4.0/include/node/v8.h:8445:52: note: declared here\r\n   V8_DEPRECATED(\"Use maybe version.\", Local<Value> StackTrace() const);\r\n                                                    ^\r\n/root/.node-gyp/10.4.0/include/node/v8config.h:324:3: note: in definition of macro ‘V8_DEPRECATED’\r\n   declarator __attribute__((deprecated(message)))\r\n   ^~~~~~~~~~\r\n../src/fibers.cc: In static member function ‘static void Fiber::SetPoolSize(v8::Local<v8::String>, v8::Local<v8::Value>, const SetterCallbackInfo&)’:\r\n../src/fibers.cc:741:43: error: no matching function for call to ‘v8::Value::ToNumber()’\r\n    Coroutine::pool_size = value->ToNumber()->Value();\r\n                                           ^\r\nIn file included from /root/.node-gyp/10.4.0/include/node/node.h:63:0,\r\n                 from ../src/coroutine.h:1,\r\n                 from ../src/fibers.cc:1:\r\n/root/.node-gyp/10.4.0/include/node/v8.h:2390:44: note: candidate: v8::MaybeLocal<v8::Number> v8::Value::ToNumber(v8::Local<v8::Context>) const\r\n   V8_WARN_UNUSED_RESULT MaybeLocal<Number> ToNumber(\r\n                                            ^~~~~~~~\r\n/root/.node-gyp/10.4.0/include/node/v8.h:2390:44: note:   candidate expects 1 argument, 0 provided\r\nIn file included from /root/.node-gyp/10.4.0/include/node/v8.h:26:0,\r\n                 from /root/.node-gyp/10.4.0/include/node/node.h:63,\r\n                 from ../src/coroutine.h:1,\r\n                 from ../src/fibers.cc:1:\r\n/root/.node-gyp/10.4.0/include/node/v8.h:2407:35: note: candidate: v8::Local<v8::Number> v8::Value::ToNumber(v8::Isolate*) const\r\n                     Local<Number> ToNumber(Isolate* isolate) const);\r\n                                   ^\r\n/root/.node-gyp/10.4.0/include/node/v8config.h:346:48: note: in definition of macro ‘V8_DEPRECATE_SOON’\r\n #define V8_DEPRECATE_SOON(message, declarator) declarator\r\n                                                ^~~~~~~~~~\r\n/root/.node-gyp/10.4.0/include/node/v8.h:2407:35: note:   candidate expects 1 argument, 0 provided\r\n                     Local<Number> ToNumber(Isolate* isolate) const);\r\n                                   ^\r\n/root/.node-gyp/10.4.0/include/node/v8config.h:346:48: note: in definition of macro ‘V8_DEPRECATE_SOON’\r\n #define V8_DEPRECATE_SOON(message, declarator) declarator\r\n                                                ^~~~~~~~~~\r\n../src/fibers.cc: In static member function ‘static void Fiber::Init(v8::Handle<v8::Object>)’:\r\n../src/fibers.cc:793:72: error: no matching function for call to ‘v8::Function::SetAccessor(v8::Handle<v8::String>, uni::FunctionType (&)(v8::Local<v8::String>, const GetterCallbackInfo&))’\r\n    fn->SetAccessor(uni::NewLatin1Symbol(isolate, \"current\"), GetCurrent);\r\n                                                                        ^\r\nIn file included from /root/.node-gyp/10.4.0/include/node/node.h:63:0,\r\n                 from ../src/coroutine.h:1,\r\n                 from ../src/fibers.cc:1:\r\n/root/.node-gyp/10.4.0/include/node/v8.h:3260:37: note: candidate: v8::Maybe<bool> v8::Object::SetAccessor(v8::Local<v8::Context>, v8::Local<v8::Name>, v8::AccessorNameGetterCallback, v8::AccessorNameSetterCallback, v8::MaybeLocal<v8::Value>, v8::AccessControl, v8::PropertyAttribute, v8::SideEffectType)\r\n   V8_WARN_UNUSED_RESULT Maybe<bool> SetAccessor(\r\n                                     ^~~~~~~~~~~\r\n/root/.node-gyp/10.4.0/include/node/v8.h:3260:37: note:   candidate expects 8 arguments, 2 provided\r\n../src/fibers.cc:794:87: error: no matching function for call to ‘v8::Function::SetAccessor(v8::Handle<v8::String>, uni::FunctionType (&)(v8::Local<v8::String>, const GetterCallbackInfo&), void (&)(v8::Local<v8::String>, v8::Local<v8::Value>, const SetterCallbackInfo&))’\r\n    fn->SetAccessor(uni::NewLatin1Symbol(isolate, \"poolSize\"), GetPoolSize, SetPoolSize);\r\n                                                                                       ^\r\nIn file included from /root/.node-gyp/10.4.0/include/node/node.h:63:0,\r\n                 from ../src/coroutine.h:1,\r\n                 from ../src/fibers.cc:1:\r\n/root/.node-gyp/10.4.0/include/node/v8.h:3260:37: note: candidate: v8::Maybe<bool> v8::Object::SetAccessor(v8::Local<v8::Context>, v8::Local<v8::Name>, v8::AccessorNameGetterCallback, v8::AccessorNameSetterCallback, v8::MaybeLocal<v8::Value>, v8::AccessControl, v8::PropertyAttribute, v8::SideEffectType)\r\n   V8_WARN_UNUSED_RESULT Maybe<bool> SetAccessor(\r\n                                     ^~~~~~~~~~~\r\n/root/.node-gyp/10.4.0/include/node/v8.h:3260:37: note:   no known conversion for argument 2 from ‘uni::FunctionType(v8::Local<v8::String>, const GetterCallbackInfo&) {aka void(v8::Local<v8::String>, const v8::PropertyCallbackInfo<v8::Value>&)}’ to ‘v8::Local<v8::Name>’\r\n../src/fibers.cc:795:84: error: no matching function for call to ‘v8::Function::SetAccessor(v8::Handle<v8::String>, uni::FunctionType (&)(v8::Local<v8::String>, const GetterCallbackInfo&))’\r\n    fn->SetAccessor(uni::NewLatin1Symbol(isolate, \"fibersCreated\"), GetFibersCreated);\r\n                                                                                    ^\r\nIn file included from /root/.node-gyp/10.4.0/include/node/node.h:63:0,\r\n                 from ../src/coroutine.h:1,\r\n                 from ../src/fibers.cc:1:\r\n/root/.node-gyp/10.4.0/include/node/v8.h:3260:37: note: candidate: v8::Maybe<bool> v8::Object::SetAccessor(v8::Local<v8::Context>, v8::Local<v8::Name>, v8::AccessorNameGetterCallback, v8::AccessorNameSetterCallback, v8::MaybeLocal<v8::Value>, v8::AccessControl, v8::PropertyAttribute, v8::SideEffectType)\r\n   V8_WARN_UNUSED_RESULT Maybe<bool> SetAccessor(\r\n                                     ^~~~~~~~~~~\r\n/root/.node-gyp/10.4.0/include/node/v8.h:3260:37: note:   candidate expects 8 arguments, 2 provided\r\nfibers.target.mk:102: recipe for target 'Release/obj.target/fibers/src/fibers.o' failed\r\nmake: Leaving directory '/root/code/api/node_modules/fibers/build'\r\nmake: *** [Release/obj.target/fibers/src/fibers.o] Error 1\r\ngyp ERR! build error\r\ngyp ERR! stack Error: `make` failed with exit code: 2\r\ngyp ERR! stack     at ChildProcess.onExit (/usr/lib/node_modules/npm/node_modules/node-gyp/lib/build.js:258:23)\r\ngyp ERR! stack     at ChildProcess.emit (events.js:182:13)\r\ngyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:237:12)\r\ngyp ERR! System Linux 4.15.0-22-generic\r\ngyp ERR! command \"/usr/bin/node\" \"/usr/lib/node_modules/npm/node_modules/node-gyp/bin/node-gyp.js\" \"rebuild\" \"--release\"\r\ngyp ERR! cwd /root/code/api/node_modules/fibers\r\ngyp ERR! node -v v10.4.0\r\ngyp ERR! node-gyp -v v3.6.2\r\ngyp ERR! not ok\r\nnode-gyp exited with code: 1\r\nPlease make sure you are using a supported platform and node version. If you\r\nwould like to compile fibers on this machine please make sure you have setup your\r\nbuild environment--\r\n`",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1254/comments",
    "author": "leafiy",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-06-07T07:17:09Z",
        "body": "Hello, are you using the latest version, v0.20.3?"
      },
      {
        "user": "leafiy",
        "created_at": "2018-06-07T08:43:49Z",
        "body": "yes its 0.20.3"
      },
      {
        "user": "lovell",
        "created_at": "2018-06-07T09:40:03Z",
        "body": "These errors are from the `fibers` module, not `sharp`."
      }
    ]
  },
  {
    "number": 1239,
    "title": "Modify exif/metadata of image",
    "created_at": "2018-05-28T14:39:28Z",
    "closed_at": "2018-05-28T21:54:26Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1239",
    "body": "Is it possible to edit the metadata of an image? For example, update the timedate, or add an author or other custom data to the image?\r\n\r\nFrom the documentation I see you can do this:\r\n`withMetadata.orientation Number? value between 1 and 8, used to update the EXIF Orientation tag`\r\n\r\nBut is it possible to edit other information such as the things I mentioned?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1239/comments",
    "author": "Dror-Bar",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-05-28T21:54:26Z",
        "body": "Hello, please subscribe to #650"
      }
    ]
  },
  {
    "number": 1238,
    "title": "Feature Request: Composite Blend Modes",
    "created_at": "2018-05-24T06:49:40Z",
    "closed_at": "2018-05-24T10:31:44Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1238",
    "body": "I had a look and this appears to be available in libvips (issue #657) but not yet in sharp. It is one of the features I feel sharp is lacking that would make it very useful personally. \r\n\r\n     VImage VImage::composite( VImage other, VipsBlendMode mode, VOption *options );\r\n\r\nWithout having too much knowledge on the library I'd imagine a pseudo method as below could work?\r\n\r\n\tVImage Blend(VImage image, VImage overlayImage, VipsBlendMode mode) \r\n\t{\r\n\t\t// check for same width + height\r\n\t\t// check for alpha\r\n\t\treturn image.composite(overlayImage, mode, VImage::option());\r\n\t}",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1238/comments",
    "author": "wezside",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-05-24T09:19:55Z",
        "body": "Hello, did you see #728?"
      },
      {
        "user": "wezside",
        "created_at": "2018-05-24T09:36:29Z",
        "body": "I did but totally forgot about it. Will follow along the other discussion. I do think a single/simple method could be beneficial, even if the multiple overlay references this single/simple method. Feel free to close this."
      },
      {
        "user": "lovell",
        "created_at": "2018-05-24T10:31:44Z",
        "body": "Let's track this at #728, thanks."
      }
    ]
  },
  {
    "number": 1234,
    "title": "Yarn add sharp fails with exit code 127",
    "created_at": "2018-05-21T07:08:20Z",
    "closed_at": "2018-05-21T11:46:35Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1234",
    "body": "node -v\r\nv8.0.0\r\n\r\nnpm-v\r\n5.4.2\r\n\r\nyarn -v\r\n1.3.2\r\n\r\nWhen I try to install package `yarn add sharp` I get the following error.\r\n`yarn install v1.3.2\r\n\r\n[1/4] 🔍  Resolving packages...\r\n\r\n[2/4] 🚚  Fetching packages...\r\n\r\n[3/4] 🔗  Linking dependencies...\r\n\r\n[4/4] 📃  Building fresh packages...\r\n\r\n[1/1] ⠄ sharp: install No prebuilt binaries found (target=9.5.0 runtime=node arch=x64 platform=darwin)\r\n\r\n[-/1] ⠄ waiting...\r\n\r\n[-/1] ⠄ waiting...\r\n\r\n[-/1] ⠄ waiting...\r\n\r\nerror /Users/cocacrave/Workspace/projects/functions/image_optimizer/node_modules/sharp: Command failed.\r\n\r\nExit code: 127\r\n\r\nCommand: (node install/libvips && node install/dll-copy && prebuild-install) || (node-gyp rebuild && node install/dll-copy)\r\n\r\nArguments:\r\nDirectory: /Users/cocacrave/Workspace/projects/functions/image_optimizer/node_modules/sharp\r\n\r\nOutput:`",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1234/comments",
    "author": "cocacrave",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-05-21T11:38:39Z",
        "body": "Hello, given `node -v` reports v8.0.0 but part of the message suggests v9.5.0 is being used, could there be two conflicting versions of Node on this machine?\r\n\r\n```\r\nsharp: install No prebuilt binaries found (target=9.5.0 runtime=node arch=x64 platform=darwin)\r\n```\r\n"
      },
      {
        "user": "cocacrave",
        "created_at": "2018-05-21T11:46:35Z",
        "body": "I tried yarn add again without doing anything else and now it works. So confused... Anyways thanks!"
      }
    ]
  },
  {
    "number": 1232,
    "title": "Random error messages in my log",
    "created_at": "2018-05-18T09:22:34Z",
    "closed_at": "2018-06-19T11:38:51Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1232",
    "body": "Hi,\r\n\r\nI get the following error messages in my log for my nodejs app:\r\n\r\n```\r\n(sharp:20979): GLib-GObject-WARNING **: 08:22:29.153: invalid uninstantiatable type '(null)' in cast to 'GObject'\r\n\r\n(sharp:20979): GLib-GObject-CRITICAL **: 08:22:29.153: g_object_set_qdata: assertion 'G_IS_OBJECT (object)' failed\r\n```\r\n\r\nUnfortunately I have only the above log to go by.  Any ideas? ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1232/comments",
    "author": "1Map",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-05-18T10:31:18Z",
        "body": "Hello, you've provided very little to go on here.\r\n\r\nWhat version  of Node and sharp is this, and on what platform?\r\n\r\nAre you able to provide sample code and image(s) that reproduce this warning?\r\n\r\nAre there any other dependencies that require glib e.g. node-canvas?"
      },
      {
        "user": "1Map",
        "created_at": "2018-05-18T19:10:21Z",
        "body": "Ubuntu 16.04 Server 64bit\r\nNode Version 8.11.2\r\nSharp 0.20.2\r\n\r\nUnfortunately I have different pieces of code that uses Sharp for various things, like converting tiff to jpeg, converting PDF to jpeg, creating deep zoom tiling from jpeg images, etc.  I cannot trace the exact line of code where this happens as it happens randomly."
      },
      {
        "user": "lovell",
        "created_at": "2018-05-19T07:01:12Z",
        "body": "All I can suggest here is to add more detailed logging to help narrow down the task and therefore code that's running when the message occurs."
      },
      {
        "user": "kevinswarner",
        "created_at": "2018-05-21T16:54:41Z",
        "body": "I also have been getting these messages.\r\n\r\n```\r\n(sharp:9): GLib-GObject-[1;33mWARNING[0m **: [34m16:34:33.204[0m: invalid uninstantiatable type '(null)' in cast to 'GObject'\r\n(sharp:9): GLib-GObject-[1;35mCRITICAL[0m **: [34m16:34:33.205[0m: g_object_set_qdata: assertion 'G_IS_OBJECT (object)' failed \r\n```\r\n\r\nBut, the messages are ONLY output when I use sharp.cache(...).\r\n\r\nAlso, my final image results appear to be just fine, even when these messages occur.\r\n\r\nWhen...\r\n\r\nsharp.cache(false)  -->  messages printed\r\nsharp.cache({ memory: 5, files: 2, items: 10 })  -->  messages printed\r\nsharp.cache(true) -->  NO messages printed\r\n\r\nOf course, if I do not use sharp.cache at all, the messages to not appear.\r\n\r\nBut, again, it seems so far, my resulting images are fine. And, to confirm, the reason I was using sharp.cache(false) was to see if I could reduce the memory consumption. Glad to report that it does indeed do that!\r\n\r\nSo, I am not sure what to make of these messages. For now, I am going to focus on the results, which appear to be fine.\r\n\r\nHope this helps in the discussion. Thanks for a great library!"
      },
      {
        "user": "1Map",
        "created_at": "2018-05-21T18:52:44Z",
        "body": "Tried it with:\r\nsharp.cache(true)\r\nsharp.cache(false)\r\n\r\nSame result on my side.  Just randomly.  Not always.\r\n\r\nAll seems ok with the end result, except for this random messages:\r\n\r\n```\r\n(sharp:88815): GLib-GObject-WARNING **: 20:47:36.463: invalid uninstantiatable type '(null)' in cast to 'GObject'\r\n\r\n(sharp:88815): GLib-GObject-CRITICAL **: 20:47:36.463: g_object_set_qdata: assertion 'G_IS_OBJECT (object)' failed\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2018-06-19T11:38:51Z",
        "body": "Please feel free to re-open with a code sample that consistently produces these messages."
      }
    ]
  },
  {
    "number": 1221,
    "title": "Cant overlay two images",
    "created_at": "2018-05-05T18:07:19Z",
    "closed_at": "2018-05-26T09:22:02Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1221",
    "body": "I am trying to overlay a png over jpeg . But cant get it done. What to do ?\r\n\r\n`\r\nvar background = sharp(\"./letter.jpg\");\r\nvar front = sharp(\"./page_1.png\");\r\n\r\nfront.background({r: 255, g: 255, b: 255, alpha: 255}).flatten().toFile(\"f.png\").then(value => {\r\n    background.overlayWith(\"f.png\", {cutout: true}).toFile(\"final.png\").then(value1 => {\r\n        console.log(value1);\r\n    });\r\n});\r\n\r\n`\r\n\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1221/comments",
    "author": "parthibd",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-05-07T08:30:34Z",
        "body": "Hello, the use of the `flatten()` operation on `page_1.png` will remove its alpha channel. Is this what you intended?"
      },
      {
        "user": "lovell",
        "created_at": "2018-05-26T09:22:02Z",
        "body": "@parthibd Hope this answered your question, please re-open with more details if more help is required."
      }
    ]
  },
  {
    "number": 1210,
    "title": "Error: The specified procedure could not be found.",
    "created_at": "2018-04-27T09:48:02Z",
    "closed_at": "2018-04-28T09:01:22Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1210",
    "body": "I have two Electron projects using sharp. I have a small testing project for testing sharp but it gave me an initialization DLL error at first. The commands I used were these and it got fixed.\r\n\r\n```\r\nnpm install --save-dev electron-rebuild\r\nnpm install sharp\r\n.\\node_modules\\.bin\\electron-rebuild.cmd\r\n```\r\nI can use sharp now and tested it with some code which generated cropped output from the original image.\r\n\r\n```\r\nsharp('input.jpg')\r\n  .resize(300, 200)\r\n  .toFile('output.jpg', function(err) {\r\n  });\r\n```\r\n\r\nThe bigger project (electron-builder/yarn) where I want to implement sharp gives me this error. \r\n```\r\nError: The specified procedure could not be found.\r\n  \\\\?\\C:\\Users\\Noblesse\\Documents\\GitHub\\desktop-gen-electron - kopie\\node_modules\\sharp\\build\\Release\\sharp.node\r\n      at process.module.(anonymous function) [as dlopen] (ELECTRON_ASAR.js:172:20)\r\n      at Object.Module._extensions..node (module.js:598:18)\r\n      at Object.module.(anonymous function) [as .node] (ELECTRON_ASAR.js:172:20)\r\n      at Module.load (module.js:503:32)\r\n      at tryModuleLoad (module.js:466:12)\r\n      at Function.Module._load (module.js:458:3)\r\n      at Module.require (module.js:513:17)\r\n      at require (internal/module.js:11:18)\r\n      at Object.<anonymous> (C:\\Users\\Noblesse\\Documents\\GitHub\\desktop-gen-electron - kopie\\node_modules\\sharp\\lib\\constructor.js:10:15)\r\n      at Object.<anonymous> (C:\\Users\\Noblesse\\Documents\\GitHub\\desktop-gen-electron - kopie\\node_modules\\sharp\\lib\\constructor.js:256:3)\r\n```\r\n\r\nI use the yarn way in this one but it doesn't work. There certainly is sharp.node in sharp/build/release/.\r\n```\r\nyarn add --dev electron-rebuild\r\nyarn add sharp\r\n.\\node_modules\\.bin\\electron-rebuild.cmd\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1210/comments",
    "author": "OualidYousfi",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-04-27T10:40:26Z",
        "body": "Does the \"bigger project\" include `node-canvas` as a dependency? If so, please see #1157"
      },
      {
        "user": "OualidYousfi",
        "created_at": "2018-04-28T00:26:24Z",
        "body": "It did, actually. As well as `text2png` which required `node-canvas`. Removed the two as they weren't essential to the project. Got no errors anymore. I implemented the .tiff() method to be sure (because JIMP doesn't seem to have an option for reducing the file size for TIFFs) and all my images are ~50 KB now instead of ~5 MB.\r\n\r\nThanks for the quick tip!"
      }
    ]
  },
  {
    "number": 1179,
    "title": "ForceSet deprecation warnings in v8 while building",
    "created_at": "2018-04-04T06:58:10Z",
    "closed_at": "2018-04-04T09:23:53Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1179",
    "body": "I'm getting many of these in various files with the latest version of node:\r\n```\r\n  CXX(target) Release/obj.target/sharp/src/utilities.o\r\nIn file included from ../../nan/nan.h:192:0,\r\n                 from ../src/utilities.cc:19:\r\n../../nan/nan_maybe_43_inl.h: In function 'Nan::Maybe<bool> Nan::ForceSet(v8::Local<v8::Object>, v8::Local<v8::Value>, v8::Local<v8::Value>, v8::PropertyAttribute)':\r\n../../nan/nan_maybe_43_inl.h:112:73: warning: 'v8::Maybe<bool> v8::Object::ForceSet(v8::Local<v8::Context>, v8::Local<v8::Value>, v8::Local<v8::Value>, v8::PropertyAttribute)' is deprecated: Use CreateDataProperty / DefineOwnProperty [-Wdeprecated-declarations]\r\n   return obj->ForceSet(isolate->GetCurrentContext(), key, value, attribs);\r\n                                                                         ^\r\nIn file included from /root/.node-gyp/9.10.1/include/node/v8.h:26:0,\r\n                 from /root/.node-gyp/9.10.1/include/node/node.h:63,\r\n                 from ../src/utilities.cc:18:\r\n/root/.node-gyp/9.10.1/include/node/v8.h:3165:29: note: declared here\r\n                 Maybe<bool> ForceSet(Local<Context> context, Local<Value> key,\r\n                             ^\r\n/root/.node-gyp/9.10.1/include/node/v8config.h:318:3: note: in definition of macro 'V8_DEPRECATED'\r\n   declarator __attribute__((deprecated(message)))\r\n   ^~~~~~~~~~\r\n```\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1179/comments",
    "author": "jwater7",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-04-04T07:56:49Z",
        "body": "Hello, does the most recent version of sharp, namely v0.20.1, exhibit this behaviour also?"
      },
      {
        "user": "jwater7",
        "created_at": "2018-04-04T09:23:53Z",
        "body": "v0.20.1 does in fact fix the issue, sorry - this was a misunderstanding on my part how the node packages were getting updated and I thought I was getting the latest version.  I'll resolve the issue, thanks for the tip."
      }
    ]
  },
  {
    "number": 1169,
    "title": "Get image histogram",
    "created_at": "2018-03-27T18:57:54Z",
    "closed_at": "2018-04-27T11:24:22Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1169",
    "body": "Can we get image histogram like using \"histogram:info:-\" on imagemagick/graphmagick?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1169/comments",
    "author": "rodrigoalviani",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-03-27T20:33:08Z",
        "body": "Hello, did you see the discussion at #640?"
      }
    ]
  },
  {
    "number": 1150,
    "title": "sharp - creating an image to overlayWith different buffers at specific offsets",
    "created_at": "2018-03-06T11:02:27Z",
    "closed_at": "2018-03-09T20:17:10Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1150",
    "body": "Why does a sharp object not have persistence, I make a point to overlay each row of pixels and save the final image in the end but toFile() only creates an image with the last position I tried to overLay. Am I using overlayWith incorrectly or is that just the way it has been created. I cant find any information about this.\r\n\r\n```\r\nimage.metadata().then((metadata) => {\r\n        return {\r\n            width: metadata.width,\r\n            height: metadata.height,\r\n            channels: metadata.channels\r\n        }\r\n    })\r\n    .then((metadata) => {\r\n\r\n        /*\r\n        ** Tiles are 20x20 modulo for less computation\r\n        */\r\n\r\n        var xMax = metadata.width - (metadata.width % 20)\r\n        var yMax = metadata.height - (metadata.height % 20)\r\n        let final = sharp({\r\n            create: {\r\n                width: xMax,\r\n                height: yMax,\r\n                channels: metadata.channels,\r\n                background: { r: 255, g: 255, b: 255 }\r\n            }\r\n        })\r\n        .jpeg()\r\n\r\n        /*\r\n        ** Loop through x-axis\r\n        */\r\n\r\n        for (let xOffset = 0; xOffset <= xMax; xOffset += 20)\r\n        {\r\n\r\n            /*\r\n            ** Loop through y-axis\r\n            */\r\n\r\n            for (let yOffset = 0; yOffset <= yMax; yOffset += 20)\r\n            {\r\n\r\n                /*\r\n                ** To prevent a read biigger then possible\r\n                */\r\n\r\n                if ((yOffset + 20) > metadata.height || (xOffset + 20) > metadata.width)\r\n                    break ;\r\n\r\n                /*\r\n                ** Extract the 20x20 tile from the input image\r\n                */\r\n\r\n                image.clone().extract({\r\n                    left: xOffset,\r\n                    top: yOffset,\r\n                    width: 20,\r\n                    height: 20\r\n                })\r\n                .toBuffer()\r\n                .then((buffer) => {\r\n\r\n                    /*\r\n                    ** Get the color distance of the 20x20 tile\r\n                    */\r\n\r\n                    return  color.distance(buffer)\r\n                    .then((space) => { return space.space })\r\n                    .catch((err) => console.log(err))\r\n                })\r\n                .then((space) => {\r\n\r\n                    /*\r\n                    ** Find the image in the db with the smallest difference\r\n                    */\r\n\r\n                    return distance.smallest(db, space)\r\n                })\r\n                .then((path) => {\r\n\r\n                    /*\r\n                    ** Resize the image from the db with smallest difference\r\n                    */\r\n\r\n                    return sharp(path).resize(20, 20).toBuffer()\r\n                })\r\n                .then((buffer) => {\r\n\r\n                    /*\r\n                    ** Insert resized image into 20x20 tile\r\n                    */\r\n\r\n                    final.overlayWith(buffer, {\r\n                        top: yOffset,\r\n                        left: xOffset\r\n                    })\r\n                })\r\n                .catch((err) => console.log(err))\r\n\r\n            }\r\n        }\r\n\r\n        // final.toFile('./output/' + Date.now() + '.jpg')\r\n\r\n    })\r\n    .catch((err) => console.log(err))\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1150/comments",
    "author": "afullstopdot",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-03-06T11:18:29Z",
        "body": "Hello, please see #728"
      }
    ]
  },
  {
    "number": 1147,
    "title": "Unsupported image format for all Bitmap files",
    "created_at": "2018-03-05T16:30:59Z",
    "closed_at": "2018-03-05T16:36:21Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1147",
    "body": "Unable to resize or write to different filename when source file type is image/bmp.\r\n\r\nHere's my code:\r\n```\r\n#1 sharp('/path/to/file.bmp').resize(100, 50).toFile('/path/to/file.jpg');\r\n#2 sharp('/path/to/file.bmp').tile().toFile('/path/to/file.dzi');\r\n```\r\n\r\nBoth operation results:\r\n```\r\nMime type:  image/bmp\r\nError: Input file is missing or of an unsupported image format\r\n```\r\n\r\nNote: Input file exists and in correct path",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1147/comments",
    "author": "j0hnw0rk3r",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-03-05T16:36:21Z",
        "body": "Hello, please see #543 #717 #806 #1118"
      }
    ]
  },
  {
    "number": 1146,
    "title": "Sharp how to get the best results",
    "created_at": "2018-03-05T15:04:47Z",
    "closed_at": "2018-03-05T15:07:51Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1146",
    "body": "Sharp how to get the best results and the smallest picture size?\r\n\r\nconst Sharp = require('sharp');\r\nvar sharpObj = Sharp(\"1.jpg\")\r\nsharpObj.jpeg()\r\nsharpObj.toFile(\"2.jpg\")\r\n\r\nthe jpeg default quality is 80 But the picture quality is too bad  if  set  quality 90 The output picture is too large\r\nHow to output the best quality picture under the condition that the picture volume is the lowest\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1146/comments",
    "author": "littlestar1998",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-03-05T15:07:51Z",
        "body": "Hello, please see #836"
      }
    ]
  },
  {
    "number": 1136,
    "title": "Throw error on problem",
    "created_at": "2018-02-23T14:29:38Z",
    "closed_at": "2018-02-23T17:56:20Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1136",
    "body": "Some problematic files (e.g. a `.png` file that is accidentally a `.html` file because a download didn't 404 but 302 to html) cause `sharp` to hang indefinitely.\r\n\r\nI think this should throw an Error in stead.\r\n\r\n```javascript\r\ntry {\r\n\tsharp(src, {failOnError: true})\r\n\t\t.resize(width, height)\r\n\t\t.background(bg)\r\n\t\t.embed()\r\n\t\t.toFile(dest, cb)\r\n}\r\ncatch (err) {\r\n\t// Never fires\r\n\tconsole.error(err.stack)\r\n\tcb()\r\n}\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1136/comments",
    "author": "Redsandro",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-02-23T14:49:52Z",
        "body": "Hello, `toFile()` is asynchronous and any error during image processing will be passed as the first parameter to the provided callback function, `cb` in your example.\r\n\r\nIf you want try/catch behaviour you'll need to use async/await.\r\n\r\n```javascript\r\ntry {\r\n\tawait sharp(src, {failOnError: true})\r\n\t\t.resize(width, height)\r\n\t\t.background(bg)\r\n\t\t.embed()\r\n\t\t.toFile(dest)\r\n}\r\ncatch (err) {\r\n\tconsole.error(err.stack)\r\n}\r\n```"
      },
      {
        "user": "Redsandro",
        "created_at": "2018-02-23T17:56:20Z",
        "body": "Great, thank you! :+1: "
      }
    ]
  },
  {
    "number": 1116,
    "title": "Question: Quickly get a pixel color?",
    "created_at": "2018-02-06T22:46:05Z",
    "closed_at": "2018-02-08T14:12:33Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1116",
    "body": "What is the best way to quickly get the RGB value of a particular pixel? Is this possible using sharp? I've looked through the docs but don't see anything about this.\r\n\r\nIn particular, I'd like to avoid wasting large amounts of memory, as I really only need to sample 10 or so random pixel locations for my use-case.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1116/comments",
    "author": "sam0x17",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-02-08T12:20:12Z",
        "body": "Hello, did you see #934?"
      },
      {
        "user": "sam0x17",
        "created_at": "2018-02-08T14:12:33Z",
        "body": "@lovell I did not -- thanks!"
      }
    ]
  },
  {
    "number": 1110,
    "title": "PNG image larger after processing (was: How to optimize image?)",
    "created_at": "2018-01-31T13:46:53Z",
    "closed_at": "2018-03-04T20:12:12Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1110",
    "body": "I have an image that gets cropped in the browser on the client-side before getting uploaded to the server as a png blob. However, the file is almost 100kb, which seems like a lot because it's just a small 350x200 thumbnail. Is there any way for sharp to optimize the image somehow, maybe by converting it to another type or whatever? I'd like to keep it the same dimensions, just have it be smaller if possible.\r\n\r\nOne strange thing, the file gets uploaded at about 95kb, but if I do sharp's `resize(350, 200)` on it just to see what would happen (so resize it to the same size), the resulting file that gets saved to disk is actually about 5-10kb higher. How could that be?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1110/comments",
    "author": "rightaway",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-01-31T14:38:19Z",
        "body": "Hello, did you see #478, #600 and #1017, which all relate to the same question as to why a PNG file might be larger after processing."
      }
    ]
  },
  {
    "number": 1096,
    "title": "Error loading shared library /usr/src/app/node_modules/sharp/build/Release/sharp.node: Exec format error",
    "created_at": "2018-01-17T07:49:26Z",
    "closed_at": "2018-01-17T09:28:15Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1096",
    "body": "On docker-compose up\r\n____________________________________________________________---\r\nreturn process.dlopen(module, path._makeLong(filename));\r\n                ^\r\n Error: Error loading shared library /usr/src/app/node_modules/sharp/build/Release/sharp.node: Exec format error\r\n     at Object.Module._extensions..node (module.js:664:18)\r\n     at Module.load (module.js:554:32)\r\n     at tryModuleLoad (module.js:497:12)\r\n     at Function.Module._load (module.js:489:3)\r\n    at Module.require (module.js:579:17)\r\n     at require (internal/module.js:11:18)\r\n     at Object.<anonymous> (/usr/src/app/node_modules/sharp/lib/constructor.js:10:15)\r\n     at Module._compile (module.js:635:30)\r\n    at Module._extensions..js (module.js:646:10)\r\n    at Object.require.extensions.(anonymous function) [as .js] (/usr/src/app/node_modules/babel-register/lib/node.js:152:7)\r\n   at Module.load (module.js:554:32)\r\n     at tryModuleLoad (module.js:497:12)\r\n     at Function.Module._load (module.js:489:3)\r\n     at Module.require (module.js:579:17)\r\n     at require (internal/module.js:11:18)\r\n     at Object.<anonymous> (/usr/src/app/node_modules/sharp/lib/index.js:3:15)\r\n-----------------------------------------------------------------------------------------------",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1096/comments",
    "author": "lucifez385",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-01-17T09:28:15Z",
        "body": "Hello, the same platform (and same major version of Node) has to be used at both `npm install` time and runtime.\r\n\r\nYou've not said what platforms are involved here but I would guess this is an OS X host running a Docker-managed Linux container.\r\n\r\nRunning `npm install` inside the container should solve this."
      }
    ]
  },
  {
    "number": 1091,
    "title": "How to change image opacity?",
    "created_at": "2018-01-13T22:38:25Z",
    "closed_at": "2018-05-26T09:07:30Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1091",
    "body": "I need to overlay an image on top of another image whose opacity I need to change. \r\n\r\nI've got something like\r\n```javascript\r\nbackgroundImage\r\n  .overlayWith(await foregroundImage.toBuffer())\r\n```\r\nBut I would like to\r\n```javascript\r\nbackgroundImage\r\n  .opacity(0.1) // Change the opacity of the image to 10%\r\n  .overlayWith(await foregroundImage.toBuffer())\r\n```\r\nIs there any way to to do this?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1091/comments",
    "author": "BrandonZacharie",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-01-14T15:18:29Z",
        "body": "Hello, did you see the suggestions in #554 and #859?"
      },
      {
        "user": "BrandonZacharie",
        "created_at": "2018-01-19T19:19:52Z",
        "body": "I took a look and I haven't had much luck with those methods so far. I'll give a full account of my results when I have some time tomorrow."
      },
      {
        "user": "lovell",
        "created_at": "2018-03-04T20:08:58Z",
        "body": "@BrandonZacharie Were you able to make any progress with this?"
      },
      {
        "user": "BrandonZacharie",
        "created_at": "2018-03-07T20:21:42Z",
        "body": "@lovell I still haven't had any success with this. I'm going to give it another try tomorrow. I'll give you an update then."
      },
      {
        "user": "lovell",
        "created_at": "2018-05-26T09:07:30Z",
        "body": "Closing due to inactivity but please feel free to re-open with more details if the problem persists."
      }
    ]
  },
  {
    "number": 1087,
    "title": "Python: ImportError: No module named compiler.ast",
    "created_at": "2018-01-11T02:53:01Z",
    "closed_at": "2018-02-03T14:43:28Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1087",
    "body": "```\r\nroot@root:/home/kobida# npm install sharp\r\n\r\n> sharp@0.18.4 install /home/kobida/node_modules/sharp\r\n> node-gyp rebuild\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/node_modules/npm/node_modules/node-gyp/gyp/gyp_main.py\", line 13, in <module>\r\n    import gyp\r\n  File \"/usr/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/__init__.py\", line 8, in <module>\r\n    import gyp.input\r\n  File \"/usr/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/input.py\", line 5, in <module>\r\n    from compiler.ast import Const\r\nImportError: No module named compiler.ast\r\ngyp ERR! configure error\r\ngyp ERR! stack Error: `gyp` failed with exit code: 1\r\ngyp ERR! stack     at ChildProcess.onCpExit (/usr/lib/node_modules/npm/node_modules/node-gyp/lib/configure.js:336:16)\r\ngyp ERR! stack     at ChildProcess.emit (events.js:160:13)\r\ngyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:209:12)\r\ngyp ERR! System Linux 4.9.0-5-amd64\r\ngyp ERR! command \"/usr/bin/node\" \"/usr/lib/node_modules/npm/node_modules/node-gyp/bin/node-gyp.js\" \"rebuild\"\r\ngyp ERR! cwd /home/kobida/node_modules/sharp\r\ngyp ERR! node -v v9.4.0\r\ngyp ERR! node-gyp -v v3.6.2\r\ngyp ERR! not ok\r\nnpm WARN apollo-cache-control@0.0.7 requires a peer of graphql@^0.10.0 || ^0.11.0 but none is installed. You must install peer dependencies yourself.\r\nnpm WARN apollo-link-http@1.3.2 requires a peer of graphql@^0.11.0 but none is installed. You must install peer dependencies yourself.\r\nnpm WARN apollo-tracing@0.1.1 requires a peer of graphql@^0.10.0 || ^0.11.0 but none is installed. You must install peer dependencies yourself.\r\nnpm WARN graphql-extensions@0.0.5 requires a peer of graphql@^0.10.0 || ^0.11.0 but none is installed. You must install peer dependencies yourself.\r\nnpm WARN digital@1.0.0 No description\r\nnpm WARN digital@1.0.0 No repository field.\r\nnpm WARN digital@1.0.0 No license field.\r\n\r\nnpm ERR! code ELIFECYCLE\r\nnpm ERR! errno 1\r\nnpm ERR! sharp@0.18.4 install: `node-gyp rebuild`\r\nnpm ERR! Exit status 1\r\nnpm ERR!\r\nnpm ERR! Failed at the sharp@0.18.4 install script.\r\nnpm ERR! This is probably not a problem with npm. There is likely additional logging output above.\r\n\r\nnpm ERR! A complete log of this run can be found in:\r\nnpm ERR!     /root/.npm/_logs/2018-01-11T02_51_28_732Z-debug.log\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1087/comments",
    "author": "ghost",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-01-11T07:31:38Z",
        "body": "Hello, the `ImportError: No module named compiler.ast` error suggests something is wrong with the (conflicting?) Python installation(s) on this machine. Perhaps see #684 as it was a similar problem."
      },
      {
        "user": "paultiplady",
        "created_at": "2018-01-22T22:02:05Z",
        "body": "I hit this, and fixes in the linked issue didn't work -- the install process was correctly using my python2 interpreter.\r\n\r\nIn my case the issue was that the `ubuntu:16.04` docker container that I was installing in didn't contain the python dev headers, which appear to be required to get `compiler` / `parser` modules.\r\n\r\n`apt-get install python-dev` fixed the problem for me."
      },
      {
        "user": "jnrepo",
        "created_at": "2018-01-27T00:49:03Z",
        "body": "I'm also having this issue on...\r\n\r\n- mac osx high sierra\r\n- node v9\r\n\r\nI tried different sharp versions 0.19.0 and 0.18.4"
      },
      {
        "user": "lovell",
        "created_at": "2018-02-03T14:43:28Z",
        "body": "This problem relates to local Python installations. Please subscribe #186 for updates about a possible Python-less future."
      }
    ]
  },
  {
    "number": 1084,
    "title": "Alpine: which dependencies are unnecessary at runtime?",
    "created_at": "2018-01-04T15:54:13Z",
    "closed_at": "2018-01-06T03:55:41Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1084",
    "body": "It doesn't work on the alpine-based docker image when I delete the vips-dev.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1084/comments",
    "author": "zhcsyncer",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-01-04T20:18:34Z",
        "body": "Hello, the `vips` and `vips-dev` packages are required at `npm install` (compile) time but only the `vips` package is required at runtime when using Alpine."
      },
      {
        "user": "zhcsyncer",
        "created_at": "2018-01-06T03:55:41Z",
        "body": "thks.\r\nWhen I used `apk add vips-dev` to install `vips-dev`, `vips` was installed as a dependency of `vips-dev`, so when `apk del vips-dev` was executed, `apk` was also deleted by `apk`. \r\n"
      }
    ]
  },
  {
    "number": 1082,
    "title": "Windows7 error MSB4019",
    "created_at": "2018-01-01T12:22:21Z",
    "closed_at": "2018-01-02T04:01:40Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1082",
    "body": "hello ,my run environment is   node=8.9.0,    windows64,   \r\nthere some error is this :\r\n\r\n\r\nD:\\qifuProject\\sharp-example>yarn add sharp\r\nyarn add v1.1.0\r\n[1/4] Resolving packages...\r\n[2/4] Fetching packages...\r\ninfo fsevents@1.1.3: The platform \"win32\" is incompatible with this module.\r\ninfo \"fsevents@1.1.3\" is an optional dependency and failed compatibility check. Excluding it from installation.\r\n[3/4] Linking dependencies...\r\n[4/4] Building fresh packages...\r\n\r\n\r\n[-/2] ⡀ waiting...\r\n[-/2] ⡀ waiting...\r\nerror D:\\qifuProject\\sharp-example\\node_modules\\sharp: Command failed.\r\nExit code: 1\r\nCommand: node-gyp rebuild\r\nArguments:\r\nDirectory: D:\\qifuProject\\sharp-example\\node_modules\\sharp\r\nOutput:\r\nD:\\qifuProject\\sharp-example\\node_modules\\sharp>if not defined npm_config_node_gyp (node \"C:\\Program Files\\nodejs\\node_modules\\npm\\bin\\node-gyp\r\n-bin\\\\..\\..\\node_modules\\node-gyp\\bin\\node-gyp.js\" rebuild )  else (node \"\" rebuild )\r\ngyp info it worked if it ends with ok\r\ngyp info using node-gyp@3.6.2\r\ngyp info using node@8.9.1 | win32 | x64\r\ngyp info spawn C:\\Python27\\python.exe\r\ngyp info spawn args [ 'C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp\\\\gyp\\\\gyp_main.py',\r\ngyp info spawn args   'binding.gyp',\r\ngyp info spawn args   '-f',\r\ngyp info spawn args   'msvs',\r\ngyp info spawn args   '-G',\r\ngyp info spawn args   'msvs_version=auto',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   'D:\\\\qifuProject\\\\sharp-example\\\\node_modules\\\\sharp\\\\build\\\\config.gypi',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   'C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp\\\\addon.gypi',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   'C:\\\\Users\\\\Administrator\\\\.node-gyp\\\\8.9.1\\\\include\\\\node\\\\common.gypi',\r\ngyp info spawn args   '-Dlibrary=shared_library',\r\ngyp info spawn args   '-Dvisibility=default',\r\ngyp info spawn args   '-Dnode_root_dir=C:\\\\Users\\\\Administrator\\\\.node-gyp\\\\8.9.1',\r\ngyp info spawn args   '-Dnode_gyp_dir=C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp',\r\ngyp info spawn args   '-Dnode_lib_file=C:\\\\Users\\\\Administrator\\\\.node-gyp\\\\8.9.1\\\\<(target_arch)\\\\node.lib',\r\ngyp info spawn args   '-Dmodule_root_dir=D:\\\\qifuProject\\\\sharp-example\\\\node_modules\\\\sharp',\r\ngyp info spawn args   '-Dnode_engine=v8',\r\ngyp info spawn args   '--depth=.',\r\ngyp info spawn args   '--no-parallel',\r\ngyp info spawn args   '--generator-output',\r\ngyp info spawn args   'D:\\\\qifuProject\\\\sharp-example\\\\node_modules\\\\sharp\\\\build',\r\ngyp info spawn args   '-Goutput_dir=.' ]\r\ngyp info spawn C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\msbuild.exe\r\ngyp info spawn args [ 'build/binding.sln',\r\ngyp info spawn args   '/clp:Verbosity=minimal',\r\ngyp info spawn args   '/nologo',\r\ngyp info spawn args   '/p:Configuration=Release;Platform=x64' ]\r\n�ڴ˽��������һ������һ����Ŀ����Ҫ���ò������ɣ�����ӡ�/m�����ء�\r\nD:\\qifuProject\\sharp-example\\node_modules\\sharp\\build\\libvips-cpp.vcxproj(20,3): error MSB4019: δ�ҵ��������Ŀ��D:\\Microsoft.Cpp.Defa\r\nult.props������ȷ�� <Import> �����е�·����ȷ���Ҵ����ϴ��ڸ��ļ���\r\ngyp ERR! build error\r\ngyp ERR! stack Error: `C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\msbuild.exe` failed with exit code: 1\r\ngyp ERR! stack     at ChildProcess.onExit (C:\\Program Files\\nodejs\\node_modules\\npm\\node_modules\\node-gyp\\lib\\build.js:258:23)\r\ngyp ERR! stack     at emitTwo (events.js:126:13)\r\ngyp ERR! stack     at ChildProcess.emit (events.js:214:7)\r\ngyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:198:12)\r\ngyp ERR! System Windows_NT 6.1.7601\r\ngyp ERR! command \"C:\\\\Program Files\\\\nodejs\\\\node.exe\" \"C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp\\\\bin\\\\node-gyp.js\"\r\n \"rebuild\"\r\ngyp ERR! cwd D:\\qifuProject\\sharp-example\\node_modules\\sharp\r\ngyp ERR! node -v v8.9.1\r\ngyp ERR! node-gyp -v v3.6.2\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1082/comments",
    "author": "Blackgan3",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2018-01-01T12:45:54Z",
        "body": "Hello, the salient error code is `MSB4019` - please see #985 #949 #420 #483 for details of how others have solved this problem when using multiple MSVC installations."
      },
      {
        "user": "Blackgan3",
        "created_at": "2018-01-02T03:31:43Z",
        "body": "@lovell  Thanks!"
      }
    ]
  },
  {
    "number": 1076,
    "title": "Crash with .resize() and big image input  ",
    "created_at": "2017-12-23T15:22:38Z",
    "closed_at": "2018-02-23T17:20:40Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1076",
    "body": "My app crashes while resizing a very big PNG image with sharp : \r\n\r\nImage metadata : \r\n```\r\n{ format: 'png',\r\n   width: 23520,\r\n   height: 19815,\r\n   space: 'srgb',\r\n   channels: 3,\r\n   density: 256,\r\n   hasProfile: false,\r\n   hasAlpha: false }\r\n```\r\n\r\nMy code :\r\n```\r\nconst resizedImage = sharp(myBigPngImage)\r\n                        .resize(23040, 23040)\r\n                        .background('white')\r\n                        .embed()\r\n```\r\n\r\nHow could i manage very big images and don't make my app crash ? thanks !",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1076/comments",
    "author": "Aarbel",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-12-23T19:58:56Z",
        "body": "Hello, is the input PNG image interlaced (\"Adam7\")? If so, libpng has to decompress the whole thing into memory first, so you'll need 1.8GB of RAM for the input image (plus 2.1GB for the output image)."
      },
      {
        "user": "lovell",
        "created_at": "2018-02-03T14:41:57Z",
        "body": "@Aarbel Were you able to make any progress with this?"
      },
      {
        "user": "lovell",
        "created_at": "2018-02-23T17:20:40Z",
        "body": "Closing due to inactivity - hope my estimates of the required RAM helped - feel free to re-open with more details if not."
      }
    ]
  },
  {
    "number": 1057,
    "title": "Using overlayWith before a rotate call throws an error",
    "created_at": "2017-12-09T08:22:44Z",
    "closed_at": "2017-12-12T08:06:59Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1057",
    "body": "I'm working on a project where I need to extract a piece of an image and then mask the extracted image with a polygon shape and then rotate it. I am using an SVG string buffer as the mask.\r\n\r\nWhen I run this line of code with rotate() I get an error:\r\n\"Overlay image must have same dimensions or smaller\"\r\n\r\n```\r\nsharp(imageData)\r\n    .extract({left: left, top: top, width: width, height: height})\r\n    .overlayWith(mask, {cutout: true})\r\n    .flip(isMirrored)\r\n    .rotate(rotation)\r\n    .png()\r\n    .toFile(filePath);\r\n```\r\n\r\nWhen I run it without the rotate call, it runs without error. I am not sure if this is an actual bug or if I may be doing something wrong. I am assuming that the overlayWith is happening after the rotation and that may be what is causing the error.\r\n\r\nI also want to thank you for creating this library. It is brilliant!",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1057/comments",
    "author": "zachzurn",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-12-10T20:03:32Z",
        "body": "Hello, your guess is correct, the overlay is applied at the end. You'll probably need to split this into two pipelines, something like:\r\n```javascript\r\nsharp(imageData)\r\n  .extract({left: left, top: top, width: width, height: height})\r\n  .overlayWith(mask, { cutout: true })\r\n  .raw()\r\n  .toBuffer({ resolveWithObject: true })\r\n  .then(({ data, info }) => sharp(data, { raw: info })\r\n    .flip(isMirrored)\r\n    .rotate(rotation)\r\n    .png()\r\n    .toFile(filePath)\r\n  );\r\n```\r\n"
      },
      {
        "user": "zachzurn",
        "created_at": "2017-12-12T00:11:03Z",
        "body": "Ah thanks! I will do it that way."
      }
    ]
  },
  {
    "number": 1052,
    "title": "Create folder with `.toFile`?",
    "created_at": "2017-12-04T16:02:11Z",
    "closed_at": "2017-12-04T17:11:54Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1052",
    "body": "If the folder doesn't exist `sharp` throws me an error\r\nIs there's a way to sharp to create such folder if it doesn't exist?\r\n\r\n```js\r\n.toFile(`./public/uploads/${'resize-' + req.body.file}`)\r\n```\r\n```\r\nError: vips__file_open_write: unable to open file \"./public/uploads/greyscale-67badcb0-8a98-4126-828a-4e9fe152979b.jpeg\" for writing\r\nunix error: No such file or directory\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1052/comments",
    "author": "hackuun",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-12-04T17:11:48Z",
        "body": "Hello, please see #874."
      },
      {
        "user": "hackuun",
        "created_at": "2017-12-05T15:39:35Z",
        "body": "@lovell got it. So you suggest something like this: first check is directory is exist, if not then create it with `mkdirp` and only after fire up `sharp`? Can I see basic clean example, because right now it looks little messed for me."
      },
      {
        "user": "papandreou",
        "created_at": "2017-12-05T18:44:15Z",
        "body": "```js\r\nconst mkdirp = require('mkdirp-promise');\r\nconst sharp = require('sharp');\r\n(async () => {\r\n  await mkdirp('public/uploads');\r\n\r\n  await sharp()\r\n    // ...\r\n    .toFile(`./public/uploads/${'resize-' + req.body.file}`);\r\n})();\r\n```\r\n"
      },
      {
        "user": "hackuun",
        "created_at": "2017-12-08T23:10:20Z",
        "body": "@papandreou thanks!"
      }
    ]
  },
  {
    "number": 1049,
    "title": "Multiple operations doesn't work",
    "created_at": "2017-11-30T19:56:54Z",
    "closed_at": "2017-11-30T20:12:37Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1049",
    "body": "Hello. I am trying to resize and then grayscale image, but console gives me an error\r\n\r\n```js\r\nsharp(req.file.buffer)\r\n    .resize(800)\r\n    .toFile(`./public/uploads/${'resize-' + req.body.file}`)\r\n    .grayscale()\r\n    .toFile(`./public/uploads/${'grayscale-' + req.body.file}`)\r\n```\r\n\r\nIs it possible? Or this savings should be separate operations?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1049/comments",
    "author": "hackuun",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-11-30T20:10:38Z",
        "body": "Hello, `toFile` returns a `Promise` so try something like the following (untested):\r\n\r\n```javascript\r\nPromise.all([\r\n  sharp(req.file.buffer)\r\n    .resize(800)\r\n    .toFile(`./public/uploads/resize-${req.body.file}`),\r\n  sharp(req.file.buffer)\r\n    .resize(800)\r\n    .grayscale()\r\n    .toFile(`./public/uploads/grayscale-${req.body.file}`)\r\n]).then( ... );\r\n```"
      },
      {
        "user": "hackuun",
        "created_at": "2017-11-30T20:12:37Z",
        "body": "@lovell thank you, this will work."
      }
    ]
  },
  {
    "number": 1043,
    "title": "Error on boot with sharp (Mac Sierra, Node v8.9.0)",
    "created_at": "2017-11-25T01:31:44Z",
    "closed_at": "2018-01-01T20:17:54Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1043",
    "body": "Related to #939 and #1031 \r\n\r\nNode v8.9.0 with fresh `sharp` install on Mac Sierra related to libvips install issue:\r\n\r\n```sh\r\nmodule.js:664\r\n  return process.dlopen(module, path._makeLong(filename));\r\n                 ^\r\n\r\nError: dlopen(/Users/user/Projects/project/template/node_modules/sharp/build/Release/sharp.node, 1): Library not loaded: @rpath/libvips-cpp.42.dylib\r\n  Referenced from: /Users/user/Projects/project/template/node_modules/sharp/build/Release/sharp.node\r\n  Reason: image not found\r\n    at Object.Module._extensions..node (module.js:664:18)\r\n    at Module.load (module.js:554:32)\r\n    at tryModuleLoad (module.js:497:12)\r\n    at Function.Module._load (module.js:489:3)\r\n    at Module.require (module.js:579:17)\r\n    at require (internal/module.js:11:18)\r\n    at Object.<anonymous> (/Users/user/Projects/project/template/node_modules/sharp/lib/constructor.js:9:15)\r\n    at Module._compile (module.js:635:30)\r\n    at Object.Module._extensions..js (module.js:646:10)\r\n    at Module.load (module.js:554:32)\r\n    at tryModuleLoad (module.js:497:12)\r\n    at Function.Module._load (module.js:489:3)\r\n    at Module.require (module.js:579:17)\r\n    at require (internal/module.js:11:18)\r\n    at Object.<anonymous> (/Users/user/Projects/project/template/node_modules/sharp/lib/index.js:3:15)\r\n    at Module._compile (module.js:635:30)\r\n    at Object.Module._extensions..js (module.js:646:10)\r\n    at Module.load (module.js:554:32)\r\n    at tryModuleLoad (module.js:497:12)\r\n    at Function.Module._load (module.js:489:3)\r\n    at Module.require (module.js:579:17)\r\n    at require (internal/module.js:11:18)\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1043/comments",
    "author": "niftylettuce",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-11-25T10:15:40Z",
        "body": "* Are there any errors during `npm install sharp`?\r\n* Does the `node_modules/sharp/vendor` directory, created during `npm install`, exist?\r\n* Has `vips` been installed globally on this machine via `brew` at any time in the past?\r\n* What does `otool -L node_modules/sharp/build/Release/sharp.node` say?"
      },
      {
        "user": "lovell",
        "created_at": "2018-01-01T20:17:13Z",
        "body": "@niftylettuce Are you able to provide the requested details should this problem still be occurring?"
      },
      {
        "user": "davidbarton",
        "created_at": "2018-03-14T17:02:41Z",
        "body": "Had exact same error. Fixed by upgrade from `\"^0.18.4\"` to `\"^0.20.0\"`"
      },
      {
        "user": "owenhoskins",
        "created_at": "2018-03-21T23:25:58Z",
        "body": "This error randomly occurred after adding an unrelated package with yarn just a moment ago. I was already at `\"^0.20.0\"` but running `yarn upgrade sharp` resolved the issue anyway!"
      }
    ]
  },
  {
    "number": 1040,
    "title": "Can't rezie any pngs",
    "created_at": "2017-11-23T00:51:54Z",
    "closed_at": "2018-02-08T08:07:21Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1040",
    "body": "png's dont resize. jpgs work just fine.\r\n\r\nThis bit of code sends the resized images to S3 for context\r\n\r\n```\r\nfunction writeObject(data, width, newFilePath, callback) {\r\n    return Sharp(data.Body)\r\n      .resize(width)\r\n      .toFormat('png')\r\n      .toBuffer()\r\n      .then(buffer => S3.putObject({\r\n          Body: buffer,\r\n          Bucket: BUCKET,\r\n          ContentType: 'image/png',\r\n          Key: newFilePath,\r\n        }).promise()\r\n      )\r\n      .then(() => callback(null, {\r\n        statusCode: '301',\r\n        headers: {'location': `${URL}/${newFilePath}`},\r\n        body: '',\r\n      })\r\n    )\r\n}\r\n```\r\nThe output is the original file in original size. I have tried 5 or 6 png files, both from google images and ones I made. I don't think its a png file issue but I'm happy to link a test image here if needed.  I'm also confused why its not throwing an error?\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1040/comments",
    "author": "LMS007",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-11-23T20:35:33Z",
        "body": "Hello, please can you provide a reduced test case that removes all the S3/HTTP logic and focuses only on sharp."
      },
      {
        "user": "LMS007",
        "created_at": "2017-11-25T00:09:56Z",
        "body": "Roger that, I'll output directly to local disk and post again. Thanks Lovell, the package is great otherwise!"
      },
      {
        "user": "lovell",
        "created_at": "2017-12-19T18:46:45Z",
        "body": "@LMS007 Were you able to make any progress with this?"
      },
      {
        "user": "LMS007",
        "created_at": "2017-12-19T19:00:30Z",
        "body": "@lovell \r\nI have not, but I need to get this this soon, probably after the new year. Thanks for following up "
      },
      {
        "user": "LMS007",
        "created_at": "2018-02-08T00:17:53Z",
        "body": "@lovell \r\nsorry it took so longer to circle back to this, too many projects not enough time. I went and broke down the code into simple tests and uhm... it was working. Turns out the lambda method I wrote had a bug, not in the `writeObject` method, but in the wrapper method that recursively called it with various \"approved\" file extension types that it would restrict on and guess at while grabbing objects from S3. I was only passing the `width` param the very first time, but not the recursive case and so JPEG was the first extension in my array, PNG was not... e.g. PNG never got the `width` param... my fault. Long story short, this is *not* a bug, please close :)\r\n"
      }
    ]
  },
  {
    "number": 1026,
    "title": "SHARP_DIST_BASE_URL not working in windows 10",
    "created_at": "2017-11-16T01:38:39Z",
    "closed_at": "2017-12-07T20:34:06Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1026",
    "body": "I added the system environment variable SHARP_DIST_BASE_URL in windows 10 and did the npm install but  i am getting the error connect ETimedout 104.20.22.46:443. \r\nI am behind proxy and i self hosted the libvips windows x64 binary in localhost and added that path to the above environment variable\r\nIt doesn't look like the install using the variable. Any idea why the variable is not working in windows ?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1026/comments",
    "author": "vinothvk",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-11-16T09:23:07Z",
        "body": "> \"connect ETimedout 104.20.22.46:443\"\r\n\r\n104.20.22.46 belongs to Cloudflare, but this isn't used by sharp so is probably unrelated. Are you able to share the full error log?\r\n\r\n> \"I am behind proxy and i self hosted the libvips windows x64 binary in localhost and added that path to the above environment variable\"\r\n\r\nWhat did you set it to? Are there any proxy-related environment variables set that could affect this?"
      },
      {
        "user": "lovell",
        "created_at": "2017-12-07T20:34:06Z",
        "body": "Closing due to a lack of feedback but please re-open with the requested information if the problem persists."
      }
    ]
  },
  {
    "number": 1025,
    "title": ".jpeg({quality:100}) results in larger image file size than the original",
    "created_at": "2017-11-14T21:53:53Z",
    "closed_at": "2017-11-15T15:38:28Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1025",
    "body": "```\r\nsharp('input.jpg')\r\n  .jpeg({quality:100})\r\n  .toFile();\r\n```\r\n\r\nThe input file is 7.4MB (quality 100). The output file is 18.3 MB. Same thing happens with toBuffer(). Why? How can I output a jpeg with same quality as the original (instead of the default 80) without increasing  file size?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1025/comments",
    "author": "cheadle",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-11-15T11:43:42Z",
        "body": "Hello, `quality` is not the only attribute that can affect JPEG file size. Concepts such as chroma subsampling and \"fancy\" downsampling can also have an impact, especially at higher \"quality\" levels.\r\n\r\nAlthough you've not mentioned platform, my best guess would be that you're using OS X. If so, please see #1006 for a recent example and discussion.\r\n\r\n(It's also worth mentioning that the ability for any software to determine the original \"quality\" setting of a JPEG image depends on it making assumptions about the quantisation tables used at compression time, which may not always be correct.)"
      },
      {
        "user": "cheadle",
        "created_at": "2017-11-15T15:38:28Z",
        "body": "Thanks Lovell. Yes, I am on OS X. Looks like sharp v0.19.0 will fix this issue. Great work on this library. It's a pleasure to use. "
      }
    ]
  },
  {
    "number": 1020,
    "title": "Cannot load images with colon in filename",
    "created_at": "2017-11-10T12:36:34Z",
    "closed_at": "2017-11-13T09:50:01Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1020",
    "body": "Hello,\r\nI have to resize a lot of files with special chars in their names. All is working but files with colon in their name like 4BhTRy5:1z.jpg\r\nHere is the error message\r\nError: Input file is missing or of an unsupported image format\r\n\r\nI used jimp before and there were no problems with colons in file   ##names.\r\n\r\nThanks",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1020/comments",
    "author": "moncasi",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-11-10T13:13:12Z",
        "body": "This is probably due to how the glib library, used by libvips to open files, handles relative paths. Your example `4BhTRy5:1z.jpg` is interpreted as `1z.jpg` with a protocol of `4BhTRy5`, neither of which exist.\r\n\r\nUsing absolute file paths everywhere solves most of these kind of problems and usually makes code more robust."
      },
      {
        "user": "moncasi",
        "created_at": "2017-11-13T08:35:45Z",
        "body": "Yes, you're right but I already use absolute paths like this : sharp(path.resolve(sourceFolder+'/'+filename))\r\nI tried to replace all colons with a '\\:' but it doesn't matter...\r\nI'll be searching about glib and an eventual issue with colon in file names."
      },
      {
        "user": "moncasi",
        "created_at": "2017-11-13T09:05:50Z",
        "body": "I found this kind of bug reports. I tried with adding 'file://localhost' before the absolute path and that did not work too.\r\nI did not try with relative paths.\r\nI use the buffer from fs.readFile and that works well :)\r\nThanks"
      },
      {
        "user": "lovell",
        "created_at": "2017-11-13T09:50:01Z",
        "body": "Thanks for the update. There's not a lot we can do here so I'm glad you found a workaround."
      }
    ]
  },
  {
    "number": 1019,
    "title": "Increase/decrease image brightness?",
    "created_at": "2017-11-09T20:39:11Z",
    "closed_at": "2017-11-09T21:18:14Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1019",
    "body": "I tried to used the `gamma` operation to change an image brightness for dataset augmentation, but it doesn't seem to actually make the image brigther or darker.\r\n\r\nHow can I change the image brightness? (eg: add +10 to all pixels)",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1019/comments",
    "author": "Cristy94",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-11-09T20:55:49Z",
        "body": "Hello, did you see #609?"
      },
      {
        "user": "Cristy94",
        "created_at": "2017-11-09T21:02:46Z",
        "body": "That looks like what I need, but is it implemented yet?"
      },
      {
        "user": "lovell",
        "created_at": "2017-11-09T21:18:14Z",
        "body": "Please subscribe to #609 for any updates."
      }
    ]
  },
  {
    "number": 1017,
    "title": "png compressed than the original larger",
    "created_at": "2017-11-09T04:28:18Z",
    "closed_at": "2017-11-09T20:10:49Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1017",
    "body": "`\r\nvar sharpObj = Sharp(urlencode.decode(origin_full_path_file_name_path))\r\n\r\nsharpObj = sharpObj.png({ compressionLevel: 9, adaptiveFiltering: false, force: false })\r\n`\r\n\r\nHello\r\n\r\nThe original 100k, but after generation by .png({ compressionLevel: 9, adaptiveFiltering: false, force: false }) format 160k, the picture has an alpha transparent color. In addition to returning to the original image. What kind of ways can also be improved?\r\n\r\nThanks\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1017/comments",
    "author": "littlestar1998",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-11-09T20:10:48Z",
        "body": "Hello, please see #478 and #600 for previous answers to this question."
      }
    ]
  },
  {
    "number": 1010,
    "title": "\"undefined symbol\" upon launch on Centos6 32bit",
    "created_at": "2017-11-02T14:25:15Z",
    "closed_at": "2018-02-03T14:48:37Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1010",
    "body": "In reference to #649. I have built `libvips` from the tarball with some of the dependencies, but on runtime of the app i get:\r\n````\r\nError: /root/app/build/node_modules/sharp/build/Release/sharp.node: undefined s$\r\nmbol: _ZN2v816FunctionTemplate3NewEPNS_7IsolateEPFvRKNS_20FunctionCallbackInfoI$\r\nS_5ValueEEEENS_5LocalIS4_EENSA_INS_9SignatureEEEiNS_19ConstructorBehaviorE      \r\n   at Error (native)                                                           \r\n   at Object.Module._extensions..node (module.js:434:18)                       \r\n   at Module.load (module.js:343:32)                                           \r\n   at Function.Module._load (module.js:300:12)                                 \r\n   at Module.require (module.js:353:17)                                        \r\n   at require (internal/module.js:12:17)                                       \r\n   at Object.<anonymous> (/root/app/build/node_modules/sharp/lib/constructor.j$\r\n:9:15)                                                                          \r\n   at Module._compile (module.js:409:26)\r\n   at Object.Module._extensions..js (module.js:416:10)\r\n   at Module.load (module.js:343:32)\r\n````\r\n\r\nOutput of `ldd ./app/build/node_modules/sharp/build/Release/sharp.node`:\r\n\r\n````\r\nlinux-gate.so.1 =>  (0xb77d4000)                                        \r\nlibvips-cpp.so.42 => /usr/local/lib/libvips-cpp.so.42 (0xb7761000)      \r\nlibvips.so.42 => /usr/local/lib/libvips.so.42 (0xb73dc000)              \r\nlibgobject-2.0.so.0 => /lib/libgobject-2.0.so.0 (0xb738f000)            \r\nlibgthread-2.0.so.0 => /lib/libgthread-2.0.so.0 (0xb738a000)            \r\nlibrt.so.1 => /lib/librt.so.1 (0xb7380000) \r\nlibglib-2.0.so.0 => /lib/libglib-2.0.so.0 (0xb7263000)          [4/1991]\r\nlibstdc++.so.6 => /usr/lib/libstdc++.so.6 (0xb7178000)                  \r\nlibm.so.6 => /lib/libm.so.6 (0xb714e000)                                \r\nlibgcc_s.so.1 => /lib/libgcc_s.so.1 (0xb7130000)                        \r\nlibpthread.so.0 => /lib/libpthread.so.0 (0xb7115000)                    \r\nlibc.so.6 => /lib/libc.so.6 (0xb6f7d000)\r\nlibz.so.1 => /lib/libz.so.1 (0xb6f69000)\r\nlibpng12.so.0 => /usr/lib/libpng12.so.0 (0xb6f41000)\r\nlibtiff.so.3 => /usr/lib/libtiff.so.3 (0xb6edf000)\r\nlibjpeg.so.62 => /usr/lib/libjpeg.so.62 (0xb6e88000)\r\nlibgmodule-2.0.so.0 => /lib/libgmodule-2.0.so.0 (0xb6e84000)\r\nlibexpat.so.1 => /lib/libexpat.so.1 (0xb6e5b000)\r\nliblcms.so.1 => /usr/lib/liblcms.so.1 (0xb6e21000)\r\nlibgif.so.4 => /usr/lib/libgif.so.4 (0xb6e18000)\r\nlibexif.so.12 => /usr/lib/libexif.so.12 (0xb6ddf000)\r\n/lib/ld-linux.so.2 (0xb77d5000)\r\nlibdl.so.2 => /lib/libdl.so.2 (0xb6dd9000)\r\nlibSM.so.6 => /usr/lib/libSM.so.6 (0xb6dd1000)\r\nlibICE.so.6 => /usr/lib/libICE.so.6 (0xb6db7000)\r\nlibX11.so.6 => /usr/lib/libX11.so.6 (0xb6c7d000)\r\nlibuuid.so.1 => /lib/libuuid.so.1 (0xb6c78000)\r\nlibxcb.so.1 => /usr/lib/libxcb.so.1 (0xb6c4f000)\r\nlibXau.so.6 => /usr/lib/libXau.so.6 (0xb6c4c000)\r\n````\r\nI'm running on `node 8`. Wiping and reinstalling `node_modules` doesn't help. Changing versions of node doesn't either. It works okay on my dev environment with the pre built binaries, but fails on production.\r\nAny guesses? Maybe I need the python binding stuff for `libvips`?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1010/comments",
    "author": "unski11ed",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-11-02T15:59:34Z",
        "body": "It looks like `build/Release/sharp.node` has been compiled at `npm install` time against one version of V8 but is being used at run time with another V8 version.\r\n\r\nIs your production system using the same major version of Node as the system on which `npm install` is being run?"
      },
      {
        "user": "unski11ed",
        "created_at": "2017-11-02T17:56:24Z",
        "body": "Yes, both are running `node 8.6.0`, the only difference is that the app is compilled on a 64bit machine. But that shouldn't make a diferrence as  `npm install` is ran on the server itself. I can even see in the output that sharp is building there."
      },
      {
        "user": "lovell",
        "created_at": "2017-11-02T18:14:26Z",
        "body": "What does \"the app is compilled on a 64bit machine\" mean?\r\n\r\nCould the contents of `node_modules` generated on a 64-bit machine get copied to a 32-bit machine (even if \"npm install is ran on the server itself\")?\r\n\r\nAre there any environment variables that could be altering compiler behaviour, e.g. `LDFLAGS`?"
      },
      {
        "user": "unski11ed",
        "created_at": "2017-11-02T18:32:56Z",
        "body": "\"Compile\" isn't the right word i guess... Webpack building the application is what i meant ;)\r\n\r\n`node_modules` aren't sent over the wire at all, only `package.json` and after it is complete it runs `npm install` there. I checked it out many times, after your first suggestion - I'm quite sure that different node version isn't the case here. Although you seem to be very confident about it, which makes it very wierd :O No other things come to your mind? `node-gyp` is throwing a warning about some deprecated constant - this is the one thing that looked odd for me.\r\n\r\n`LDFLAGS` is only modified inside some other modules - `fibers` and `node-sass`, the app build mechanism itself doesn't tocuh it, at least I'm not aware of it."
      },
      {
        "user": "lovell",
        "created_at": "2017-11-02T19:12:32Z",
        "body": "Thank you, definitely a weird one. Are you able to see if this occurs with another major Node (and therefore V8) version, perhaps the latest v6.11.5?"
      },
      {
        "user": "lovell",
        "created_at": "2017-12-07T20:30:18Z",
        "body": "@unski11ed Is this problem still occurring?"
      },
      {
        "user": "unski11ed",
        "created_at": "2017-12-08T09:28:08Z",
        "body": "Sorry, forgot about this. I can't really tell at the moment. I had to switch for now for a pure JS solution which is slow as he'll. I'll be mangling with the production server in January so I will be able to investigate it more. I can't touch it at the moment. I'll post an update when I'll be able to look at it ok?"
      },
      {
        "user": "lovell",
        "created_at": "2018-02-03T14:48:37Z",
        "body": "Closing for now but please feel free to re-open with more information if available in the future."
      }
    ]
  },
  {
    "number": 1002,
    "title": "Cannot find module 'caw'",
    "created_at": "2017-10-24T06:17:30Z",
    "closed_at": "2017-10-24T07:45:18Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/1002",
    "body": "i saw same issue #871\r\nbut my case is different.\r\n\r\ni trying deploy my node application in CloudFoundry environment.\r\nmy local environment is success npm install but CloudFoundry environment is fail\r\n\r\ncause is Cannot find module 'caw'\r\n\r\nplease help me\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/1002/comments",
    "author": "kishe89",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-10-24T07:45:18Z",
        "body": "Hello, this is very likely to be a temporary problem with CloudFoundry, probably network related. You'll need to get the `npm install` log from CloudFoundry to see what happened. Good luck!"
      },
      {
        "user": "kishe89",
        "created_at": "2017-10-24T07:50:13Z",
        "body": "Probably CloudFoundry npm cache problem. \r\nThank you for quick response.\r\n"
      }
    ]
  },
  {
    "number": 997,
    "title": "how to get metadata width and height after trim",
    "created_at": "2017-10-18T20:59:25Z",
    "closed_at": "2017-10-19T12:42:05Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/997",
    "body": "Is there a way to get width and height metadata after trim?\r\n\r\n```\r\nlet transform = sharp()\r\n    .trim()\r\n    .metadata()\r\n    .then(function(metadata) {\r\n        console.log(metadata)\r\n    })\r\n\r\nreturn readableStream\r\n            .pipe(transform)\r\n```\r\n\r\nThis doesn't seem to work\r\n\r\n\r\nThanks",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/997/comments",
    "author": "jaekunchoi",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-10-19T10:51:53Z",
        "body": "Hello, `metadata()` operates on the input but it looks like you need to generate the output.\r\n\r\n`toBuffer()` provides the output dimensions via `info`, so try something like (untested):\r\n\r\n```javascript\r\nconst trimmer = sharp()\r\n  .trim()\r\n  .toBuffer((err, data, info) => {\r\n    console.log(info)\r\n  })\r\nreturn readableStream\r\n  .pipe(trimmer)\r\n```"
      },
      {
        "user": "jaekunchoi",
        "created_at": "2017-10-19T11:31:48Z",
        "body": "thanks. How do I then pass the info to the next `pipe`?"
      },
      {
        "user": "lovell",
        "created_at": "2017-10-19T11:54:53Z",
        "body": "When using Stream-based output, the data piped from a sharp instance is the (compressed) image.\r\n\r\nThe instance will emit an `info` event with the data you need, which can be used to update another variable in an outer scope, something like:\r\n\r\n```javascript\r\n// Define this within a scope that writableStream can access\r\nlet trimmedInfo\r\n\r\nconst trimmer = sharp()\r\n  .trim()\r\n  .on('info', info => {\r\n    trimmedInfo = info\r\n  })\r\n\r\nreadableStream\r\n  .pipe(trimmer)\r\n  .pipe(writableStream);\r\n```"
      },
      {
        "user": "jaekunchoi",
        "created_at": "2017-10-19T11:58:41Z",
        "body": "thanks I mean I want to be able to do something like:\r\n\r\n```\r\nlet trimmedInfo = { width: 0, height: 0 }\r\n\r\nconst trimmer = sharp()\r\n  .trim()\r\n  .on('info', info => {\r\n    trimmedInfo = info\r\n  })\r\n  .extend({ top: trimmedInfo.height, bottom: trimmedInfo.height, left: trimmedInfo.width, right: trimmedInfo.width })\r\n  .background(background)\r\n\r\nreadableStream\r\n  .pipe(trimmer)\r\n```\r\n\r\nIt seems width and height is 0 how can I pass them through as they are not updated?"
      },
      {
        "user": "lovell",
        "created_at": "2017-10-19T12:00:20Z",
        "body": "Thanks for the extra context. You'll need to separate this into two operations with two sharp instances, one for the trim, and a second for the extend."
      },
      {
        "user": "jaekunchoi",
        "created_at": "2017-10-19T12:12:46Z",
        "body": "thanks for the tip.\r\n\r\nI have this operation below but it doesn't seem to update the `padding_width` for example into `extend` parameter. It only seems to persist 0\r\n\r\n```\r\n          let padding_width = 0\r\n          let padding_height = 0\r\n\r\n          const transformer2 = sharp()\r\n            .trim()\r\n            .on('info', trimmed_metadata => {\r\n              console.log(height, trimmed_metadata)\r\n              padding_width = parseInt((width - trimmed_metadata.width) / 2)\r\n              padding_height = (height - trimmed_metadata.height) / 2\r\n\r\n              if(trimmed_metadata.width > width) {\r\n                padding_width = 10\r\n              }\r\n\r\n              if(padding_height >= 50) {\r\n                padding_height = parseInt(padding_height)\r\n              } else {\r\n                padding_height = 50\r\n              }\r\n\r\n              console.log('Trimmed Metadata ', trimmed_metadata)\r\n              console.log('Original Metadata ', original_metadata)\r\n              if(trimmed_metadata.height == original_metadata.height) {\r\n                padding_height = 0\r\n              }\r\n\r\n              console.log(padding_height, padding_width)\r\n\r\n            })\r\n\r\n          const transformer3 = sharp()\r\n            .extend({ top: padding_height, bottom: padding_height, left: padding_width, right: padding_width })\r\n            .background(background)\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2017-10-19T12:29:58Z",
        "body": "Thank you for even more context. In the above example, `padding_width` has a value of `0` when `extend()` is called on `transformer3`.\r\n\r\nYou'll probably want to defer this assignment, something like:\r\n\r\n```javascript\r\nconst transformer3 = sharp()\r\n  .background(background)\r\n\r\nconst transformer2 = sharp()\r\n  .trim()\r\n  .on('info', trimmed_metadata => {\r\n    ...\r\n    transformer3.extend({ ... })\r\n  })\r\n```\r\n"
      },
      {
        "user": "jaekunchoi",
        "created_at": "2017-10-19T12:36:11Z",
        "body": "thank you it works beautifully!"
      }
    ]
  },
  {
    "number": 994,
    "title": "Silent crash when calling sharp without arguments",
    "created_at": "2017-10-17T17:58:01Z",
    "closed_at": "2017-10-17T20:06:25Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/994",
    "body": "Minimal test case:\r\n\r\n```js\r\nconst sharp = require('sharp')\r\nconst main = async () => {\r\n  const image = sharp()\r\n  const info = await image.metadata()\r\n  console.log('done')\r\n}\r\n\r\nmain()\r\n```\r\n\r\nThe process simply exits with status 0.  There is no error message, and 'done' is never logged to the console.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/994/comments",
    "author": "whmountains",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-10-17T18:16:31Z",
        "body": "Hello, the parameter-less constructor is for Stream-based input.\r\n\r\n> \"JPEG, PNG, WebP, GIF, SVG, TIFF or raw pixel image data can be streamed into the object when not present.\" \r\n\r\nIn your example, this might look like the following:\r\n```diff\r\n  const image = sharp()\r\n+ readableSteam.pipe(image)\r\n  const info = await image.metadata()\r\n```"
      },
      {
        "user": "whmountains",
        "created_at": "2017-10-17T20:06:25Z",
        "body": "Thank you, I missed that."
      }
    ]
  },
  {
    "number": 993,
    "title": "Question about overlayWith and color profiles",
    "created_at": "2017-10-16T01:31:11Z",
    "closed_at": "2017-11-14T09:07:39Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/993",
    "body": "Hi,\r\n\r\nI've been reading issues and how-to create compositions with sharp, and a question pops out on my head.. \r\nHow sharp handles different colorprofiles when overlaying?\r\nShould I have a promise of each file buffer with toColorspace('srgb') and then reduce/forkJoin all? or is automatic?\r\n\r\nThank you!\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/993/comments",
    "author": "rui-cruz",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-10-16T09:15:01Z",
        "body": "The summary is: it will try to convert to sRGB for you.\r\n\r\nMost use cases will involve using an image with an alpha channel as the overlay, typically PNG or (automagically-rasterised) SVG, which will \"just work\".\r\n\r\nI've not tried but I suspect attempting to use a profile-less CMYK JPEG as the overlay may fail at the moment, but that will be a rare scenario as JPEG has no alpha channel."
      },
      {
        "user": "lovell",
        "created_at": "2017-11-11T09:53:55Z",
        "body": "@rui-cruz Did this answer your question?"
      },
      {
        "user": "rui-cruz",
        "created_at": "2017-11-13T23:28:18Z",
        "body": "My goal is to create a \"collage\" of images on a blank image. This collage can be huge.. but my concern was about color-profiles. At this time I had not tested yet, You can close for now, and later I'll give you feedback.\r\n\r\nThank you @lovell "
      }
    ]
  },
  {
    "number": 982,
    "title": "Should I enable GZIP for already compressed WebP images?",
    "created_at": "2017-10-10T07:27:58Z",
    "closed_at": "2017-10-30T11:15:58Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/982",
    "body": "I read that WebP is the best format when it comes to compression.\r\nMy question is, after I convert the uploaded JPEG images to WebP using `sharp`, should I still enable express gzip `compression`?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/982/comments",
    "author": "Altiano",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-10-10T08:26:10Z",
        "body": "Hello, you're unlikely to see much reduction in file size compressing WebP with gzip; in some cases the output may be larger.\r\n\r\nIf you need more help with this, perhaps check for similar questions on Stack Overflow as this topic isn't specific to sharp."
      },
      {
        "user": "lovell",
        "created_at": "2017-10-30T11:15:58Z",
        "body": "Hope this helped."
      }
    ]
  },
  {
    "number": 973,
    "title": "SVG to JPG not working with image files",
    "created_at": "2017-10-03T19:56:52Z",
    "closed_at": "2017-11-13T21:19:18Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/973",
    "body": "I'm trying to rasterize an SVG image which contains an image tag pointing to a local file. However, the image is not rendered. I've tried the same svg directly with rsvg-convert and it works. I've tried relative and absolute paths with the image in the project root or descendant folder. Sharp does work if the image tag contains a data uri.\r\n\r\nAny help would be appreciated!",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/973/comments",
    "author": "hbar-digital",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-10-03T20:12:43Z",
        "body": "Hello, is this with file-based input or Buffer/Stream based input? If the latter please try the former as librsvg places security limits on the location of included files.\r\n\r\nIt's also worth trying with absolute filesystem paths or ensuring paths are relative to the process' working directory (which may not be the same as the directory your script is in)."
      },
      {
        "user": "lovell",
        "created_at": "2017-11-11T09:51:58Z",
        "body": "@hbar-digital Were you able to make any progress with this?"
      },
      {
        "user": "hbar-digital",
        "created_at": "2017-11-13T21:14:20Z",
        "body": "@lovell You are correct in that it's a librsvg limitation as I was using a stream based input. The workaround was to convert the image to base64."
      },
      {
        "user": "lovell",
        "created_at": "2017-11-13T21:19:18Z",
        "body": "Thanks for confirming. I'll close as this is a security feature of librsvg with a workaround for trusted input."
      }
    ]
  },
  {
    "number": 957,
    "title": "Feature Request: Convert color space",
    "created_at": "2017-09-21T07:48:02Z",
    "closed_at": "2017-10-02T17:38:41Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/957",
    "body": "Hi\r\n\r\nthanks for sharp, wonderful lib! I need it to resize images. \r\n\r\nWhat I'm looking is a way to convert the colorspace, for example I want to convert it from ARGB(8888) to RGB(565). I can do this in JS, but I doubt it's high performance.\r\n\r\nAny chance we can implement a conversion function in sharp?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/957/comments",
    "author": "neophob",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-09-21T08:13:18Z",
        "body": "Hello, I think #218 covers this."
      },
      {
        "user": "edzis",
        "created_at": "2018-11-14T02:07:58Z",
        "body": "@lovell I am also having ARGB inputs and I fail to convert them with sharp. Did you mean that #218 has the recipe to do that or that this will be supported once the ideas discussed in #218  will be implemented?"
      },
      {
        "user": "lovell",
        "created_at": "2018-11-14T10:02:51Z",
        "body": "@edzis Raw, uncompressed ARGB input will need to be byte-swapped before passing to sharp as it expects 4 channel RGBA (or 2 for greyscale+A) raw input to have the alpha channel at the end."
      }
    ]
  },
  {
    "number": 952,
    "title": "Module did not self-register on node 8.1.3",
    "created_at": "2017-09-19T06:15:32Z",
    "closed_at": "2017-10-30T11:14:36Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/952",
    "body": "I'm getting the following error:\r\n\r\nmodule.js:598\r\n  return process.dlopen(module, path._makeLong(filename));\r\n                 ^\r\n\r\nError: Module did not self-register.\r\n    at Object.Module._extensions..node (module.js:598:18)\r\n    at Module.load (module.js:503:32)\r\n    at tryModuleLoad (module.js:466:12)\r\n    at Function.Module._load (module.js:458:3)\r\n    at Module.require (module.js:513:17)\r\n    at require (internal/module.js:11:18)\r\n    at Object.<anonymous> (SOME_PATH/node_modules/sharp/lib/constructor.js:9:15)\r\n    at Module._compile (module.js:569:30)\r\n    at Object.Module._extensions..js (module.js:580:10)\r\n    at Module.load (module.js:503:32)\r\n\r\nThere is no problem in node 6.x.\r\nI've tried with npm rebuild, and also a clean install, and the problem persists.\r\n\r\nAny clues???\r\nThanks!",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/952/comments",
    "author": "rm3nchaca",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-09-19T06:29:17Z",
        "body": "Hello, the \"Module did not self-register\" message usually suggests either different versions of node are being used at `npm install` time and run time, or different platforms/architectures are being used, e.g. 32-bit vs 64-bit."
      },
      {
        "user": "rm3nchaca",
        "created_at": "2017-09-19T06:51:13Z",
        "body": "Thanks for you fast response!\r\nI know, but I tried a rebuild, and a clean install and the problem persisted.\r\nThen I switch back to a 6.x version and run again a rebuild and worked.\r\nThen I switch to a 8.1.3 version and show me the errors related to different versions.\r\nFinally with an npm rebuild I got the self register error.\r\nAlso, with a fresh install..\r\nI'm using fedora, I'm going to dig more with this, maybe is something in my environment.\r\nAny help is appreciated!\r\nThanks!"
      },
      {
        "user": "lovell",
        "created_at": "2017-09-19T09:28:16Z",
        "body": "If you've not already tried it, `readelf` might provide some help when debugging the shared library that is being built.\r\n```sh\r\n$ readelf -h SOME_PATH/node_modules/sharp/build/Release/sharp.node\r\n```\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2017-10-30T11:14:35Z",
        "body": "Closing due to inactivity but please feel free to re-open if the original problem persists."
      },
      {
        "user": "brollb",
        "created_at": "2017-11-03T14:53:32Z",
        "body": "I have been seeing this same issue with node version v6.9.2 and node 8.9.0. I tried clearing the cache and reinstalling the node modules but it didn't seem to resolve the issue...\r\n```\r\nrm -rf node_modules\r\nnpm cache clean --force\r\nnpm install\r\n```\r\n\r\nbut I am still getting the error:\r\n```\r\n Could not load sharp: Error: Module did not self-register.\r\n    at Object.Module._extensions..node (module.js:664:18)\r\n    at Module.load (module.js:554:32)\r\n    at tryModuleLoad (module.js:497:12)\r\n    at Function.Module._load (module.js:489:3)\r\n    at Module.require (module.js:579:17)\r\n    at require (internal/module.js:11:18)\r\n    at Object.<anonymous> (/home/brian/projects/netsblox/netsblox/node_modules/sharp/lib/constructor.js:9:15)\r\n    at Module._compile (module.js:635:30)\r\n    at Object.Module._extensions..js (module.js:646:10)\r\n    at Module.load (module.js:554:32)\r\n    at tryModuleLoad (module.js:497:12)\r\n    at Function.Module._load (module.js:489:3)\r\n    at Module.require (module.js:579:17)\r\n    at require (internal/module.js:11:18)\r\n    at Object.<anonymous> (/home/brian/projects/netsblox/netsblox/node_modules/sharp/lib/index.js:3:15)\r\n    at Module._compile (module.js:635:30)\r\n    at Object.Module._extensions..js (module.js:646:10)\r\n    at Module.load (module.js:554:32)\r\n    at tryModuleLoad (module.js:497:12)\r\n    at Function.Module._load (module.js:489:3)\r\n    at Module.require (module.js:579:17)\r\n    at require (internal/module.js:11:18)\r\n\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2017-11-03T16:37:32Z",
        "body": "@brollb Please make certain that the same major version of node is being used for `npm install` and at runtime. For example, could there be conflicting node versions on this machine (you do mention this)?\r\n\r\nCould there be a slightly broken global installation of libvips on this machine? What does the suggested `readelf` command above produce?"
      },
      {
        "user": "ghost",
        "created_at": "2018-01-09T21:14:00Z",
        "body": "I am having this issue to, when I try to run the readelf command, it says it's not found. The reason I had to switch node versions was because sharp wasn't compiled for the latest. I've removed the node_modules folder several times with no prevail, and using nvm i made sure that I was on the node version that supported NODE_MODULES 51 (node 7.10.1). \r\n\r\nAny luck? Spent hours trying to get this package to work..."
      },
      {
        "user": "lovell",
        "created_at": "2018-01-09T21:38:25Z",
        "body": "@JordanMaxFCB A value of 51 for `NODE_MODULE_VERSION` means there's probably an old version of the unsupported Node 7 somewhere on your machine that is taking priority over anything that `nvm` is using."
      },
      {
        "user": "ghost",
        "created_at": "2018-01-09T22:13:52Z",
        "body": "@lovell  So what would you recommend to resolving that? I'm not a Node developer, and I do use Node to develop React Native on my own time (this is a work computer), is there a way to check if other node versions exist? Also what would happen if a user wanted to use this library, and had another package with a different node that compiled that? Off-topic, but I can't seem to grasp how Javascript developers do that (I do .NET primarily). But really just wondering if there's a way to check if other nodejs exists on my computer (what you were saying) and how to fix that? "
      },
      {
        "user": "iliaskarim",
        "created_at": "2021-09-01T19:24:38Z",
        "body": "> If you've not already tried it, `readelf` might provide some help when debugging the shared library that is being built.\r\n> \r\n> ```shell\r\n> $ readelf -h SOME_PATH/node_modules/sharp/build/Release/sharp.node\r\n> ```\r\n\r\nit's not an ELF but a \" Mach-O 64-bit bundle x86_64\" \"sharp@npm:^0.23.0\""
      }
    ]
  },
  {
    "number": 948,
    "title": "Trim only top and bottom",
    "created_at": "2017-09-14T08:05:24Z",
    "closed_at": "2017-09-16T06:48:11Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/948",
    "body": "Is there a way to use `.trim` for only top and the bottom and not left and right?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/948/comments",
    "author": "jaekunchoi",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-09-14T09:19:58Z",
        "body": "Hello, the `trim` operation will be switching to the libvips-provided version from the next release as part of #914. This work will expose the dimensions calculated by the trim operation so perhaps you could use these for a second call to extract the area you're interested in?"
      },
      {
        "user": "jaekunchoi",
        "created_at": "2017-09-16T01:58:11Z",
        "body": "Hi @lovell so is it possible to achieve this at the current version? I have a few `.resize` operations but was trying to find a way so `trim` does not keep its original size but resize down to that trimmed version. This way I can minus from original width and put `extend` with left and right. Is it possible to do this?"
      },
      {
        "user": "lovell",
        "created_at": "2017-09-16T06:48:11Z",
        "body": "This will only be possible after the work for #914 is done, and only then as a two-step operation, so your best bet is to subscribe to it for updates."
      },
      {
        "user": "jaekunchoi",
        "created_at": "2017-09-24T00:31:08Z",
        "body": "It would be great if someone had a workaround solution to this. @lovell "
      }
    ]
  },
  {
    "number": 943,
    "title": "Images not process fully",
    "created_at": "2017-09-10T07:55:42Z",
    "closed_at": "2017-09-10T18:12:42Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/943",
    "body": "When I process images in bulk I'm getting images with half processed results and in Lambda I get \r\n`\tError: ENOENT: no such file or directory, open `\r\n` Process exited before completing request` and `(sharp:1): GLib-CRITICAL **: g_hash_table_lookup: assertion 'hash_table != NULL' failed`\r\n\r\nBelow is my code:\r\n\r\n```\r\nimport fs from \"fs\";\r\nimport aws from \"aws-sdk\";\r\nimport sharp from \"sharp\";\r\nimport pipefy from \"pipefy\";\r\nimport rimraf from \"rimraf\";\r\n\r\nlet s3 = new aws.S3()\r\n\r\nconst coords = { x: 0, y: 0 }\r\n\r\nlet background = { r: 255, g: 255, b: 255, alpha: 1 }\r\n\r\nlet minimumChannelThreshold = { r: 200, g: 200, b: 200, alpha: 1 }\r\nlet pdp = { width: 360, height: 464 }\r\nlet plp = { width: 180, height: 232 }\r\nlet pdp_retina = { width: 720, height: 928 }\r\n\r\nconst tmp_dir = \"/tmp/\"\r\nconst processed_bucket_name = \"images-processed-test\"\r\n\r\n// Keep safe the original function with proper scope\r\nlet putObject = s3.putObject.bind(s3)\r\n\r\n// Override the function\r\ns3.putObject = function(opts, cb) {\r\n  if (!opts.Body) {\r\n    return pipefy(mapBody);\r\n  }\r\n  return putObject(opts, cb);\r\n\r\n  function mapBody(buffer) {\r\n    opts.Body = buffer;\r\n    putObject(opts, cb);\r\n  }\r\n}\r\n\r\nfunction download_file(bucketName, key, localPath) {\r\n  let params = { Bucket: bucketName, Key: key }\r\n  let file = fs.createWriteStream(localPath)\r\n\r\n  return s3.getObject(params).createReadStream().pipe(file)\r\n}\r\n\r\nfunction upload_file(bucketName, key, localFile, callback) {\r\n  console.log(\"Uploading file to bucket:\", bucketName, \", key:\", key)\r\n  let params = {\r\n    Bucket: bucketName,\r\n    Key: key\r\n  }\r\n\r\n  fs.createReadStream(localFile).pipe(\r\n    s3.putObject(params, function(err, resp) {\r\n      if (err) {\r\n        console.log(err)\r\n      }\r\n      console.log(\"Successfully uploaded package.\", resp)\r\n\r\n      // Remove all local files\r\n      // rimraf(tmp_dir + '/*', function () { console.log('Removed local file', ) })\r\n    })\r\n  )\r\n}\r\n\r\nfunction get_write_file_name(file_name, width, height) {\r\n  let write_file_parts = file_name.split(\".\");\r\n  return write_file_parts[0]\r\n    .concat(\"_\" + width + \"x\" + height + \".\")\r\n    .concat(write_file_parts[1]);\r\n}\r\n\r\nfunction process_image(read_file, upload_path, width, height) {\r\n  const local_read_file = tmp_dir + read_file\r\n  let readableStream = fs.createReadStream(local_read_file)\r\n\r\n  const write_file = get_write_file_name(read_file, width, height)\r\n  const local_write_file = tmp_dir + write_file\r\n  console.log(\"Creating file: \", write_file)\r\n  let writableStream = fs.createWriteStream(local_write_file)\r\n\r\n  const transformer1 = sharp()\r\n    .trim()\r\n    .extend({ top: 10, bottom: 10, left: 5, right: 5 })\r\n    .background(background)\r\n\r\n  const transformer2 = sharp()\r\n    .toBuffer(function(err, outputBuffer, info) {\r\n      const offset = 3 * (1 * coords.x + coords.y) // channels * (width * y + x);\r\n      const red = outputBuffer[offset]\r\n      const green = outputBuffer[offset + 1]\r\n      const blue = outputBuffer[offset + 2]\r\n      background.r = red\r\n      background.g = green\r\n      background.b = blue\r\n      // outputBuffer is a Buffer of length (width * height * channels)\r\n      // containing 8-bit RGB(A) pixel data.\r\n    })\r\n    .resize(width, height)\r\n    .embed()\r\n    .background(background)\r\n\r\n  return readableStream\r\n    .pipe(transformer1)\r\n    .pipe(transformer2)\r\n    .pipe(writableStream)\r\n}\r\n\r\nmodule.exports.lambda_handler = (event, context, callback) => {\r\n  console.log(JSON.stringify(event))\r\n\r\n  let upload_path = ''\r\n  let s3_event_records = event[\"Records\"]\r\n  s3_event_records.forEach(function(record) {\r\n    let s3_event = record[\"s3\"]\r\n\r\n    let key_path = s3_event[\"object\"][\"key\"].split('+').join(' ')\r\n    let key_parts = key_path.split(\"/\")\r\n    // Ensure `+` is replaced with whitespace from Lambda event\r\n    let read_file = key_parts[key_parts.length - 1]\r\n    const local_read_file = tmp_dir + read_file\r\n\r\n    let downloaded_file = download_file(\r\n      s3_event[\"bucket\"][\"name\"],\r\n      key_path,\r\n      local_read_file\r\n    )\r\n\r\n    downloaded_file.on(\"finish\", function() {\r\n      key_parts.pop();\r\n      upload_path = key_parts.join(\"/\").concat(\"/\")\r\n      process_image(read_file, upload_path, pdp.width, pdp.height)\r\n      process_image(read_file, upload_path, plp.width, plp.height)\r\n      process_image(read_file, upload_path, pdp_retina.width, pdp_retina.height)\r\n    })\r\n  })\r\n\r\n  fs.readdir(tmp_dir, (err, files) => {\r\n    files.forEach(file => {\r\n        upload_file(processed_bucket_name, upload_path + file, tmp_dir + file)\r\n    })\r\n  })\r\n}\r\n```\r\n\r\nI'm not sure if other processes are exiting and causing this interruption. Is there a way to ensure these errors doesn't occur?\r\n\r\nThanks",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/943/comments",
    "author": "jaekunchoi",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-09-10T08:40:25Z",
        "body": "Hello, there's a lot going on in this code. Are you able to reduce the test case to help make it easier to diagnose?"
      },
      {
        "user": "jaekunchoi",
        "created_at": "2017-09-10T11:08:25Z",
        "body": "@lovell yes so I'm passing in s3 events whenever image is uploaded and Lambda processes it. I feel like it's related to #885, #182 and #418 so maybe s3 the streams call process exits thus interrupting other threads. Not sure if this is correct assumption though"
      },
      {
        "user": "lovell",
        "created_at": "2017-09-10T18:12:42Z",
        "body": "Yes, the lack of `on('error', ...)` handling on the various streams means they can kill the process.\r\n\r\nThe `ENOENT: no such file or directory` message is probably coming from `let readableStream = fs.createReadStream(local_read_file)` so perhaps start there. This is unlikely to be a sharp problem - good luck!"
      }
    ]
  },
  {
    "number": 933,
    "title": "resize request exception error message is junk characters",
    "created_at": "2017-09-05T02:26:06Z",
    "closed_at": "2017-09-05T07:07:16Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/933",
    "body": "Here is how I am using sharp:\r\n>         sharp(\"sample.jpg\")\r\n>          .resize(parseInt(20))\r\n>          .toBuffer()\r\n>          .then(function(err, outputBuffer){\r\n>             if (err) {\r\n>                 throw err;\r\n>             }\r\n>         })\r\n>         .catch(function (err){\r\n>             console.log('exception in sharp: '+err);\r\n>         });\r\n\r\nThis request is hitting exception and returning junk characters as error message:\r\n\r\n> exception in sharp: ï¿½ï¿½ï¿½ï¿½C\r\n%-(0%()(ï¿½ï¿½C\r\n> \r\n> \r\n> (((((((((((((((((((((((((((((((((((((((((((((((((((ï¿½ï¿½\r\n> \"ï¿½ï¿½ï¿½ï¿½\"!A1Qï¿½ï¿½ï¿½ï¿½!ï¿½ï¿½\r\n> ?ï¿½ï¿½ï¿½ï¿½Cï¿½ï¿½ï¿½ï¿½ï¿½Qï¿½Eï¿½ï¿½ï¿½;|ï¿½0ï¿½ï¿½ï¿½Ó¡Qï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½RYï¿½ï¿½fï¿½ï¿½4ï¿½ï¿½F%ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½> rMï¿½ï¿½ï¿½ï¿½\r\n> PuTTYPuTTYPuTTYPuTTYPuTTYPuTTY\r\n\r\nWhat am I doing wrong?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/933/comments",
    "author": "vikramaditya234",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-09-05T07:07:16Z",
        "body": "JavaScript Promises resolve with a value via `then()` and reject with an error via `catch()` .\r\n```diff\r\n-     .then(function(err, outputBuffer){\r\n+     .then(function(outputBuffer){\r\n```"
      }
    ]
  },
  {
    "number": 928,
    "title": "MSB8007 Error on x64 windows 10",
    "created_at": "2017-09-03T02:05:16Z",
    "closed_at": "2017-09-03T22:08:21Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/928",
    "body": "Hi,\r\n\r\nI'm trying to create a sample app with electron, but unfortunately I'm not able to try it:\r\n\r\n> sharp@0.18.2 install C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\r\n node-gyp rebuild\r\n\r\n\r\n> C:\\Users\\infor\\Desktop\\sample-app\\sharp>if not defined npm_config_node_gyp (node \"C:\\Program Files\\nodejs\\node_modules\\npm\\bin\\node-gyp-bin\\\\..\\..\\node_modules\\node-gyp\\bin\\node-gyp.js\" rebuild )  else (node \"\" rebuild )\r\ngyp info it worked if it ends with ok\r\ngyp verb cli [ 'C:\\\\Program Files\\\\nodejs\\\\node.exe',\r\ngyp verb cli   'C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp\\\\bin\\\\node-gyp.js',\r\ngyp verb cli   'rebuild' ]\r\ngyp info using node-gyp@3.4.0\r\ngyp info using node@6.11.2 | win32 | x64\r\ngyp verb command rebuild []\r\ngyp verb command clean []\r\ngyp verb clean removing \"build\" directory\r\ngyp verb command configure []\r\ngyp verb check python checking for Python executable \"c:/Python27/python.exe\" in the PATH\r\ngyp verb `which` succeeded c:/Python27/python.exe c:\\Python27\\python.exe\r\ngyp verb check python version `c:\\Python27\\python.exe -c \"import platform; print(platform.python_version());\"` returned: \"2.7.3\\r\\n\"\r\ngyp verb get node dir no --target version specified, falling back to host node version: 6.11.2\r\ngyp verb command install [ '6.11.2' ]\r\ngyp verb install input version string \"6.11.2\"\r\ngyp verb install installing version: 6.11.2\r\ngyp verb install --ensure was passed, so won't reinstall if already installed\r\ngyp verb install version is already installed, need to check \"installVersion\"\r\ngyp verb got \"installVersion\" 9\r\ngyp verb needs \"installVersion\" 9\r\ngyp verb install version is good\r\ngyp verb get node dir target node version installed: 6.11.2\r\ngyp verb build dir attempting to create \"build\" dir: C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\build\r\ngyp verb build dir \"build\" dir needed to be created? C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\build\r\ngyp verb build/config.gypi creating config file\r\ngyp verb build/config.gypi writing out config file: C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\build\\config.gypi\r\ngyp verb config.gypi checking for gypi file: C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\config.gypi\r\ngyp verb common.gypi checking for gypi file: C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\common.gypi\r\ngyp verb gyp gyp format was not specified; forcing \"msvs\"\r\ngyp info spawn c:\\Python27\\python.exe\r\ngyp info spawn args [ 'C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp\\\\gyp\\\\gyp_main.py',\r\ngyp info spawn args   'binding.gyp',\r\ngyp info spawn args   '-f',\r\ngyp info spawn args   'msvs',\r\ngyp info spawn args   '-G',\r\ngyp info spawn args   'msvs_version=auto',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   'C:\\\\Users\\\\infor\\\\Desktop\\\\app-electron\\\\angular-electron\\\\node_modules\\\\sharp\\\\build\\\\config.gypi',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   'C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp\\\\addon.gypi',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   'C:\\\\Users\\\\infor\\\\.node-gyp\\\\6.11.2\\\\include\\\\node\\\\common.gypi',\r\ngyp info spawn args   '-Dlibrary=shared_library',\r\ngyp info spawn args   '-Dvisibility=default',\r\ngyp info spawn args   '-Dnode_root_dir=C:\\\\Users\\\\infor\\\\.node-gyp\\\\6.11.2',\r\ngyp info spawn args   '-Dnode_gyp_dir=C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp',\r\ngyp info spawn args   '-Dnode_lib_file=node.lib',\r\ngyp info spawn args   '-Dmodule_root_dir=C:\\\\Users\\\\infor\\\\Desktop\\\\app-electron\\\\angular-electron\\\\node_modules\\\\sharp',\r\ngyp info spawn args   '--depth=.',\r\ngyp info spawn args   '--no-parallel',\r\ngyp info spawn args   '--generator-output',\r\ngyp info spawn args   'C:\\\\Users\\\\infor\\\\Desktop\\\\app-electron\\\\angular-electron\\\\node_modules\\\\sharp\\\\build',\r\ngyp info spawn args   '-Goutput_dir=.' ]\r\ngyp verb command build []\r\ngyp verb build type Release\r\ngyp verb architecture x64\r\ngyp verb node dev dir C:\\Users\\infor\\.node-gyp\\6.11.2\r\ngyp verb found first Solution file build/binding.sln\r\ngyp verb could not find \"msbuild.exe\" in PATH - finding location in registry\r\ngyp verb \"Release\" dir needed to be created? null\r\ngyp verb copying \"node.lib\" for x64 C:\\Users\\infor\\.node-gyp\\6.11.2\\Release\\node.lib\r\ngyp info spawn C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\msbuild.exe\r\ngyp info spawn args [ 'build/binding.sln',\r\ngyp info spawn args   '/nologo',\r\ngyp info spawn args   '/p:Configuration=Release;Platform=x64' ]\r\nBuilding the projects in this solution one at a time. To enable parallel build, please add the \"/m\" switch.\r\nBuild started 03/09/2017 02:44:49.\r\nProject \"C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\build\\binding.sln\" on node 1 (default targets).\r\nValidateSolutionConfiguration:\r\n  Building solution configuration \"Release|x64\".\r\nThe target \"Midl\" listed in a BeforeTargets attribute at \"C:\\Program Files (x86)\\MSBuild\\Microsoft.Cpp\\v4.0\\BuildCustomizations\\masm.targets (28,5)\" does not exist in the\r\n project, and will be ignored.\r\nThe target \"CustomBuild\" listed in an AfterTargets attribute at \"C:\\Program Files (x86)\\MSBuild\\Microsoft.Cpp\\v4.0\\BuildCustomizations\\masm.targets (29,5)\" does not exist\r\n in the project, and will be ignored.\r\nProject \"C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\build\\binding.sln\" (1) is building \"C:\\Users\\infor\\Desktop\\app-electron\\a\r\nngular-electron\\node_modules\\sharp\\build\\libvips-cpp.vcxproj\" (2) on node 1 (default targets).\r\nC:\\Program Files (x86)\\MSBuild\\Microsoft.Cpp\\v4.0\\Microsoft.Cpp.InvalidPlatform.Targets(23,7): error MSB8007: The Platform for project 'libvips-cpp.vcxproj' is invalid.\r\nPlatform='x64'. You may be seeing this message because you are trying to build a project without a solution file, and have specified a non-default Platform that doesn't e\r\nxist for this project. [C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\build\\libvips-cpp.vcxproj]\r\nDone Building Project \"C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\build\\libvips-cpp.vcxproj\" (default targets) -- FAILED.\r\n\r\n>Done Building Project \"C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\build\\binding.sln\" (default targets) -- FAILED.\r\n\r\n\r\n>Build FAILED.\r\n\r\n>\"C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\build\\binding.sln\" (default target) (1) ->\r\n\"C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\build\\libvips-cpp.vcxproj\" (default target) (2) ->\r\n(InvalidPlatformError target) ->\r\n  C:\\Program Files (x86)\\MSBuild\\Microsoft.Cpp\\v4.0\\Microsoft.Cpp.InvalidPlatform.Targets(23,7): error MSB8007: The Platform for project 'libvips-cpp.vcxproj' is invalid.\r\n  Platform='x64'. You may be seeing this message because you are trying to build a project without a solution file, and have specified a non-default Platform that doesn't\r\n exist for this project. [C:\\Users\\infor\\Desktop\\app-electron\\sample-app\\sharp\\build\\libvips-cpp.vcxproj]\r\n\r\n>    0 Warning(s)\r\n>    1 Error(s)\r\n\r\nAny help is appreciated\r\n\r\nKind regards,\r\nRui",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/928/comments",
    "author": "rui-cruz",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-09-03T07:01:45Z",
        "body": "Hello, it looks like there may be multiple, conflicting copies of msbuild as both `C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\msbuild.exe` and `C:\\Program Files (x86)\\MSBuild\\Microsoft.Cpp\\v4.0\\...` appear in the output.\r\n\r\nYou'll probably need to either uninstall an old one or set/update an environment variable to point to the new one, perhaps `VCTargetsPath`."
      },
      {
        "user": "rui-cruz",
        "created_at": "2017-09-03T22:07:31Z",
        "body": "Hi @lovell \r\nyou were right! but I could only solve this issue on other laptop I bought yesterday..\r\nI had to use this:\r\n`# as admin `\r\n> npm install --global --production windows-build-tools\r\n\r\nThank you very much!"
      }
    ]
  },
  {
    "number": 921,
    "title": "v0.18.x fails to build after building v0.17.x",
    "created_at": "2017-08-25T21:20:23Z",
    "closed_at": "2017-08-27T20:20:46Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/921",
    "body": "I'm happily using `ridge` versions in my projects across mac, linux, and win10 builds, with and without electron, so from a consumer standpoint, `sharp` is great.\r\n\r\nI tried to finish my older PR (failOnError) today, rebased my patch against master, and saw compilation errors during `rm -rf node_modules && npm install` on win10. I switched to the master branch to get to a known-good state, and there were still compilation errors. I tried upgrading npm (to pull in a new `node-gyp`) and `yarn`, but the only way I can get my tree to compile is to revert to a `v0.17.*` tag.\r\n\r\n```\r\ngyp ERR! build error\r\ngyp ERR! stack Error: `C:\\Program Files (x86)\\MSBuild\\14.0\\bin\\msbuild.exe` failed with exit code: 1\r\ngyp ERR! stack     at ChildProcess.onExit (C:\\Users\\mrm\\AppData\\Roaming\\npm\\node_modules\\npm\\node_modules\\node-gyp\\lib\\build.js:258:23)\r\ngyp ERR! stack     at emitTwo (events.js:106:13)\r\ngyp ERR! stack     at ChildProcess.emit (events.js:194:7)\r\ngyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:215:12)\r\ngyp ERR! System Windows_NT 10.0.15063\r\ngyp ERR! command \"C:\\\\Program Files\\\\nodejs\\\\node.exe\" \"C:\\\\Users\\\\mrm\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp\\\\bin\\\\node-gyp.js\" \"rebuild\"\r\ngyp ERR! cwd C:\\Users\\mrm\\src\\sharp\r\ngyp ERR! node -v v7.9.0\r\ngyp ERR! node-gyp -v v3.6.2\r\ngyp ERR! not ok\r\nnpm ERR! code ELIFECYCLE\r\nnpm ERR! errno 1\r\n```\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/921/comments",
    "author": "mceachen",
    "comments": [
      {
        "user": "mceachen",
        "created_at": "2017-08-25T21:23:48Z",
        "body": "The solution is to `git clean -fdx`. \r\n\r\n`npm run clean` doesn't currently remove the `lib` or `include` directories. Would you like a PR that adds that? (In either event, feel free to close this, as it's mostly to help Engineers of Tomorrow)."
      },
      {
        "user": "mceachen",
        "created_at": "2017-08-25T21:28:00Z",
        "body": "Also, just want to reiterate that sharp is 👌. 👍!"
      },
      {
        "user": "lovell",
        "created_at": "2017-08-27T19:29:54Z",
        "body": "Hi Matthew, sorry you ran into this, I think it should only impact those working on the source between 0.17.x and 0.18.x. Given `lib` is now a valid directory containing the JS code, I'm not sure the proposed change is the right thing to do.\r\n\r\n(At some point the the `vendor` directory will either become platform-specific or the installation script will check the contents of `vendor` matches the current platform.)"
      },
      {
        "user": "mceachen",
        "created_at": "2017-08-27T20:20:46Z",
        "body": "OK, closing."
      }
    ]
  },
  {
    "number": 920,
    "title": "doc about install on alpine on docker",
    "created_at": "2017-08-24T10:10:01Z",
    "closed_at": "2017-08-30T13:11:27Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/920",
    "body": "all package needed while install: (can delete after install)\r\n> vips-dev fftw-dev python make g++ binutils\r\n\r\nextra package required while running:\r\n> vips\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/920/comments",
    "author": "GongT",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-08-24T20:53:19Z",
        "body": "Hello, Python and a C++11 compiler (and related tools) are prerequisites for all platforms, not just Alpine Linux.\r\n\r\n`fftw-dev` is included in the \"latest\" docs, which will be promoted to the \"stable\" docs after the next release."
      },
      {
        "user": "GongT",
        "created_at": "2017-08-30T13:11:27Z",
        "body": "ok, that's right, thanks!"
      }
    ]
  },
  {
    "number": 911,
    "title": "Possible to use sharp to blend two images together?",
    "created_at": "2017-08-14T16:11:34Z",
    "closed_at": "2017-08-14T20:09:40Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/911",
    "body": "I'm hoping to use sharp to blend two images together at different opacities, to stitch together a cross fade.  It's not evident from the `overlayWith` documentation that this is possible.  Would someone kindly let me know if this is a supported use case?  Thanks!",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/911/comments",
    "author": "artz",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-08-14T18:19:37Z",
        "body": "Hello, did you see #859?"
      },
      {
        "user": "artz",
        "created_at": "2017-08-14T20:09:40Z",
        "body": "Looks to be the solution, thanks."
      }
    ]
  },
  {
    "number": 907,
    "title": "resized image is not displayed in Safari",
    "created_at": "2017-08-08T12:22:48Z",
    "closed_at": "2017-08-09T05:38:20Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/907",
    "body": "Hello,\r\n\r\nWould like to request assistance...\r\nI resize the image to smaller dimension (200 by 200), convert it to base64 and store it to database.\r\nI can display the resized image in chrome but in safari the base64 image can't be loaded.\r\n\r\nHere is the code in resizing ...\r\n`const resizeImageJPEG = (base64, dimension) => {\r\n    const base64WithNoMetadata = base64.replace(JPEG_METADATA, '')\r\n    const imageBuffer = Buffer.from(base64WithNoMetadata, ENCODING_BASE64)\r\n    return new Promise(resolve => {\r\n        const { width, height } = dimension\r\n        sharp(imageBuffer).resize(width, height).toBuffer().then(data => {\r\n            resolve(`${JPEG_METADATA}${data.toString(ENCODING_BASE64)}`)\r\n        })\r\n    })\r\n}`\r\n\r\nThanks.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/907/comments",
    "author": "ghost",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-08-08T12:34:56Z",
        "body": "Hello, I'm not quite sure I understand what you're trying to achieve here. Are you able to clean up your example code with newlines and/or semi-colons? If you remove all the base64 encoding/decoding does it work?"
      },
      {
        "user": "ghost",
        "created_at": "2017-08-09T05:38:20Z",
        "body": "sharp encoding/decoding is working ok. It is an issue with test image we used.  Even mac could not open it.  We observed that images that mac could not open, could not be rendered in safari and firefox browsers. \r\nThank you for accommodating my question."
      }
    ]
  },
  {
    "number": 905,
    "title": "Blurry Images",
    "created_at": "2017-08-07T14:27:03Z",
    "closed_at": "2017-08-21T18:36:13Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/905",
    "body": "Hello,\r\n\r\nI am encountering an issue with resizing images. It may be due to something I am doing. Basically, the output images are blurry.\r\n\r\nThis is the code I am using:\r\n```js\r\n    var quality = 100;\r\n    var format  = 'png';\r\n\r\n    S3.getObject({Bucket: BUCKET, Key: originalKey}).promise()\r\n        .then(data => Sharp(data.Body)\r\n        .resize(width, height)\r\n        .toFormat(format)\r\n        .quality(quality)\r\n        .toBuffer()\r\n    )\r\n    .then(buffer => S3.putObject({\r\n        Body: buffer,\r\n        Bucket: BUCKET,\r\n        ContentType: 'image/png',\r\n        Key: key,\r\n    }).promise()\r\n    )\r\n    .then(() => callback(null, {\r\n        statusCode: '301',\r\n        headers: {'location': URL+key},\r\n        body: '',\r\n    })\r\n```\r\nThe original files are in PNG format; they are high-quality/high-resolution images.\r\n\r\nI saw that there's PNG compression level setting, but I can't seem to figure out how to use it with the toBuffer() method.\r\n\r\nI am using a MacBook with a retina display, I hope that's not the reason why they do appear blurry. If that's the case, is there a way to optimize them for retina. I've went through the docs and can't seem to figure it out.\r\n\r\nThe library is great!\r\n\r\nThank you in advance!\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/905/comments",
    "author": "Radostin",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-08-07T17:55:21Z",
        "body": "Hello, I notice you're using the now-removed `quality` API, but this was ignored for PNG images as they are lossless (you'll see there are now `quality` parameters only for lossy formats).\r\n\r\nPlease can you use the latest version of sharp and if you're still having problems provide an original PNG image and the resize dimensions that when used produce a blurry PNG output."
      }
    ]
  },
  {
    "number": 880,
    "title": "Jpg is occupied",
    "created_at": "2017-07-25T05:42:54Z",
    "closed_at": "2017-07-25T12:53:56Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/880",
    "body": "windows 10\r\n\r\n```\r\nvar img = sharp('xxx.jpg');\r\nimg.toBuffer().then((buffer) => {\r\n  buffer;\r\n});\r\n```\r\n\r\nAfter the .toBuffer, the file is occupied.\r\nUnable to delete in system.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/880/comments",
    "author": "VisualSJ",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-07-25T07:29:12Z",
        "body": "Hello, did you see #415?"
      },
      {
        "user": "VisualSJ",
        "created_at": "2017-07-25T08:23:49Z",
        "body": "Sorry, I didn't see the issue(415).\r\n\r\nIt has been solved:\r\n\r\n```\r\nSharp.cache(false);\r\n```\r\n\r\nThank you.\r\n"
      }
    ]
  },
  {
    "number": 878,
    "title": "Sharp install fails \\sharp\\build\\libvips-cpp.vcxproj\" (default targets) -- FAILED.",
    "created_at": "2017-07-24T16:22:01Z",
    "closed_at": "2017-09-08T09:31:34Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/878",
    "body": "I've installed python 2.7, windows-build-tools, im on latest node, any pointers as to why it isn't working or what else I can try?\r\n\r\n```\r\n\r\n> sharp@0.18.2 install C:\\VSO Agent Geoff\\_work\\151\\s\\node_modules\\sharp\r\n> node-gyp rebuild\r\n\r\n\r\nC:\\VSO Agent Geoff\\_work\\151\\s\\node_modules\\sharp>if not defined npm_config_node_gyp (node \"C:\\Program Files\\nodejs\\node_modules\\npm\\bin\\node-gyp-bin\\\\..\\..\\node_modules\\node-gyp\\bin\\node-gyp.js\" rebuild )  else (node \"\" rebuild ) \r\nBuilding the projects in this solution one at a time. To enable parallel build, please add the \"/m\" switch.\r\nBuild started 24/07/2017 17:16:03.\r\nProject \"C:\\VSO Agent Geoff\\_work\\151\\s\\node_modules\\sharp\\build\\binding.sln\" on node 1 (default targets).\r\nValidateSolutionConfiguration:\r\n  Building solution configuration \"Release|x64\".\r\nProject \"C:\\VSO Agent Geoff\\_work\\151\\s\\node_modules\\sharp\\build\\binding.sln\" (1) is building \"C:\\VSO Agent Geoff\\_work\\151\\s\\node_modules\\sharp\\build\\libvips-cpp.vcxproj\" (2) on node 1 (default targets).\r\nPrepareForBuild:\r\n  Creating directory \"Release\\obj\\libvips-cpp\\\".\r\n  Creating directory \"Release\\obj\\libvips-cpp\\libvips-cpp.tlog\\\".\r\nInitializeBuildStatus:\r\n  Creating \"Release\\obj\\libvips-cpp\\libvips-cpp.tlog\\unsuccessfulbuild\" because \"AlwaysCreate\" was specified.\r\nClCompile:\r\n  C:\\Program Files (x86)\\Microsoft Visual Studio 11.0\\VC\\bin\\CL.exe /c /I\"C:\\Users\\tom.sanderson\\.node-gyp\\6.11.1\\include\\node\" /I\"C:\\Users\\tom.sanderson\\.node-gyp\\6.11.1\\src\" /I\"C:\\Users\\tom.sanderson\\.node-gyp\\6.11.1\\deps\\uv\\include\" /I\"C:\\Users\\tom.sanderson\\.node-gyp\\6.11.1\\deps\\v8\\include\" /I..\\vendor\\include /I\"..\\vendor\\include\\glib-2.0\" /I\"..\\vendor\\lib\\glib-2.0\\include\" /Zi /nologo /W3 /WX- /Ox /Ob2 /Oi /Ot /Oy /GL /D \"NODE_GYP_MODULE_NAME=libvips-cpp\" /D USING_UV_SHARED=1 /D USING_V8_SHARED=1 /D V8_DEPRECATION_WARNINGS=1 /D WIN32 /D _CRT_SECURE_NO_DEPRECATE /D _CRT_NONSTDC_NO_DEPRECATE /D _HAS_EXCEPTIONS=0 /D VIPS_CPLUSPLUS_EXPORTS /D _ALLOW_KEYWORD_MACROS /D _WINDLL /GF /Gm- /EHsc /MT /GS /Gy /fp:precise /Zc:wchar_t /Zc:forScope /Zc:inline /GR- /Fo\"Release\\obj\\libvips-cpp\\\\\" /Fd\"Release\\obj\\libvips-cpp\\vc140.pdb\" /Gd /TP /wd4267 /wd4351 /wd4355 /wd4800 /wd4251 /wd4275 /errorReport:queue /MP ..\\src\\libvips\\cplusplus\\VError.cpp ..\\src\\libvips\\cplusplus\\VInterpolate.cpp ..\\src\\libvips\\cplusplus\\VImage.cpp \"C:\\Program Files\\nodejs\\node_modules\\npm\\node_modules\\node-gyp\\src\\win_delay_load_hook.cc\"\r\nC:\\Program Files (x86)\\MSBuild\\Microsoft.Cpp\\v4.0\\V140\\Microsoft.CppCommon.targets(356,5): error MSB6006: \"CL.exe\" exited with code -1073741515. [C:\\VSO Agent Geoff\\_work\\151\\s\\node_modules\\sharp\\build\\libvips-cpp.vcxproj]\r\nDone Building Project \"C:\\VSO Agent Geoff\\_work\\151\\s\\node_modules\\sharp\\build\\libvips-cpp.vcxproj\" (default targets) -- FAILED.\r\nDone Building Project \"C:\\VSO Agent Geoff\\_work\\151\\s\\node_modules\\sharp\\build\\binding.sln\" (default targets) -- FAILED.\r\n\r\nBuild FAILED.\r\n\r\n\"C:\\VSO Agent Geoff\\_work\\151\\s\\node_modules\\sharp\\build\\binding.sln\" (default target) (1) ->\r\n\"C:\\VSO Agent Geoff\\_work\\151\\s\\node_modules\\sharp\\build\\libvips-cpp.vcxproj\" (default target) (2) ->\r\n(ClCompile target) -> \r\n  C:\\Program Files (x86)\\MSBuild\\Microsoft.Cpp\\v4.0\\V140\\Microsoft.CppCommon.targets(356,5): error MSB6006: \"CL.exe\" exited with code -1073741515. [C:\\VSO Agent Geoff\\_work\\151\\s\\node_modules\\sharp\\build\\libvips-cpp.vcxproj]\r\n\r\n    0 Warning(s)\r\n    1 Error(s)\r\n\r\nTime Elapsed 00:00:00.86\r\n```\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/878/comments",
    "author": "sattaman",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-07-24T16:42:46Z",
        "body": "Hello, the appearance of the `C:\\Program Files (x86)\\Microsoft Visual Studio 11.0\\VC\\bin\\CL.exe` path suggests you've got an (old?) installation of Visual Studio 2012 on the same machine that is conflicting with the more recent tooling installed via `windows-build-tools`. Perhaps either uninstall this older version if no longer required or remove any reference to it from `PATH`."
      },
      {
        "user": "lovell",
        "created_at": "2017-09-03T08:40:27Z",
        "body": "@sattaman Were you able to make any progress with this?"
      },
      {
        "user": "odahcam",
        "created_at": "2017-12-15T11:58:24Z",
        "body": "I'm using VS2015 and got almost the same error: \r\n\r\n```bash\r\n$ yarn\r\nyarn install v1.3.2\r\n[1/4] Resolving packages...\r\n[2/4] Fetching packages...\r\ninfo fsevents@1.1.3: The platform \"win32\" is incompatible with this module.\r\ninfo \"fsevents@1.1.3\" is an optional dependency and failed compatibility check. Excluding it from installation.\r\n[3/4] Linking dependencies...\r\nwarning \" > mocha-webpack@0.7.0\" has incorrect peer dependency \"webpack@^1.12.13 || ^2.1.0-beta.15\".\r\n[4/4] Building fresh packages...\r\n[1/3] ⠂ sharp: not ok\r\n[2/3] ⠂ phantomjs-prebuilt: Done. Phantomjs binary available at C:\\Users\\67390\\Projects\\odahcam\\zxing-ts\\node_m\r\n[3/3] ⠂ uglifyjs-webpack-plugin\r\n[-/3] ⠂ waiting...\r\nerror C:\\Users\\67390\\Projects\\odahcam\\zxing-ts\\node_modules\\sharp: Command failed.\r\nExit code: 1\r\nCommand: node-gyp rebuild\r\nArguments:\r\nDirectory: C:\\Users\\67390\\Projects\\odahcam\\zxing-ts\\node_modules\\sharp\r\nOutput:\r\nC:\\Users\\67390\\Projects\\odahcam\\zxing-ts\\node_modules\\sharp>if not defined npm_config_node_gyp (node \"C:\\Program Files\\nodejs\\node_modules\\npm\\bin\\node-gyp-bin\\\\..\\..\\node_modules\\node-gyp\\bin\\node-gyp.js\" rebuild )  else (node \"\" rebuild )\r\ngyp info it worked if it ends with ok\r\ngyp info using node-gyp@3.6.2\r\ngyp info using node@8.3.0 | win32 | x64\r\ngyp info spawn C:\\Python27\\python.exe\r\ngyp info spawn args [ 'C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp\\\\gyp\\\\gyp_main.py',\r\ngyp info spawn args   'binding.gyp',\r\ngyp info spawn args   '-f',\r\ngyp info spawn args   'msvs',\r\ngyp info spawn args   '-G',\r\ngyp info spawn args   'msvs_version=auto',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   'C:\\\\Users\\\\67390\\\\Projects\\\\odahcam\\\\zxing-ts\\\\node_modules\\\\sharp\\\\build\\\\config.gypi',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   'C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp\\\\addon.gypi',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   'C:\\\\Users\\\\67390\\\\.node-gyp\\\\8.3.0\\\\include\\\\node\\\\common.gypi',\r\ngyp info spawn args   '-Dlibrary=shared_library',\r\ngyp info spawn args   '-Dvisibility=default',\r\ngyp info spawn args   '-Dnode_root_dir=C:\\\\Users\\\\67390\\\\.node-gyp\\\\8.3.0',\r\ngyp info spawn args   '-Dnode_gyp_dir=C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp',\r\ngyp info spawn args   '-Dnode_lib_file=C:\\\\Users\\\\67390\\\\.node-gyp\\\\8.3.0\\\\<(target_arch)\\\\node.lib',\r\ngyp info spawn args   '-Dmodule_root_dir=C:\\\\Users\\\\67390\\\\Projects\\\\odahcam\\\\zxing-ts\\\\node_modules\\\\sharp',\r\ngyp info spawn args   '-Dnode_engine=v8',\r\ngyp info spawn args   '--depth=.',\r\ngyp info spawn args   '--no-parallel',\r\ngyp info spawn args   '--generator-output',\r\ngyp info spawn args   'C:\\\\Users\\\\67390\\\\Projects\\\\odahcam\\\\zxing-ts\\\\node_modules\\\\sharp\\\\build',\r\ngyp info spawn args   '-Goutput_dir=.' ]\r\ngyp info spawn C:\\Program Files (x86)\\MSBuild\\14.0\\bin\\msbuild.exe\r\ngyp info spawn args [ 'build/binding.sln',\r\ngyp info spawn args   '/clp:Verbosity=minimal',\r\ngyp info spawn args   '/nologo',\r\ngyp info spawn args   '/p:Configuration=Release;Platform=x64' ]\r\nBuilding the projects in this solution one at a time. To enable parallel build, please add the \"/m\" switch.\r\nTRACKER : error TRK0005: Failed to locate: \"CL.exe\". O sistema n�o pode encontrar o arquivo especificado. [C:\\Users\\67390\\Projects\\odahcam\\zxing-ts\\node_modules\\sharp\\build\\libvips-cpp.vcxproj]\r\n\r\n\r\ngyp ERR! build error\r\ngyp ERR! stack Error: `C:\\Program Files (x86)\\MSBuild\\14.0\\bin\\msbuild.exe` failed with exit code: 1\r\ngyp ERR! stack     at ChildProcess.onExit (C:\\Program Files\\nodejs\\node_modules\\npm\\node_modules\\node-gyp\\lib\\build.js:258:23)\r\ngyp ERR! stack     at emitTwo (events.js:125:13)\r\ngyp ERR! stack     at ChildProcess.emit (events.js:213:7)\r\ngyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:200:12)\r\ngyp ERR! System Windows_NT 10.0.15063\r\ngyp ERR! command \"C:\\\\Program Files\\\\nodejs\\\\node.exe\" \"C:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp\\\\bin\\\\node-gyp.js\" \"rebuild\"\r\ngyp ERR! cwd C:\\Users\\67390\\Projects\\odahcam\\zxing-ts\\node_modules\\sharp\r\n```"
      }
    ]
  },
  {
    "number": 866,
    "title": "How to avoid white background for the resized images",
    "created_at": "2017-07-06T11:37:46Z",
    "closed_at": "2017-09-05T19:20:12Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/866",
    "body": "Hi, \r\n\r\n I started using sharp for resizing images. The original image is bigger. I tried to resize it to a size less than the original dimensions. However,found white background is being created. How can I just get the original image without white background while preserving aspect ratio. \r\n\r\n```\r\n                       sharp(result.path+\"/\"+name)\r\n                       .resize(w,l)\r\n                       .max()\r\n                       .toBuffer()\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/866/comments",
    "author": "karthiks416",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-07-06T21:08:15Z",
        "body": "Hello, are you able to provide a sample image and the dimensions for which this is occurring?"
      },
      {
        "user": "lovell",
        "created_at": "2017-08-07T17:58:48Z",
        "body": "@karthiks416 Is this problem still occurring?"
      },
      {
        "user": "lovell",
        "created_at": "2017-09-05T19:20:12Z",
        "body": "Closing due to inactivity, please reopen if this problem is still occurring."
      }
    ]
  },
  {
    "number": 864,
    "title": "[question] concating images",
    "created_at": "2017-07-04T07:20:51Z",
    "closed_at": "2017-08-07T17:59:43Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/864",
    "body": "Lets say i have 4 100X100 images\r\nAnd i want to concat them for a 100X400 image.\r\n\r\nI've tired to do this:\r\n```js\r\n    const fullScreenshotSharp = sharp(Buffer.from([]), <any>{\r\n        create: {\r\n            width: 100,\r\n            height: 400,\r\n            channels: 4,\r\n            background: \"rgba(0, 0, 0, 0)\",\r\n        }\r\n    }); \r\n```\r\nAnd then \r\n```js\r\n        fullScreenshotSharp.overlayWith(screenshotFragmentBuffer, {\r\n            top: i,\r\n            left: 0,\r\n        });\r\n```\r\nFor each image with the appropriate `i`\r\nBut in each tick the rest of the image is covered with the ` background: \"rgba(0, 0, 0, 0)\"`\r\ndeleting my previous work\r\n\r\nThanks!\r\n\r\n*EDIT*\r\nWhat i did for now is to recreate sharp object on each iteration from the output of the last one.\r\n```\r\n        fullScreenshotSharp = await sharp(await fullScreenshotSharp.toBuffer());\r\n```\r\n\r\nI hope there's a better way",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/864/comments",
    "author": "Bnaya",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-07-04T11:14:14Z",
        "body": "#728 is tracking a possible future enhancement that will make this easier. #699 is also relevant here."
      },
      {
        "user": "joemanfoo",
        "created_at": "2017-07-21T03:35:21Z",
        "body": "I use the `extend` (1) method for enlarging the output image with appended images by `overlayWith` (2)"
      },
      {
        "user": "lovell",
        "created_at": "2017-08-07T17:59:43Z",
        "body": "@Bnaya Hope this answered your question. Please subscribe to the linked issues for updates should you be interested."
      },
      {
        "user": "Bnaya",
        "created_at": "2017-08-07T21:03:24Z",
        "body": "Will do, thanks"
      }
    ]
  },
  {
    "number": 860,
    "title": "Error: /lib64/libz.so.1: version `ZLIB_1.2.9' not found (required by /some_path/my_project/node_modules/sharp/build/Release/../../vendor/lib/libpng16.so.16)",
    "created_at": "2017-06-27T19:51:48Z",
    "closed_at": "2017-06-27T20:41:32Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/860",
    "body": "So... it was working... the server is CentOS... i'm working with nvm, pm2 and i know i got it running last time. Because of how all of that was installed(nvm, pm2) i had to switch users and `nvm use X`.. but it worked!! ... i remember i had to install sharp again(i think this is sth to do with another C/C++ compiled module - uws)... now no matter with what user(root, myUser) i `npm install` and run it i have this error^...any suggestions?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/860/comments",
    "author": "purepear",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-06-27T20:41:32Z",
        "body": "Please see #843"
      },
      {
        "user": "purepear",
        "created_at": "2017-06-28T09:48:54Z",
        "body": "Thank you @lovell ... i put `require('sharp')` on the first line of the app and the error was gone :)"
      },
      {
        "user": "elliotthill",
        "created_at": "2018-03-07T14:56:19Z",
        "body": "I'm getting this error and putting the require on the first line of the app is not a good solution for me. I only have one specific API endpoint that needs this.\r\n\r\nI don't have electron, node-canvas or any other image libraries being required.\r\n\r\nIts looking for 1.2.9:\r\n`Error: /lib64/libz.so.1: version `ZLIB_1.2.9' not found`\r\n\r\nBut 1.2.7 seems to be the one installed:\r\n\r\n`node -e \"console.log(process.versions.zlib)\"\r\n1.2.7\r\n`\r\n\r\nAny ideas?\r\n\r\nEDIT:\r\n\r\nAlso have glibc installed\r\n```\r\nInstalled Packages\r\nglibc.x86_64   \r\n```  "
      },
      {
        "user": "lovell",
        "created_at": "2018-03-07T16:04:13Z",
        "body": "@elliotthill Please see #892"
      }
    ]
  },
  {
    "number": 859,
    "title": "Is there a way to blend two images?",
    "created_at": "2017-06-26T19:06:12Z",
    "closed_at": "2017-08-07T18:00:30Z",
    "labels": [
      "question",
      "cookbook"
    ],
    "url": "https://github.com/lovell/sharp/issues/859",
    "body": "I would like to blend two images using a percentage (let's say 30% of image 1 and 70% of image 2). They will be exact same size. Is this possible to do with sharp package? I was not able to find much about this in documentation.\r\n\r\nThanks!",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/859/comments",
    "author": "Andriy-Kulak",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-06-27T10:30:55Z",
        "body": "Hello, assuming neither has a transparency (e.g. both JPEG) then this should be possible. Try something like the following (untested), which adds a transparency to the first image then composites this over the second image.\r\n\r\n```javascript\r\nconst { width, height } = await sharp.metadata(image1);\r\n\r\nconst thirtyPercentGrey = Math.round(0.30 * 255);\r\nconst thirtyPercentTransparency = Buffer.alloc(width * height, thirtyPercentGrey);\r\n\r\nconst image1WithThirtyPercentTransparency = await sharp(image1)\r\n  .joinChannel(\r\n    thirtyPercentTransparency,\r\n    { raw: { width, height, channels: 1 } }\r\n  )\r\n  .raw()\r\n  .toBuffer();\r\n\r\nconst result = await sharp(image2)\r\n  .overlayWith(\r\n    image1WithThirtyPercentTransparency,\r\n    { raw: { width, height, channels: 4 } }\r\n  )\r\n  .toBuffer();\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2017-08-07T18:00:30Z",
        "body": "@Andriy-Kulak Hope this answered your question."
      }
    ]
  },
  {
    "number": 854,
    "title": "How can i condition the max() or min() without breaking the chain",
    "created_at": "2017-06-22T14:47:22Z",
    "closed_at": "2017-07-22T19:55:54Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/854",
    "body": "Sharp(data.Body)\r\n      .resize(imageWidth, imageHeight)\r\n      (.max()<- this should be optional, for ex: if nocrop == true)\r\n      .toFormat(imageFormat)\r\n      .toBuffer()",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/854/comments",
    "author": "BogdanBucsa",
    "comments": [
      {
        "user": "papandreou",
        "created_at": "2017-06-22T16:20:56Z",
        "body": "I think this is pretty much your only option:\r\n\r\n```js\r\nvar sharpInstance = Sharp(data.Body)\r\n  .resize(imageWidth, imageHeight);\r\nif (nocrop) {\r\n  sharpInstance = sharpInstance.max();\r\n}\r\nsharpInstance\r\n  .toFormat(imageFormat)\r\n  .toBuffer();\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2017-06-22T17:09:57Z",
        "body": "If it absolutely has to be a single chain then the following is untested but will probably work:\r\n```javascript\r\nSharp(data.Body)\r\n  .resize(imageWidth, imageHeight)\r\n  [nocrop ? 'max' : 'crop']()\r\n  .toFormat(imageFormat)\r\n  .toBuffer()\r\n```\r\n...but please use @papandreou's suggestion for more easily maintained code :)"
      }
    ]
  },
  {
    "number": 852,
    "title": "How to do color manipulation?",
    "created_at": "2017-06-20T22:24:38Z",
    "closed_at": "2017-07-17T15:46:36Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/852",
    "body": "Hi guys,\r\n\r\nIs it possible to do image manipulation like brightening, darkening, contrast... or applying some function to the whole image on pixel by pixel basis?\r\n\r\nThanks,\r\nRussell",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/852/comments",
    "author": "RussellRC",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-06-21T05:44:04Z",
        "body": "Hello, did you see #609?"
      },
      {
        "user": "Algae666",
        "created_at": "2017-06-23T18:18:51Z",
        "body": "I 2nd the request to expose libvips modulate functionality in sharp, definitely would make a useful addition. (or 3rd, or whatever...)"
      },
      {
        "user": "lovell",
        "created_at": "2017-07-17T15:46:36Z",
        "body": "@RussellRC Hopefully #609 will provide what you need, please feel free to re-open with more details if not."
      }
    ]
  },
  {
    "number": 834,
    "title": "vips compiled with imagemagick fails with pdfs",
    "created_at": "2017-06-02T23:15:41Z",
    "closed_at": "2017-06-19T22:48:41Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/834",
    "body": "managed to create a custom tar ball with imagemagick but when I try to input a PDF it throws \"Input buffer contains unsupported image format\"\r\n\r\nI can see in sharp.format that magick is all true while pdf is all false, guessing this is due to not compiling with poppler which the libvips documentation says it should fallback to imagemagick which is what I'm looking for due to the lack of cmyk support with poppler.\r\n\r\nany hints? ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/834/comments",
    "author": "BoLaMN",
    "comments": [
      {
        "user": "BoLaMN",
        "created_at": "2017-06-03T00:56:10Z",
        "body": "managed to work around it by using gm to preconvert it and then use sharp to handle all the transforming but its probably not the nicest work around due to the increased dep size\r\n\r\n``` javascript\r\nlet preConvertFormats = \r\n  {pdf: 'png'};\r\n\r\nlet format = 'pdf';\r\nlet formatTo = preConvertFormats[format];\r\n  \r\nhttp.get(url, function(err, stream) {\r\n  let image;\r\n  if (formatTo) {\r\n    image = gm(stream).stream(formatTo).pipe(sharp());\r\n  } else { \r\n    image = stream.pipe(sharp()); \r\n  }\r\n});```"
      },
      {
        "user": "lovell",
        "created_at": "2017-06-03T06:33:25Z",
        "body": "Hello, was Imagemagick compiled with PDF support?"
      },
      {
        "user": "BoLaMN",
        "created_at": "2017-06-03T15:18:48Z",
        "body": "i compiled magick with `./configure --prefix=${TARGET} --enable-shared --disable-static --disable-dependency-tracking --with-modules --with-gslib --without-magick-plus-plus`\r\n\r\nim going to try compiling poppler with `--enable-cmyk: Include support for CMYK rasterization.` and see what the results are \r\n\r\ncheers"
      },
      {
        "user": "lovell",
        "created_at": "2017-06-07T17:38:57Z",
        "body": "Does #840 mean you've been able to make progress with this?"
      },
      {
        "user": "lovell",
        "created_at": "2017-06-19T22:48:41Z",
        "body": "Closing as I suspect from further questions that this is resolved, please feel free to re-open if not."
      }
    ]
  },
  {
    "number": 830,
    "title": "Installed sharp module on MacOs does not work on AWS Lambda(Ubuntu)",
    "created_at": "2017-05-30T12:14:28Z",
    "closed_at": "2017-05-30T12:30:43Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/830",
    "body": "I have my code and installed sharp module on MacOs Sierra.\r\nI zipped these in zip file.\r\nAfter that I am uploading my zip file to AWS Lambda.\r\nWhen I run my lambda function I always see error\r\n`module initialization error: Error\r\nat Module.load (module.js:487:32)\r\nat tryModuleLoad (module.js:446:12)\r\nat Function.Module._load (module.js:438:3)\r\nat Module.require (module.js:497:17)\r\nat require (internal/module.js:20:19)\r\n `\r\nIf I install sharp module on ubuntu os and copy it to  aws lambda - will work.\r\nHow I can fix it ?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/830/comments",
    "author": "vkkis93",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-05-30T12:30:43Z",
        "body": "Hello, the pre-compiled binaries for OS X will not work on Linux. `npm install` has to occur on the same platform as the runtime.\r\n"
      }
    ]
  },
  {
    "number": 827,
    "title": "ETIMEDOUT install failed on macOS 10.12, nodejs version:7.10.0",
    "created_at": "2017-05-27T12:01:15Z",
    "closed_at": "2017-06-19T22:50:49Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/827",
    "body": "install failed, and the console information:\r\n\r\n```\r\ngyp WARN install got an error, rolling back install\r\ngyp ERR! configure error \r\ngyp ERR! stack Error: read ETIMEDOUT\r\ngyp ERR! stack     at exports._errnoException (util.js:1050:11)\r\ngyp ERR! stack     at TLSWrap.onread (net.js:582:26)\r\ngyp ERR! System Darwin 16.5.0\r\ngyp ERR! command \"/usr/local/Cellar/node/7.10.0/bin/node\" \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/bin/node-gyp.js\" \"rebuild\"\r\ngyp ERR! cwd /Users/hh/2017spring/mynpm/img-resize/node_modules/sharp\r\ngyp ERR! node -v v7.10.0\r\ngyp ERR! node-gyp -v v3.5.0\r\ngyp ERR! not ok \r\nnpm WARN img-resize@0.1.1 No repository field.\r\nnpm ERR! Darwin 16.5.0\r\nnpm ERR! argv \"/usr/local/Cellar/node/7.10.0/bin/node\" \"/usr/local/bin/npm\" \"install\" \"sharp\" \"--save\"\r\nnpm ERR! node v7.10.0\r\nnpm ERR! npm  v4.2.0\r\nnpm ERR! code ELIFECYCLE\r\nnpm ERR! errno 1\r\n\r\nnpm ERR! sharp@0.17.3 install: `node-gyp rebuild`\r\nnpm ERR! Exit status 1\r\nnpm ERR! \r\nnpm ERR! Failed at the sharp@0.17.3 install script 'node-gyp rebuild'.\r\nnpm ERR! Make sure you have the latest version of node.js and npm installed.\r\nnpm ERR! If you do, this is most likely a problem with the sharp package,\r\nnpm ERR! not with npm itself.\r\nnpm ERR! Tell the author that this fails on your system:\r\nnpm ERR!     node-gyp rebuild\r\nnpm ERR! You can get information on how to open an issue for this project with:\r\nnpm ERR!     npm bugs sharp\r\nnpm ERR! Or if that isn't available, you can get their info via:\r\nnpm ERR!     npm owner ls sharp\r\nnpm ERR! There is likely additional logging output above.\r\n\r\nnpm ERR! Please include the following file with any support request:\r\nnpm ERR!     /Users/hh/.npm/_logs/2017-05-27T11_55_30_106Z-debug.log\r\n```\r\n\r\nThanks.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/827/comments",
    "author": "aircloud",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-05-27T12:57:19Z",
        "body": "sharp attempts to download libvips and its dependencies at `npm install` time. The \"Error: read ETIMEDOUT\" message suggests there is a (temporary) network or firewall connection problem trying to connect to `dl.bintray.com` via HTTPS."
      }
    ]
  },
  {
    "number": 809,
    "title": "Provide pre-compiled lib for windows",
    "created_at": "2017-05-18T03:18:26Z",
    "closed_at": "2017-05-18T06:34:55Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/809",
    "body": "can you please provide pre-compiled lib for windows?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/809/comments",
    "author": "lszhu",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-05-18T06:34:54Z",
        "body": "Hello, this is being tracked at #186."
      }
    ]
  },
  {
    "number": 808,
    "title": "how to get metadata of output image?",
    "created_at": "2017-05-16T15:21:49Z",
    "closed_at": "2017-05-16T16:57:49Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/808",
    "body": "the current example only get input image metadata, not output, if the input image's size is 1200x1200, we get  `{width: 1200, height: 1200, ...}` not `{width: 400, height: ?, ...}`\r\n\r\n\r\n```js\r\n      const sharpInstance = sharp(buf).resize(400);\r\n      const resizedBuf = await sharpInstance.toBuffer();\r\n      const metadata = await sharpInstance.metadata();\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/808/comments",
    "author": "hbakhtiyor",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-05-16T16:52:22Z",
        "body": "Hello, I think you're looking for the metadata of the processed image, which would be:\r\n```javascript\r\nconst metadata = await sharp(resizedBuf).metadata();\r\n```\r\n\r\nFrom v0.17.3+, you could also use:\r\n```javascript\r\nconst { data, info } = await sharpInstance.toBuffer({ resolveWithObject: true });\r\n```"
      },
      {
        "user": "hbakhtiyor",
        "created_at": "2017-05-16T16:57:33Z",
        "body": "thanks"
      },
      {
        "user": "ajhool",
        "created_at": "2018-08-02T02:36:49Z",
        "body": "Can this be achieved without calling toBuffer? It seems like a common use-case that somebody would need to know the metadata of the transformed file."
      },
      {
        "user": "lovell",
        "created_at": "2018-08-02T08:17:33Z",
        "body": "@ajhool Please can you provide a code sample demonstrating how you think this might be improved."
      },
      {
        "user": "kghost",
        "created_at": "2018-12-21T14:10:00Z",
        "body": "@lovell\r\nEg, I want to convert an unknown sized image to 200\\*100 with { fit: inside }. after resize call, the size of processed image is unknown, I need to calculate paddings and call extend to extend the image to 200\\*100.\r\n\r\n\r\nI don't know if it is a bug. After\r\n\r\n```\r\nimg.resize(200,100,{fit:sharp.fit.inside})\r\n``` \r\n\r\nI got an 100*100 image when input is square."
      }
    ]
  },
  {
    "number": 802,
    "title": "Sharp fails to build on Centos7 x64 using Node LTS",
    "created_at": "2017-05-08T21:42:02Z",
    "closed_at": "2017-05-09T08:59:45Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/802",
    "body": "inside of ../node_modules/sharp\r\n\r\n```\r\n$ node-gyp rebuild\r\ngyp info it worked if it ends with ok\r\ngyp info using node-gyp@3.6.1\r\ngyp info using node@6.10.3 | linux | x64\r\ngyp info spawn /usr/bin/python2\r\ngyp info spawn args [ '/usr/lib/node_modules/node-gyp/gyp/gyp_main.py',\r\ngyp info spawn args   'binding.gyp',\r\ngyp info spawn args   '-f',\r\ngyp info spawn args   'make',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   '/vagrant/client-website/node_modules/sharp/build/config.gypi',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   '/usr/lib/node_modules/node-gyp/addon.gypi',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   '/home/vagrant/.node-gyp/6.10.3/include/node/common.gypi',\r\ngyp info spawn args   '-Dlibrary=shared_library',\r\ngyp info spawn args   '-Dvisibility=default',\r\ngyp info spawn args   '-Dnode_root_dir=/home/vagrant/.node-gyp/6.10.3',\r\ngyp info spawn args   '-Dnode_gyp_dir=/usr/lib/node_modules/node-gyp',\r\ngyp info spawn args   '-Dnode_lib_file=node.lib',\r\ngyp info spawn args   '-Dmodule_root_dir=/vagrant/client-website/node_modules/sharp',\r\ngyp info spawn args   '-Dnode_engine=v8',\r\ngyp info spawn args   '--depth=.',\r\ngyp info spawn args   '--no-parallel',\r\ngyp info spawn args   '--generator-output',\r\ngyp info spawn args   'build',\r\ngyp info spawn args   '-Goutput_dir=.' ]\r\nPackage vips was not found in the pkg-config search path.\r\nPerhaps you should add the directory containing `vips.pc'\r\nto the PKG_CONFIG_PATH environment variable\r\nNo package 'vips' found\r\ngyp: Call to 'PKG_CONFIG_PATH=\":$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig:/usr/lib/pkgconfig\" pkg-config --libs vips' returned exit status 1 while in binding.gyp. while trying to load binding.gyp\r\ngyp ERR! configure error\r\ngyp ERR! stack Error: `gyp` failed with exit code: 1\r\ngyp ERR! stack     at ChildProcess.onCpExit (/usr/lib/node_modules/node-gyp/lib/configure.js:336:16)\r\ngyp ERR! stack     at emitTwo (events.js:106:13)\r\ngyp ERR! stack     at ChildProcess.emit (events.js:191:7)\r\ngyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:215:12)\r\ngyp ERR! System Linux 3.10.0-514.16.1.el7.x86_64\r\ngyp ERR! command \"/usr/bin/node\" \"/usr/bin/node-gyp\" \"rebuild\"\r\ngyp ERR! cwd /vagrant/client-website/node_modules/sharp\r\ngyp ERR! node -v v6.10.3\r\ngyp ERR! node-gyp -v v3.6.1\r\ngyp ERR! not ok\r\n```\r\n\r\nshould I try installing vips from source? ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/802/comments",
    "author": "troyxmccall",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-05-08T22:13:17Z",
        "body": "Hello, which version of sharp is this? Does the latest v0.17.3 work?"
      },
      {
        "user": "troyxmccall",
        "created_at": "2017-05-08T22:21:41Z",
        "body": "hey @lovell, it's sharp@0.11.4 from Laravel Elixir/ gulp-responsive, if I do a clean install of sharp@0.17.3 it works. Apologies, it's probably a dependency issue. I should've checked that before filing this issue. "
      }
    ]
  },
  {
    "number": 782,
    "title": "Cannot crop image with my coords",
    "created_at": "2017-04-23T01:34:26Z",
    "closed_at": "2017-04-23T21:10:17Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/782",
    "body": "Isn't into the API something like image.crop(10,20,30,40)? If not tell me why.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/782/comments",
    "author": "leandrocurioso",
    "comments": [
      {
        "user": "abpai",
        "created_at": "2017-04-23T09:26:43Z",
        "body": "Have you considered using extract?"
      },
      {
        "user": "leandrocurioso",
        "created_at": "2017-04-23T16:35:31Z",
        "body": "ohh I see thanks!"
      }
    ]
  },
  {
    "number": 777,
    "title": "Bad extract area Error. while using valid parameters.",
    "created_at": "2017-04-21T06:52:59Z",
    "closed_at": "2017-04-21T08:59:35Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/777",
    "body": "Hi people. I'm getting Bad extract area error with parameters below.\r\n\r\nmetadata of image: \r\n```javascript\r\n{ format: 'jpeg',\r\n  width: 1200,\r\n  height: 675,\r\n  space: 'srgb',\r\n  channels: 3,\r\n  hasProfile: false,\r\n  hasAlpha: false }\r\n\r\n```\r\nextract parameter object:\r\n\r\n`{ width: 1123, left: 0, height: 675, top: 0 }`\r\n\r\nmy code is not complex: \r\n\r\n```javascript\r\nlet zoomedOrigin = sharp(names.origin);\r\n\r\n        zoomedOrigin\r\n        .resize(zoomedOriginWidth)\r\n        .metadata()\r\n        .then((metadata) => {\r\n          console.log(metadata) // { format: 'jpeg',   width: 1200,   height: 675,   space: 'srgb', channels: 3, hasProfile: false, hasAlpha: false }\r\n          let p0x = this.imageData.manipulation.x * metadata.width;\r\n          let p0y = this.imageData.manipulation.y * metadata.height;\r\n\r\n          let hParams = this.getDimensions(p0x, metadata.width, ImageManipulation.PRODUCT_ORIGIN_WIDTH);\r\n          let vParams = this.getDimensions(p0y, metadata.height, ImageManipulation.PRODUCT_ORIGIN_HEIGHT);\r\n\r\n          let extract = {\r\n            width: parseInt(hParams.dimension),\r\n            left: parseInt(hParams.position),\r\n            height: Math.ceil(vParams.dimension),\r\n            top: Math.ceil(vParams.position)\r\n          };\r\n\r\n          console.log(extract); // { width: 1123, left: 0, height: 675, top: 0 }\r\n\r\n          return zoomedOrigin\r\n            .extract(extract)\r\n            .toFile(tempName);\r\n        })\r\n        .then((l) => {\r\n          console.log(l)\r\n          resolve(this.imageData);\r\n        }).\r\n        catch((err) => {\r\n          console.error(err);\r\n        });\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/777/comments",
    "author": "AttilaSATAN",
    "comments": [
      {
        "user": "AttilaSATAN",
        "created_at": "2017-04-21T08:17:03Z",
        "body": "Hmm it seems I have to save resized image before getting meta."
      },
      {
        "user": "lovell",
        "created_at": "2017-04-21T08:59:35Z",
        "body": "That's correct. The `resize(zoomedOriginWidth)` operation occurs only when an output image is requested via `toFile()`. `metadata()` provides fast access to the input image, `names.origin` in your example."
      }
    ]
  },
  {
    "number": 775,
    "title": "node-gyp rebuild freezes",
    "created_at": "2017-04-20T10:40:36Z",
    "closed_at": "2017-05-27T21:46:57Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/775",
    "body": "Today faced a problem:\r\nDoing as regular `npm install` (the same behaviour with `npm install --save-dev sharp`) and process freeze on:\r\n> sharp@0.17.3 install /path/to/proj/node_modules/sharp\r\n> node-gyp rebuild\r\n\r\nWhen kill the process (`Ctrl+C`) receive trace info:\r\n```Traceback (most recent call last):\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/gyp_main.py\", line 16, in <module>\r\n    sys.exit(gyp.script_main())\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/__init__.py\", line 545, in script_main\r\n    return main(sys.argv[1:])\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/__init__.py\", line 538, in main\r\n    return gyp_main(args)\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/__init__.py\", line 514, in gyp_main\r\n    options.duplicate_basename_check)\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/__init__.py\", line 130, in Load\r\n    params['parallel'], params['root_targets'])\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/input.py\", line 2775, in Load\r\n    variables, includes, depth, check, True)\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/input.py\", line 417, in LoadTargetBuildFile\r\n    build_file_data, PHASE_EARLY, variables, build_file_path)\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/input.py\", line 1292, in ProcessVariablesAndConditionsInDict\r\n    build_file)\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/input.py\", line 1307, in ProcessVariablesAndConditionsInList\r\n    ProcessVariablesAndConditionsInDict(item, phase, variables, build_file)\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/input.py\", line 1266, in ProcessVariablesAndConditionsInDict\r\n    ProcessConditionsInDict(the_dict, phase, variables, build_file)\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/input.py\", line 1145, in ProcessConditionsInDict\r\n    variables, build_file)\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/input.py\", line 1266, in ProcessVariablesAndConditionsInDict\r\n    ProcessConditionsInDict(the_dict, phase, variables, build_file)\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/input.py\", line 1145, in ProcessConditionsInDict\r\n    variables, build_file)\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/input.py\", line 1214, in ProcessVariablesAndConditionsInDict\r\n    variables, build_file, 'variables')\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/input.py\", line 1221, in ProcessVariablesAndConditionsInDict\r\n    expanded = ExpandVariables(value, phase, variables, build_file)\r\n  File \"/usr/local/lib/node_modules/npm/node_modules/node-gyp/gyp/pylib/gyp/input.py\", line 911, in ExpandVariables\r\n    p_stdout, p_stderr = p.communicate('')\r\n  File \"/usr/lib/python2.7/subprocess.py\", line 799, in communicate\r\n    return self._communicate(input)\r\n  File \"/usr/lib/python2.7/subprocess.py\", line 1409, in _communicate\r\n    stdout, stderr = self._communicate_with_poll(input)\r\n  File \"/usr/lib/python2.7/subprocess.py\", line 1463, in _communicate_with_poll\r\n    ready = poller.poll()\r\nKeyboardInterrupt\r\n```\r\n\r\nIf I do rebuild `node-gyp rebuild` right in module (cd node_modules/sharp) got:\r\n```\r\ngyp info it worked if it ends with ok\r\ngyp info using node-gyp@3.6.0\r\ngyp info using node@6.8.0 | linux | x64\r\ngyp info spawn /usr/bin/python2\r\ngyp info spawn args [ '/usr/lib/node_modules/node-gyp/gyp/gyp_main.py',\r\ngyp info spawn args   'binding.gyp',\r\ngyp info spawn args   '-f',\r\ngyp info spawn args   'make',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   '/path/to/proj/node_modules/sharp/build/config.gypi',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   '/usr/lib/node_modules/node-gyp/addon.gypi',\r\ngyp info spawn args   '-I',\r\ngyp info spawn args   '/home/dev/.node-gyp/6.8.0/include/node/common.gypi',\r\ngyp info spawn args   '-Dlibrary=shared_library',\r\ngyp info spawn args   '-Dvisibility=default',\r\ngyp info spawn args   '-Dnode_root_dir=/home/dev/.node-gyp/6.8.0',\r\ngyp info spawn args   '-Dnode_gyp_dir=/usr/lib/node_modules/node-gyp',\r\ngyp info spawn args   '-Dnode_lib_file=node.lib',\r\ngyp info spawn args   '-Dmodule_root_dir=/path/to/proj/node_modules/sharp',\r\ngyp info spawn args   '-Dnode_engine=v8',\r\ngyp info spawn args   '--depth=.',\r\ngyp info spawn args   '--no-parallel',\r\ngyp info spawn args   '--generator-output',\r\ngyp info spawn args   'build',\r\ngyp info spawn args   '-Goutput_dir=.' ]\r\n```\r\n\r\nSystem: Debian\r\nnode:  6.8.0\r\nnode-gyp: 3.6.0\r\nnpm: 3.8.9\r\npython: 2.7.9\r\nGCC: 4.9.2\r\n\r\n**UPD:**  After about 30-40 minutes it finally build. But suppose it's not normal. ",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/775/comments",
    "author": "alexKazarin",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-04-20T16:41:25Z",
        "body": "Hello, my best guess would be either a temporary network problem or perhaps reaching a file descriptor limit."
      },
      {
        "user": "lovell",
        "created_at": "2017-05-13T19:36:36Z",
        "body": "@alexKazarin Were you able to make any progress understanding what might be causing this?"
      },
      {
        "user": "alexKazarin",
        "created_at": "2017-05-27T21:46:57Z",
        "body": "@lovell Sorry for late reply, really seems it was network problem (but why exactly unfortunately don't know). Seems issue may be closed. Thank you."
      }
    ]
  },
  {
    "number": 766,
    "title": "Using sharp with react",
    "created_at": "2017-04-11T18:33:37Z",
    "closed_at": "2017-04-11T21:04:05Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/766",
    "body": "Is there a reason this shouldn't work with React? I was using sharp and it worked well until I moved the front end to React. Now, I get `ERROR in ./~/sharp/index.js\r\nModule not found: Error: Can't resolve './build/Release/sharp' in '/path/to/node_modules/sharp'` as if it doesn't recognize the .node extension.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/766/comments",
    "author": "TimMenninger",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-04-11T19:42:21Z",
        "body": "Hello, are you trying to use sharp in a web browser? If so, that won't work as it is a native module requiring the Node runtime."
      },
      {
        "user": "TimMenninger",
        "created_at": "2017-04-11T21:04:05Z",
        "body": "Shoot, I am. Sorry for the novice question, I'm new to web dev... I'll Google for workarounds.\r\nThanks!"
      },
      {
        "user": "ohenepee",
        "created_at": "2018-02-16T09:45:44Z",
        "body": "@lovell Would you happen to know any library similar to yours that work in the browser? Or could you compile port yours to WebAssembly? Wish I knew C++, perhaps I would have done the WASM part by now. :(\r\n\r\n@TimMenninger did you find the worksround?\r\n\r\nI'm particularly interested in WebP support."
      }
    ]
  },
  {
    "number": 763,
    "title": "Is there a method to create an sharp image from a 3D or 2D array",
    "created_at": "2017-04-10T08:39:28Z",
    "closed_at": "2017-05-06T18:30:52Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/763",
    "body": " exp, how to create a sharp image from sth. like\r\n````\r\n[[[123,123,123,100],[255,254,253,100],[1,2,3,4]........],\r\n[[...,...,...,...],[...,...,...,...].......],\r\n.......\r\n[..............]]\r\n````\r\nor sth like\r\n````\r\n[[{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4}...],\r\n[{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4}...],\r\n[{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4}...],\r\n......\r\n[{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4},{r:1,g:2,b:3,a:4}...]]\r\n````\r\n?\r\n\r\nbtw How to label this as 'question' ?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/763/comments",
    "author": "zszszsz",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-04-10T11:29:32Z",
        "body": "Hello, a 2D array will need flattening into RGBA order, plus the width and height need to be passed to the sharp constructor, something like (untested):\r\n```javascript\r\nconst data2d = [ [r1, g1, b1, a1], [r2, g2, b2, a2], ... ];\r\nconst flat = [].concat.apply(data2d);\r\n\r\nconst width = ?;\r\nconst height = ?;\r\n\r\n// assert flat.length === width * height * channels \r\n\r\nsharp(flat, { raw: { channels: 4, width, height })...\r\n```"
      },
      {
        "user": "lovell",
        "created_at": "2017-05-06T18:30:52Z",
        "body": "Hope this answered your question, feel free to re-open if not."
      },
      {
        "user": "zszszsz",
        "created_at": "2017-05-27T06:49:16Z",
        "body": "There is a problem when using `[].concat.apply`\r\n\r\nIf there are too much pixels, it will result in `Maximum call stack size exceeded`"
      },
      {
        "user": "lovell",
        "created_at": "2017-05-27T06:56:45Z",
        "body": "@zszszsz Perhaps try a for loop instead to avoid the recursion (untested):\r\n```javascript\r\nconst data2d = [ [r1, g1, b1, a1], [r2, g2, b2, a2], ... ];\r\nconst flat = [];\r\n\r\nfor (let i = 0; i < data2d.length; i++) {\r\n  flat.push(data2d[i][0]);\r\n  flat.push(data2d[i][1]);\r\n  flat.push(data2d[i][2]);\r\n  flat.push(data2d[i][3]);\r\n}\r\n```\r\n"
      }
    ]
  },
  {
    "number": 757,
    "title": "No promise response or error.",
    "created_at": "2017-04-05T21:09:37Z",
    "closed_at": "2017-04-06T00:50:11Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/757",
    "body": "I have a command that was working in `16.2.0` but stopped responding with `17.3.0`.   I tried my old method first and have even updated it with noted depreciations. \r\n\r\n**Older method**\r\n```\r\nsharpObj.png().quality( PIXEL_QUALITY ).limitInputPixels(PIXEL_LIMIT).resize(2000,2000).toBuffer(  )\r\n            .then( function returnOutputFile( buffer ) {\r\n                return buffer;\r\n            }).catch( logReadError );\r\n```\r\n\r\n\r\n**New Method**\r\n```\r\nsharpObj.png({ quality: PIXEL_QUALITY }).limitInputPixels(PIXEL_LIMIT).resize(2000,2000).toBuffer( { 'resolveWithObject': true } )\r\n            .then( function returnOutputFile( buffer ) {\r\n                return buffer;\r\n            }).catch( logReadError );\r\n```\r\n\r\nProblem is I recieve no error response.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/757/comments",
    "author": "webbrandon",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-04-05T21:29:10Z",
        "body": "Hello, for this example you can omit the new, optional `resolveWithObject: true` setting.\r\n\r\nIf you really need `resolveWithObject: true` then perhaps try:\r\n```diff\r\n-                return buffer;\r\n+                return buffer.data;\r\n```\r\n"
      },
      {
        "user": "webbrandon",
        "created_at": "2017-04-05T21:42:48Z",
        "body": "Thank you for responding @lovell.  I have tried omitting this and still get a stuck process.  Ensured I removed old global and local instances of `sharp` also.  \r\n\r\nI am on Mac OSX 10.11.6.  Could there be a new libvips dependency not included in the common files?  Is there some sort of development mode that produces more verbose logging?\r\n\r\n> If you really need resolveWithObject: true then perhaps try:\r\n\r\nYes I would love to use it so I can pass filesize back to the header."
      },
      {
        "user": "lovell",
        "created_at": "2017-04-05T21:46:55Z",
        "body": "Are you able to share how `sharpObj` is constructed?\r\n\r\nAs an aside, the `quality` option of `png({ quality: PIXEL_QUALITY })` is ignored as PNGs are lossless."
      },
      {
        "user": "webbrandon",
        "created_at": "2017-04-06T01:03:43Z",
        "body": "> As an aside, the quality option of png({ quality: PIXEL_QUALITY }) is ignored as PNGs are lossless.\r\n\r\nThank you for pointing that out but the way this is implemented is dynamic on format, I just chose a bad example to pull.\r\n\r\nThe issue ended up being a issue with node.js not sending the proper error. As always sharp is perfect!"
      }
    ]
  },
  {
    "number": 750,
    "title": "Error: Module version mismatch. Expected 48, got 47",
    "created_at": "2017-04-01T10:03:48Z",
    "closed_at": "2017-04-26T16:49:11Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/750",
    "body": "I am geting this error after updating node fro. 5.0.0 to 6.10.0\r\n\r\nnpm version is 3.10.10\r\n\r\nmodule.js:597\r\n  return process.dlopen(module, path._makeLong(filename));\r\n                 ^\r\nError: Module version mismatch. Expected 48, got 47.\r\n    at Error (native)\r\n    at Object.Module._extensions..node (module.js:597:18)\r\n    at Module.load (module.js:487:32)\r\n    at tryModuleLoad (module.js:446:12)\r\n    at Function.Module._load (module.js:438:3)\r\n    at Module.require (module.js:497:17)\r\n    at require (internal/module.js:20:19)\r\n    at Object.<anonymous> (/home/sandeep/Bluewings/bluewings-pro/node_modules/sharp/index.js:12:13)\r\n    at Module._compile (module.js:570:32)\r\n    at Object.Module._extensions..js (module.js:579:10)\r\n    at Module.load (module.js:487:32)\r\n    at tryModuleLoad (module.js:446:12)\r\n    at Function.Module._load (module.js:438:3)\r\n    at Module.require (module.js:497:17)\r\n    at require (internal/module.js:20:19)\r\n    at Object.<anonymous> ()\r\n    at Module._compile (module.js:570:32)\r\n    at Object.Module._extensions..js (module.js:579:10)\r\n    at Module.load (module.js:487:32)\r\n    at tryModuleLoad (module.js:446:12)\r\n    at Function.Module._load (module.js:438:3)\r\n    at Module.require (module.js:497:17)\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/750/comments",
    "author": "sanmish16",
    "comments": [
      {
        "user": "xiongjiabin",
        "created_at": "2017-04-01T11:25:09Z",
        "body": "rm node_modules and npm install fixed the problem for me.\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2017-04-01T12:48:05Z",
        "body": "Please see #468 #733 #740"
      }
    ]
  },
  {
    "number": 733,
    "title": "Module version mismatch. Expected 47, got 48.",
    "created_at": "2017-03-14T18:14:31Z",
    "closed_at": "2017-03-17T06:46:49Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/733",
    "body": "Thanks for the help - I've seen this issue with other npm libs but haven't been able to resolve by switching around node versions etc. I have tried 6.0-7.7.2. Sharp runs great on my local machine but I get this error every time on AWS instance. \r\n\r\nError: Module version mismatch. Expected 47, got 48.\r\n    at Error (native)\r\n    at Object.Module._extensions..node (module.js:444:18)\r\n    at Module.load (module.js:357:32)\r\n    at Function.Module._load (module.js:314:12)\r\n    at Module.require (module.js:367:17)\r\n    at require (internal/module.js:16:19)\r\n    at Object.<anonymous> (/home/ec2-user/projects/resizer/node_modules/sharp/lib/constructor.js:8:15)\r\n    at Module._compile (module.js:417:34)\r\n    at Object.Module._extensions..js (module.js:426:10)\r\n    at Module.load (module.js:357:32)\r\n    at Function.Module._load (module.js:314:12)\r\n    at Module.require (module.js:367:17)\r\n    at require (internal/module.js:16:19)\r\n    at Object.<anonymous> (/home/ec2-user/projects/resizer/node_modules/sharp/lib/index.js:3:15)\r\n    at Module._compile (module.js:417:34)\r\n    at Object.Module._extensions..js (module.js:426:10)",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/733/comments",
    "author": "alanweissman",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-03-14T20:48:52Z",
        "body": "Hello, did you see #468?"
      },
      {
        "user": "alanweissman",
        "created_at": "2017-03-14T21:32:54Z",
        "body": "Thanks Lovell my mistake for the dupe I searched earlier but didn't see #468. Appreciate the help!"
      },
      {
        "user": "DroidGar",
        "created_at": "2017-03-16T21:13:16Z",
        "body": "same problem to me, npm install doesnt solve the problem, any help?"
      },
      {
        "user": "alanweissman",
        "created_at": "2017-03-16T22:44:20Z",
        "body": "Using 'n' and not 'nvm' I was able to update my AWS machine to node 7.6.0, rm -rf node_modules, npm cache clean, npm cache clear, npm install. Make sure node version in /usr/local/bin matches version on command line. Good luck!"
      },
      {
        "user": "DroidGar",
        "created_at": "2017-03-16T22:59:52Z",
        "body": "I resolve it by installing 'n', my mistake was install twice node.js to keep same version use command: n 'node_x.x.x' this way you select witch node u want to use (Use the same version of runing node). and problem resolved."
      },
      {
        "user": "lovell",
        "created_at": "2017-03-17T06:46:49Z",
        "body": "Glad to hear you both managed to get the correct version of node installed and working."
      }
    ]
  },
  {
    "number": 716,
    "title": "Checking Quality of a webp image",
    "created_at": "2017-02-21T06:19:27Z",
    "closed_at": "2017-03-27T19:39:08Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/716",
    "body": "Might be a stupid thing on my part, but I am not able to check for a WebP image's quality level using `sharp.metadata()` or `identify -verbose`. Pointers will be appreciated.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/716/comments",
    "author": "rn4391",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-02-21T13:49:46Z",
        "body": "Hello Rahul, as far as I know, the value of the \"quality\" setting is not preserved in a WebP file.\r\n\r\nAt WebP compression time, the \"quality\" setting is used to control the level of quantisation in the VP8 encoder (lower quality = quantise more = discard more data). Given this step is adaptive and splits the image into (up to) four regions, I'm not sure it's even possible to reverse engineer a single value given the compressed data."
      },
      {
        "user": "lovell",
        "created_at": "2017-03-27T19:39:08Z",
        "body": "Closing this as I hope your question has been answered, even if that answer is only \"sorry, not possible\"."
      }
    ]
  },
  {
    "number": 712,
    "title": "Converting tiff to png",
    "created_at": "2017-02-13T11:48:41Z",
    "closed_at": "2017-02-13T15:42:07Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/712",
    "body": "I have tiff image with 200 pages. How can i get needed page or all pages in png format? \r\nWhen i do convert to png result always will be first page",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/712/comments",
    "author": "RomanZaiats",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-02-13T12:24:02Z",
        "body": "Hello, please see #654 for a PR-in-progress that will expose the ability to select a given page for TIFF-based input."
      },
      {
        "user": "RomanZaiats",
        "created_at": "2017-02-13T13:46:46Z",
        "body": "Thanks! Is it works with stream?  \r\nCan i get needed page in pipeline. Something like: readstream.pipe(sharp({page:4})).pipe(writestream)?"
      },
      {
        "user": "RomanZaiats",
        "created_at": "2017-02-13T14:50:42Z",
        "body": "  sharp('D:/cps/images/manypages.tif', {page: 4}).png().toFile('D:/cps/images/output_4page.png', function(err) {\r\n            if(err) console.log(err);\r\n        });\r\nThis code doesnt work(.  Return first page\r\nsharp version \"^0.17.1\""
      },
      {
        "user": "lovell",
        "created_at": "2017-02-13T15:42:07Z",
        "body": "This feature is a proposed Pull Request that requires further work before it can be merged and released."
      },
      {
        "user": "RomanZaiats",
        "created_at": "2017-02-13T15:57:14Z",
        "body": "Thank you very much!"
      }
    ]
  },
  {
    "number": 694,
    "title": "sharp().toBuffer() Promise doesn't contain info",
    "created_at": "2017-01-31T08:50:29Z",
    "closed_at": "2017-01-31T12:39:52Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/694",
    "body": "Unfortunately the `toBuffer()` Promise doesn't contain the `info` property compared to calling `toBuffer()` with a callback...\r\n\r\n```javascript\r\nsharp()\r\n.toBuffer()\r\n.then((buffer, info) => {\r\n  console.log(buffer); // the buffer\r\n  console.log(info); // undefined\r\n})\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/694/comments",
    "author": "Vispercept",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-01-31T11:41:29Z",
        "body": "Hello, did you see #143?"
      },
      {
        "user": "Vispercept",
        "created_at": "2017-01-31T12:39:52Z",
        "body": "No didn't see that. Thanks."
      }
    ]
  },
  {
    "number": 692,
    "title": "Append output to existing multi-page TIFF file",
    "created_at": "2017-01-30T13:22:55Z",
    "closed_at": "2017-03-23T00:02:57Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/692",
    "body": "I have to convert  png file to tiff,  and add that file to another tiff. For instance i have  one png file, and one tiff file  with 3 pages. i'd like to convert the png to tiff and add  it inside that tiff file.In other words that tiff file with 3 pages should be 4 pages after that.I know how to convert  png to tiff but how could i add that coverted file inside of tiff???",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/692/comments",
    "author": "SargisParunakyan",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-01-30T14:16:23Z",
        "body": "Hello, sharp/libvips is probably the wrong tool for the job. Perhaps try the `tiffcp` command line tool to join/append multi-page TIFF files."
      },
      {
        "user": "jcupitt",
        "created_at": "2017-02-01T13:49:44Z",
        "body": "libvips 8.5 (due in March 2017) supports \"toilet roll\" multipage images. These are multipage images where each page has identical dimensions, and they can be loaded as a very tall, thin image (a toilet roll), with a little metadata giving the sheet size. \r\n\r\nIf all of your images are identical, you can load your multipage tiff, append the png, write back again and it should just work with no changes to sharp. \r\n\r\nAs @lovell says, `tiffcp` might be a better choice. "
      },
      {
        "user": "SargisParunakyan",
        "created_at": "2017-02-02T08:54:52Z",
        "body": " @lovell @jcupitt  \r\n I  would like to do that through node js code not with cmd command.if i am not mistaken the tiffcp is tool for cmd.Is there any way to do that through node js code?"
      },
      {
        "user": "lovell",
        "created_at": "2017-02-02T14:09:52Z",
        "body": "@SargisParunakyan This is probably a question more suited to Stack Overflow."
      },
      {
        "user": "lovell",
        "created_at": "2017-03-23T00:02:57Z",
        "body": "Closing due to inactivity but please re-open if questions remain."
      }
    ]
  },
  {
    "number": 690,
    "title": "Thread frozen by lib with console.log",
    "created_at": "2017-01-24T17:29:07Z",
    "closed_at": "2017-01-25T13:14:39Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/690",
    "body": "Hello,\r\n\r\nWe are leveraging the library to do some basic image resize on an existing nodejs app, but we have an issue we can't explain.\r\n\r\nI have a code snippet that reproduces the issue, though it's not systematic but random, it's more than 80% failing.\r\n\r\nHere is the code snippet for a full app.js, taken from the documentation about metadata (except the file is written as jpg in a file)\r\n\r\n\r\n```\r\n\"use strict\";\r\n\r\nvar sharp=require('sharp');\r\n\r\nvar image = sharp('/tmp/t.jpg');\r\nimage\r\n  .metadata()\r\n  .then(metadata => {\r\n    console.log('size before resizing');\r\n    return image\r\n      .resize(Math.round(metadata.width / 2))\r\n      .jpeg()\r\n      .toFile('/tmp/ts.jpg');\r\n  })\r\n  .then(data => { });\r\n```\r\n\r\n\r\nWhen commenting the console.log line, it's working fine. But when it's there, it's blocking nodejs almost every time. If I press CTRL-C, the rest of the code succeed.\r\n\r\nDo you have any clue on what's happening? Have you heard about this kind of issue with sharp?\r\n\r\nThanks!\r\n\r\nRegards,\r\nGreg",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/690/comments",
    "author": "sogetimaitral",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-01-24T18:35:47Z",
        "body": "Hello, do you see any errors when you add a `catch` handler to the Promise chain?\r\n```javascript\r\n  .then(data => { })\r\n  .catch(console.log);\r\n```"
      },
      {
        "user": "sogetimaitral",
        "created_at": "2017-01-25T08:40:33Z",
        "body": "Hello,\r\n\r\nWhen adding the catch, nothing more is shown. This is coherent with the fact that a CTRL-C makes the program work again.\r\nWere you able to reproduce the issue with the snippet? The behavior is really strange, and we can't figure out why, even with such a small snippet."
      },
      {
        "user": "lovell",
        "created_at": "2017-01-25T11:40:33Z",
        "body": "I am unable to reproduce this on OS X, Node v6.9.4, sharp v0.17.1. With what combinations are you seeing this behaviour?\r\n\r\nThe mention of Ctrl-C sounds like some form of process forking or piping is occurring external to your sample code."
      },
      {
        "user": "sogetimaitral",
        "created_at": "2017-01-25T13:14:39Z",
        "body": "I am using the same versions. But to get them, I restarted my linux, and now I don't have the issue anymore... \r\n\r\nI don't know what happened, and that's what is worrying, but it may be something totally unrelated. The code is running on a VM with 2 cores, maybe something was messed up on it until I rebooted it. I'll keep testing forward. \r\n\r\nThanks for the answer, and sorry for the inconvenience :)"
      }
    ]
  },
  {
    "number": 688,
    "title": "Error: extract_area: bad extract area",
    "created_at": "2017-01-19T13:00:31Z",
    "closed_at": "2017-01-19T13:54:46Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/688",
    "body": "Hello, I'm using 512x512 image. First I resize it then extract and expecting readable stream data but it shows me \"Error: extract_area: bad extract area\" error.\r\nHere's the code;\r\n\r\n```\r\ntest2(x, y, zoom) {\r\n        const width = 500;\r\n        const height = 500;\r\n\r\n        return this.image\r\n            .metadata()\r\n            .then((metadata) => {\r\n                var resizedWidth = metadata.width * zoom;\r\n                var resizedHeight = metadata.height * zoom;\r\n                var left = parseInt(resizedWidth * x);\r\n                var top = parseInt(resizedHeight * y);\r\n                return this.image\r\n                    .resize(resizedWidth, resizedHeight)\r\n                    .extract({left: left, top: top, width: width, height: height})\r\n                    .jpeg()\r\n                    .resize(500);\r\n            });\r\n}\r\n```\r\nThanks.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/688/comments",
    "author": "erhankilic",
    "comments": [
      {
        "user": "erhankilic",
        "created_at": "2017-01-19T13:06:21Z",
        "body": "Ahhh, I must say, resizedWidth = 1024, resizedHeight = 1024 (because i used zoom = 0,5) and left = 204, right = 204 (because i used x = 0,2 and y = 0,2). Extract area is valid."
      },
      {
        "user": "lovell",
        "created_at": "2017-01-19T13:39:45Z",
        "body": "Hello, I think the problem here is that `.resize(500)` will replace the values passed to `.resize(resizedWidth, resizedHeight)`. Whilst you can chain `extract` with `resize` (with `extract`), you can't chain `resize` with itself.\r\n\r\nIf you need the output image to always be 500 pixels wide, you might be able to extract-then-resize via `.extract(...).resize(500, resizedHeight)`, making sure to alter your `resizedHeight` calculation accordingly."
      },
      {
        "user": "erhankilic",
        "created_at": "2017-01-19T13:54:46Z",
        "body": "Ahhh, thanks,\r\n\r\nI fixed it with this codes.\r\n\r\n```\r\nreturn this.image\r\n            .metadata()\r\n            .then((metadata) => {\r\n                var resizedWidth = metadata.width * zoom;\r\n                var resizedHeight = metadata.height * zoom;\r\n                var left = parseInt(resizedWidth * x);\r\n                var top = parseInt(resizedHeight * y);\r\n                return this.image\r\n                    .jpeg()\r\n                    .resize(resizedWidth, resizedHeight)\r\n                    .toBuffer()\r\n                    .then((data) => {\r\n                        return sharp(data)\r\n                            .extract({left: left, top: top, width: width, height: height})\r\n                            .resize(width, height);\r\n                    })\r\n            });\r\n```"
      },
      {
        "user": "imCorfitz",
        "created_at": "2020-10-18T08:10:44Z",
        "body": "I know this may be an old thread - but I experienced this issue recently, and it was due to the orientation of the image on the server, not being equivalent of the interpreted orientation in the browser. Say I took a picture with my iPhone, then safari and the phone knew how to properly orient the photo, but the server no.\r\n\r\nIn order to fix that, I simply initialised the sharp procedure with `.rotate()`, which took care of that. \r\n\r\n`sharp('image data goes here').rotate().extract({left: left, top: top, width: width, height: height}).resize(width, height);`.\r\n\r\nJust as a note for future visitors, as this issue pops up as the first result when searching in Google."
      },
      {
        "user": "hunzaGit",
        "created_at": "2021-06-24T19:15:59Z",
        "body": "Thanks to @imCorfitz 's comment I solved the problem, for some strange reason Sharp (v0.25.4) interprets some rotated images, in particular a vertical image taken from the smartphone's gallery. If the frontend of the app gets the picture (vertical or horizontal) from the camera everything works fine.\r\n\r\nIn my case, simply comparing the Sharp Metadata with the original dimensions of the photo fixed it.\r\n\r\nAs a simple code example for future visitors:\r\n```\r\nif(dimOriginal.width === metadata.height && dimOriginal.height === metadata.width){\r\n    console.log(\"image is rotated\");\r\n    promiseImg = promiseImg.rotate()\r\n}\r\n```"
      },
      {
        "user": "geiszla",
        "created_at": "2022-05-23T11:39:11Z",
        "body": "This is still an issue until this day. Is there an issue tracking this?\r\n\r\nEdit: my bad, didn't realize the `rotate()` auto-rotates the image. Works perfectly now."
      }
    ]
  },
  {
    "number": 686,
    "title": "Error: VipsImage: memory area too small --- should be N bytes, you passed 0",
    "created_at": "2017-01-17T15:43:55Z",
    "closed_at": "2017-01-23T16:46:37Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/686",
    "body": "Hi\r\n\r\nI am trying to use this library on a Raspberry Pi 3. Every time I run the toFile() function, I get this error:\r\n\r\n`Error: VipsImage: memory area too small --- should be N bytes, you passed 0`\r\n\r\n(N changes based on image dimensions).\r\n\r\nI have tried the following versions:\r\n\r\n- 0.17.1\r\n- 0.16.0\r\n- 0.15.0\r\n\r\nThe following failed to install (node-gyp rebuild error):\r\n\r\n- 0.14.0\r\n- 0.13.0\r\n- 0.12.0\r\n- 0.11.0\r\n\r\n(I believe v0.12.2 did install fine once shortly before, but as of this writing, running `npm install sharp@0.12.2` fails...)\r\n\r\nI am using NodeJS v6.9.1, downloaded from the NodeJS website. ARMv7 version.\r\n\r\n\r\nIs it likely my native compiler toolchain is not setup correctly? Could you point me in the correct direction?\r\n\r\nThanks & Regards,\r\nTJ\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/686/comments",
    "author": "tjwoon",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-01-17T15:52:33Z",
        "body": "Hello, what input are you using with the `sharp()` constructor? The `memory area too small` error suggests raw pixel data. Are you able to provide a complete code sample that fails?"
      },
      {
        "user": "tjwoon",
        "created_at": "2017-01-23T16:46:37Z",
        "body": "Sorry, it looks like I was calculating the size of my images incorrectly. It is working now that I am passing in the correct values for raw.width and raw.height.\r\n\r\nApologies for the mistake!"
      }
    ]
  },
  {
    "number": 660,
    "title": "Any performance benefit of using streams?",
    "created_at": "2016-12-22T14:03:38Z",
    "closed_at": "2016-12-26T14:54:37Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/660",
    "body": "Hi,\r\n\r\nI've been using the streams API (piping to sharp, piping result to a stream) for my current application, but have certain cases where using streams is a bit of a pain.\r\n\r\nFor instance, I want to check the format when the `metadata` event is emitted, and if the file is an SVG, I don't want to transform the image at all, but just directly pipe it to the response stream, but since the input stream is already consumed by sharp, I can't get hold of the content anymore. \r\n\r\nThe alternative would of course be to just buffer the entire input into memory, so I could reuse the `Buffer` instance. I'm wondering if I would lose any performance doing it this way, though. I've read a couple of issues regarding streams which leads me to believe that at least *output* streams are not actually.. streaming. Is the same true for input streams?",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/660/comments",
    "author": "rexxars",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-12-22T17:09:13Z",
        "body": "The *tl;dr* is no, but please do read #179 for discussion about adding stream/pipe support to libvips.\r\n\r\nYou can get away with calling `metadata()` on an incomplete image Buffer as long as the complete image header is present. See #298 for building this logic into sharp itself."
      },
      {
        "user": "rexxars",
        "created_at": "2016-12-26T14:54:37Z",
        "body": "Thanks for the reply. I'll subscribe to updates on the streaming issue and hope that it will be possible in some way in the future."
      }
    ]
  },
  {
    "number": 647,
    "title": "Process CMYK images without converting to RGB",
    "created_at": "2016-12-07T06:27:26Z",
    "closed_at": "2016-12-07T17:19:59Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/647",
    "body": "When Sharp loads an image it automatically converts it to sRGB.\r\nI am using Sharp in a print pipeline, with mostly CMYK input files. I need to be able to process (resize, mostly) images with Sharp, without converting them to a different colourspace.\r\n\r\nI am aware of the `toColourspace` function, however, I have a few problems with that as a solution.\r\n\r\nThe first problem is that I would *much* prefer not to convert my images to RGB and then back to CMYK, which is what Sharp seems to be going to do. I'd rather keep them in CMYK all the way through. Is this not a possibility?\r\n\r\nAnother, more minor, problem is that I have to use `metadata()` to find the current colourspace, and then call `toColourspace()` with the result and do all my further work inside the calback from `metadata()`. It introduces another layer of complexity – it would be nicer if keeping the existing colourspace was a simple option when the image was loaded.\r\n\r\nThe biggest problem at the moment though is it seems not to work...!\r\nWith this code (roughly):\r\n```javascript\r\nimage.metadata().then((metadata) => {\r\n\timage.toColourspace(metadata.space)\r\n\t\t.resize(1024,1024).max().withoutEnlargement()\r\n\t\t.toBuffer().then((buf) => { vinylFile.contents = buf; })\r\n});\r\n```\r\nI get the following error:\r\n```\r\nError: vips_colourspace: no known route between 'srgb' and 'cmyk'\r\n```\r\n\r\nDo you have any idea what is causing that error?\r\nI am on OS X 10.11.6. So far as I'm aware I don't have an installed `vips` beyond what is bundled with Sharp.\r\n\r\n(I guess the first part of this is a feature request and the second part is a bug report, maybe they should be separate... sorry!)",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/647/comments",
    "author": "caesar",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-12-07T11:58:34Z",
        "body": "Hello, did you see #218, which should improve the use of non-sRGB profiles and prevent unnecessary conversions?"
      },
      {
        "user": "caesar",
        "created_at": "2016-12-07T15:39:23Z",
        "body": "Hi Lovell, thanks for the reply. I did find #218 and read through the discussion there, but I didn't find a solution there really.\r\n\r\nSeemingly the `toColourspace` method was created as a result of the discussion on that issue, but it doesn't seem to work for me. Even using `toColourspace` as the first command after loading an image, the image is first converted to sRGB – and then Sharp (or vips) can't convert it back… Am I using it wrong?\r\n\r\nThere is also discussion on that issue of adding a further option to the `withMetadata` method – or (better, IMO) to the `sharp` constructor – to tell Sharp not to change the colourspace (I think) but seemingly that functionality hasn't been implemented yet. Or am I missing something?"
      },
      {
        "user": "caesar",
        "created_at": "2016-12-07T15:52:16Z",
        "body": "Just added a comment on #218, which may be a better place to continue the discussion about maintaining the source colourspace.\r\n\r\nBut I am still unsure about one thing, so perhaps you could clarify: is CMYK output (nevermind for now what happens internally in terms of conversion to sRGB and back) implemented at all yet, or is the `toColourspace` function just a stub for the moment?"
      },
      {
        "user": "lovell",
        "created_at": "2016-12-07T17:19:59Z",
        "body": "`toColourspace` as it stands definitely needs some attention, especially for non-(s)RGB use cases. As you've seen from the more recent comments on #218 this is starting to take on a more fully-formed API proposal so let's continue the discussion there."
      },
      {
        "user": "caesar",
        "created_at": "2016-12-07T19:31:28Z",
        "body": "Sure, happy to participate in the discussion there. I would have just commented there in the first place, except that I assumed the error I was getting was a bug – I hadn't realised it was simply as-yet-unimplemented functionality."
      }
    ]
  },
  {
    "number": 636,
    "title": "Advice Needed: How to create deep zoom image if I already have tiles?",
    "created_at": "2016-11-27T19:51:53Z",
    "closed_at": "2016-12-08T18:16:47Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/636",
    "body": "If I had a single large .tif, my understanding is that I could create a Deep Zoom image from this single large file quite easily by using the `tile` method\r\n\r\nHowever, my large image is already split up into a regular grid of non-overlapping tiles. One approach would be to stitch this array of tiles into a single large .tif first. If I were to go that approach, I'm not sure that `sharp` has a method to stitch so many files, and if it did, I'm not sure that it exposes a way to do it without needing to have the entire final image in memory at some point. I'd love to be wrong on both of these points!\r\n\r\nEssentially, I need to treat these tiles as the full-resolution image somehow, and then have the images further split and compressed to generate the various resolutions necessary for the Deep Zoom format. Do you have any advice on how to go about this with Sharp?\r\n\r\nMany thanks.\r\n\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/636/comments",
    "author": "Taytay",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-11-27T21:45:40Z",
        "body": "Hi Taylor, rather than use sharp, `vips_arrayjoin` is probably your friend here. When vips is installed you can use it via the command line, for example the following will stitch 4 tiles into a 2x2 grid:\r\n\r\n```sh\r\nvips arrayjoin 1.png 2.png 3.png 4.png 2x2.png --across 2\r\n```\r\n"
      },
      {
        "user": "Taytay",
        "created_at": "2016-11-27T22:03:37Z",
        "body": "Thank you @lovell! I'll give it a shot!"
      },
      {
        "user": "lovell",
        "created_at": "2016-12-08T18:16:47Z",
        "body": "Closing this as I think you now have an answer but please feel free to re-open if further help is required."
      }
    ]
  },
  {
    "number": 635,
    "title": "win10 64 build  error!",
    "created_at": "2016-11-27T09:15:10Z",
    "closed_at": "2017-01-05T20:29:29Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/635",
    "body": "Environment setup and configuration:\r\n`npm install -g windows-build-tools`\r\n\r\n```\r\n> sharp@0.16.2 install E:\\nodejs\\test\\node_modules\\sharp\r\n> node-gyp rebuild\r\n\r\n\r\nE:\\nodejs\\test\\node_modules\\sharp>if not defined npm_config_node_gyp (node \"D:\\Program Files\\nodejs\\node_modules\\npm\\bin\\node-gyp-bin\\\\..\\..\\node_modules\\node-gyp\\bin\\node-gyp.js\" rebuild )  else (node \"\" rebuild )\r\n在此解决方案中一次生成一个项目。若要启用并行生成，请添加“/m”开关。\r\n  VError.cpp\r\n  VInterpolate.cpp\r\n  VImage.cpp\r\n  win_delay_load_hook.cc\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\string.h(444): error C2664: 'char *strpbrk(char *const ,\r\nconst char *const )': cannot convert argument 1 from 'const char *' to 'char *const ' (compiling source file D:\\Program\r\n Files\\nodejs\\node_modules\\npm\\node_modules\\node-gyp\\src\\win_delay_load_hook.cc) [E:\\nodejs\\test\\node_modules\\sharp\\bui\r\nld\\libvips-cpp.vcxproj]\r\n  D:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\string.h(444): note: Conversion loses qualifiers (comp\r\n  iling source file D:\\Program Files\\nodejs\\node_modules\\npm\\node_modules\\node-gyp\\src\\win_delay_load_hook.cc)\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\string.h(444): error C2664: 'char *strpbrk(char *const ,\r\nconst char *const )': cannot convert argument 1 from 'const char *' to 'char *const ' (compiling source file ..\\src\\lib\r\nvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcxproj]\r\n  D:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\string.h(444): note: Conversion loses qualifiers (comp\r\n  iling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp)\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\string.h(444): error C2664: 'char *strpbrk(char *const ,\r\nconst char *const )': cannot convert argument 1 from 'const char *' to 'char *const ' (compiling source file ..\\src\\lib\r\nvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcxproj]\r\n  D:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\string.h(444): note: Conversion loses qualifiers (comp\r\n  iling source file ..\\src\\libvips\\cplusplus\\VError.cpp)\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\string.h(444): error C2664: 'char *strpbrk(char *const ,\r\nconst char *const )': cannot convert argument 1 from 'const char *' to 'char *const ' (compiling source file ..\\src\\lib\r\nvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcxproj]\r\n  D:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\string.h(444): note: Conversion loses qualifiers (comp\r\n  iling source file ..\\src\\libvips\\cplusplus\\VImage.cpp)\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(20): error C2039: 'strcmp': is not a member of '\r\n`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\shar\r\np\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(20): error C2039: 'strcmp': is not a member of '\r\n`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\buil\r\nd\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(20): error C2039: 'strcmp': is not a member of '\r\n`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\buil\r\nd\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(20): error C2873: 'strcmp': symbol cannot be use\r\nd in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\r\n\\sharp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(20): error C2873: 'strcmp': symbol cannot be use\r\nd in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\r\n\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(20): error C2873: 'strcmp': symbol cannot be use\r\nd in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\r\n\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(21): error C2039: 'strcspn': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sha\r\nrp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(21): error C2039: 'strcspn': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bui\r\nld\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(21): error C2039: 'strcspn': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bui\r\nld\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(21): error C2873: 'strcspn': symbol cannot be us\r\ned in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_module\r\ns\\sharp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(21): error C2873: 'strcspn': symbol cannot be us\r\ned in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\shar\r\np\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(21): error C2873: 'strcspn': symbol cannot be us\r\ned in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\shar\r\np\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(22): error C2039: 'strlen': is not a member of '\r\n`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\shar\r\np\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(22): error C2039: 'strlen': is not a member of '\r\n`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\buil\r\nd\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(22): error C2039: 'strlen': is not a member of '\r\n`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\buil\r\nd\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(22): error C2873: 'strlen': symbol cannot be use\r\nd in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\r\n\\sharp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(22): error C2873: 'strlen': symbol cannot be use\r\nd in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\r\n\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(22): error C2873: 'strlen': symbol cannot be use\r\nd in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\r\n\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(23): error C2039: 'strncmp': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sha\r\nrp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(23): error C2039: 'strncmp': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bui\r\nld\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(23): error C2039: 'strncmp': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bui\r\nld\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(23): error C2873: 'strncmp': symbol cannot be us\r\ned in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_module\r\ns\\sharp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(23): error C2873: 'strncmp': symbol cannot be us\r\ned in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\shar\r\np\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(23): error C2873: 'strncmp': symbol cannot be us\r\ned in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\shar\r\np\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(24): error C2039: 'strspn': is not a member of '\r\n`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\shar\r\np\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(24): error C2039: 'strspn': is not a member of '\r\n`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\buil\r\nd\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(24): error C2039: 'strspn': is not a member of '\r\n`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\buil\r\nd\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(24): error C2873: 'strspn': symbol cannot be use\r\nd in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\r\n\\sharp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(24): error C2873: 'strspn': symbol cannot be use\r\nd in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\r\n\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\cstring(24): error C2873: 'strspn': symbol cannot be use\r\nd in a using-declaration (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\r\n\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\iosfwd(524): error C2039: 'strlen': is not a member of '\r\n`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\shar\r\np\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\iosfwd(524): error C2039: 'strlen': is not a member of '\r\n`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\buil\r\nd\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\iosfwd(524): error C2039: 'strlen': is not a member of '\r\n`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\buil\r\nd\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\iosfwd(524): error C3861: 'strlen': identifier not found\r\n (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp\r\n.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\iosfwd(524): error C3861: 'strlen': identifier not found\r\n (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcxpr\r\noj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\iosfwd(524): error C3861: 'strlen': identifier not found\r\n (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcxpr\r\noj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(508): error C2039: 'strcmp': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bui\r\nld\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(508): error C2039: 'strcmp': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bui\r\nld\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(508): error C2039: 'strcmp': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sha\r\nrp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(508): error C3861: 'strcmp': identifier not foun\r\nd (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcxp\r\nroj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(508): error C3861: 'strcmp': identifier not foun\r\nd (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcxp\r\nroj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(508): error C3861: 'strcmp': identifier not foun\r\nd (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cp\r\np.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(748): error C2039: 'strlen': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bui\r\nld\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(748): error C3861: 'strlen': identifier not foun\r\nd (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcxp\r\nroj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(748): error C2039: 'strlen': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bui\r\nld\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(748): error C2039: 'strlen': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sha\r\nrp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(748): error C3861: 'strlen': identifier not foun\r\nd (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcxp\r\nroj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(748): error C3861: 'strlen': identifier not foun\r\nd (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cp\r\np.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(787): error C2039: 'strlen': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bui\r\nld\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(787): error C2039: 'strlen': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sha\r\nrp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(787): error C2039: 'strlen': is not a member of\r\n'`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bui\r\nld\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(787): error C3861: 'strlen': identifier not foun\r\nd (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcxp\r\nroj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(787): error C3861: 'strlen': identifier not foun\r\nd (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cp\r\np.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(787): error C3861: 'strlen': identifier not foun\r\nd (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcxp\r\nroj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1693): error C2039: 'strlen': is not a member of\r\n '`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bu\r\nild\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1693): error C3861: 'strlen': identifier not fou\r\nnd (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcx\r\nproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1693): error C2039: 'strlen': is not a member of\r\n '`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bu\r\nild\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1693): error C3861: 'strlen': identifier not fou\r\nnd (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcx\r\nproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1693): error C2039: 'strlen': is not a member of\r\n '`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sh\r\narp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1693): error C3861: 'strlen': identifier not fou\r\nnd (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-c\r\npp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1794): error C2039: 'strlen': is not a member of\r\n '`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bu\r\nild\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1794): error C3861: 'strlen': identifier not fou\r\nnd (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcx\r\nproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1794): error C2039: 'strlen': is not a member of\r\n '`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bu\r\nild\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1794): error C2039: 'strlen': is not a member of\r\n '`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sh\r\narp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1794): error C3861: 'strlen': identifier not fou\r\nnd (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcx\r\nproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1794): error C3861: 'strlen': identifier not fou\r\nnd (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-c\r\npp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1927): error C2039: 'strlen': is not a member of\r\n '`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bu\r\nild\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1927): error C3861: 'strlen': identifier not fou\r\nnd (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcx\r\nproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1927): error C2039: 'strlen': is not a member of\r\n '`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bu\r\nild\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1927): error C3861: 'strlen': identifier not fou\r\nnd (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcx\r\nproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1927): error C2039: 'strlen': is not a member of\r\n '`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sh\r\narp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(1927): error C3861: 'strlen': identifier not fou\r\nnd (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-c\r\npp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(2028): error C2039: 'strlen': is not a member of\r\n '`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bu\r\nild\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(2028): error C3861: 'strlen': identifier not fou\r\nnd (compiling source file ..\\src\\libvips\\cplusplus\\VImage.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcx\r\nproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(2028): error C2039: 'strlen': is not a member of\r\n '`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\bu\r\nild\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(2028): error C3861: 'strlen': identifier not fou\r\nnd (compiling source file ..\\src\\libvips\\cplusplus\\VError.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-cpp.vcx\r\nproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(2028): error C2039: 'strlen': is not a member of\r\n '`global namespace'' (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sh\r\narp\\build\\libvips-cpp.vcxproj]\r\nD:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\xlocale(2028): error C3861: 'strlen': identifier not fou\r\nnd (compiling source file ..\\src\\libvips\\cplusplus\\VInterpolate.cpp) [E:\\nodejs\\test\\node_modules\\sharp\\build\\libvips-c\r\npp.vcxproj]\r\ngyp ERR! build error\r\ngyp ERR! stack Error: `F:\\Program Files (x86)\\MSBuild\\14.0\\bin\\msbuild.exe` failed with exit code: 1\r\ngyp ERR! stack     at ChildProcess.onExit (D:\\Program Files\\nodejs\\node_modules\\npm\\node_modules\\node-gyp\\lib\\build.js:276:23)\r\ngyp ERR! stack     at emitTwo (events.js:106:13)\r\ngyp ERR! stack     at ChildProcess.emit (events.js:191:7)\r\ngyp ERR! stack     at Process.ChildProcess._handle.onexit (internal/child_process.js:215:12)\r\ngyp ERR! System Windows_NT 10.0.10240\r\ngyp ERR! command \"D:\\\\Program Files\\\\nodejs\\\\node.exe\" \"D:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\node_modules\\\\node-gyp\\\\bin\\\\node-gyp.js\" \"rebuild\"\r\ngyp ERR! cwd E:\\nodejs\\test\\node_modules\\sharp\r\ngyp ERR! node -v v7.0.0\r\ngyp ERR! node-gyp -v v3.4.0\r\ngyp ERR! not ok\r\nnpm WARN enoent ENOENT: no such file or directory, open 'E:\\nodejs\\test\\package.json'\r\nnpm WARN test No description\r\nnpm WARN test No repository field.\r\nnpm WARN test No README data\r\nnpm WARN test No license field.\r\nnpm ERR! Windows_NT 10.0.10240\r\nnpm ERR! argv \"D:\\\\Program Files\\\\nodejs\\\\node.exe\" \"D:\\\\Program Files\\\\nodejs\\\\node_modules\\\\npm\\\\bin\\\\npm-cli.js\" \"i\" \"sharp\"\r\nnpm ERR! node v7.0.0\r\nnpm ERR! npm  v3.10.8\r\nnpm ERR! code ELIFECYCLE\r\n\r\nnpm ERR! sharp@0.16.2 install: `node-gyp rebuild`\r\nnpm ERR! Exit status 1\r\nnpm ERR!\r\nnpm ERR! Failed at the sharp@0.16.2 install script 'node-gyp rebuild'.\r\nnpm ERR! Make sure you have the latest version of node.js and npm installed.\r\nnpm ERR! If you do, this is most likely a problem with the sharp package,\r\nnpm ERR! not with npm itself.\r\nnpm ERR! Tell the author that this fails on your system:\r\nnpm ERR!     node-gyp rebuild\r\nnpm ERR! You can get information on how to open an issue for this project with:\r\nnpm ERR!     npm bugs sharp\r\nnpm ERR! Or if that isn't available, you can get their info via:\r\nnpm ERR!     npm owner ls sharp\r\nnpm ERR! There is likely additional logging output above.\r\n\r\nnpm ERR! Please include the following file with any support request:\r\nnpm ERR!     E:\\nodejs\\test\\npm-debug.log\r\n```",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/635/comments",
    "author": "hpze2000",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-11-27T09:43:03Z",
        "body": "The first error looks odd (and is very likely to be the cause of the remaining, cascading errors):\r\n\r\n> D:\\Program Files (x86)\\Microsoft Visual Studio 14.0\\VC\\include\\string.h(444): error C2664: 'char *strpbrk(char *const , const char *const )': cannot convert argument 1 from 'const char *' to 'char *const ' (compiling source file D:\\Program Files\\nodejs\\node_modules\\npm\\node_modules\\node-gyp\\src\\win_delay_load_hook.cc)\r\n\r\nThis suggests Visual Studio cannot compile its own `string.h` header file. This problem is probably a local environment thing rather than specific to sharp.\r\n\r\nDoes running `npm install --build-from-source bcrypt` fail in a similar manner?"
      },
      {
        "user": "lovell",
        "created_at": "2016-12-14T18:20:29Z",
        "body": "@hpze2000 Have you been able to make any progress with this?"
      },
      {
        "user": "lovell",
        "created_at": "2017-01-05T20:29:29Z",
        "body": "Closing due to inactivity. Feel free to re-open if help is still required."
      }
    ]
  },
  {
    "number": 628,
    "title": "Get meta data about actual transformation",
    "created_at": "2016-11-18T17:07:06Z",
    "closed_at": "2016-11-20T12:41:27Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/628",
    "body": "(OT: `sharp` is awesome, thank you for your efforts!)\r\n\r\nIs there some API available which can give me a set of meta data about applied transformations? I would like to store this data with along with my image, so that transformations can be re-applied later.\r\n\r\nMy use case is the following:\r\n\r\nA user uploads an arbitrary image which is automatically scaled to 400 x 400 square dimensions using `resize` and `max`, additionally, we store the original image. \r\n\r\nWe also provide an image cropper within the browser, which optionally allows the user to perform a custom cropping. When opening this image cropper, I would like to show the original image, but initialize the cropper to `sharp`'s automatically determined dimensions. Therefor I would need to know, how `sharp` placed the crop.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/628/comments",
    "author": "qqilihq",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-11-19T11:47:41Z",
        "body": "Hello, using `sharp(input).resize(400, 400).max().toBuffer()...` shouldn't result in any cropping. The length of the longest edge will equal 400 pixels and the length of the shortest edge will be less than or equal to 400 pixels.\n\nI've probably misunderstood your question. Are you able to provide a fully worked example that highlights the missing data?\n"
      },
      {
        "user": "qqilihq",
        "created_at": "2016-11-20T12:41:27Z",
        "body": "Hi Lovell,\n\nthank you for quick response! In the meantime I spent some more time understanding our cropping library and sharp's APIs. So, reading my question again, it indeed sounds confusing even to me and was probably caused just because of my initial lack of understanding how the cropping works :)\n\nEverything is working now as expected, so I'll close this one.\n\nBest\nPhilipp\n"
      }
    ]
  },
  {
    "number": 625,
    "title": "Mysticism: sharp reacalls old type-related buffer from somewhere?",
    "created_at": "2016-11-15T10:15:57Z",
    "closed_at": "2016-11-15T13:11:20Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/625",
    "body": "My app uploads jpg/png files (type is restricted in app) to server, source image is saved to certain path (it works).\r\nThen I apply following resize routine:\r\n\r\n ```\r\n//Processing logo\r\n              sharp(logoPath + '/logo_upload')\r\n                .resize(640,120)\r\n                .max()\r\n                .toFormat('jpeg')\r\n                .toFile(logoPath + '/logo.jpg', function(err, info) {\r\n                  if (err) {console.error(err); throw (err)}\r\n                  console.log('120 info: ', info)\r\n                });\r\n```\r\n\r\nThe issue is **very** strange:\r\n1) I upload \"1.jpg\", sharp works - 1.jpg image resized/saved, no problem\r\n2) upload \"2.png\", sharp works as well -  image resized/saved (always under the same name - logo.jpg)\r\n3) upload \"3.jpg\", sharp resizes and saves \"1.jpg\" content (WTF?! from where?) \r\nAfter that no matter what I upload (source file logo_upload changes every time - I double-checked) - sharp output stays the same, \"1.jpg\" ((\r\nVersions: sharp - 0.16.2, node - 4.4.5\r\n\r\nGuys, what I'm doing wrong? What to consider to check in approach?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/625/comments",
    "author": "greenais",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-11-15T10:56:19Z",
        "body": "Hello, it looks like the input filename remains the same so you're probably seeing the effects of libvips' operation cache serving the previous contents to the processing pipeline.\r\n\r\nPerhaps try adding the following before any processing:\r\n\r\n``` javascript\r\nsharp.cache({files: 0});\r\n```\r\n"
      },
      {
        "user": "greenais",
        "created_at": "2016-11-15T13:11:20Z",
        "body": "Wow, you are right - that cache plays tricks.\nTried your suggestion, \n`sharp.cache({files: 0});`\ndoesn't work.\n\n`sharp.cache({items: 0});`\ndoes.\n\nProbably it's a good idea to put this in FAQ.\nThank you for your great job and support.\n"
      }
    ]
  },
  {
    "number": 600,
    "title": "PNG resulting image is larger with more metadata",
    "created_at": "2016-10-13T12:32:50Z",
    "closed_at": "2016-11-01T19:39:32Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/600",
    "body": "Attached is the diff for the two images using `identify`\n\n1c1\n<  Image: /Users/rahul/Downloads/outofbox.png\n  Image: /Users/rahul/Downloads/outofbox-2.png\n6c6,8\n\n<   Units: Undefined\n@@@\n   Resolution: 28.34x28.34\n   Print size: 44.566x35.9915\n   Units: PixelsPerCentimeter\n160,161c162,163\n\n<     date:create: 2016-10-13T17:28:54+06:00\n<     date:modify: 2016-10-13T17:28:44+06:00\n@@@\n     date:create: 2016-10-13T17:57:26+05:00\n     date:modify: 2016-10-13T17:57:18+05:00\n164,165c166,167\n\n<     png:IHDR.color-type-orig: 3\n<     png:IHDR.color_type: 3 (Indexed)\n@@@\n     png:IHDR.color-type-orig: 6\n     png:IHDR.color_type: 6 (RGBA)\n168c170\n\n<     png:PLTE.number_colors: 78\n@@@\n     png:pHYs: x_res=2834, y_res=2834, units=1\n170d171\n\n<     png:tRNS: chunk was found\n173c174\n<     filename: /Users/rahul/Downloads/outofbox.png\n@@@\n     filename: /Users/rahul/Downloads/outofbox-2.png\n176c177\n\n<   Filesize: 23.7KB\n@@@\n   Filesize: 40.5KB\n\n**The one after @@@ is the new image, The one before is the original image.**\n\nThe resulting image is larger than the original image with some extra data in the `identify` command. What could be the reason that the resulting image is larger. pngquant can return this image in exactly the same size. I am using `pipeline = pipeline.compressionLevel(9).withoutAdaptiveFiltering().png()` and if i remove `withoutAdaptiveFiltering()` the output size is even more 60.4Kb. The original image could have probably been run through tinypng or something. How do I ensure that the output image is not larger than the input image\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/600/comments",
    "author": "rn4391",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-10-13T12:54:58Z",
        "body": "```\n< png:IHDR.color-type-orig: 3\n< png:IHDR.color_type: 3 (Indexed)\n@@@\n> png:IHDR.color-type-orig: 6\n> png:IHDR.color_type: 6 (RGBA)\n```\n\nHello, libvips doesn't support indexed PNG output. See also #478.\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-11-01T19:39:32Z",
        "body": "Hope this answered your question. Feel free to reopen with more details if not.\n"
      }
    ]
  },
  {
    "number": 599,
    "title": "How to manually manage the cache?",
    "created_at": "2016-10-12T09:44:26Z",
    "closed_at": "2016-10-12T09:59:43Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/599",
    "body": "@lovell \nI found that `sharp` has an interface `cache` can set the limitation of the cache. But how can I force open a file without reading the data from cache?\n\nI want to enable the caching. And once an image file changed(I know it's changed), I can read the latest data of it but not the cached data.\n\nIs there an interface can remove the cached data of specified file? Or a method can force read the latest file data?\n\nWould appreciate any feedback / help....Thanks for your time and God Bless....\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/599/comments",
    "author": "natural-law",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-10-12T09:55:25Z",
        "body": "Hello, the cache belongs to libvips and stores the result of intermediate image operations.\n\nIf you need custom, fine-grained cache control beyond that already provided, I would suggest managing it yourself outside of sharp/libvips.\n"
      },
      {
        "user": "natural-law",
        "created_at": "2016-10-12T09:59:43Z",
        "body": "@lovell Thanks for your quickly reply.\n\nI found a way to implement it:\nDisable caching when I want to read latest file data, and enable caching again after the reading.\n\nIt works well by now. Thanks for your time again!\n"
      }
    ]
  },
  {
    "number": 585,
    "title": "Resizing image with larger dimension and size",
    "created_at": "2016-09-26T19:01:52Z",
    "closed_at": "2016-10-12T18:54:46Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/585",
    "body": "Like to have some suggestions regarding the issue i'm facing currently.\n\nWe are allowing image upload and user can choose larger dimension images and large in size.\n\nAs of now  we are giving some fixed dimension to resize. is there a way to figure out  preferred  `height` and `width`  which to be resized based on the image we upload.\n\n```\nex  var dim1 = getPrefferedSize(4000,5500)  // 1024, 1400\nex  var dim2 = getPrefferedSize(2040,1500)  // 904, 720\n```\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/585/comments",
    "author": "tomalex0",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-09-26T19:33:56Z",
        "body": "Hello, I'm not quite sure I understand the requirement here. Are the numbers in the comments input dimensions or expected output dimensions? A fully worked example would help me :)\n"
      },
      {
        "user": "tomalex0",
        "created_at": "2016-09-26T20:23:53Z",
        "body": "@lovell  sorry for not to be clear\n\nWhen we upload  a larger image (4000 x 5000), can we give some `percentage` instead of `width and height`, so that it will be  resized into lets say `1024 x 1200`.   Its kind of hard to figure out  to which size it should be resized.\n\nI'm looking  for a solution so that user will still upload larger images but in node layer we will take care of resizing, considering users can upload different size of images\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-09-26T22:11:20Z",
        "body": "If the output dimensions are to be a percentage of input dimensions then something like the following (untested) should work:\n\n``` javascript\nconst percentage = 25;\nsharp(input).metadata()\n  .then(info => {\n    const width = Math.round(info.width * percentage / 100);\n    const height = Math.round(info.height * percentage / 100);\n    return sharp(input).resize(width, height).toBuffer();\n  })\n  .then(output => {\n     ...\n  });\n```\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-10-12T18:31:20Z",
        "body": "@tomalex0 Does this help answer you question?\n"
      },
      {
        "user": "tomalex0",
        "created_at": "2016-10-12T18:54:46Z",
        "body": "Sorry for not updating, this does helped us.\nThanks a lot\n"
      },
      {
        "user": "jrock2468",
        "created_at": "2019-12-16T02:43:10Z",
        "body": "> If the output dimensions are to be a percentage of input dimensions then something like the following (untested) should work:\r\n> \r\n> ```js\r\n> const percentage = 25;\r\n> sharp(input).metadata()\r\n>   .then(info => {\r\n>     const width = Math.round(info.width * percentage / 100);\r\n>     const height = Math.round(info.height * percentage / 100);\r\n>     return sharp(input).resize(width, height).toBuffer();\r\n>   })\r\n>   .then(output => {\r\n>      ...\r\n>   });\r\n> ```\r\n\r\nThis would be an awesome example to include in the documentation.  I searched for something similar for a long time."
      },
      {
        "user": "lovell",
        "created_at": "2019-12-16T21:20:43Z",
        "body": "@jrock2468 Commit 703d90e adds a similar example to the docs, thanks for the nudge."
      }
    ]
  },
  {
    "number": 576,
    "title": "JPG to string/buffer and back again",
    "created_at": "2016-09-16T23:16:29Z",
    "closed_at": "2016-10-12T18:28:38Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/576",
    "body": "Hi there,\n\nI am currently trying to pass a sharp image as a string (because it's over a message queue),  to another process which needs to reconvert it back to a sharp image. We saw the\n#552  issue, which seemed similar, except we don't want to pass the raw data, it's several times the size of the jpg form. So, the question is: is there a way to convert a sharp image to a string (as a jpg), and then transform it back to a sharp image? Thank you!\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/576/comments",
    "author": "schaeffer11",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-09-17T09:01:52Z",
        "body": "> \"is there a way to convert a sharp image to a string\"\n\nHello, an instance of a `sharp` Object represents a series of operations that will be applied to an input image rather than any kind of \"sharp image\" itself.\n\nThe processing pipeline _starts_ work on the input image when one of `toFile()`, `toBuffer()` or `pipe()` are called to access the output image.\n\nIntermediate images are unavailable (and may never completely exist in memory at the same time anyway based on the way that libvips works).\n\nFrom what is described here, passing the input JPEG data alongside another data structure representing the operations to be applied to it would probably make most sense.\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-10-12T18:28:38Z",
        "body": "Feel free to re-open if there are further, related questions.\n"
      }
    ]
  },
  {
    "number": 571,
    "title": "Clean up/destroy sharp instances",
    "created_at": "2016-09-14T13:23:36Z",
    "closed_at": "2016-10-12T18:27:31Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/571",
    "body": "Is it possible explicitly clean up/destroy a sharp instance (when it is not needed anymore)?\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/571/comments",
    "author": "strarsis",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-09-14T15:30:04Z",
        "body": "A sharp instance is a standard JavaScript Object and therefore will be subject to garbage collection when no references remain.\r\n\r\nlibvips cache can be cleared via `sharp.cache(false)`\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-10-12T18:27:31Z",
        "body": "Feel free to re-open if there are still further questions related to this.\n"
      },
      {
        "user": "beenotung",
        "created_at": "2024-10-11T08:31:20Z",
        "body": "> A sharp instance is a standard JavaScript Object and therefore will be subject to garbage collection when no references remain.\r\n\r\nWe may mention this in the documentation and readme. I was in doubt if I need to explicitly call the destroy() method to free up the resources. (And didn't saw mention on this method in the documentation website and the readme)"
      }
    ]
  },
  {
    "number": 563,
    "title": "Get meta info before transforming?",
    "created_at": "2016-09-06T23:52:52Z",
    "closed_at": "2016-09-07T18:52:41Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/563",
    "body": "Question...\n\nWhat would be the best way to go about determining a streamed input source's dimensions before transforming to a writable stream (i.e. get the meta info without having to pipe data somewhere)?\n\nI can use withoutEnlargement() to prevent enlarging, but I would rather not generate a new image at all in my use-case. I am getting a read stream from S3 and piping it through Sharp to create thumbnails and then streaming those thumbnails back to S3.\n\nI would prefer not to create several duplicate thumbnails, but I'm just not sure what the best approach is to do so.\n\n**For Example:**\n1. User uploads a 100px image\n2. My image processor creates thumbnails that should have widths [250, 500, 750]\n3. Since I'm using withoutEnlargement(), I get three extra duplicate images that are all the same size instead\n4. Only after they are created do I get the 'info' that tells me they are all the same, at which time I need to remove those duplicates and update my models to point to the original instead.\n\nThanks you for your help!\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/563/comments",
    "author": "elliotfleming",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-09-07T09:09:51Z",
        "body": "Hi Elliot, did you see #236 and the other issues/questions that reference it?\n"
      },
      {
        "user": "elliotfleming",
        "created_at": "2016-09-07T18:52:40Z",
        "body": "Yes I think that would do the trick.\n"
      }
    ]
  },
  {
    "number": 557,
    "title": "Is sharp blocking?",
    "created_at": "2016-08-30T09:50:41Z",
    "closed_at": "2016-09-19T18:07:16Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/557",
    "body": "Does sharp block the event loop, or does it use timeouts every few milliseconds while processing?\n\nOtherwise someone uploading a big file will hang our server for a few seconds while it resizes.\n\nThis isn't mentioned in the performance section of the API, where it would be nice to see.\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/557/comments",
    "author": "RichardJECooke",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-09-02T14:09:00Z",
        "body": "> \"Everything remains non-blocking thanks to libuv, no child processes are spawned...\"\r\n\r\nDoes this answer your question?\r\n\r\nPerhaps the \"performance\" section of the docs should be renamed \"benchmarks tests\" to clarify its role?\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-09-19T18:07:16Z",
        "body": "Feel free to re-open if your question has not been answered.\n"
      }
    ]
  },
  {
    "number": 548,
    "title": "Confusion over documentation location",
    "created_at": "2016-08-19T08:24:11Z",
    "closed_at": "2016-08-19T11:10:45Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/548",
    "body": "I've managed to find the documentation for Sharp in two different places.\r\n\r\nThe Read The Docs version seems out of date. Sorry, I'm not actually sure how I found the the link to the RTD version, but I thought I'd point out the disparity. \r\n\r\n---\r\n\r\nOn a side note, I'm temporarily using my wife's Macbook Air (Yosemite 10.10.5) and I've noticed that I have to manually install lib vps for Sharp 0.15.1 to work, unlike stated in the latest docs. I'm sure on my regular computer (Ubuntu 14.04) this, as expected, wasn't necessary. Shall I raise this as a separate issue?\r\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/548/comments",
    "author": "philmander",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-08-19T10:24:35Z",
        "body": "Hi Phil, I think those two hostnames should both CNAME resolve to the same place - I'll need to read the Read The Docs docs to check - perhaps there's a stale cached version somewhere?"
      },
      {
        "user": "philmander",
        "created_at": "2016-08-19T11:10:42Z",
        "body": "0.16 now works nicely without libvps being preinstalled.\n\nI think it was just coincidental that I was looking up the docs around 0.16 being released and a cache was stale somewhere.\n\nThanks\n"
      }
    ]
  },
  {
    "number": 545,
    "title": "Clarification/bug: Using raw pixels as input format",
    "created_at": "2016-08-16T14:52:14Z",
    "closed_at": "2016-08-17T14:40:43Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/545",
    "body": "In order to 'realize' some sharp operations, the sharp image instance \nhas to be outputted to buffer and fed back as input for a new sharp image instance.\n\nFor less overhead and simplicity, I want to use raw pixel format instead the default one (png).\nHowever, in contrast to using e.g. png as format for the intermediate buffer contents, \nraw pixel doesn't seem to work - an exception is thrown when using it as input.\n\nEdit: I added some promise handling so second sharp call has a chance of complaining all the time:\n\n``` js\nvar sharp = require('sharp');\n\nsharp('./input.jpg')\n.raw().toBuffer()\n.then(function(rawBuf) {\n  return sharp(rawBuf) // unsupported image format error\n          .metadata();\n})\n.then(function(info) {\n  console.log(info);\n});\n```\n\n```\n[...]Input file is missing or of an unsupported image format\n         at Error (native)\n\n```\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/545/comments",
    "author": "strarsis",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-08-17T08:44:24Z",
        "body": "Hello, the `width`, `height` and `channels` are required as additional parameters for raw pixel input as the Buffer contains only the pixel values.\r\n\r\nLuckily the second parameter of the `toBuffer` callback contains what you need:\r\n\r\n``` javascript\r\nsharp('./input.png')\r\n  .raw()\r\n  .toBuffer(function(data, info) {\r\n    sharp(rawBuf, { raw: info })...\r\n  });\r\n```\r\n"
      },
      {
        "user": "strarsis",
        "created_at": "2016-08-17T11:39:45Z",
        "body": "But when I use the promise, there is only one parameter passed from it, namely only the pixel values.\nWouldn't it make sense adding the info parameter also to the parameters passed?\n\n``` js\nvar sharp = require('sharp');\n\nsharp('./input.jpg')\n.raw().toBuffer()\n.then(function(rawBuf, rawInfo) {\n  console.log(typeof rawBuf, typeof rawInfo); // object undefined\n});\n```\n\nEdit: Would a \"realize\"([cb]) method make sense? One that performs all queued operations in-place (in the C implementation) - so one doesn't need to move the data around to a new sharp instance?\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-08-17T12:44:37Z",
        "body": "Please see #143\n"
      },
      {
        "user": "strarsis",
        "created_at": "2016-08-17T13:54:47Z",
        "body": "A realize() method could help a bit. When the changes can be directly applied in-place, \nthere would be less to no need using the raw() approach.\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-08-17T14:33:53Z",
        "body": "Did you see #241?\n"
      }
    ]
  },
  {
    "number": 528,
    "title": "How to prevent crash on unhandled errors when using streams?",
    "created_at": "2016-07-25T21:06:32Z",
    "closed_at": "2016-07-27T18:43:15Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/528",
    "body": "Hi,\n\nwhat is the recommended way of preventing a crash of the application if I'm using sharp as follows and the buffer data is undefined or has unsupported image data in it?\nThe 'error' event is not being fired in this case. Do I need to incorporate a try/catch block somehow?\n\n``` js\nvar pipeline = sharp()\n.on('error', err => console.log('error'))\n.pipe(fs.createWriteStream('filename.jpg'));\n\nvar readStream = new stream.PassThrough();\nreadStream.end(someBuffer);\n\nreadStream.pipe(pipeline);\n```\n\nWhen `someBuffer` is undefined, I get this error and the app crashes.\n\n```\n     Error: Input file is missing or of an unsupported image format\n        at Error (native)\n```\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/528/comments",
    "author": "dsine-de",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-07-26T09:02:38Z",
        "body": "Piping `undefined` into a `sharp` instance will (currently) result in a zero-length Buffer being processed by libvips. This situation can be improved, but I would expect it to still emit the `error` event. I'll need to take a closer look.\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-07-27T15:43:55Z",
        "body": "If you change your example to call `pipe` on the pipeline rather than the return value of the call to `on` it correctly emits the expected error.\n\n``` diff\n- .on('error', err => console.log('error'))\n- .pipe(fs.createWriteStream('filename.jpg'));\n+ .on('error', err => console.log('error'));\n+ pipeline.pipe(fs.createWriteStream('filename.jpg'));\n```\n\nMy best guess would be that this is something to do with to node's `stream.Duplex` object inheriting from `stream.Readable` but not `stream.Writable` (due to the lack of multiple inheritance).\n"
      },
      {
        "user": "dsine-de",
        "created_at": "2016-07-27T18:43:15Z",
        "body": "Thank you - that helped a lot.\n"
      },
      {
        "user": "papandreou",
        "created_at": "2016-07-28T09:10:49Z",
        "body": "`on` is chainable, but `pipe` returns the target (writable) stream, so the original snippet pipes the readable stream directly into the writable stream.\n"
      },
      {
        "user": "afrozl",
        "created_at": "2016-08-08T21:50:13Z",
        "body": "I'm trying to follow this example, but I am clearly missing something as I am unable to trap the error. \nmy pipeline looks like:\n\n```\n var remoteWriteStream = bucket.file('assets/images/lead/' + file).createWriteStream({metadata: { contentType: 'image/jpeg'}});\n var pipeline = sharp('./public/images/tmp/' + file)\n .resize(1280, 800)\n .crop(sharp.gravity.north)\n .quality(85)\n .on('error', err => console.log('error');\n pipeline.pipe(remoteWriteStream)\n\nsharp error: Error: Input file is missing or \nof an unsupported image format\n\n```\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-08-09T08:56:51Z",
        "body": "@afrozl Perhaps try using an absolute path instead of the relative `./public/images/...` (as paths are relative to the working directory, which isn't always the same as the directory containing your script).\n"
      },
      {
        "user": "afrozl",
        "created_at": "2016-08-09T10:55:50Z",
        "body": "Thanks, looks like I was receiving the error but not handling the unpipe correctly\n"
      }
    ]
  },
  {
    "number": 523,
    "title": "Promises and raw buffers -- awkward with current API",
    "created_at": "2016-07-21T18:00:04Z",
    "closed_at": "2016-08-09T19:06:21Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/523",
    "body": "If using a raw buffer, it's hard to also use promises, as I don't currently see a convenient way to get the buffer size information along with the raw buffer.\n\nFor example, this is a pattern (perhaps misguded?) that I've seen come up a lot with raw buffers:\n\n``` javascript\nsharp(input)\n  .someop()\n  .raw()\n  .toBuffer(function callback(err, buf, info) {\n    doSomethingWithBuffer(buf, info);\n  });\n```\n\nAs you could, for example, run another processing stage with sharp in `doSomethingWithBuffer()`:\n\n```\nsharp(buf, {raw: info})...\n```\n\nIt would be great to use promises for this, which I would like to use this way:\n\n``` javascript\nsharp(input)\n  .someop()\n  .raw()\n  .toBuffer()\n  .then( doSomethingPromise );\n```\n\nBut at the moment, the promise returned by `toBuffer()` only populates the first argument (I think, to spec) so\n\n``` javascript\ndoSomethingPromise(err, buf, info) {\n  console.log(err, buf, info);\n}\n```\n\nPrints:\n\n```\n<Buffer xx yy zz ... > undefined undefined\n```\n\nThis leaves you with a buffer in the processing chain with no structure information. One could imagine, for the purpose of a raw buffer promise, returning an object like this, rather than just the node buffer:\n\n```\nbuffer {\n  buf: nodeBuffer,\n  info: { \n    format: 'raw',\n    width: 200,\n    height: 200,\n    channels: 4,\n    size: 12345 \n  }\n}\n```\n\nI'm not sure how to balance backward compatibility with that approach. I.e. would all sharp buffers be embedded in such an object? All sharp raw buffers? Only those returned by a promise?\n\nAnother compounding problem (bug?) is that `sharp().metadata()` doesn't work if the input to sharp was a raw buffer.\n\nInterested in hearing people's thoughts.\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/523/comments",
    "author": "mhirsch",
    "comments": [
      {
        "user": "mhirsch",
        "created_at": "2016-07-21T20:30:10Z",
        "body": "In bluebird, `promisify` has a `multiArgs` option, which returns multiple arguments to a callback in an array. Maybe this is the standard to follow.\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-07-22T07:33:25Z",
        "body": "Hi Matt, did you see #143?\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-08-09T16:31:03Z",
        "body": "@mhirsch bump\n"
      },
      {
        "user": "mhirsch",
        "created_at": "2016-08-09T16:51:44Z",
        "body": "It would be great if `toBuffer()` returned a promise that resolved with an array, following bluebird `multiArgs: true` and your suggestion in #143.\n"
      },
      {
        "user": "mhirsch",
        "created_at": "2016-08-09T17:57:23Z",
        "body": "I realized maybe you were asking if I could use the workaround. As noted above, `sharp().metadata()` doesn't work when the input is a raw buffer.\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-08-09T18:47:47Z",
        "body": "@mhirsch Do the forthcoming ImageDescriptor changes make raw pixel input work with `metadata()`? If it's OK with you, let's track this API-breaking change via #143.\n"
      },
      {
        "user": "mhirsch",
        "created_at": "2016-08-09T19:05:03Z",
        "body": "Ah, yes. Metadata now works with raw buffers on the `pencil` branch. I'm happy to close this and track the api change on #143. Thanks!\n"
      }
    ]
  },
  {
    "number": 514,
    "title": "Resize to higher resolution",
    "created_at": "2016-07-17T12:01:41Z",
    "closed_at": "2016-08-18T08:40:45Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/514",
    "body": "Is there a way to resize an image at a smaller size but larger resolution?\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/514/comments",
    "author": "zooshme",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-07-18T10:40:43Z",
        "body": "Hi Ovidiu, what do you mean by \"resolution\" in this context? Perhaps you're generating images for print? Please can you provide an example.\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-08-09T16:31:43Z",
        "body": "@zooshme Were you able to make any progress with this?\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-08-18T08:40:45Z",
        "body": "Please re-open if help is still required.\n"
      }
    ]
  },
  {
    "number": 505,
    "title": "Allow empty sharp image",
    "created_at": "2016-07-13T10:05:01Z",
    "closed_at": "2016-07-13T11:31:54Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/505",
    "body": "For specific applications, like with using overlayWith(...), \nit may be necessary or easier to just create an wholly empty image \n(maybe with specific dimensions or just 1px x 1px and extend(...) it).\n\nHowever, using sharp() without any argument \nresults in non-functional output methods.\n\nOne workaround may be using a dummy input image - \nbut this unnecessarily complicates the application.\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/505/comments",
    "author": "strarsis",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-07-13T11:01:58Z",
        "body": "Hello, did you see #470, a similar question?\n"
      },
      {
        "user": "strarsis",
        "created_at": "2016-07-13T11:31:54Z",
        "body": "Yes, this seems to be the same issue.\n"
      }
    ]
  },
  {
    "number": 502,
    "title": "Building a multi-channel image from multiple files - what's the right way for sharp?",
    "created_at": "2016-07-08T04:40:33Z",
    "closed_at": "2016-07-08T17:00:05Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/502",
    "body": "I'd like to be able to join a collection of images into a single RGB image with sharp, as in vips `bandjoin`. I can think of two ways to go about this, but I think both of them are a little ugly.\n1.  Overload the sharp constructor to accept an object or array containing image filenames or buffers to be joined before being processed: \n\n``` javascript\nsharp([image1, image2, image3]).xyz().toBuffer(...);\n```\n1. Add a new function to sharp to join on more image bands / channels after the image has been loaded:\n\n``` javascript\nsharp(image1).joinChannel([image2, image3]).xyz().toBuffer(...);\n```\n\nThe downside to method 1 is that it is not semantically clear what will happen with the array of images. This could be mitigated by putting them in an object with some descriptive key, such as `{0:image1, 1:image2, 2:image3}`. The downside to method 2 is that it spreads out the image bands where they should be logically grouped together. There's nothing special about image1 vs image2 and image3, except that it's supposed to end up in band 0.\n\nThoughts and suggestions? I plan to submit a pr for something like this, and I'm leaning towards method 1.\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/502/comments",
    "author": "mhirsch",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-07-08T12:09:31Z",
        "body": "Hi Matt, method 2 is much closer to the underlying libvips operations required to achieve a \"bandjoin\" and, as you suggest, the method 1 approach to listing multiple input files could lead to ambiguity, so my vote is with the second approach.\n\n`joinChannel` seems like a good (consistent, clear) name for this operation.\n\nThanks again for all your recent work to expose more libvips operations. These are much appreciated and have the potential to draw in a whole new community of people more deeply involved with image processing!\n"
      },
      {
        "user": "mhirsch",
        "created_at": "2016-07-08T16:48:30Z",
        "body": "Thanks a bunch for your comments. I'll work on something that looks like `joinChannel` above.\n\nAnd thanks also for considering my patches. I would love to see something (perhaps a different project) down the road that's closer to a more general node-vips interface but for now, with what I've added, sharp is working really well for me. This is a very high quality project! I really appreciate what you've done with it.\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-07-08T19:54:54Z",
        "body": "> \"closer to a more general node-vips interface\"\n\nPlease see #241\n"
      },
      {
        "user": "mhirsch",
        "created_at": "2016-07-08T21:01:57Z",
        "body": "Something like that would be fantastic. Is there progress being made in that direction?\n"
      }
    ]
  },
  {
    "number": 488,
    "title": "Fails with paths including spaces",
    "created_at": "2016-07-03T15:01:06Z",
    "closed_at": "2016-07-03T17:56:52Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/488",
    "body": "On Windows, node-sharp fails when a valid path to an image file is passed that also contains spaces:\n\n```\n[Error: Input file is missing or of an unsupported image format]\n```\n\nIn contrast, e.g. the fs module can successfully use the same path, \nincluding spaces, to read the image file into buffer.\n\nOne could use this as workaround, first reading the image file into buffer, \nthen passing that buffer to node-sharp - \nbut there may be performance degrading, as optimizations in node-sharp \nlike streaming or peeking for metadata are skipped.\n\nMaybe resolving the path + getting a file/stream handle could be handled by node, \nthen used by the existing C++ implementation?\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/488/comments",
    "author": "strarsis",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-07-03T17:39:46Z",
        "body": "Hello, are there any UTF-16 encoded chars in the path? #319 and #406 are examples of these failing on Windows.\n"
      },
      {
        "user": "strarsis",
        "created_at": "2016-07-03T17:56:52Z",
        "body": "After testing a bit more, I conclude it isn't the space character causing this issue \nbut special characters indeed, umlauts (e.g. 'ö'), in file and/or folder name in the passed path.\n"
      }
    ]
  },
  {
    "number": 453,
    "title": "Library not loaded: /usr/local/opt/orc/lib/liborc-0.4.0.dylib",
    "created_at": "2016-06-05T05:15:27Z",
    "closed_at": "2016-06-05T10:58:21Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/453",
    "body": "Unable to run the module due to an error of `Library not loaded: /usr/local/opt/orc/lib/liborc-0.4.0.dylib`.\n\nI used `brew install homebrew/science/vips` to install all dependancies. Everything was installed correctly (after around 10 minutes), yet the module still fails to run.\n\nAny idea on how to fix this?\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/453/comments",
    "author": "zilions",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-06-05T09:11:13Z",
        "body": "Hello, this looks like #323. Please can you try:\n\n``` sh\nbrew update && brew upgrade\nbrew unlink orc && brew link orc\n```\n"
      },
      {
        "user": "zilions",
        "created_at": "2016-06-05T10:04:37Z",
        "body": "That did the trick! Thanks @lovell \n"
      },
      {
        "user": "tiendq",
        "created_at": "2016-08-12T03:43:02Z",
        "body": "@lovell I got the same error yesterday on my OSX and your trick worked, thanks :)\n\nError ==========================\n\n1): Library not loaded: /usr/local/opt/libpng/lib/libpng16.16.dylib\n  Referenced from: /usr/local/opt/vips/lib/libvips-cpp.42.dylib\n  Reason: Incompatible library version: libvips-cpp.42.dylib requires version 40.0.0 or later, but libpng16.16.dylib provides version 38.0.0\n"
      }
    ]
  },
  {
    "number": 450,
    "title": "Scaling the overlay?",
    "created_at": "2016-06-01T02:14:38Z",
    "closed_at": "2016-06-03T09:16:25Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/450",
    "body": "Is there a way to scale the overlay image @lovell ?  I saw a mention from you in the early discussions of the `overlayWith` feature that you can \"resize/interpolate/ratio the overlay image\" with methods that already exist.\n\nThis option would be useful for adding watermarks to images dynamic in size. Having an image of the same size or smaller presents other transformation issues in chaining this command when the overlay needs resizing unless scaling was added as an option or another API function was available like suggested in (#335) with `.overlaySize()`. \n\nUSAGE\n\n```\n  .overlayWith(\"overlay.png\", {\n    scale: 0.15,\n    gravity: center,\n    tile: true\n  })\n```\n\nor\n\n```\n  .overlaySize(\"100x100\")\n  .overlayWith(\"overlay.png\", {\n    gravity: center,\n    tile: true\n  })\n```\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/450/comments",
    "author": "webbrandon",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-06-01T11:26:07Z",
        "body": "Hi Brandon, is it possible that, in your scenario, the watermark could be represented by a vector image in the SVG format? If so, you could \"dynamically\" alter its `viewBox` attribute to fill the dimensions you need.\n\nThere are a lot of options, conditions and therefore complexity when resizing images and I'd rather keep the overlay/compositing part of the API as simple as we can.\n"
      },
      {
        "user": "webbrandon",
        "created_at": "2016-06-01T18:27:13Z",
        "body": "I understand the hesitation. Thank you for the suggestion, been awhile since I worked with SVG but this could be a viable solution.  I will explore this option.\n\nIf this works I won't need to request an `opacity` setting either :) \n"
      },
      {
        "user": "webbrandon",
        "created_at": "2016-06-03T01:53:23Z",
        "body": "Thank you again @lovell .  If anyone else faces this edge case here is a little share code:\n\n```\nfunction getWatermark(image, size){\n    var svg;\n    var xml = \"<?xml version='1.0' encoding='UTF-8' standalone='no'?>\";\n    var svgHeadStart = \"<svg \";\n    if(size){\n        svgHeadStart += \"width='\" + size + \"' height='\" + size + \"' \";\n    } else {\n        svgHeadStart += \"width='200px' height='200px' \";\n    }\n    var svgHeadEnd = \"viewBox='0 0 200 200' id='svgwatermark' preserveAspectRatio='xMidYMid meet'>\";\n    var svgImage = \"<image id='watermark' x='0' y='0' width='90%' height='90%' xlink:href='\" + image + \"' />\";\n    var svgTail = \"</svg>\";\n\n    svg = xml + svgHeadStart + svgHeadEnd + svgImage + svgTail;\n\n    return new Buffer(svg);\n};\n```\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-06-03T09:16:25Z",
        "body": "Thanks for the update - great to hear you got it working.\n"
      },
      {
        "user": "gaurav16694",
        "created_at": "2019-04-23T11:56:39Z",
        "body": "hello @webbrandon I am getting the following error when I am using SVG \r\n\r\nsvgload_buffer: SVG rendering failed"
      }
    ]
  },
  {
    "number": 447,
    "title": "After use sharp resize can't remove original file with fs.unlinkSync",
    "created_at": "2016-05-28T17:26:33Z",
    "closed_at": "2016-05-29T16:22:34Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/447",
    "body": "**Error: EBUSY: resource busy or locked, unlink '**\n\n```\napp.post(\"/upload\", upload.single('file'), function (req, res, next) {\n    var newName = new Date().getTime();\n    var cnt = 0;\n    sharp('./uploads/' + tmpName)\n      .resize(220, 220)\n      .crop(sharp.strategy.entropy)\n      .toFile('./uploads/' + newName + '_sm.webp', function(err) {\n        cnt++;\n        removeTemp(cnt,tmpName);\n      });\n\n      sharp('./uploads/' + tmpName)\n      .resize(400, null)\n      .toFile('./uploads/' + newName + '_md.webp', function(err) {\n        cnt++;\n        removeTemp(cnt,tmpName);\n      });\n\n       sharp('./uploads/' + tmpName)     \n      .resize(800, null)\n      .toFile('./uploads/' + newName + '_lg.webp', function(err) {\n        cnt++;\n        removeTemp(cnt,tmpName);\n      });\n\n    res.send(req.file);\n});\n\n function removeTemp(n,fname){\n     if(n == 3){        \n        fs.unlinkSync('./uploads/' + fname);\n     }\n }\n```\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/447/comments",
    "author": "chanut",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-05-28T17:43:12Z",
        "body": "Hello, this looks like #346\n"
      },
      {
        "user": "chanut",
        "created_at": "2016-05-29T16:22:31Z",
        "body": "@lovell  \nthanks that work  the files are locked.\n"
      }
    ]
  },
  {
    "number": 423,
    "title": "tile does not generate deep zoom images or xml",
    "created_at": "2016-05-02T00:58:45Z",
    "closed_at": "2016-06-02T16:58:58Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/423",
    "body": "tile does not generate deep zoom images or xml of jpeg file\n\ns3.getObject({ Bucket: srcBucket, Key: srcKey}, function(err, response) {\n       if(err)  console.log(err, err.stack); // an error occurred\n       else{          // successful response\n           sharp(response.Body).toFormat('jpeg')\n           .tile({\n                size: 512,\n              })\n              .toFile('/tmp/output.dzi', function(err, info) {\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/423/comments",
    "author": "eltonnobrega",
    "comments": [
      {
        "user": "eltonnobrega",
        "created_at": "2016-05-02T12:15:25Z",
        "body": "For a file in the local folder it works. But I did some tests and find that:\nYou can not use buffer\nYou can not use toformat\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-05-02T19:21:42Z",
        "body": "Hello, as you've discovered, tile-based output is to the filesystem only. Given the potentially thousands of files a tiled image pyramid can generate, would writing these to a Buffer be something you'd expect to be possible?\n\nThere's currently no control over the format - see #337 for improvements to this.\n\nI've tried using absolute and relative file paths for the tiled output and both seem to work OK here.\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-05-18T16:50:25Z",
        "body": "@eltonnobrega Have you been able to make any progress with this? Does #337 provide what you're looking for?\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-06-02T16:58:58Z",
        "body": "Closing due to inactivity. Please feel free to re-open if there's still a problem.\n"
      }
    ]
  },
  {
    "number": 422,
    "title": "Can't install sharp v0.12.2 with node 6",
    "created_at": "2016-04-30T16:53:53Z",
    "closed_at": "2016-04-30T17:37:55Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/422",
    "body": "Error shown when I tried to install:\n\nnpm ERR! Darwin 15.4.0\nnpm ERR! argv \"/usr/local/bin/node\" \"/usr/local/bin/npm\" \"install\"\nnpm ERR! node v6.0.0\nnpm ERR! npm  v3.8.6\nnpm ERR! code ELIFECYCLE\n\nnpm ERR! sharp@0.12.2 install: `node-gyp rebuild`\nnpm ERR! Exit status 1\nnpm ERR! \nnpm ERR! Failed at the sharp@0.12.2 install script 'node-gyp rebuild'.\nnpm ERR! Make sure you have the latest version of node.js and npm instal\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/422/comments",
    "author": "MichaelBuen",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-04-30T16:58:54Z",
        "body": "Please can you try with v0.14.1, the latest version.\n"
      },
      {
        "user": "MichaelBuen",
        "created_at": "2016-04-30T17:37:55Z",
        "body": "Thanks Lovell, it worked!\n"
      }
    ]
  },
  {
    "number": 396,
    "title": "Unable to put an overlay of smaller size than the resized  image",
    "created_at": "2016-04-05T04:28:21Z",
    "closed_at": "2016-04-15T02:44:36Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/396",
    "body": "Hi I have a functionality to put a default overlay on top of images of different sizes\nand using sharp for generating those images \n\nThe error comes up saying the overlay image should be of same size of resized image\nIs there a way to do the same\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/396/comments",
    "author": "ghost",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-04-05T08:57:15Z",
        "body": "Hello, please try with the latest version:\r\n\r\n> \"Improvements to overlayWith: differing sizes/formats, gravity, buffer input.\"\r\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-04-14T21:01:04Z",
        "body": "@sbsomya Were you able to try with v0.14.0?\r\n"
      },
      {
        "user": "ghost",
        "created_at": "2016-04-15T02:44:20Z",
        "body": "Yess lovell \nThanks\n"
      },
      {
        "user": "srameshr",
        "created_at": "2019-02-15T19:45:23Z",
        "body": "@lovell I am on 0.21.2 and this issue still exists"
      }
    ]
  },
  {
    "number": 390,
    "title": "sharp building fails",
    "created_at": "2016-04-01T09:13:26Z",
    "closed_at": "2016-04-03T13:20:57Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/390",
    "body": "npm ERR! Linux 3.14.36-20150326-1131-6606ede\nnpm ERR! argv \"node\" \"/usr/local/bin/npm\" \"install\"\nnpm ERR! node v0.10.36\nnpm ERR! npm  v2.14.20\nnpm ERR! code ELIFECYCLE\n\nnpm ERR! sharp@0.13.1 install: `node-gyp rebuild`\nnpm ERR! Exit status 1\nnpm ERR! \nnpm ERR! Failed at the sharp@0.13.1 install script 'node-gyp rebuild'.\nnpm ERR! This is most likely a problem with the sharp package,\nnpm ERR! not with npm itself.\nnpm ERR! Tell the author that this fails on your system:\nnpm ERR!     node-gyp rebuild\nnpm ERR! You can get information on how to open an issue for this project with:\nnpm ERR!     npm bugs sharp\nnpm ERR! Or if that isn't available, you can get their info via:\nnpm ERR! \nnpm ERR!     npm owner ls sharp\nnpm ERR! There is likely additional logging output above.\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/390/comments",
    "author": "ashish-soni",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-04-01T09:41:35Z",
        "body": "Please can you provide more of the error log that appears before this.\n"
      },
      {
        "user": "ashish-soni",
        "created_at": "2016-04-03T13:20:46Z",
        "body": "@lovell  it was some npm related issue. I am able to bulid it now. Thanks.\n"
      }
    ]
  },
  {
    "number": 389,
    "title": "incompatible library version",
    "created_at": "2016-04-01T04:33:42Z",
    "closed_at": "2016-04-01T10:13:45Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/389",
    "body": "I got this error when i tried to run.\n\n\"Reason: Incompatible library version: libvips-cpp.42.dylib requires version 38.0.0 or later, but libpng16.16.dylib provides version 35.0.0\"\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/389/comments",
    "author": "SuThaw",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-04-01T08:00:23Z",
        "body": "Hello, running `brew update && brew upgrade` and/or `brew unlink libpng && brew link libpng` might help. See #323 too.\n"
      },
      {
        "user": "SuThaw",
        "created_at": "2016-04-01T10:13:45Z",
        "body": "brew update && brew upgrade solve my problem. Thank you.\n"
      }
    ]
  },
  {
    "number": 386,
    "title": "Alpha channel won't work with DeepZoom",
    "created_at": "2016-03-27T17:08:36Z",
    "closed_at": "2016-04-02T06:46:11Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/386",
    "body": "Hey guys, how are you?\n\nI'm trying to figure out why does alpha channel won't work with DZI images.\n\n```\n  sharp('image.png')\n  .tile(256)\n  .background(0,0,0,0)\n  .// here i've already tried { nothing, embed(), flatten() }\n  .toFile('image.dzi', function(err, info) {\n  });\n```\n\nThis code will output a dzi image with black background and no transparency at all. I've already tried modifying index.js and changing background default option to background: [0, 0, 0, 0] but this does not seem to work either. Is there something I can help you with?\n\nThanks in advance\natt Rafael\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/386/comments",
    "author": "rafaelnco",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-03-27T19:50:31Z",
        "body": "Ola Rafael, as you've discovered, tiled output currently uses the JPEG format so you'll lose any alpha channel. #337 includes adding support for other output settings so I've added a comment explicitly mentioning the PNG format. Shall we move this discussion to #337?\n"
      },
      {
        "user": "rafaelnco",
        "created_at": "2016-04-02T06:03:21Z",
        "body": "Ola @lovell! Sorry for the delay!\n\nI would really appreciate to help you with this quest, although I've mitigated this issue using image magick directly. Indeed, having sharp's PNG support at hand would be really useful but there are so many other issues my team got to solve right now that I can't spend much time on this. However, I'm lazily analysing sharp's code and trying to understand where exactly is the problem\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-04-02T06:46:11Z",
        "body": "Thanks for the reply - I'm going to close this in favour of #337 - tudo bom!\n"
      }
    ]
  },
  {
    "number": 381,
    "title": "Question about mixing resizing algorithms",
    "created_at": "2016-03-24T04:19:38Z",
    "closed_at": "2016-06-12T08:44:24Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/381",
    "body": "In my application I need to resize images of different aspect ratios and with different orientations and I found that it makes sense to apply resizing algorithm twice as follows:\n\n```\nvar image = sharp(filePath)\n  .resize(320, 320)\n  .min()\n  .withoutEnlargement()\n  .resize(720, 720)\n  .max()\n  .withoutEnlargement()\n  .withMetadata()\n  .jpeg();\n```\n\nThis seems work but is this the correct way to do it? Will this operation incur double resizing or is sharp smart enough to  calculate final dimensions and do it only once? Do I need to specify `withoutEnlargement()` twice? Is there a better way to do this? Thanks.\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/381/comments",
    "author": "dtoubelis",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-03-24T19:32:03Z",
        "body": "Hello Dmitri, the second `resize` operation will replace the values of the first, and `max` will replace `min`, so your example is equivalent to:\n\n``` javascript\nvar image = sharp(filePath)\n  .resize(720, 720)\n  .max()\n  .withoutEnlargement()\n  .withMetadata()\n  .jpeg();\n```\n\nAre you able to provide a couple of worked examples to help explain \"resize images of different aspect ratios and with different orientations\"?\n"
      },
      {
        "user": "dtoubelis",
        "created_at": "2016-03-24T19:47:18Z",
        "body": "Thanks Lovell. Yes, I figured that much myself that it does not do what I want. Here ase few samples of what I'm trying to achieve:\n1. source 860x360 -> resize(320, 320).min().withoutEnlargement() -> 764x320 -> resize(720,720).max().withoutEnlargement() -> 720x301\n2. source 1280x720 -> resize(320, 320).min().withoutEnlargement() -> 569x320 -> resize(720,720).max().withoutEnlargement() -> 569x320\n\nEssentially I want use case 2 to work and I was hoping that there is an easy way to avoid doing my own calculations on metadata or performing resize twice.\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-03-24T21:00:16Z",
        "body": "Thanks for the example, this looks like fairly specific logic so (if you're not using a Stream-based input) I'd go with the metadata approach as there's minimal performance impact in doing so.\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-06-12T08:44:24Z",
        "body": "Closing this as it's been dormant for a while - feel free to reopen if there are still questions/problems.\n"
      }
    ]
  },
  {
    "number": 377,
    "title": "metadata(): format comes out as 'magick'",
    "created_at": "2016-03-14T17:06:51Z",
    "closed_at": "2016-03-14T17:24:54Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/377",
    "body": "``` js\nrequire('sharp')('testdata/animated.gif').metadata(console.log);\n// ...\n{ format: 'magick',\n  width: 23,\n  height: 20,\n  space: 'rgb',\n  channels: 3,\n  hasProfile: false,\n  hasAlpha: false }\n```\n\nI expected it to be `format: 'gif'`. I'm guessing the info is available somehow since the width and height are?\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/377/comments",
    "author": "papandreou",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2016-03-14T17:23:42Z",
        "body": "Hej Andreas, libvips knows that *magick could load the image, but has no further information about what codec/container it used.\n\nThe forthcoming v8.3.0 of libvips is about to get much-improved GIF support and #369 should provide what you're looking for. I'll probably stop bundling the *magick loader too, so this unexpectedly expected behaviour should disappear entirely.\n"
      },
      {
        "user": "papandreou",
        "created_at": "2016-03-14T17:24:53Z",
        "body": "Okay, thanks. That's good enough for me :)\n"
      },
      {
        "user": "papandreou",
        "created_at": "2016-03-23T15:44:26Z",
        "body": "@lovell, actually, a quick follow-up question -- will the improved GIF support add the ability to detect an animated gif via `.metadata(...)`?\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-03-23T16:28:40Z",
        "body": "@papandreou Not sure yet, will add an investigation as part of #369.\n"
      },
      {
        "user": "papandreou",
        "created_at": "2016-03-23T16:29:45Z",
        "body": "@lovell Thanks a lot :)\n"
      }
    ]
  },
  {
    "number": 328,
    "title": "preinstall: cache build folders for faster ci tests",
    "created_at": "2015-12-22T22:08:15Z",
    "closed_at": "2015-12-22T23:07:02Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/328",
    "body": "currently, on circleci, compiling libvips with the preinstall.sh script takes 2 minutes, which is more than 50% of the entire test. it takes so long because it's compiling libvips from source.\n\nan optimization would be to check whether the cache folders already exist (ex. `vips-8.1.1`) and simplify install it, skipping the rest of the script. this would make installations much faster.\n\nof course, in your CI test suite, you have to add the cache folder to your config.\n\nany thoughts or ideas on this?\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/328/comments",
    "author": "jonathanong",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2015-12-22T22:44:15Z",
        "body": "Hello, which version of sharp are you using?\r\n\r\nv0.12.0+ should use a pre-compiled libvips on Circle CI's Ubuntu 12.04 via `npm install` without the need to run the almost-deprecated `preinstall.sh` script\r\n"
      },
      {
        "user": "jonathanong",
        "created_at": "2015-12-22T23:07:02Z",
        "body": "ah i didn't know it was deprecated. thanks!\n"
      },
      {
        "user": "lovell",
        "created_at": "2015-12-22T23:10:08Z",
        "body": "No worries. I say \"almost deprecated\" because Centos 6.\n"
      }
    ]
  },
  {
    "number": 323,
    "title": "Library not loaded: /usr/local/opt/jpeg/lib/libjpeg.8.dylib",
    "created_at": "2015-12-18T05:29:12Z",
    "closed_at": "2016-02-04T20:11:55Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/323",
    "body": "Hello，\n\n```\n ...Library not loaded: /usr/local/opt/jpeg/lib/libjpeg.8.dylib\n  Referenced from: /usr/local/opt/vips/lib/libvips.42.dylib\n  Reason: Incompatible library version: libvips.42.dylib requires version 13.0.0 or later, but libjpeg.8.dylib provides version 9.0.0\n\n```\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/323/comments",
    "author": "wenshan",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2015-12-18T10:03:23Z",
        "body": "Hello. Does running `brew update && brew upgrade` help? What command was run to install `vips`?\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-01-01T12:33:27Z",
        "body": "@wenshan Have you been able to make any progress?\n"
      },
      {
        "user": "tomjoro",
        "created_at": "2016-01-03T23:06:29Z",
        "body": "try symlinking it from $ sudo ln -s /usr/local/Cellar/jpeg/8d/lib/libjpeg.8.dylib /usr/local/opt/jpeg/lib/libjpeg.8.dylib\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-01-04T16:25:12Z",
        "body": "IIRC running `brew unlink jpeg && brew link jpeg` might also produce a similar effect to that described by @tomjoro.\n"
      },
      {
        "user": "tomjoro",
        "created_at": "2016-01-04T17:55:59Z",
        "body": "thanks. That worked for me too and is a better solution than manual symlink.\n"
      },
      {
        "user": "lovell",
        "created_at": "2016-02-04T20:11:55Z",
        "body": "Closing this as it looks like the solution is working for people. Feel free to re-open if not.\n"
      }
    ]
  },
  {
    "number": 252,
    "title": "Error: libMagickCore.so.5: cannot open shared object file: No such file or directory",
    "created_at": "2015-08-15T07:16:40Z",
    "closed_at": "2015-08-15T12:27:00Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/252",
    "body": "```\nmodule.js:482\n    var homeDir = process.env.HOME;\n  ^\nError: libMagickCore.so.5: cannot open shared object file: No such file or directory\n    at Error (native)\n    at Module.load (module.js:355:32)\n    at Function.Module._load (module.js:310:12)\n    at Module.require (module.js:365:17)\n    at require (module.js:384:17)\n    at Object.<anonymous> (/home/michael-heuberger/binarykitchen/code/videomail.io/node_modules/sharp/index.js:12:13)\n    at Module._compile (module.js:430:26)\n    at Object.Module._extensions..js (module.js:448:10)\n    at Module.load (module.js:355:32)\n    at Function.Module._load (module.js:310:12)\n    at Module.require (module.js:365:17)\n    at require (module.js:384:17)\n    at Object.<anonymous> (/home/michael-heuberger/binarykitchen/code/videomail.io/src/util/poster.js:2:13)\n    at Module._compile (module.js:430:26)\n    at Object.Module._extensions..js (module.js:448:10)\n    at Module.load (module.js:355:32)\n```\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/252/comments",
    "author": "binarykitchen",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2015-08-15T08:28:01Z",
        "body": "Hello, if you've recently upgraded the version of libmagick from 5 to 6, perhaps as a result of upgrading Ubuntu from 14.x to 15.04, then you may have run into #219.\n"
      },
      {
        "user": "binarykitchen",
        "created_at": "2015-08-15T11:17:40Z",
        "body": "@lovell I tried everything what is suggested in #219 but no success.\n\nYes, I were upgrading from 14.x to 15.x before ... but what should I do now?? It's breaking the development of www.videomail.io ...\n"
      },
      {
        "user": "lovell",
        "created_at": "2015-08-15T12:27:00Z",
        "body": "> \"I were upgrading from 14.x to 15.x\"\n\nThanks, marking as a duplicate of #219 - the discussion can continue there.\n"
      }
    ]
  },
  {
    "number": 240,
    "title": "Straight Pipeline with Resize + Metadata Operation for Streaming?",
    "created_at": "2015-07-14T02:34:56Z",
    "closed_at": "2015-11-23T13:29:42Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/240",
    "body": "I'm wondering if there is a way to enable this behavior:\n\n```\nvar maxHeight = 400;\nvar image = sharp( 'myImage.png' );\nimage\n  .resize( 300, null )\n  .metadata( metaDataHandler.bind( image ) )\n  .toFile( 'output/I-WORK.png', function( err, info ) {\n    console.log( info );\n  });\n\nfunction metaDataHandler( err, data ) {\n  if ( data.height > maxHeight ) {\n    this.extract( 0, 0, data.width, maxHeight );\n  }\n}\n```\n\nWhile applying the actual dimensions that the image will be after the `resize` operation? I'd basically really like to be able to pipe an image to a transform pipeline without having to issue a `toBuffer` call like this:\n\n```\nimage\n  .resize( 300, null )\n  .toBuffer()\n  .then( function( outputBuffer ) {\n    this.metadata( function( err, data ) {\n      if ( data.height > maxHeight ) {\n        this.extract( 0, 0, data.width, maxHeight; \n      }\n      this.toFile( 'output/I-WORK.png', function( err, info ) {\n        console.log( info );\n      })\n  }).bind( image )\n```\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/240/comments",
    "author": "Robert-Wett",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2015-07-14T09:49:50Z",
        "body": "Hi Rob, might #236 provide what you're looking for?\n"
      },
      {
        "user": "lovell",
        "created_at": "2015-08-25T23:33:55Z",
        "body": "Ping @Robert-Wett\n"
      },
      {
        "user": "lovell",
        "created_at": "2015-11-23T13:29:42Z",
        "body": "Closing this question as there hasn't been any activity in the last 90 days. Feel free to re-open if you still need help.\n"
      }
    ]
  },
  {
    "number": 181,
    "title": "Set image resolution (dpi)",
    "created_at": "2015-03-19T10:23:24Z",
    "closed_at": "2015-03-19T11:01:26Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/181",
    "body": "I think that my search skills are failing me...\n\nIs it possible to manually set the desired dpi of an image?\n\nI have a set of big TIFFs at 300 dpi and I would like to convert them into 300 dpi and 72 dpi JPEGs, is it possible?\n\nThanks!\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/181/comments",
    "author": "Couto",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2015-03-19T10:53:42Z",
        "body": "As far as I know, and if I understand your question correctly, the concept of DPI doesn't mean anything in the land of JPEG.\n\nYou should be able to achieve the equivalent of a 300DPI to 72DPI conversion by resizing to smaller dimensions, e.g. resize a source 1000x1000 pixel square image to a `1000 * 72 / 300` = 240x240 pixel image.\n"
      },
      {
        "user": "Couto",
        "created_at": "2015-03-19T11:01:26Z",
        "body": "Oh boy... I need to review my concepts of image formats and so on (it's not my area of expertise), as far as I can tell, you're absolutely right! :)\n\nThanks for the explanation! :+1: \n"
      }
    ]
  },
  {
    "number": 153,
    "title": "non-aspect resize?",
    "created_at": "2015-01-25T22:50:00Z",
    "closed_at": "2015-01-25T23:59:45Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/153",
    "body": "After months of using this library I finally noticed that sharp behaves exactly like documented ;-)\n\nJoking aside, I somehow managed to completely overlook the cropping behavior of resize() when used with two non-null parameters. Given the auto-logic when omitting one, and also having max() I somehow assumed that specifying both parameters would scale to the given size, ignoring the original aspect ratio, and essentially stretch and squeeze the image to fit.\n\nI understand that this is a very uncommon and usually completely unwanted usecase for the general public. Unfortunately I do need it for my application, and I really don't want to switch to something else.\n\nAm I overlooking something how this could be achieved already, or am I asking for a new feature that probably no one would use, except for me?\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/153/comments",
    "author": "bkw",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2015-01-25T23:58:42Z",
        "body": "Hi Bernhard, does #118 sound similar enough to what you need? Feel free to add comment there if so.\n"
      },
      {
        "user": "bkw",
        "created_at": "2015-01-25T23:59:45Z",
        "body": "I swear I looked through the issues before. Time to go to bed, sorry to bother.\n"
      }
    ]
  },
  {
    "number": 119,
    "title": "Perf question",
    "created_at": "2014-11-18T08:18:50Z",
    "closed_at": "2014-12-02T11:28:26Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/119",
    "body": "First of all, thank you for the great binding.  \nPlease help.  I'm not sure if I'm doing something wrong.  Libvip and sharp is great for processing one image at a time.  But when I have lots concurrent requests, it doesn't seem to perform on the same level as graphics magick.  \nHere's my sample code \n\n```\nvar util = require('util');\nvar fs = require('fs');\nvar Promise = require('es6-promise').Promise;\nvar _ = require('underscore');\nvar sharp = require('sharp');\n\nvar totalTime = 0;\nvar count = 100;\n\n// concurrency does not help\n//sharp.concurrency(32);\n\nvar originalImage = fs.readFile('./lib/test.jpg', function(err, data) {\n    var promises = [];\n    if(err) {\n        return console.log(' ERROR in reading file ' + err);\n    }\n    for(var i = 0; i < count; i++ ) {\n        promises[i] = sharpResize(data, _.random(400) + 1, _.random(400) + 1);\n    }\n\n    Promise.all(promises)\n    .then(function() {\n        console.log('  Final avg time is ' + totalTime / count);\n    }).catch(function(err) {\n        console.log('  Final ERROR ' + err);\n    });\n});\n\nfunction sharpResize(data, width, height) {\n    return new Promise(function (resolve, reject) {\n        var start = Date.now();\n        var counter = sharp.counters();\n        console.log('  counter stats ' + util.inspect(counter));\n        var stats = sharp.cache();\n        console.log('  cache stats ' + util.inspect(stats));\n\n        var pipeline = sharp(data)\n        .resize(width, height)\n        .embed()\n        .toBuffer(function sharpDone(err, buffer, info) {\n            var timeDelta = (Date.now() - start);\n            if (err) {\n                return reject('failed ' + err);\n            }\n            console.log(' success time ' + timeDelta.toFixed(0));\n            totalTime += timeDelta;\n            resolve(buffer);\n        });\n    });\n}\n```\n\nand this is my output\nsuccess time 143\n success time 147\n success time 147\n success time 168\n...\n...\nsuccess time 2926\nsuccess time 2930\nsuccess time 2943\nsuccess time 2949\n  Final avg time is 1542.15\n\nThe queue stacks up, and the number of working process doesn't really get past 4 (even if I increase the concurrency value).  (I'm on a 8 core Mac laptop).  \nSo, am I missing something?  \n\nThank you.  (btw.. I'm not sure if this is the place to ask question)\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/119/comments",
    "author": "jsongHBO",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2014-11-18T09:59:35Z",
        "body": "If you're only seeing 4 concurrent processes (`sharp.counters()` can confirm) then it sounds like libuv thinks you only have 4 CPUs. To force it to use 8 worker threads, try adding this as the first line of the script:\n\n```\nprocess.env.UV_THREADPOOL_SIZE=8;\n```\n\nThe value passed to `sharp.concurrency(...)` is used by libvips to spawn that many threads per resize operation. Large reductions will benefit from more threads, but go too high and you get too much thread-management overhead.\n\nI recommend a max value of the number of cores and you may find that no threading (a value of 1) is more performant - it depends on the situation.\n\nIf your input is a file on the filesystem, passing the filename as the input may be faster to take advantage of libvips (and OS) caching.\n"
      },
      {
        "user": "lovell",
        "created_at": "2014-12-01T22:42:30Z",
        "body": "@jsongHBO did you have any success by modifying `UV_THREADPOOL_SIZE` and/or `sharp.concurrency`?\n"
      },
      {
        "user": "jsongHBO",
        "created_at": "2014-12-01T23:45:29Z",
        "body": "Yes.  There is increase perf when I set threadpool_size to 2, and concurrency value low.  \nThere's still an increase per request.  But much better than before.  \n\nThank you.\n"
      },
      {
        "user": "lovell",
        "created_at": "2014-12-02T11:28:26Z",
        "body": "Great, thanks for confirming.\n\nFor the future benefit of anyone else discovering this question:\n1. the value of `UV_THREADPOOL_SIZE` limits the maximum number of concurrent tasks, and\n2. the value passed to `sharp.concurrency` controls the number of threads working on each task.\n\nBoth values default to the number of CPU cores, which may or may not not provide the best performance for a given workload - YMMV.\n"
      }
    ]
  },
  {
    "number": 104,
    "title": "Is HTML5 Canvas DataURL format Supported?",
    "created_at": "2014-10-20T16:56:56Z",
    "closed_at": "2014-10-20T20:19:12Z",
    "labels": [
      "question"
    ],
    "url": "https://github.com/lovell/sharp/issues/104",
    "body": "Hi Guys,\n\nI am trying to find a solution where I convert an image upload on the front-end into a data string format, which is essentially a base64 style string, using HTML5 Canvas API.\n\nI then send  this string to the back-end. What I wanted to ask is if there is a way for me to use the 'sharp' library so that it can load and process this data string so I can perform some operations (mainly resize in to new images).\n\nIs this possible?\n",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/104/comments",
    "author": "iq-dot",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2014-10-20T18:06:52Z",
        "body": "The `toDataURL()` method of an HTML5 canvas returns base64-encoded PNG image data (you can request JPEG data by using `toDataURL('image/jpeg')`.\n\nAssuming `image` is a String containing base64-encoded data, either PNG or JPEG, then you should be able to use something like the following:\n\n`sharp(new Buffer(image, 'base64')).resize(width, height).toBuffer(function(err, data) { ... })`\n"
      },
      {
        "user": "iq-dot",
        "created_at": "2014-10-20T19:24:47Z",
        "body": "Ah fantastic, I currently do use JPEG data using 'image/jpeg'.\n\nOne last clarification, will the toBuffer give back the same format JPEG data in base64 so that I can send it back as is to the front-end for rendering?\n"
      },
      {
        "user": "lovell",
        "created_at": "2014-10-20T20:08:59Z",
        "body": "If you'd like the output image data to be a base64-encoded string you can use `data.toString('base64')`.\n\nIf you simply need the browser to display the output JPEG image then you can send the Buffer directly. Here's an example using Express:\n\n```\nroute.get(..., function(req, res) {\n  ...\n  sharp(...).resize(...).toBuffer(function(err, data) {\n    res.header('Content-Type', 'image/jpeg').send(data);\n  });\n});\n```\n"
      }
    ]
  },
  {
    "number": 904,
    "title": "Expose XMP / IPTC via metadata API",
    "created_at": "2017-08-05T17:08:05Z",
    "closed_at": "2018-01-10T22:12:12Z",
    "labels": [
      "enhancement",
      "help wanted"
    ],
    "url": "https://github.com/lovell/sharp/issues/904",
    "body": "Hello!\r\n\r\nSince metadata API exposes EXIF data, would the project consider supporting XMP and IPTC as well?\r\n\r\nI briefly looked around the libvips wiki. It doesn't mention XMP or IPTC. Happy to open a ticket there as well.",
    "comments_url": "https://api.github.com/repos/lovell/sharp/issues/904/comments",
    "author": "rayshan",
    "comments": [
      {
        "user": "lovell",
        "created_at": "2017-08-07T17:29:53Z",
        "body": "Hello, libvips makes these available as `VIPS_META_XMP_NAME` and `VIPS_META_IPCT_NAME` properties  but they have yet to be exposed via sharp. Happy to accept a PR with this useful addition."
      }
    ]
  }
]